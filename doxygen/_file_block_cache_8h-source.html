<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/RangeServer/FileBlockCache.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b6724abc6b41a2670a831834f82498af.html">RangeServer</a></div>
<h1>FileBlockCache.h</h1><a href="_file_block_cache_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#ifndef HYPERTABLE_FILEBLOCKCACHE_H</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#define HYPERTABLE_FILEBLOCKCACHE_H</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;boost/multi_index_container.hpp&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;boost/multi_index/hashed_index.hpp&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;boost/multi_index/mem_fun.hpp&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;boost/multi_index/sequenced_index.hpp&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;boost/thread/mutex.hpp&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include "<a class="code" href="atomic_8h.html">Common/atomic.h</a>"</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="keyword">namespace </span>Hypertable {
<a name="l00034"></a>00034   <span class="keyword">using namespace </span>boost::multi_index;
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html">00036</a>   <span class="keyword">class </span><a class="code" href="class_hypertable_1_1_file_block_cache.html">FileBlockCache</a> {
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#23c166474019e28c10e8ab605034d88a">00038</a>     <span class="keyword">static</span> <a class="code" href="structatomic__t.html">atomic_t</a> <a class="code" href="class_hypertable_1_1_file_block_cache.html#23c166474019e28c10e8ab605034d88a">ms_next_file_id</a>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040   <span class="keyword">public</span>:
<a name="l00041"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#37828225517a61eef9f0db777ef45309">00041</a>     <a class="code" href="class_hypertable_1_1_file_block_cache.html#37828225517a61eef9f0db777ef45309">FileBlockCache</a>(uint64_t max_memory)
<a name="l00042"></a>00042         : <a class="code" href="class_hypertable_1_1_file_block_cache.html#a30c74f541c9add6405d5092a51c543d">m_max_memory</a>(max_memory), <a class="code" href="class_hypertable_1_1_file_block_cache.html#a7f16b4b89dee8a6e39b31fbe982f8e4">m_avail_memory</a>(max_memory) {  }
<a name="l00043"></a>00043     <a class="code" href="class_hypertable_1_1_file_block_cache.html#94f16cc9c6c01f55943ef0e76c0662b7">~FileBlockCache</a>();
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     <span class="keywordtype">bool</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html#55129eef0d86ffc3cc95249ca13b5a25">checkout</a>(<span class="keywordtype">int</span> file_id, uint32_t file_offset, uint8_t **blockp,
<a name="l00046"></a>00046                   uint32_t *lengthp);
<a name="l00047"></a>00047     <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html#737969e4fb2c198f68643a695a1d2b1c">checkin</a>(<span class="keywordtype">int</span> file_id, uint32_t file_offset);
<a name="l00048"></a>00048     <span class="keywordtype">bool</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html#e55603d051b0373d20a98d46f5f1578d">insert_and_checkout</a>(<span class="keywordtype">int</span> file_id, uint32_t file_offset,
<a name="l00049"></a>00049                              uint8_t *block, uint32_t length);
<a name="l00050"></a>00050     <span class="keywordtype">bool</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html#f503613c10d57266bbdea4683cb61d55">contains</a>(<span class="keywordtype">int</span> file_id, uint32_t file_offset);
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#5c5db6cc6ae493d1c578f3148b32927a">00052</a>     <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html#5c5db6cc6ae493d1c578f3148b32927a">get_next_file_id</a>() {
<a name="l00053"></a>00053       <span class="keywordflow">return</span> <a class="code" href="atomic_8h.html#9a5d8951b9c8bae6c060b2bf41a76d03">atomic_inc_return</a>(&amp;<a class="code" href="class_hypertable_1_1_file_block_cache.html#23c166474019e28c10e8ab605034d88a">ms_next_file_id</a>);
<a name="l00054"></a>00054     }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   <span class="keyword">private</span>:
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html">00058</a>     <span class="keyword">class </span><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html">BlockCacheEntry</a> {
<a name="l00059"></a>00059     <span class="keyword">public</span>:
<a name="l00060"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#fec0b5a7bc1731a6535b357a0c9598b0">00060</a>       <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#fec0b5a7bc1731a6535b357a0c9598b0">BlockCacheEntry</a>() : <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#4b5965f8312163b5e8acb54a91a00b51">file_id</a>(-1), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#221816092fb4f3ce91f4abd3d68a323c">file_offset</a>(0), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#7d526bc05281ebe688ddc4bb2a28f245">block</a>(0), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#d316e969f03f4c1f3b3f11a62e69dd4d">length</a>(0),
<a name="l00061"></a>00061           <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1af37ae3fc2d45e5ef1aa4b70609a217">ref_count</a>(0) { <span class="keywordflow">return</span>; }
<a name="l00062"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1794e7f8086df7feb61e33dc023aba9f">00062</a>       <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#fec0b5a7bc1731a6535b357a0c9598b0">BlockCacheEntry</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, uint32_t <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>) : <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#4b5965f8312163b5e8acb54a91a00b51">file_id</a>(id),
<a name="l00063"></a>00063           <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#221816092fb4f3ce91f4abd3d68a323c">file_offset</a>(offset), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#7d526bc05281ebe688ddc4bb2a28f245">block</a>(0), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#d316e969f03f4c1f3b3f11a62e69dd4d">length</a>(0), <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1af37ae3fc2d45e5ef1aa4b70609a217">ref_count</a>(0) { <span class="keywordflow">return</span>; }
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#4b5965f8312163b5e8acb54a91a00b51">00065</a>       <span class="keywordtype">int</span>      <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#4b5965f8312163b5e8acb54a91a00b51">file_id</a>;
<a name="l00066"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#221816092fb4f3ce91f4abd3d68a323c">00066</a>       uint32_t <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#221816092fb4f3ce91f4abd3d68a323c">file_offset</a>;
<a name="l00067"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#7d526bc05281ebe688ddc4bb2a28f245">00067</a>       uint8_t  *<a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#7d526bc05281ebe688ddc4bb2a28f245">block</a>;
<a name="l00068"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#d316e969f03f4c1f3b3f11a62e69dd4d">00068</a>       uint32_t <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#d316e969f03f4c1f3b3f11a62e69dd4d">length</a>;
<a name="l00069"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1af37ae3fc2d45e5ef1aa4b70609a217">00069</a>       uint32_t <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1af37ae3fc2d45e5ef1aa4b70609a217">ref_count</a>;
<a name="l00070"></a><a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#2b44c7fdd71a742ad86b2aff928a256e">00070</a>       uint64_t <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#2b44c7fdd71a742ad86b2aff928a256e">key</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ((uint64_t)<a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#4b5965f8312163b5e8acb54a91a00b51">file_id</a> &lt;&lt; 32) | <a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#221816092fb4f3ce91f4abd3d68a323c">file_offset</a>; }
<a name="l00071"></a>00071     };
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_decrement_ref_count.html">00073</a>     <span class="keyword">struct </span><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_decrement_ref_count.html">DecrementRefCount</a> {
<a name="l00074"></a><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_decrement_ref_count.html#55fcac5767899fa27292d1807635aa84">00074</a>       <span class="keywordtype">void</span> <a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_decrement_ref_count.html#55fcac5767899fa27292d1807635aa84">operator()</a>(<a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html">BlockCacheEntry</a> &amp;entry) {
<a name="l00075"></a>00075         entry.<a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#1af37ae3fc2d45e5ef1aa4b70609a217">ref_count</a>--;
<a name="l00076"></a>00076       }
<a name="l00077"></a>00077     };
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_hash_i64.html">00079</a>     <span class="keyword">struct </span><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_hash_i64.html">HashI64</a> {
<a name="l00080"></a><a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_hash_i64.html#29a2edbb8b99b44fb9786677115df61a">00080</a>       std::size_t <a class="code" href="struct_hypertable_1_1_file_block_cache_1_1_hash_i64.html#29a2edbb8b99b44fb9786677115df61a">operator()</a>(uint64_t x)<span class="keyword"> const </span>{
<a name="l00081"></a>00081         <span class="keywordflow">return</span> (std::size_t)(x &gt;&gt; 32) ^ (std::size_t)x;
<a name="l00082"></a>00082       }
<a name="l00083"></a>00083     };
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keyword">typedef</span> boost::multi_index_container&lt;
<a name="l00086"></a>00086       BlockCacheEntry,
<a name="l00087"></a>00087       indexed_by&lt;
<a name="l00088"></a>00088         sequenced&lt;&gt;,
<a name="l00089"></a>00089         hashed_unique&lt;const_mem_fun&lt;BlockCacheEntry, uint64_t,
<a name="l00090"></a>00090                       &amp;<a class="code" href="class_hypertable_1_1_file_block_cache_1_1_block_cache_entry.html#2b44c7fdd71a742ad86b2aff928a256e">BlockCacheEntry::key</a>&gt;, HashI64&gt;
<a name="l00091"></a>00091       &gt;
<a name="l00092"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#99cf4b8744bef9b18744415a3991446d">00092</a>     &gt; <a class="code" href="class_hypertable_1_1_file_block_cache.html#99cf4b8744bef9b18744415a3991446d">BlockCache</a>;
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#587e1b75ddf1ef93fe5fe182d578a439">00094</a>     <span class="keyword">typedef</span> BlockCache::nth_index&lt;0&gt;::type <a class="code" href="class_hypertable_1_1_file_block_cache.html#587e1b75ddf1ef93fe5fe182d578a439">Sequence</a>;
<a name="l00095"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#1bed103d282c1ed845b01619abff4ca5">00095</a>     <span class="keyword">typedef</span> BlockCache::nth_index&lt;1&gt;::type <a class="code" href="class_hypertable_1_1_file_block_cache.html#1bed103d282c1ed845b01619abff4ca5">HashIndex</a>;
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#1e56af2f9cb85fed9d89cc631547fad2">00097</a>     boost::mutex  <a class="code" href="class_hypertable_1_1_file_block_cache.html#1e56af2f9cb85fed9d89cc631547fad2">m_mutex</a>;
<a name="l00098"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#307d11dbb1b8ac15fb73038611ef1229">00098</a>     <a class="code" href="class_hypertable_1_1_file_block_cache.html#99cf4b8744bef9b18744415a3991446d">BlockCache</a>    <a class="code" href="class_hypertable_1_1_file_block_cache.html#307d11dbb1b8ac15fb73038611ef1229">m_cache</a>;
<a name="l00099"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#a30c74f541c9add6405d5092a51c543d">00099</a>     uint64_t      <a class="code" href="class_hypertable_1_1_file_block_cache.html#a30c74f541c9add6405d5092a51c543d">m_max_memory</a>;
<a name="l00100"></a><a class="code" href="class_hypertable_1_1_file_block_cache.html#a7f16b4b89dee8a6e39b31fbe982f8e4">00100</a>     uint64_t      <a class="code" href="class_hypertable_1_1_file_block_cache.html#a7f16b4b89dee8a6e39b31fbe982f8e4">m_avail_memory</a>;
<a name="l00101"></a>00101   };
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="preprocessor">#endif // HYPERTABLE_FILEBLOCKCACHE_H</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Aug 1 14:19:23 2008 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
