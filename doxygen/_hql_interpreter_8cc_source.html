<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/Lib/HqlInterpreter.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ad5135801673f2e4c4e1be66fcd2e528.html">Lib</a>
  </div>
</div>
<div class="contents">
<h1>HqlInterpreter.cc</h1><a href="_hql_interpreter_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_compat_8h.html">Common/Compat.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_schema_8h.html">Schema.h</a>"</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="_time_8h.html">time.h</a>&gt;</span>
<a name="l00032"></a>00032 }
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;boost/iostreams/device/file_descriptor.hpp&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;boost/iostreams/filtering_stream.hpp&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;boost/iostreams/filter/gzip.hpp&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;boost/iostreams/device/null.hpp&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="_common_2_config_8h.html">Common/Config.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="_error_8h.html">Common/Error.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="_file_utils_8h.html">Common/FileUtils.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="_stopwatch_8h.html">Common/Stopwatch.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="_scope_guard_8h.html">Common/ScopeGuard.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="_string_8h.html">Common/String.h</a>"</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="_hypertable_2_lib_2_client_8h.html">Client.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="_hql_interpreter_8h.html">HqlInterpreter.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="_hql_help_text_8h.html">HqlHelpText.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="_hql_parser_8h.html">HqlParser.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="_key_8h.html">Key.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="_load_data_escape_8h.html">LoadDataEscape.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="_load_data_source_8h.html">LoadDataSource.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="_load_data_source_factory_8h.html">LoadDataSourceFactory.h</a>"</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">using namespace </span>std;
<a name="l00056"></a>00056 <span class="keyword">using namespace </span>Hypertable;
<a name="l00057"></a>00057 <span class="keyword">using namespace </span>Hql;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">namespace </span>{
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="keywordtype">void</span> close_file(<span class="keywordtype">int</span> fd) {
<a name="l00062"></a>00062   <span class="keywordflow">if</span> (fd &gt;= 0)
<a name="l00063"></a>00063     close(fd);
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keywordtype">void</span> cmd_help(<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00067"></a>00067   <span class="keyword">const</span> <span class="keywordtype">char</span> **text = <a class="code" href="namespace_hypertable_1_1_config.html#93660d0486a4cb41e9dfa813c3034f47" title="get config value">HqlHelpText::get</a>(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#8935e9c56dd08ce620a1cd2183bcf169">str</a>);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069   <span class="keywordflow">if</span> (text) {
<a name="l00070"></a>00070     <span class="keywordflow">for</span> (; *text; ++text)
<a name="l00071"></a>00071       cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#778e24cb69781147113d7b2728ad0d21" title="Called when interpreter returns a string result Maybe called multiple times for a...">on_return</a>(*text);
<a name="l00072"></a>00072   }
<a name="l00073"></a>00073   <span class="keywordflow">else</span>
<a name="l00074"></a>00074     cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#778e24cb69781147113d7b2728ad0d21" title="Called when interpreter returns a string result Maybe called multiple times for a...">on_return</a>(<span class="stringliteral">"\nno help for '"</span> + state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#8935e9c56dd08ce620a1cd2183bcf169">str</a>);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="keywordtype">void</span>
<a name="l00078"></a>00078 cmd_show_create_table(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00079"></a>00079                       <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00080"></a>00080   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> out_str;
<a name="l00081"></a>00081   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> schema_str = client-&gt;get_schema(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, <span class="keyword">true</span>);
<a name="l00082"></a>00082   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema = Schema::new_instance(schema_str.c_str(),
<a name="l00083"></a>00083                                           schema_str.length(), <span class="keyword">true</span>);
<a name="l00084"></a>00084   <span class="keywordflow">if</span> (!schema-&gt;is_valid())
<a name="l00085"></a>00085     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b28a5a59aa0e7adf59fa4f92bf15e0f9e6">Error::BAD_SCHEMA</a>, schema-&gt;get_error_string());
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   schema-&gt;render_hql_create_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, out_str);
<a name="l00088"></a>00088   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#778e24cb69781147113d7b2728ad0d21" title="Called when interpreter returns a string result Maybe called multiple times for a...">on_return</a>(out_str);
<a name="l00089"></a>00089   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="keywordtype">void</span>
<a name="l00093"></a>00093 cmd_create_table(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00094"></a>00094                  <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00095"></a>00095   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> schema_str;
<a name="l00096"></a>00096   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l00097"></a>00097   <span class="keywordtype">bool</span> need_default_ag = <span class="keyword">false</span>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099   <span class="keywordflow">if</span> (!state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#05ef9a744680c4005a859804fbb8b986">clone_table_name</a>.empty()) {
<a name="l00100"></a>00100     schema_str = client-&gt;get_schema(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#05ef9a744680c4005a859804fbb8b986">clone_table_name</a>, <span class="keyword">true</span>);
<a name="l00101"></a>00101     schema = Schema::new_instance(schema_str.c_str(), schema_str.size(), <span class="keyword">true</span>);
<a name="l00102"></a>00102     schema_str.clear();
<a name="l00103"></a>00103     schema-&gt;render(schema_str);
<a name="l00104"></a>00104     client-&gt;create_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, schema_str.c_str());
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106   <span class="keywordflow">else</span> {
<a name="l00107"></a>00107     schema = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_schema.html">Schema</a>();
<a name="l00108"></a>00108     schema-&gt;validate_compressor(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#994a7e368c68dbd12906b9546db9223d">table_compressor</a>);
<a name="l00109"></a>00109     schema-&gt;set_compressor(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#994a7e368c68dbd12906b9546db9223d">table_compressor</a>);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="keywordflow">foreach</span>(<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a> *ag, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#bbd7724226ca466a8fc44f5f8ec9abf0">ag_list</a>) {
<a name="l00112"></a>00112       schema-&gt;validate_compressor(ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#1c74b9ff41bfe0e05cf616533ee4b996">compressor</a>);
<a name="l00113"></a>00113       schema-&gt;validate_bloom_filter(ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#2183a4f9a3199b13416375df5fb30829">bloom_filter</a>);
<a name="l00114"></a>00114       <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#92b8d763aa627a912fed14a455f5d253">table_in_memory</a>)
<a name="l00115"></a>00115         ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#f00c75922a651bcdd0a3be32e6c22f9c">in_memory</a> = <span class="keyword">true</span>;
<a name="l00116"></a>00116       <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#6fa725d549ad0457939d3551f425e52b">table_blocksize</a> != 0 &amp;&amp; ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#18987204f756e93815e614214cba8050">blocksize</a> == 0)
<a name="l00117"></a>00117         ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#18987204f756e93815e614214cba8050">blocksize</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#6fa725d549ad0457939d3551f425e52b">table_blocksize</a>;
<a name="l00118"></a>00118       schema-&gt;add_access_group(ag);
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5a73b7967e8a4f99f2f20b5020448007">ag_map</a>.find(<span class="stringliteral">"default"</span>) == state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5a73b7967e8a4f99f2f20b5020448007">ag_map</a>.end())
<a name="l00122"></a>00122       need_default_ag = <span class="keyword">true</span>;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <span class="keywordflow">foreach</span>(<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html">Schema::ColumnFamily</a> *cf, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#661b82dfcbc6a8fcd07cde25b8165429">cf_list</a>) {
<a name="l00125"></a>00125       <span class="keywordflow">if</span> (cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cfc4e253ca8590c5abee81172d9b705a">ag</a> == <span class="stringliteral">""</span>) {
<a name="l00126"></a>00126         cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cfc4e253ca8590c5abee81172d9b705a">ag</a> = <span class="stringliteral">"default"</span>;
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (need_default_ag) {
<a name="l00128"></a>00128           <a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a> *ag = <span class="keyword">new</span> <a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a>();
<a name="l00129"></a>00129           ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#f73dc29e25d8ce7ca2b67c15a3ced902">name</a> = <span class="stringliteral">"default"</span>;
<a name="l00130"></a>00130           <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#92b8d763aa627a912fed14a455f5d253">table_in_memory</a>)
<a name="l00131"></a>00131             ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#f00c75922a651bcdd0a3be32e6c22f9c">in_memory</a> = <span class="keyword">true</span>;
<a name="l00132"></a>00132           <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#6fa725d549ad0457939d3551f425e52b">table_blocksize</a> != 0 &amp;&amp; ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#18987204f756e93815e614214cba8050">blocksize</a> == 0)
<a name="l00133"></a>00133             ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#18987204f756e93815e614214cba8050">blocksize</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#6fa725d549ad0457939d3551f425e52b">table_blocksize</a>;
<a name="l00134"></a>00134           schema-&gt;add_access_group(ag);
<a name="l00135"></a>00135           need_default_ag = <span class="keyword">false</span>;
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137       }
<a name="l00138"></a>00138       <span class="keywordflow">if</span> (cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#dfd2949429fa30dcd1ac82d314078422">ttl</a> == 0 &amp;&amp; state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#d5e7e56ce07308efadc249302fbbb2a1">ttl</a> != 0)
<a name="l00139"></a>00139         cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#dfd2949429fa30dcd1ac82d314078422">ttl</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#d5e7e56ce07308efadc249302fbbb2a1">ttl</a>;
<a name="l00140"></a>00140       <span class="keywordflow">if</span> (cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cd48ee0c45da9a3658da60e366616c4f">max_versions</a> == 0 &amp;&amp; state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5904aa5f522f4795fc0e47d30b48d759">max_versions</a> != 0)
<a name="l00141"></a>00141         cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cd48ee0c45da9a3658da60e366616c4f">max_versions</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5904aa5f522f4795fc0e47d30b48d759">max_versions</a>;
<a name="l00142"></a>00142       schema-&gt;add_column_family(cf);
<a name="l00143"></a>00143     }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (!schema-&gt;is_valid())
<a name="l00146"></a>00146       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2310fad45ca881ccdbff9a91b78ddfa4b">Error::HQL_PARSE_ERROR</a>, schema-&gt;get_error_string());
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     schema-&gt;render(schema_str);
<a name="l00149"></a>00149     client-&gt;create_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, schema_str.c_str());
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="keywordtype">void</span>
<a name="l00155"></a>00155 cmd_alter_table(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00156"></a>00156                  <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00157"></a>00157   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> schema_str;
<a name="l00158"></a>00158   <a class="code" href="class_hypertable_1_1_schema.html">Schema</a> *schema = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_schema.html">Schema</a>();
<a name="l00159"></a>00159   <span class="keywordtype">bool</span> need_default_ag = <span class="keyword">false</span>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="keywordflow">foreach</span>(<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a> *ag, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#bbd7724226ca466a8fc44f5f8ec9abf0">ag_list</a>)
<a name="l00162"></a>00162     schema-&gt;<a class="code" href="class_hypertable_1_1_schema.html#1665e6c2a05731badb7bfc5596c0343c">add_access_group</a>(ag);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164   <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5a73b7967e8a4f99f2f20b5020448007">ag_map</a>.find(<span class="stringliteral">"default"</span>) == state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5a73b7967e8a4f99f2f20b5020448007">ag_map</a>.end())
<a name="l00165"></a>00165     need_default_ag = <span class="keyword">true</span>;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   <span class="keywordflow">foreach</span>(<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html">Schema::ColumnFamily</a> *cf, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#661b82dfcbc6a8fcd07cde25b8165429">cf_list</a>) {
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cfc4e253ca8590c5abee81172d9b705a">ag</a> == <span class="stringliteral">""</span>) {
<a name="l00169"></a>00169       cf-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_column_family.html#cfc4e253ca8590c5abee81172d9b705a">ag</a> = <span class="stringliteral">"default"</span>;
<a name="l00170"></a>00170       <span class="keywordflow">if</span> (need_default_ag) {
<a name="l00171"></a>00171         <a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a> *ag = <span class="keyword">new</span> <a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a>();
<a name="l00172"></a>00172         ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#f73dc29e25d8ce7ca2b67c15a3ced902">name</a> = <span class="stringliteral">"default"</span>;
<a name="l00173"></a>00173         schema-&gt;<a class="code" href="class_hypertable_1_1_schema.html#1665e6c2a05731badb7bfc5596c0343c">add_access_group</a>(ag);
<a name="l00174"></a>00174         need_default_ag = <span class="keyword">false</span>;
<a name="l00175"></a>00175       }
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     schema-&gt;<a class="code" href="class_hypertable_1_1_schema.html#07177ba9890d9a4f84549428ceb8e093">add_column_family</a>(cf);
<a name="l00178"></a>00178   }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   <span class="keyword">const</span> <span class="keywordtype">char</span> *error_str = schema-&gt;<a class="code" href="class_hypertable_1_1_schema.html#70aab413af15f3e2370a31437487d0be">get_error_string</a>();
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   <span class="keywordflow">if</span> (error_str)
<a name="l00183"></a>00183     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2310fad45ca881ccdbff9a91b78ddfa4b">Error::HQL_PARSE_ERROR</a>, error_str);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185   schema-&gt;<a class="code" href="class_hypertable_1_1_schema.html#43c4c9447ff16b9d39fae1a3e0ffce89">render</a>(schema_str);
<a name="l00186"></a>00186   client-&gt;alter_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, schema_str.c_str());
<a name="l00187"></a>00187 
<a name="l00191"></a>00191   client-&gt;refresh_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>);
<a name="l00192"></a>00192   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="keywordtype">void</span>
<a name="l00196"></a>00196 cmd_describe_table(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00197"></a>00197                    <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00198"></a>00198   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> schema_str = client-&gt;get_schema(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#2ffac43c226a106af5c19ee98c124e87">with_ids</a>);
<a name="l00199"></a>00199   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#778e24cb69781147113d7b2728ad0d21" title="Called when interpreter returns a string result Maybe called multiple times for a...">on_return</a>(schema_str);
<a name="l00200"></a>00200   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keywordtype">void</span>
<a name="l00204"></a>00204 cmd_select(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00205"></a>00205   <a class="code" href="namespace_hypertable.html#c71c18ddb7522183899f6a8cd29a997a">TablePtr</a> table;
<a name="l00206"></a>00206   <a class="code" href="namespace_hypertable.html#ec5eeec65d09ad656c434b6ce60b1d87">TableScannerPtr</a> scanner;
<a name="l00207"></a>00207   boost::iostreams::filtering_ostream fout;
<a name="l00208"></a>00208   FILE *outf = cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#aae5ace429ac17715d337b5a93e1c229">output</a>;
<a name="l00209"></a>00209   <span class="keywordtype">int</span> out_fd = -1;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211   table = client-&gt;open_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>);
<a name="l00212"></a>00212   scanner = table-&gt;create_scanner(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#30c0081c53cdca14176a108557af9630">builder</a>.<a class="code" href="class_hypertable_1_1_scan_spec_builder.html#800441f2a2df4c7459ce886273d8000f" title="Returns the built ScanSpec object.">get</a>(), 0, <span class="keyword">true</span>);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="comment">// whether it's select into file</span>
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (!state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#772ccccf9ef1fcfc048257ec1f807de4">outfile</a>.empty()) {
<a name="l00216"></a>00216     FileUtils::expand_tilde(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#772ccccf9ef1fcfc048257ec1f807de4">outfile</a>);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (boost::algorithm::ends_with(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#772ccccf9ef1fcfc048257ec1f807de4">outfile</a>, <span class="stringliteral">".gz"</span>))
<a name="l00219"></a>00219       fout.push(boost::iostreams::gzip_compressor());
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     fout.push(boost::iostreams::file_descriptor_sink(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#772ccccf9ef1fcfc048257ec1f807de4">outfile</a>));
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#ea8109635167face07d1721ef5d9ccb3">display_timestamps</a>) {
<a name="l00223"></a>00223       <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#489a9f10a157e2196e60a8cd2a42ce58">keys_only</a>)
<a name="l00224"></a>00224         fout &lt;&lt; <span class="stringliteral">"#timestamp\trow\n"</span>;
<a name="l00225"></a>00225       <span class="keywordflow">else</span>
<a name="l00226"></a>00226         fout &lt;&lt; <span class="stringliteral">"#timestamp\trow\tcolumn\tvalue\n"</span>;
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228     <span class="keywordflow">else</span> {
<a name="l00229"></a>00229       <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#489a9f10a157e2196e60a8cd2a42ce58">keys_only</a>)
<a name="l00230"></a>00230         fout &lt;&lt; <span class="stringliteral">"#row\n"</span>;
<a name="l00231"></a>00231       <span class="keywordflow">else</span>
<a name="l00232"></a>00232         fout &lt;&lt; <span class="stringliteral">"#row\tcolumn\tvalue\n"</span>;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!outf) {
<a name="l00236"></a>00236     cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#cbb53938fca3a7814d049b1333e077e0" title="Called when interpreter is ready to scan.">on_scan</a>(*scanner.get());
<a name="l00237"></a>00237     <span class="keywordflow">return</span>;
<a name="l00238"></a>00238   }
<a name="l00239"></a>00239   <span class="keywordflow">else</span> {
<a name="l00240"></a>00240     out_fd = dup(fileno(outf));
<a name="l00241"></a>00241     fout.push(boost::iostreams::file_descriptor_sink(out_fd));
<a name="l00242"></a>00242   }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <a class="code" href="_scope_guard_8h.html#c2618e81a125f7729e8167d7996f6a5e">HT_ON_SCOPE_EXIT</a>(&amp;close_file, out_fd);
<a name="l00245"></a>00245   <a class="code" href="class_hypertable_1_1_cell.html" title="Encapsulates decomposed key and value.">Cell</a> cell;
<a name="l00246"></a>00246   uint32_t nsec;
<a name="l00247"></a>00247   time_t unix_time;
<a name="l00248"></a>00248   <span class="keyword">struct </span>tm tms;
<a name="l00249"></a>00249   <a class="code" href="class_hypertable_1_1_load_data_escape.html">LoadDataEscape</a> escaper;
<a name="l00250"></a>00250   <span class="keyword">const</span> <span class="keywordtype">char</span> *unescaped_buf;
<a name="l00251"></a>00251   <span class="keywordtype">size_t</span> unescaped_len;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253   <span class="keywordflow">while</span> (scanner-&gt;next(cell)) {
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#271ac6c9e3e337547ac9dc9b02e6022d">normal_mode</a>) {
<a name="l00255"></a>00255       <span class="comment">// do some stats</span>
<a name="l00256"></a>00256       ++cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#fb6d337ab19c3124e20570b08ff06ddd">total_cells</a>;
<a name="l00257"></a>00257       cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d5e0c8517b803e4b9c0d0edff891933b">total_keys_size</a> += strlen(cell.<a class="code" href="class_hypertable_1_1_cell.html#a2bc9f1e95556bd9b1ebc3dda663b0a0">row_key</a>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259       <span class="keywordflow">if</span> (cell.<a class="code" href="class_hypertable_1_1_cell.html#6b36ceb93f265c0e08924cdc39416f67">column_family</a> &amp;&amp; cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>)
<a name="l00260"></a>00260         cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d5e0c8517b803e4b9c0d0edff891933b">total_keys_size</a> += strlen(cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>) + 1;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262       cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d3a98a038c5f48dd11e2366b12f76c96">total_values_size</a> += cell.<a class="code" href="class_hypertable_1_1_cell.html#07d677cc27bf399589eae814c6fa1489">value_len</a>;
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#ea8109635167face07d1721ef5d9ccb3">display_timestamps</a>) {
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#b52a756f9c1aee25ef287777d5e1d9b3">format_ts_in_usecs</a>) {
<a name="l00266"></a>00266         fout &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#da5f90a5852924922cc8024403ede417">timestamp</a> &lt;&lt; <span class="stringliteral">"\t"</span>;
<a name="l00267"></a>00267       }
<a name="l00268"></a>00268       <span class="keywordflow">else</span> {
<a name="l00269"></a>00269         nsec = cell.<a class="code" href="class_hypertable_1_1_cell.html#da5f90a5852924922cc8024403ede417">timestamp</a> % 1000000000LL;
<a name="l00270"></a>00270         unix_time = cell.<a class="code" href="class_hypertable_1_1_cell.html#da5f90a5852924922cc8024403ede417">timestamp</a> / 1000000000LL;
<a name="l00271"></a>00271         gmtime_r(&amp;unix_time, &amp;tms);
<a name="l00272"></a>00272         fout &lt;&lt; <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"%d-%02d-%02d %02d:%02d:%02d.%09d\t"</span>, tms.tm_year+1900,
<a name="l00273"></a>00273                        tms.tm_mon+1, tms.tm_mday, tms.tm_hour, tms.tm_min, tms.tm_sec, nsec);
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (!state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#ca90bf1f3658507470f2d0768ec25923">scan</a>.<a class="code" href="class_hypertable_1_1_hql_1_1_scan_state.html#489a9f10a157e2196e60a8cd2a42ce58">keys_only</a>) {
<a name="l00277"></a>00277       <span class="keywordflow">if</span> (cell.<a class="code" href="class_hypertable_1_1_cell.html#6b36ceb93f265c0e08924cdc39416f67">column_family</a>) {
<a name="l00278"></a>00278         fout &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#a2bc9f1e95556bd9b1ebc3dda663b0a0">row_key</a> &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#6b36ceb93f265c0e08924cdc39416f67">column_family</a>;
<a name="l00279"></a>00279         <span class="keywordflow">if</span> (cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a> &amp;&amp; *cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>)
<a name="l00280"></a>00280           fout &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>;
<a name="l00281"></a>00281       }
<a name="l00282"></a>00282       <span class="keywordflow">else</span>
<a name="l00283"></a>00283         fout &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#a2bc9f1e95556bd9b1ebc3dda663b0a0">row_key</a>;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5f2e9287a4544303cdd1120ef40ea5b9">escape</a>)
<a name="l00286"></a>00286         escaper.escape((<span class="keyword">const</span> <span class="keywordtype">char</span> *)cell.<a class="code" href="class_hypertable_1_1_cell.html#1f18462b9457dc6f709e9391129ba0a5">value</a>, (<span class="keywordtype">size_t</span>)cell.<a class="code" href="class_hypertable_1_1_cell.html#07d677cc27bf399589eae814c6fa1489">value_len</a>,
<a name="l00287"></a>00287                        &amp;unescaped_buf, &amp;unescaped_len);
<a name="l00288"></a>00288       <span class="keywordflow">else</span> {
<a name="l00289"></a>00289         unescaped_buf = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)cell.<a class="code" href="class_hypertable_1_1_cell.html#1f18462b9457dc6f709e9391129ba0a5">value</a>;
<a name="l00290"></a>00290         unescaped_len = (<span class="keywordtype">size_t</span>)cell.<a class="code" href="class_hypertable_1_1_cell.html#07d677cc27bf399589eae814c6fa1489">value_len</a>;
<a name="l00291"></a>00291       }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293       <span class="keywordflow">if</span> (cell.<a class="code" href="class_hypertable_1_1_cell.html#53eb7078da9d8341895205234ada830f">flag</a> != <a class="code" href="namespace_hypertable.html#587f053202ab94821346946269211a72">FLAG_INSERT</a>) {
<a name="l00294"></a>00294         fout &lt;&lt; <span class="stringliteral">"\t"</span> ;
<a name="l00295"></a>00295         fout.write(unescaped_buf, unescaped_len);
<a name="l00296"></a>00296         fout &lt;&lt; <span class="stringliteral">"\tDELETE\n"</span>;
<a name="l00297"></a>00297       }
<a name="l00298"></a>00298       <span class="keywordflow">else</span> {
<a name="l00299"></a>00299         fout &lt;&lt; <span class="stringliteral">"\t"</span> ;
<a name="l00300"></a>00300         fout.write(unescaped_buf, unescaped_len);
<a name="l00301"></a>00301         fout &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00302"></a>00302       }
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304     <span class="keywordflow">else</span>
<a name="l00305"></a>00305       fout &lt;&lt; cell.<a class="code" href="class_hypertable_1_1_cell.html#a2bc9f1e95556bd9b1ebc3dda663b0a0">row_key</a> &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00306"></a>00306   }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308   fout.strict_sync();
<a name="l00309"></a>00309   <span class="keywordflow">if</span> (out_fd &gt; 0) {
<a name="l00310"></a>00310     close(out_fd);
<a name="l00311"></a>00311     out_fd = -1;
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>(0);
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 <span class="keywordtype">void</span>
<a name="l00318"></a>00318 cmd_load_data(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, uint32_t mutator_flags,
<a name="l00319"></a>00319               <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00320"></a>00320   <a class="code" href="namespace_hypertable.html#c71c18ddb7522183899f6a8cd29a997a">TablePtr</a> table;
<a name="l00321"></a>00321   <a class="code" href="namespace_hypertable.html#a11c0e04e8944428cc219a8357a8d6f4">TableMutatorPtr</a> mutator;
<a name="l00322"></a>00322   <span class="keywordtype">bool</span> into_table = <span class="keyword">true</span>;
<a name="l00323"></a>00323   <span class="keywordtype">bool</span> display_timestamps = <span class="keyword">false</span>;
<a name="l00324"></a>00324   boost::iostreams::filtering_ostream fout;
<a name="l00325"></a>00325   FILE *outf = cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#aae5ace429ac17715d337b5a93e1c229">output</a>;
<a name="l00326"></a>00326   <span class="keywordtype">int</span> out_fd = -1;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>.empty()) {
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#1fda1f7b01eacf2496c59ad996b64dae">output_file</a>.empty())
<a name="l00330"></a>00330       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2310fad45ca881ccdbff9a91b78ddfa4b">Error::HQL_PARSE_ERROR</a>,
<a name="l00331"></a>00331                <span class="stringliteral">"LOAD DATA INFILE ... INTO FILE - bad filename"</span>);
<a name="l00332"></a>00332     fout.push(boost::iostreams::file_descriptor_sink(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#1fda1f7b01eacf2496c59ad996b64dae">output_file</a>));
<a name="l00333"></a>00333     into_table = <span class="keyword">false</span>;
<a name="l00334"></a>00334   }
<a name="l00335"></a>00335   <span class="keywordflow">else</span> {
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (outf) {
<a name="l00337"></a>00337       out_fd = dup(fileno(outf));
<a name="l00338"></a>00338       fout.push(boost::iostreams::file_descriptor_sink(out_fd));
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340     <span class="keywordflow">else</span>
<a name="l00341"></a>00341       fout.push(boost::iostreams::null_sink());
<a name="l00342"></a>00342     table = client-&gt;open_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>);
<a name="l00343"></a>00343     mutator = table-&gt;create_mutator(0, mutator_flags);
<a name="l00344"></a>00344   }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   <a class="code" href="_scope_guard_8h.html#c2618e81a125f7729e8167d7996f6a5e">HT_ON_SCOPE_EXIT</a>(&amp;close_file, out_fd);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#b9dc2d3b241a4b26f907f49a73f936ce">file_size</a> = <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">FileUtils::size</a>(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#4081497647af6de3933c8da0ccec0775">input_file</a>.c_str());
<a name="l00349"></a>00349   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#7fc1eaffdb30c8dc6b3897fdda36d900" title="Called when interpreter is ready to update.">on_update</a>(cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#b9dc2d3b241a4b26f907f49a73f936ce">file_size</a>);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <a class="code" href="namespace_hypertable.html#0eece2317918c470e25e272f2c2e2264">LoadDataSourcePtr</a> lds;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   lds = LoadDataSourceFactory::create(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#4081497647af6de3933c8da0ccec0775">input_file</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#f8c61a50bc56d2350aa5746de668a495">input_file_src</a>,
<a name="l00354"></a>00354                                       state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#70f76377bca0de2b75963db04d761d7d">header_file</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#81064de6e87088579b46bc68a4841fde">header_file_src</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#cc80b460f14b5c75c8d3e18d5d08225b">key_columns</a>,
<a name="l00355"></a>00355                                       state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#b9b16dbdcaec9b856d011477684178f7">timestamp_column</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#b0e8dd261c72dd0f26d4bba1d87a903c">row_uniquify_chars</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#df7d3e89c76b4b0848ec56227520668f">dupkeycols</a>);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357   <span class="keywordflow">if</span> (!into_table) {
<a name="l00358"></a>00358     display_timestamps = lds-&gt;has_timestamps();
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (display_timestamps)
<a name="l00360"></a>00360       fout &lt;&lt; <span class="stringliteral">"timestamp\trow\tcolumn\tvalue\n"</span>;
<a name="l00361"></a>00361     <span class="keywordflow">else</span>
<a name="l00362"></a>00362       fout &lt;&lt; <span class="stringliteral">"row\tcolumn\tvalue\n"</span>;
<a name="l00363"></a>00363   }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <a class="code" href="class_hypertable_1_1_key_spec.html">KeySpec</a> key;
<a name="l00366"></a>00366   uint8_t *value;
<a name="l00367"></a>00367   uint32_t value_len;
<a name="l00368"></a>00368   uint32_t consumed;
<a name="l00369"></a>00369   <a class="code" href="class_hypertable_1_1_load_data_escape.html">LoadDataEscape</a> escaper;
<a name="l00370"></a>00370   <span class="keyword">const</span> <span class="keywordtype">char</span> *escaped_buf;
<a name="l00371"></a>00371   <span class="keywordtype">size_t</span> escaped_len;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="keywordflow">try</span> {
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">while</span> (lds-&gt;next(0, &amp;key, &amp;value, &amp;value_len, &amp;consumed)) {
<a name="l00376"></a>00376       <span class="keywordflow">if</span> (value_len &gt; 0) {
<a name="l00377"></a>00377         ++cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#fb6d337ab19c3124e20570b08ff06ddd">total_cells</a>;
<a name="l00378"></a>00378         cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d3a98a038c5f48dd11e2366b12f76c96">total_values_size</a> += value_len;
<a name="l00379"></a>00379         cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d5e0c8517b803e4b9c0d0edff891933b">total_keys_size</a> += key.<a class="code" href="class_hypertable_1_1_key_spec.html#ff2126e370d03427e6209eca7211feff">row_len</a>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#5f2e9287a4544303cdd1120ef40ea5b9">escape</a>)
<a name="l00382"></a>00382           escaper.<a class="code" href="class_hypertable_1_1_load_data_escape.html#ebe65e154f967e5093a5681d0f4b1589">unescape</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)value, (<span class="keywordtype">size_t</span>)value_len, &amp;escaped_buf,
<a name="l00383"></a>00383                            &amp;escaped_len);
<a name="l00384"></a>00384         <span class="keywordflow">else</span> {
<a name="l00385"></a>00385           escaped_buf = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)value;
<a name="l00386"></a>00386           escaped_len = (size_t)value_len;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (into_table) {
<a name="l00390"></a>00390           <span class="keywordflow">try</span> {
<a name="l00391"></a>00391             mutator-&gt;set(key, escaped_buf, escaped_len);
<a name="l00392"></a>00392           }
<a name="l00393"></a>00393           <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00394"></a>00394             <span class="keywordflow">do</span> {
<a name="l00395"></a>00395               mutator-&gt;show_failed(e);
<a name="l00396"></a>00396             } <span class="keywordflow">while</span> (!mutator-&gt;retry());
<a name="l00397"></a>00397           }
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399         <span class="keywordflow">else</span> {
<a name="l00400"></a>00400           <span class="keywordflow">if</span> (display_timestamps)
<a name="l00401"></a>00401             fout &lt;&lt; key.<a class="code" href="class_hypertable_1_1_key_spec.html#ebf4cf119c1e78acc654b135642d753e">timestamp</a> &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; key.<a class="code" href="class_hypertable_1_1_key_spec.html#40369f5a201a674f92d5b20d1d154396">row</a> &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; key.<a class="code" href="class_hypertable_1_1_key_spec.html#62878b08e5b98e9e78ec6317fd0f9b40">column_family</a> &lt;&lt; <span class="stringliteral">"\t"</span>
<a name="l00402"></a>00402                  &lt;&lt; escaped_buf &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00403"></a>00403           <span class="keywordflow">else</span>
<a name="l00404"></a>00404             fout &lt;&lt; key.<a class="code" href="class_hypertable_1_1_key_spec.html#40369f5a201a674f92d5b20d1d154396">row</a> &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; key.<a class="code" href="class_hypertable_1_1_key_spec.html#62878b08e5b98e9e78ec6317fd0f9b40">column_family</a> &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; escaped_buf &lt;&lt; <span class="stringliteral">"\n"</span>;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406       }
<a name="l00407"></a>00407       <span class="keywordflow">if</span> (cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#271ac6c9e3e337547ac9dc9b02e6022d">normal_mode</a>)
<a name="l00408"></a>00408         cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#91890c4f356a1d82efdaad263fb18005" title="Called when interpreter updates progress for long running queries.">on_progress</a>(consumed);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410   }
<a name="l00411"></a>00411   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00412"></a>00412     <a class="code" href="_error_8h.html#e61e8974d9d73f82af9b9597f21d194f">HT_THROW2F</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b200c2b65e26be6111cbfb0adb4d91ebd3">Error::HQL_BAD_LOAD_FILE_FORMAT</a>, e,
<a name="l00413"></a>00413                <span class="stringliteral">"line number %lld"</span>, (<a class="code" href="namespace_hypertable.html#ce7eaaed51230ae858cf2843bc20cce5">Lld</a>)lds-&gt;get_current_lineno());
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   fout.strict_sync();
<a name="l00417"></a>00417   <span class="keywordflow">if</span> (out_fd != -1) {
<a name="l00418"></a>00418     close(out_fd);
<a name="l00419"></a>00419     out_fd = -1;
<a name="l00420"></a>00420   }
<a name="l00421"></a>00421   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>(mutator.get());
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 <span class="keywordtype">void</span>
<a name="l00425"></a>00425 cmd_insert(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00426"></a>00426   <a class="code" href="namespace_hypertable.html#c71c18ddb7522183899f6a8cd29a997a">TablePtr</a> table;
<a name="l00427"></a>00427   <a class="code" href="namespace_hypertable.html#a11c0e04e8944428cc219a8357a8d6f4">TableMutatorPtr</a> mutator;
<a name="l00428"></a>00428   <span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#0d644258177628f3fc1b24ae5dd094af">Cells</a> &amp;cells = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#57978faaa6512fd69d583cbb509ba013">inserts</a>.<a class="code" href="class_hypertable_1_1_cells_builder.html#53d487f896ab4219147a1ae028fe8a10">get</a>();
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   table = client-&gt;open_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>);
<a name="l00431"></a>00431   mutator = table-&gt;create_mutator();
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="keywordflow">try</span> {
<a name="l00434"></a>00434     mutator-&gt;set_cells(cells);
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00437"></a>00437     <span class="keywordflow">do</span> {
<a name="l00438"></a>00438       mutator-&gt;show_failed(e);
<a name="l00439"></a>00439     } <span class="keywordflow">while</span> (!mutator-&gt;retry());
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441   <span class="keywordflow">if</span> (cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#271ac6c9e3e337547ac9dc9b02e6022d">normal_mode</a>) {
<a name="l00442"></a>00442     cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#fb6d337ab19c3124e20570b08ff06ddd">total_cells</a> = cells.size();
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">foreach</span>(<span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_cell.html" title="Encapsulates decomposed key and value.">Cell</a> &amp;cell, cells) {
<a name="l00445"></a>00445       cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d5e0c8517b803e4b9c0d0edff891933b">total_keys_size</a> += cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>
<a name="l00446"></a>00446           ? (strlen(cell.<a class="code" href="class_hypertable_1_1_cell.html#765f88bfb07c4685da8b1af6e7345297">column_qualifier</a>) + 1) : 0;
<a name="l00447"></a>00447       cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#d3a98a038c5f48dd11e2366b12f76c96">total_values_size</a> += cell.<a class="code" href="class_hypertable_1_1_cell.html#07d677cc27bf399589eae814c6fa1489">value_len</a>;
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449   }
<a name="l00450"></a>00450   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>(mutator.get());
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="keywordtype">void</span>
<a name="l00454"></a>00454 cmd_delete(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00455"></a>00455   <a class="code" href="namespace_hypertable.html#c71c18ddb7522183899f6a8cd29a997a">TablePtr</a> table;
<a name="l00456"></a>00456   <a class="code" href="namespace_hypertable.html#a11c0e04e8944428cc219a8357a8d6f4">TableMutatorPtr</a> mutator;
<a name="l00457"></a>00457   <a class="code" href="class_hypertable_1_1_key_spec.html">KeySpec</a> key;
<a name="l00458"></a>00458   <span class="keywordtype">char</span> *column_qualifier;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   table = client-&gt;open_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>);
<a name="l00461"></a>00461   mutator = table-&gt;create_mutator();
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   key.<a class="code" href="class_hypertable_1_1_key_spec.html#40369f5a201a674f92d5b20d1d154396">row</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#830cc42d441db108964aebec504b2c51">delete_row</a>.c_str();
<a name="l00464"></a>00464   key.<a class="code" href="class_hypertable_1_1_key_spec.html#ff2126e370d03427e6209eca7211feff">row_len</a> = state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#830cc42d441db108964aebec504b2c51">delete_row</a>.length();
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#1b174748679bc70d7c9df1200e09b0dc">delete_time</a> != 0)
<a name="l00467"></a>00467     key.<a class="code" href="class_hypertable_1_1_key_spec.html#ebf4cf119c1e78acc654b135642d753e">timestamp</a> = ++state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#1b174748679bc70d7c9df1200e09b0dc">delete_time</a>;
<a name="l00468"></a>00468   <span class="keywordflow">else</span>
<a name="l00469"></a>00469     key.<a class="code" href="class_hypertable_1_1_key_spec.html#ebf4cf119c1e78acc654b135642d753e">timestamp</a> = <a class="code" href="namespace_hypertable.html#55e02ea2ff23dcecee12bef2acc81b25">AUTO_ASSIGN</a>;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   <span class="keywordflow">if</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9605b026208b13324c2841ba33aac380">delete_all_columns</a>) {
<a name="l00472"></a>00472     <span class="keywordflow">try</span> {
<a name="l00473"></a>00473       mutator-&gt;set_delete(key);
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475     <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00476"></a>00476       mutator-&gt;show_failed(e);
<a name="l00477"></a>00477       <span class="keywordflow">return</span>;
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479   }
<a name="l00480"></a>00480   <span class="keywordflow">else</span> {
<a name="l00481"></a>00481     <span class="keywordflow">foreach</span>(<span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> &amp;col, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9892203ba0a6f9e34a34f063e50dd1c2">delete_columns</a>) {
<a name="l00482"></a>00482       ++cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#fb6d337ab19c3124e20570b08ff06ddd">total_cells</a>;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484       key.<a class="code" href="class_hypertable_1_1_key_spec.html#62878b08e5b98e9e78ec6317fd0f9b40">column_family</a> = col.c_str();
<a name="l00485"></a>00485       <span class="keywordflow">if</span> ((column_qualifier = (<span class="keywordtype">char</span>*)strchr(col.c_str(), <span class="charliteral">':'</span>)) != 0) {
<a name="l00486"></a>00486         *column_qualifier++ = 0;
<a name="l00487"></a>00487         key.<a class="code" href="class_hypertable_1_1_key_spec.html#67418ffbae9c2eb8fa8525bb496e55f2">column_qualifier</a> = column_qualifier;
<a name="l00488"></a>00488         key.<a class="code" href="class_hypertable_1_1_key_spec.html#4fab3b4e8b573592e4fe3a6d1bf08776">column_qualifier_len</a> = strlen(column_qualifier);
<a name="l00489"></a>00489       }
<a name="l00490"></a>00490       <span class="keywordflow">else</span> {
<a name="l00491"></a>00491         key.<a class="code" href="class_hypertable_1_1_key_spec.html#67418ffbae9c2eb8fa8525bb496e55f2">column_qualifier</a> = 0;
<a name="l00492"></a>00492         key.<a class="code" href="class_hypertable_1_1_key_spec.html#4fab3b4e8b573592e4fe3a6d1bf08776">column_qualifier_len</a> = 0;
<a name="l00493"></a>00493       }
<a name="l00494"></a>00494       <span class="keywordflow">try</span> {
<a name="l00495"></a>00495         mutator-&gt;set_delete(key);
<a name="l00496"></a>00496       }
<a name="l00497"></a>00497       <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00498"></a>00498         mutator-&gt;show_failed(e);
<a name="l00499"></a>00499         <span class="keywordflow">return</span>;
<a name="l00500"></a>00500       }
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502   }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>(mutator.get());
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="keywordtype">void</span>
<a name="l00508"></a>00508 cmd_show_tables(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00509"></a>00509                 <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00510"></a>00510   std::vector&lt;String&gt; tables;
<a name="l00511"></a>00511   client-&gt;get_tables(tables);
<a name="l00512"></a>00512   <span class="keywordflow">foreach</span> (<span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> &amp;t, tables) {
<a name="l00513"></a>00513     cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#778e24cb69781147113d7b2728ad0d21" title="Called when interpreter returns a string result Maybe called multiple times for a...">on_return</a>(t);
<a name="l00514"></a>00514   }
<a name="l00515"></a>00515   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00516"></a>00516 }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <span class="keywordtype">void</span>
<a name="l00519"></a>00519 cmd_drop_table(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> &amp;state,
<a name="l00520"></a>00520                <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00521"></a>00521   client-&gt;drop_table(state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#9ba4cdc4686b15080346f08fdd13c10e">table_name</a>, state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#76dea5fe946d9a539a1236b7bdaca678">if_exists</a>);
<a name="l00522"></a>00522   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525 <span class="keywordtype">void</span> cmd_shutdown(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">HqlInterpreter::Callback</a> &amp;cb) {
<a name="l00526"></a>00526   client-&gt;<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html#aca1d768a1eaa6e31699624d1830620f" title="Shuts down the DFS broker.">shutdown</a>();
<a name="l00527"></a>00527   cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#2af801cb4f89ec25368056427906b047" title="Called when interpreter is finished note, mutator pointer maybe NULL in case of things...">on_finish</a>();
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 } <span class="comment">// local namespace</span>
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 
<a name="l00533"></a><a class="code" href="class_hypertable_1_1_hql_interpreter.html#746e0d19db23e31ca893a05fd530f4f9">00533</a> HqlInterpreter::HqlInterpreter(<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">Client</a> *client)
<a name="l00534"></a>00534   : m_client(client), m_mutator_flags(0) {
<a name="l00535"></a>00535   <span class="keywordflow">if</span> (<a class="code" href="namespace_hypertable_1_1_config.html#9e3d35daa165758659d83583f7a53c44" title="stored option variables map singleton">Config::properties</a>-&gt;get_bool(<span class="stringliteral">"Hypertable.HqlInterpreter.Mutator.NoLogSync"</span>))
<a name="l00536"></a>00536     <a class="code" href="class_hypertable_1_1_hql_interpreter.html#3e1d1b0270c39992f3269e255ab09495">m_mutator_flags</a> = <a class="code" href="class_hypertable_1_1_table_mutator.html#1d51f68dc405d1d10c61b043d1ed0f6faee3dade48efa92db5d407d0eed2ac95">TableMutator::FLAG_NO_LOG_SYNC</a>;
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="class_hypertable_1_1_hql_interpreter.html#a45579b987e191e6c7ca26ba94b626bc">00540</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_hql_interpreter.html#a45579b987e191e6c7ca26ba94b626bc" title="The main interface for the interpreter.">HqlInterpreter::execute</a>(<span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> &amp;line, <a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html" title="Callback interface/base class for execute.">Callback</a> &amp;cb) {
<a name="l00541"></a>00541   <a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html">ParserState</a> state;
<a name="l00542"></a>00542   <a class="code" href="struct_hypertable_1_1_hql_1_1_parser.html">Hql::Parser</a> parser(state);
<a name="l00543"></a>00543   parse_info&lt;&gt; info = parse(line.c_str(), parser, space_p);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545   <span class="keywordflow">if</span> (info.full) {
<a name="l00546"></a>00546     cb.<a class="code" href="struct_hypertable_1_1_hql_interpreter_1_1_callback.html#c97473f6d195f396baf52dd883043a3b" title="Called when the hql string is parsed successfully.">on_parsed</a>(state);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">switch</span> (state.<a class="code" href="class_hypertable_1_1_hql_1_1_parser_state.html#b131a670109df44361b033bc6721c67f">command</a>) {
<a name="l00549"></a>00549     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e6942d59a515f429313f050c57ed7ff6b3">COMMAND_SHOW_CREATE_TABLE</a>:
<a name="l00550"></a>00550       cmd_show_create_table(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);               <span class="keywordflow">break</span>;
<a name="l00551"></a>00551     <span class="keywordflow">case</span> <a class="code" href="namespace_hyperspace_1_1_hs_parser.html#de78fa255a27fd6ddb16479c9df23764272067632dda4abca03c1c702002bf49">COMMAND_HELP</a>:
<a name="l00552"></a>00552       cmd_help(state, cb);                                      <span class="keywordflow">break</span>;
<a name="l00553"></a>00553     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e69c6254279aa1209f4b9265d990a4ad6d">COMMAND_CREATE_TABLE</a>:
<a name="l00554"></a>00554       cmd_create_table(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                    <span class="keywordflow">break</span>;
<a name="l00555"></a>00555     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e618e53d5b5cf857c7a343d96d65bae674">COMMAND_DESCRIBE_TABLE</a>:
<a name="l00556"></a>00556       cmd_describe_table(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                  <span class="keywordflow">break</span>;
<a name="l00557"></a>00557     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e6a0f9d2667f8efb1bbfa91f24c848123a">COMMAND_SELECT</a>:
<a name="l00558"></a>00558       cmd_select(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                          <span class="keywordflow">break</span>;
<a name="l00559"></a>00559     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e62e3eecbaa7cbf39f8dee69fe3c2f5600">COMMAND_LOAD_DATA</a>:
<a name="l00560"></a>00560       cmd_load_data(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, <a class="code" href="class_hypertable_1_1_hql_interpreter.html#3e1d1b0270c39992f3269e255ab09495">m_mutator_flags</a>, state, cb);      <span class="keywordflow">break</span>;
<a name="l00561"></a>00561     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e61c729ad22d1b0a913fd7a6087d3bbd33">COMMAND_INSERT</a>:
<a name="l00562"></a>00562       cmd_insert(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                          <span class="keywordflow">break</span>;
<a name="l00563"></a>00563     <span class="keywordflow">case</span> <a class="code" href="namespace_hyperspace_1_1_hs_parser.html#de78fa255a27fd6ddb16479c9df23764a9155c24831e607320f6b84a55ed952d">COMMAND_DELETE</a>:
<a name="l00564"></a>00564       cmd_delete(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                          <span class="keywordflow">break</span>;
<a name="l00565"></a>00565     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e632673b4ae361fa977a3c610c57b176fc">COMMAND_SHOW_TABLES</a>:
<a name="l00566"></a>00566       cmd_show_tables(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                     <span class="keywordflow">break</span>;
<a name="l00567"></a>00567     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e6aa32cba4cf3152f9761b176baa78d4fe">COMMAND_ALTER_TABLE</a>:
<a name="l00568"></a>00568       cmd_alter_table(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                     <span class="keywordflow">break</span>;
<a name="l00569"></a>00569     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e6d4ce2a8be65ec0d1d7ac612b01dd41b6">COMMAND_DROP_TABLE</a>:
<a name="l00570"></a>00570       cmd_drop_table(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, state, cb);                      <span class="keywordflow">break</span>;
<a name="l00571"></a>00571     <span class="keywordflow">case</span> <a class="code" href="namespace_hypertable_1_1_hql.html#fef4f908bd259ce41d6bf9004cbb75e6020fb7b3a9d681f044847974ff8dfa30">COMMAND_SHUTDOWN</a>:
<a name="l00572"></a>00572       cmd_shutdown(<a class="code" href="class_hypertable_1_1_hql_interpreter.html#68aa781fa78f3301c9ce791e2761c212">m_client</a>, cb);                               <span class="keywordflow">break</span>;
<a name="l00573"></a>00573     <span class="keywordflow">default</span>:
<a name="l00574"></a>00574       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2310fad45ca881ccdbff9a91b78ddfa4b">Error::HQL_PARSE_ERROR</a>, <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"unsupported command: "</span>) + line);
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576   }
<a name="l00577"></a>00577   <span class="keywordflow">else</span>
<a name="l00578"></a>00578     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2310fad45ca881ccdbff9a91b78ddfa4b">Error::HQL_PARSE_ERROR</a>, <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"parse error at: "</span>) + info.stop);
<a name="l00579"></a>00579 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Aug 15 08:52:18 2009 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
