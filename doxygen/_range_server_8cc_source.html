<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/RangeServer/RangeServer.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b6724abc6b41a2670a831834f82498af.html">RangeServer</a>
  </div>
</div>
<div class="contents">
<h1>RangeServer.cc</h1><a href="_range_server_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_compat_8h.html">Common/Compat.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="_math_8h.html">math.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="_file_utils_8h.html">Common/FileUtils.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "<a class="code" href="md5_8h.html">Common/md5.h</a>"</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include "<a class="code" href="_string_ext_8h.html">Common/StringExt.h</a>"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="_system_info_8h.html">Common/SystemInfo.h</a>"</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="_commit_log_8h.html">Hypertable/Lib/CommitLog.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="_defaults_8h.html">Hypertable/Lib/Defaults.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="_key_8h.html">Hypertable/Lib/Key.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="_stat_8h.html">Hypertable/Lib/Stat.h</a>"</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="_range_server_meta_log_reader_8h.html">Hypertable/Lib/RangeServerMetaLogReader.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="_range_server_meta_log_entries_8h.html">Hypertable/Lib/RangeServerMetaLogEntries.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="_range_server_protocol_8h.html">Hypertable/Lib/RangeServerProtocol.h</a>"</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="_dfs_broker_2_lib_2_client_8h.html">DfsBroker/Lib/Client.h</a>"</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="_fill_scan_block_8h.html">FillScanBlock.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="_global_8h.html">Global.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="_handler_factory_8h.html">HandlerFactory.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="_maintenance_queue_8h.html">MaintenanceQueue.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="_maintenance_scheduler_8h.html">MaintenanceScheduler.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="_maintenance_task_compaction_8h.html">MaintenanceTaskCompaction.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="_maintenance_task_split_8h.html">MaintenanceTaskSplit.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "<a class="code" href="_range_server_8h.html">RangeServer.h</a>"</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="_range_stats_gatherer_8h.html">RangeStatsGatherer.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="_scan_context_8h.html">ScanContext.h</a>"</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="keyword">using namespace </span>std;
<a name="l00059"></a>00059 <span class="keyword">using namespace </span>Hypertable;
<a name="l00060"></a>00060 <span class="keyword">using namespace </span>Serialization;
<a name="l00061"></a>00061 <span class="keyword">using namespace </span>Hypertable::Property;
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="class_hypertable_1_1_range_server.html#f82372c43b9d7708b80edef3cecab0a9">00063</a> RangeServer::RangeServer(<a class="code" href="namespace_hypertable.html#3c17fee96d466b253b38bf89565838ff">PropertiesPtr</a> &amp;props, <a class="code" href="namespace_hypertable.html#e048a08bc9bd9505788d6e5823c948ae">ConnectionManagerPtr</a> &amp;conn_mgr,
<a name="l00064"></a>00064     <a class="code" href="namespace_hypertable.html#cf99fcce27d4a99f148f0af4969ebb81">ApplicationQueuePtr</a> &amp;app_queue, <a class="code" href="namespace_hyperspace.html#a6fd2655b7a3b3be4389099597a40d72">Hyperspace::SessionPtr</a> &amp;hyperspace)
<a name="l00065"></a>00065   : m_root_replay_finished(false), m_metadata_replay_finished(false),
<a name="l00066"></a>00066     m_replay_finished(false), m_props(props), m_verbose(false),
<a name="l00067"></a>00067     m_conn_manager(conn_mgr), m_app_queue(app_queue), m_hyperspace(hyperspace) {
<a name="l00068"></a>00068 
<a name="l00069"></a>00069   uint16_t port;
<a name="l00070"></a>00070   uint32_t maintenance_threads = std::min(2, <a class="code" href="class_hypertable_1_1_system.html#b3200338b308a18a560065c74bae648a">System::cpu_info</a>().total_cores);
<a name="l00071"></a>00071   <a class="code" href="class_hypertable_1_1_comm.html" title="Provides communication (message passing) services to an application.">Comm</a> *comm = conn_mgr-&gt;get_comm();
<a name="l00072"></a>00072   <a class="code" href="class_hypertable_1_1_sub_properties.html" title="Convenient help class for access parts of properties.">SubProperties</a> cfg(props, <span class="stringliteral">"Hypertable.RangeServer."</span>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <a class="code" href="class_hypertable_1_1_range_server.html#924a2c0a22e84bee9970e58d64de6add">m_verbose</a> = props-&gt;get_bool(<span class="stringliteral">"verbose"</span>);
<a name="l00075"></a>00075   <a class="code" href="class_hypertable_1_1_global.html#bf2978b9598c219683ed963583bbcdb4">Global::range_metadata_split_size</a> = cfg.get_i64(<span class="stringliteral">"Range.MetadataSplitSize"</span>, 0);
<a name="l00076"></a>00076   <a class="code" href="class_hypertable_1_1_global.html#6d86b76614bcd5c40eae6960a934ec8a">Global::range_split_size</a> = cfg.get_i64(<span class="stringliteral">"Range.SplitSize"</span>);
<a name="l00077"></a>00077   <a class="code" href="class_hypertable_1_1_global.html#aec1e134c55a17b0c1ee0e56bddd7022">Global::range_maximum_size</a> = cfg.get_i64(<span class="stringliteral">"Range.MaximumSize"</span>);
<a name="l00078"></a>00078   <a class="code" href="class_hypertable_1_1_global.html#1e574898024e9e712be780156826c2a9">Global::access_group_max_files</a> = cfg.get_i32(<span class="stringliteral">"AccessGroup.MaxFiles"</span>);
<a name="l00079"></a>00079   <a class="code" href="class_hypertable_1_1_global.html#53ca29922966f7c96c25719e10ee7ba8">Global::access_group_merge_files</a> = cfg.get_i32(<span class="stringliteral">"AccessGroup.MergeFiles"</span>);
<a name="l00080"></a>00080   <a class="code" href="class_hypertable_1_1_global.html#3dc654ffc06117efa8c71ebc42f43981">Global::access_group_max_mem</a> = cfg.get_i64(<span class="stringliteral">"AccessGroup.MaxMemory"</span>);
<a name="l00081"></a>00081   maintenance_threads = cfg.get_i32(<span class="stringliteral">"MaintenanceThreads"</span>, maintenance_threads);
<a name="l00082"></a>00082   port = cfg.get_i16(<span class="stringliteral">"Port"</span>);
<a name="l00083"></a>00083   <a class="code" href="class_hypertable_1_1_range_server.html#8c30ca2edf6d92f4bb1098abe709b223">m_scanner_ttl</a> = (time_t)cfg.get_i32(<span class="stringliteral">"Scanner.Ttl"</span>);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#53ca29922966f7c96c25719e10ee7ba8">Global::access_group_merge_files</a> &gt; <a class="code" href="class_hypertable_1_1_global.html#1e574898024e9e712be780156826c2a9">Global::access_group_max_files</a>)
<a name="l00086"></a>00086     <a class="code" href="class_hypertable_1_1_global.html#53ca29922966f7c96c25719e10ee7ba8">Global::access_group_merge_files</a> = <a class="code" href="class_hypertable_1_1_global.html#1e574898024e9e712be780156826c2a9">Global::access_group_max_files</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#8c30ca2edf6d92f4bb1098abe709b223">m_scanner_ttl</a> &lt; (time_t)10000) {
<a name="l00089"></a>00089     <a class="code" href="_logger_8h.html#709eda39b0584732f8c822dfdada36f7">HT_WARNF</a>(<span class="stringliteral">"Value %u for Hypertable.RangeServer.Scanner.ttl is too small, "</span>
<a name="l00090"></a>00090              <span class="stringliteral">"setting to 10000"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="class_hypertable_1_1_range_server.html#8c30ca2edf6d92f4bb1098abe709b223">m_scanner_ttl</a>);
<a name="l00091"></a>00091     m_scanner_ttl = (time_t)10000;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094   <span class="keywordflow">if</span> (cfg.<a class="code" href="class_hypertable_1_1_sub_properties.html#1bd51b3efe0db36f96c1b2867602df49">has</a>(<span class="stringliteral">"MemoryLimit"</span>))
<a name="l00095"></a>00095     <a class="code" href="class_hypertable_1_1_global.html#074a279ab53356e732631086a5b6ba6f">Global::memory_limit</a> = cfg.get_i64(<span class="stringliteral">"MemoryLimit"</span>);
<a name="l00096"></a>00096   <span class="keywordflow">else</span> {
<a name="l00097"></a>00097     <span class="keywordtype">double</span> pct = (double)cfg.get_i32(<span class="stringliteral">"MemoryLimit.Percentage"</span>) / 100.0;
<a name="l00098"></a>00098     <a class="code" href="class_hypertable_1_1_global.html#074a279ab53356e732631086a5b6ba6f">Global::memory_limit</a> = (int64_t)((<span class="keywordtype">double</span>)<a class="code" href="class_hypertable_1_1_system.html#fb4c649c3bf818f566f689e35421c220">System::mem_stat</a>().<a class="code" href="struct_hypertable_1_1_mem_stat.html#7c9b9877a3894968ba0ddf609d990b55">ram</a> * 1000000.0 * pct);
<a name="l00099"></a>00099   }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101   <a class="code" href="class_hypertable_1_1_range_server.html#11a39f53286620fa062a8bc81d5b4c68">m_max_clock_skew</a> = cfg.get_i32(<span class="stringliteral">"ClockSkew.Max"</span>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103   <a class="code" href="class_hypertable_1_1_range_server.html#efe4e1e48013da0d1dc47fd2c281c556">m_update_delay</a> = cfg.get_i32(<span class="stringliteral">"UpdateDelay"</span>, 0);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   uint64_t block_cacheMemory = cfg.get_i64(<span class="stringliteral">"BlockCache.MaxMemory"</span>);
<a name="l00106"></a>00106   <a class="code" href="class_hypertable_1_1_global.html#3e1365778e0b21bbcbb14e5ea15963bc">Global::block_cache</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_file_block_cache.html">FileBlockCache</a>(block_cacheMemory);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108   <a class="code" href="class_hypertable_1_1_global.html#c5a71b47a9c909db915648eda97a1db2">Global::memory_tracker</a>.<a class="code" href="class_hypertable_1_1_memory_tracker.html#bb54433cbb9656383217809fc3d71577">add</a>(block_cacheMemory);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <a class="code" href="class_hypertable_1_1_global.html#35ae8328564e6979135d2a12233800d4">Global::protocol</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range_server_protocol.html" title="Generates RangeServer protocol request messages.">Hypertable::RangeServerProtocol</a>();
<a name="l00111"></a>00111 
<a name="l00112"></a>00112   <a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">DfsBroker::Client</a> *dfsclient = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">DfsBroker::Client</a>(conn_mgr, props);
<a name="l00113"></a>00113   <span class="keywordtype">int</span> timeout = props-&gt;get_i32(<span class="stringliteral">"DfsBroker.Timeout"</span>);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115   <span class="keywordflow">if</span> (!dfsclient-&gt;<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html#f60985ce9eee0cbe1988bc7fbc72d577" title="Waits up to max_wait_secs for a connection to be established with the DFS broker...">wait_for_connection</a>(timeout))
<a name="l00116"></a>00116     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a34972308357f4c31923b957b60b9e06">Error::REQUEST_TIMEOUT</a>, <span class="stringliteral">"connecting to DFS Broker"</span>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a> = dfsclient;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120   <a class="code" href="class_hypertable_1_1_range_server.html#e08581ba1e8f72aea53ff5edcf971a6d">m_log_roll_limit</a> = cfg.get_i64(<span class="stringliteral">"CommitLog.RollLimit"</span>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122   <a class="code" href="class_hypertable_1_1_range_server.html#6022cea6deb2bafcccfe0100c801d937">m_dropped_table_id_cache</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table_id_cache.html">TableIdCache</a>(50);
<a name="l00123"></a>00123 
<a name="l00127"></a>00127   <span class="keywordflow">if</span> (cfg.<a class="code" href="class_hypertable_1_1_sub_properties.html#1bd51b3efe0db36f96c1b2867602df49">has</a>(<span class="stringliteral">"CommitLog.DfsBroker.Host"</span>)) {
<a name="l00128"></a>00128     <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> loghost = cfg.get_str(<span class="stringliteral">"CommitLog.DfsBroker.Host"</span>);
<a name="l00129"></a>00129     uint16_t logport = cfg.get_i16(<span class="stringliteral">"CommitLog.DfsBroker.Port"</span>);
<a name="l00130"></a>00130     <a class="code" href="struct_hypertable_1_1_inet_addr.html" title="Encapsulate an internet address.">InetAddr</a> addr(loghost, logport);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     dfsclient = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html" title="Proxy class for DFS broker.">DfsBroker::Client</a>(conn_mgr, addr, timeout);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (!dfsclient-&gt;<a class="code" href="class_hypertable_1_1_dfs_broker_1_1_client.html#f60985ce9eee0cbe1988bc7fbc72d577" title="Waits up to max_wait_secs for a connection to be established with the DFS broker...">wait_for_connection</a>(30000))
<a name="l00135"></a>00135       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a34972308357f4c31923b957b60b9e06">Error::REQUEST_TIMEOUT</a>, <span class="stringliteral">"connecting to commit log DFS broker"</span>);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a> = dfsclient;
<a name="l00138"></a>00138   }
<a name="l00139"></a>00139   <span class="keywordflow">else</span>
<a name="l00140"></a>00140     <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a> = <a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a>;
<a name="l00141"></a>00141 
<a name="l00145"></a>00145   <a class="code" href="struct_hypertable_1_1_inet_addr.html" title="Encapsulate an internet address.">InetAddr</a> addr(<a class="code" href="class_hypertable_1_1_system.html#8e6d866835fa21258d2f3c68c3dd855e">System::net_info</a>().primary_addr, port);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a> = addr.<a class="code" href="struct_hypertable_1_1_inet_addr.html#2fb8f62a3e54cf558d93b9914f1a6dc4">format</a>(<span class="charliteral">'_'</span>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149   <span class="comment">// Create the maintenance queue</span>
<a name="l00150"></a>00150   <a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_maintenance_queue.html">MaintenanceQueue</a>(maintenance_threads);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="comment">// Create table info maps</span>
<a name="l00153"></a>00153   <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table_info_map.html" title="Provides a mapping from table name to TableInfo object.">TableInfoMap</a>();
<a name="l00154"></a>00154   <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table_info_map.html" title="Provides a mapping from table name to TableInfo object.">TableInfoMap</a>();
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <a class="code" href="class_hypertable_1_1_range_server.html#c3d43a48d68f3703972943b19112734f" title="Figure out and create range server directoryClear any Range server state (including...">initialize</a>(props);
<a name="l00157"></a>00157 
<a name="l00161"></a>00161   <a class="code" href="class_hypertable_1_1_range_server.html#895afb7bfefc7a87c9123fba1673f0d8">m_stats_gatherer</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range_stats_gatherer.html">RangeStatsGatherer</a>(<a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>);
<a name="l00162"></a>00162   <a class="code" href="class_hypertable_1_1_range_server.html#5a4d6782e80bb75021ee2ce5597c77da">m_maintenance_scheduler</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_maintenance_scheduler.html">MaintenanceScheduler</a>(<a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a>, <a class="code" href="class_hypertable_1_1_range_server.html#895afb7bfefc7a87c9123fba1673f0d8">m_stats_gatherer</a>);
<a name="l00163"></a>00163 
<a name="l00167"></a>00167   <a class="code" href="namespace_hypertable.html#943250a09f1d457488330abcb5425a7c">ConnectionHandlerFactoryPtr</a> chfp =
<a name="l00168"></a>00168       <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_handler_factory.html">HandlerFactory</a>(comm, <a class="code" href="class_hypertable_1_1_range_server.html#b76c2aacb68ae4d1fe90d7d4d5307db5">m_app_queue</a>, <span class="keyword">this</span>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <a class="code" href="struct_hypertable_1_1_inet_addr.html" title="Encapsulate an internet address.">InetAddr</a> listen_addr(INADDR_ANY, port);
<a name="l00171"></a>00171   comm-&gt;<a class="code" href="class_hypertable_1_1_comm.html#d8e49fbe70932e0df390f018cfede4c3" title="Tells the communication subsystem to listen for connection requests on the address...">listen</a>(listen_addr, chfp);
<a name="l00172"></a>00172 
<a name="l00176"></a>00176   timeout = props-&gt;get_i32(<span class="stringliteral">"Hypertable.Request.Timeout"</span>);
<a name="l00177"></a>00177   <a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_master_client.html">MasterClient</a>(<a class="code" href="class_hypertable_1_1_range_server.html#54bfa807ec69ce26647fd65272aaff53">m_conn_manager</a>, <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>,
<a name="l00178"></a>00178                                      timeout, <a class="code" href="class_hypertable_1_1_range_server.html#b76c2aacb68ae4d1fe90d7d4d5307db5">m_app_queue</a>);
<a name="l00179"></a>00179   <a class="code" href="class_hypertable_1_1_range_server.html#da282756f7a5b220900aae834a4475f1">m_master_connection_handler</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_dfs_broker_1_1_connection_handler.html">ConnectionHandler</a>(comm, <a class="code" href="class_hypertable_1_1_range_server.html#b76c2aacb68ae4d1fe90d7d4d5307db5">m_app_queue</a>,
<a name="l00180"></a>00180                                     <span class="keyword">this</span>, <a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>);
<a name="l00181"></a>00181   <a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>-&gt;initiate_connection(<a class="code" href="class_hypertable_1_1_range_server.html#da282756f7a5b220900aae834a4475f1">m_master_connection_handler</a>);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   <span class="comment">// Halt maintenance queue processing during recovery</span>
<a name="l00184"></a>00184   <a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a>-&gt;stop();
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <a class="code" href="class_hypertable_1_1_range_server.html#f9c5576ab8087bfee4c202eeed4a97f8">local_recover</a>();
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a>-&gt;start();
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   <a class="code" href="class_hypertable_1_1_global.html#0ab97279ffb8d3800cbb85d36e5e1919">Global::log_prune_threshold_min</a> = cfg.get_i64(<span class="stringliteral">"CommitLog.PruneThreshold.Min"</span>,
<a name="l00191"></a>00191       2 * <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>-&gt;get_max_fragment_size());
<a name="l00192"></a>00192 
<a name="l00193"></a>00193   uint32_t max_memory_percentage =
<a name="l00194"></a>00194     cfg.get_i32(<span class="stringliteral">"CommitLog.PruneThreshold.Max.MemoryPercentage"</span>);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196   <a class="code" href="_logger_8h.html#cf985e8f1a1bebe7d622115e4b3e08a6">HT_ASSERT</a>(max_memory_percentage &gt;= 0 &amp;&amp; max_memory_percentage &lt;= 100);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198   <span class="keywordtype">double</span> max_memory_ratio = (double)max_memory_percentage / 100.0;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200   int64_t threshold_max = (int64_t)((<span class="keywordtype">double</span>)<a class="code" href="class_hypertable_1_1_system.html#fb4c649c3bf818f566f689e35421c220">System::mem_stat</a>().<a class="code" href="struct_hypertable_1_1_mem_stat.html#7c9b9877a3894968ba0ddf609d990b55">ram</a> *
<a name="l00201"></a>00201                                     max_memory_ratio * (double)<a class="code" href="namespace_hypertable_1_1_property.html#d6c3a5b45ba68e0b3d184baa05262700">MiB</a>);
<a name="l00202"></a>00202   <span class="comment">// cap at 4GB</span>
<a name="l00203"></a>00203   <span class="keywordflow">if</span> (threshold_max &gt; (int64_t)(4LL * <a class="code" href="namespace_hypertable_1_1_property.html#8899637cb631e238d965ef9f62a07222">GiB</a>))
<a name="l00204"></a>00204     threshold_max = 4LL * <a class="code" href="namespace_hypertable_1_1_property.html#8899637cb631e238d965ef9f62a07222">GiB</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   <a class="code" href="class_hypertable_1_1_global.html#66d8549a04f99bb897326dbd69a0ff61">Global::log_prune_threshold_max</a> = cfg.get_i64(<span class="stringliteral">"CommitLog.PruneThreshold.Max"</span>, threshold_max);
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00210"></a><a class="code" href="class_hypertable_1_1_range_server.html#22d72ff5f2100b08733e148e5647fe06">00210</a> <a class="code" href="class_hypertable_1_1_range_server.html#22d72ff5f2100b08733e148e5647fe06">RangeServer::~RangeServer</a>() {
<a name="l00211"></a>00211   <span class="keyword">delete</span> <a class="code" href="class_hypertable_1_1_global.html#3e1365778e0b21bbcbb14e5ea15963bc">Global::block_cache</a>;
<a name="l00212"></a>00212   <span class="keyword">delete</span> <a class="code" href="class_hypertable_1_1_global.html#35ae8328564e6979135d2a12233800d4">Global::protocol</a>;
<a name="l00213"></a>00213   <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a> = 0;
<a name="l00214"></a>00214   <span class="keyword">delete</span> <a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a>;
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a> != <a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a>)
<a name="l00216"></a>00216     <span class="keyword">delete</span> <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>;
<a name="l00217"></a>00217   <a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a> = 0;
<a name="l00218"></a>00218   <a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a> = 0;
<a name="l00219"></a>00219   <a class="code" href="class_hypertable_1_1_range_server.html#54bfa807ec69ce26647fd65272aaff53">m_conn_manager</a> = 0;
<a name="l00220"></a>00220   <a class="code" href="class_hypertable_1_1_range_server.html#b76c2aacb68ae4d1fe90d7d4d5307db5">m_app_queue</a> = 0;
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00229"></a><a class="code" href="class_hypertable_1_1_range_server.html#c3d43a48d68f3703972943b19112734f">00229</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#c3d43a48d68f3703972943b19112734f" title="Figure out and create range server directoryClear any Range server state (including...">RangeServer::initialize</a>(<a class="code" href="namespace_hypertable.html#3c17fee96d466b253b38bf89565838ff">PropertiesPtr</a> &amp;props) {
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;exists(<span class="stringliteral">"/hypertable/servers"</span>)) {
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;exists(<span class="stringliteral">"/hypertable"</span>))
<a name="l00233"></a>00233       <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;mkdir(<span class="stringliteral">"/hypertable"</span>);
<a name="l00234"></a>00234     <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;mkdir(<span class="stringliteral">"/hypertable/servers"</span>);
<a name="l00235"></a>00235   }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> top_dir(<span class="stringliteral">"/hypertable/servers/"</span>);
<a name="l00238"></a>00238   top_dir += <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>;
<a name="l00239"></a>00239 
<a name="l00243"></a>00243   uint32_t lock_status;
<a name="l00244"></a>00244   uint32_t oflags = <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9f19c89ca87d7b3de63bd78fe36a493622" title="Open file for reading.">OPEN_FLAG_READ</a> | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9f1d5a78002d883f613cfcb38d6386da1c" title="Open file for writing.">OPEN_FLAG_WRITE</a> | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9ff848fd6c46eb9eac3931523edd9df8af" title="Create file if it does not exist.">OPEN_FLAG_CREATE</a>
<a name="l00245"></a>00245       | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9ff848fd6c46eb9eac3931523edd9df8af" title="Create file if it does not exist.">OPEN_FLAG_CREATE</a> | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9fd9984b4e533df577fc4e39478065ea24" title="Open file for locking.">OPEN_FLAG_LOCK</a>;
<a name="l00246"></a>00246   <a class="code" href="namespace_hyperspace.html#caac2c6eb284451eb2a0a0dea6caead5">HandleCallbackPtr</a> null_callback;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   <a class="code" href="class_hypertable_1_1_range_server.html#da29e873facfdcb56bde53a593e4abc3">m_existence_file_handle</a> = <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;open(top_dir.c_str(), oflags,
<a name="l00249"></a>00249                                                null_callback);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l00252"></a>00252     lock_status = 0;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;try_lock(<a class="code" href="class_hypertable_1_1_range_server.html#da29e873facfdcb56bde53a593e4abc3">m_existence_file_handle</a>, <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac247037493b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>,
<a name="l00255"></a>00255                            &amp;lock_status, &amp;<a class="code" href="class_hypertable_1_1_range_server.html#20954894297a06ec21e164d50321517c">m_existence_file_sequencer</a>);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (lock_status == <a class="code" href="namespace_hyperspace.html#1e44834d6339fc4d4f409dd7b3ceccda56091f24bea9a4fc33d05c4608c4b7b2" title="Lock successfully granted.">LOCK_STATUS_GRANTED</a>)
<a name="l00258"></a>00258       <span class="keywordflow">break</span>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Waiting for exclusive lock on hyperspace:/"</span> &lt;&lt; top_dir
<a name="l00261"></a>00261                 &lt;&lt; <span class="stringliteral">" ..."</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00262"></a>00262     poll(0, 0, 5000);
<a name="l00263"></a>00263   }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265   <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> = top_dir + <span class="stringliteral">"/log"</span>;
<a name="l00266"></a>00266 
<a name="l00270"></a>00270   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> path;
<a name="l00271"></a>00271   <span class="keywordflow">try</span> {
<a name="l00272"></a>00272     path = <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/user"</span>;
<a name="l00273"></a>00273     <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(path);
<a name="l00274"></a>00274     path = <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/range_txn"</span>;
<a name="l00275"></a>00275     <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(path);
<a name="l00276"></a>00276   }
<a name="l00277"></a>00277   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00278"></a>00278     <a class="code" href="_error_8h.html#e61e8974d9d73f82af9b9597f21d194f">HT_THROW2F</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e, <span class="stringliteral">"Problem creating commit log directory '%s': %s"</span>,
<a name="l00279"></a>00279                path.c_str(), e.what());
<a name="l00280"></a>00280   }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"log_dir="</span> &lt;&lt; <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="class_hypertable_1_1_range_server.html#f9c5576ab8087bfee4c202eeed4a97f8">00286</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#f9c5576ab8087bfee4c202eeed4a97f8">RangeServer::local_recover</a>() {
<a name="l00287"></a>00287   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> meta_log_fname = <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/range_txn/0.log"</span>;
<a name="l00288"></a>00288   <a class="code" href="namespace_hypertable.html#931a127d778ff4ad42346aa47ec8bdfe">RangeServerMetaLogReaderPtr</a> rsml_reader;
<a name="l00289"></a>00289   <a class="code" href="namespace_hypertable.html#a403476082b15bf1a679d6e624394056">CommitLogReaderPtr</a> root_log_reader;
<a name="l00290"></a>00290   <a class="code" href="namespace_hypertable.html#a403476082b15bf1a679d6e624394056">CommitLogReaderPtr</a> metadata_log_reader;
<a name="l00291"></a>00291   <a class="code" href="namespace_hypertable.html#a403476082b15bf1a679d6e624394056">CommitLogReaderPtr</a> user_log_reader;
<a name="l00292"></a>00292   std::vector&lt;RangePtr&gt; rangev;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   <span class="keywordflow">try</span> {
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;exists(meta_log_fname)) {
<a name="l00300"></a>00300       <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"Found "</span>&lt;&lt; meta_log_fname &lt;&lt;<span class="stringliteral">", start recovering"</span>&lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302       <span class="comment">// Load range states</span>
<a name="l00303"></a>00303       rsml_reader = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range_server_meta_log_reader.html">RangeServerMetaLogReader</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00304"></a>00304                                                  meta_log_fname);
<a name="l00305"></a>00305       <span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#c457d328aed1420df0e4042a629149d4">RangeStates</a> &amp;range_states = rsml_reader-&gt;load_range_states();
<a name="l00306"></a>00306 
<a name="l00310"></a>00310       <a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> = <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a123531ca682d698872694db71670db7700f05">RangeServerProtocol::GROUP_METADATA_ROOT</a>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312       <span class="comment">// clear the replay map</span>
<a name="l00313"></a>00313       <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;clear();
<a name="l00314"></a>00314 
<a name="l00315"></a>00315       <span class="keywordflow">foreach</span>(<span class="keyword">const</span> <a class="code" href="struct_hypertable_1_1_range_state_info.html">RangeStateInfo</a> *i, range_states) {
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0 &amp;&amp; i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>.<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>
<a name="l00317"></a>00317             &amp;&amp; !strcmp(i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>.<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>, <a class="code" href="class_hypertable_1_1_key.html#1d3faf7ddb325905e9546c8c08c3d9f6">Key::END_ROOT_ROW</a>)) {
<a name="l00318"></a>00318           <a class="code" href="_logger_8h.html#cf985e8f1a1bebe7d622115e4b3e08a6">HT_ASSERT</a>(i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3734e918263b25d2845f6b4f12cb6c56">transactions</a>.empty());
<a name="l00319"></a>00319           <a class="code" href="class_hypertable_1_1_range_server.html#f4b90628d255314341ec3c3b02048fe9">replay_load_range</a>(0, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#2757f69bb8bff7ebfe0a8d0117c7e9c4">range_state</a>);
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321       }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;empty()) {
<a name="l00324"></a>00324         root_log_reader = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log_reader.html">CommitLogReader</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00325"></a>00325                                               <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/root"</span>);
<a name="l00326"></a>00326         <a class="code" href="class_hypertable_1_1_range_server.html#1971e99d6733c03d7ccf2d85724e2bbf">replay_log</a>(root_log_reader);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="comment">// Perform any range specific post-replay tasks</span>
<a name="l00329"></a>00329         rangev.clear();
<a name="l00330"></a>00330         <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get_range_vector(rangev);
<a name="l00331"></a>00331         <span class="keywordflow">foreach</span>(<a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> &amp;range, rangev)
<a name="l00332"></a>00332           range-&gt;recovery_finalize();
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;merge(<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>);
<a name="l00335"></a>00335       }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337       <span class="comment">// Create root log and wake up anybody waiting for root replay to complete</span>
<a name="l00338"></a>00338       {
<a name="l00339"></a>00339         <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (root_log_reader)
<a name="l00341"></a>00341           <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00342"></a>00342               + <span class="stringliteral">"/root"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, root_log_reader.get());
<a name="l00343"></a>00343         <a class="code" href="class_hypertable_1_1_range_server.html#3aa1d704353b7c6211378173ed73a9fd">m_root_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00344"></a>00344         <a class="code" href="class_hypertable_1_1_range_server.html#0ab83ccf84357d37aaa9cb6118539891">m_root_replay_finished_cond</a>.notify_all();
<a name="l00345"></a>00345       }
<a name="l00346"></a>00346 
<a name="l00350"></a>00350       <a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> = <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a12353ca8f49c958441f904fb75becb8a28bcc">RangeServerProtocol::GROUP_METADATA</a>;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="comment">// clear the replay map</span>
<a name="l00353"></a>00353       <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;clear();
<a name="l00354"></a>00354 
<a name="l00355"></a>00355       <span class="keywordflow">foreach</span>(<span class="keyword">const</span> <a class="code" href="struct_hypertable_1_1_range_state_info.html">RangeStateInfo</a> *i, range_states) {
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0 &amp;&amp; !(i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>.<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>
<a name="l00357"></a>00357             &amp;&amp; !strcmp(i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>.<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>, <a class="code" href="class_hypertable_1_1_key.html#1d3faf7ddb325905e9546c8c08c3d9f6">Key::END_ROOT_ROW</a>)))
<a name="l00358"></a>00358           <a class="code" href="class_hypertable_1_1_range_server.html#f4b90628d255314341ec3c3b02048fe9">replay_load_range</a>(0, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#2757f69bb8bff7ebfe0a8d0117c7e9c4">range_state</a>);
<a name="l00359"></a>00359       }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;empty()) {
<a name="l00362"></a>00362         metadata_log_reader =
<a name="l00363"></a>00363             <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log_reader.html">CommitLogReader</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/metadata"</span>);
<a name="l00364"></a>00364         <a class="code" href="class_hypertable_1_1_range_server.html#1971e99d6733c03d7ccf2d85724e2bbf">replay_log</a>(metadata_log_reader);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <span class="comment">// Perform any range specific post-replay tasks</span>
<a name="l00367"></a>00367         rangev.clear();
<a name="l00368"></a>00368         <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get_range_vector(rangev);
<a name="l00369"></a>00369         <span class="keywordflow">foreach</span>(<a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> &amp;range, rangev)
<a name="l00370"></a>00370           range-&gt;recovery_finalize();
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;merge(<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>);
<a name="l00373"></a>00373       }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375       <span class="comment">// Create metadata log and wake up anybody waiting for metadata replay to</span>
<a name="l00376"></a>00376       <span class="comment">// complete</span>
<a name="l00377"></a>00377       {
<a name="l00378"></a>00378         <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (metadata_log_reader)
<a name="l00380"></a>00380           <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00381"></a>00381               <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/metadata"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>,
<a name="l00382"></a>00382               metadata_log_reader.get());
<a name="l00383"></a>00383         <a class="code" href="class_hypertable_1_1_range_server.html#20b33dca55f8509aa217388131f939db">m_metadata_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00384"></a>00384         <a class="code" href="class_hypertable_1_1_range_server.html#407cd9ca955934be1c623b692de1b837">m_metadata_replay_finished_cond</a>.notify_all();
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386 
<a name="l00390"></a>00390       <a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> = <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a12353c4bde2c3e75ef39526acd717324f091f">RangeServerProtocol::GROUP_USER</a>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392       <span class="comment">// clear the replay map</span>
<a name="l00393"></a>00393       <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;clear();
<a name="l00394"></a>00394 
<a name="l00395"></a>00395       <span class="keywordflow">foreach</span>(<span class="keyword">const</span> <a class="code" href="struct_hypertable_1_1_range_state_info.html">RangeStateInfo</a> *i, range_states) {
<a name="l00396"></a>00396         <span class="keywordflow">if</span> (i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> != 0)
<a name="l00397"></a>00397           <a class="code" href="class_hypertable_1_1_range_server.html#f4b90628d255314341ec3c3b02048fe9">replay_load_range</a>(0, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#44eec1a98da3825167ae1144e967fd39">table</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#3bd65a349658ebce3281550991a65e88">range</a>, &amp;i-&gt;<a class="code" href="struct_hypertable_1_1_range_state_info.html#2757f69bb8bff7ebfe0a8d0117c7e9c4">range_state</a>);
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;empty()) {
<a name="l00401"></a>00401         user_log_reader = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log_reader.html">CommitLogReader</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00402"></a>00402                                               <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/user"</span>);
<a name="l00403"></a>00403         <a class="code" href="class_hypertable_1_1_range_server.html#1971e99d6733c03d7ccf2d85724e2bbf">replay_log</a>(user_log_reader);
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="comment">// Perform any range specific post-replay tasks</span>
<a name="l00406"></a>00406         rangev.clear();
<a name="l00407"></a>00407         <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get_range_vector(rangev);
<a name="l00408"></a>00408         <span class="keywordflow">foreach</span>(<a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> &amp;range, rangev)
<a name="l00409"></a>00409           range-&gt;recovery_finalize();
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;merge(<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>);
<a name="l00412"></a>00412       }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 
<a name="l00415"></a>00415       <span class="comment">// Create user log and range txn log and</span>
<a name="l00416"></a>00416       <span class="comment">// wake up anybody waiting for replay to complete</span>
<a name="l00417"></a>00417       {
<a name="l00418"></a>00418         <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00419"></a>00419         <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00420"></a>00420             + <span class="stringliteral">"/user"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, user_log_reader.get());
<a name="l00421"></a>00421         <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range_server_meta_log.html">RangeServerMetaLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00422"></a>00422                                                    meta_log_fname);
<a name="l00423"></a>00423         <a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00424"></a>00424         <a class="code" href="class_hypertable_1_1_range_server.html#0c1595ad6ee450d2127e2c86bbf07611">m_replay_finished_cond</a>.notify_all();
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="keywordflow">else</span> {
<a name="l00429"></a>00429       <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00430"></a>00430 
<a name="l00435"></a>00435       <span class="keywordflow">if</span> (root_log_reader)
<a name="l00436"></a>00436         <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00437"></a>00437             + <span class="stringliteral">"/root"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, root_log_reader.get());
<a name="l00438"></a>00438 
<a name="l00439"></a>00439       <span class="keywordflow">if</span> (metadata_log_reader)
<a name="l00440"></a>00440         <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00441"></a>00441             + <span class="stringliteral">"/metadata"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, metadata_log_reader.get());
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00444"></a>00444           + <span class="stringliteral">"/user"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, user_log_reader.get());
<a name="l00445"></a>00445 
<a name="l00446"></a>00446       <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range_server_meta_log.html">RangeServerMetaLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00447"></a>00447                                                  meta_log_fname);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449       <a class="code" href="class_hypertable_1_1_range_server.html#3aa1d704353b7c6211378173ed73a9fd">m_root_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00450"></a>00450       <a class="code" href="class_hypertable_1_1_range_server.html#20b33dca55f8509aa217388131f939db">m_metadata_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00451"></a>00451       <a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a> = <span class="keyword">true</span>;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453       <a class="code" href="class_hypertable_1_1_range_server.html#0ab83ccf84357d37aaa9cb6118539891">m_root_replay_finished_cond</a>.notify_all();
<a name="l00454"></a>00454       <a class="code" href="class_hypertable_1_1_range_server.html#407cd9ca955934be1c623b692de1b837">m_metadata_replay_finished_cond</a>.notify_all();
<a name="l00455"></a>00455       <a class="code" href="class_hypertable_1_1_range_server.html#0c1595ad6ee450d2127e2c86bbf07611">m_replay_finished_cond</a>.notify_all();
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00460"></a>00460     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00461"></a>00461     <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="class_hypertable_1_1_range_server.html#1971e99d6733c03d7ccf2d85724e2bbf">00466</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#1971e99d6733c03d7ccf2d85724e2bbf">RangeServer::replay_log</a>(<a class="code" href="namespace_hypertable.html#a403476082b15bf1a679d6e624394056">CommitLogReaderPtr</a> &amp;log_reader) {
<a name="l00467"></a>00467   <a class="code" href="class_hypertable_1_1_block_compression_header_commit_log.html" title="Base class for compressed block header for Cell Store blocks.">BlockCompressionHeaderCommitLog</a> header;
<a name="l00468"></a>00468   uint8_t *base;
<a name="l00469"></a>00469   <span class="keywordtype">size_t</span> len;
<a name="l00470"></a>00470   <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> table_id;
<a name="l00471"></a>00471   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> dbuf;
<a name="l00472"></a>00472   <span class="keyword">const</span> uint8_t *<a class="code" href="lzoconf_8h.html#edc63c09328e8dcce47e667c1cb0e36b">ptr</a>, *end;
<a name="l00473"></a>00473   int64_t revision;
<a name="l00474"></a>00474   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00475"></a>00475   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l00476"></a>00476   <a class="code" href="class_hypertable_1_1_serialized_key.html">SerializedKey</a> key;
<a name="l00477"></a>00477   <a class="code" href="class_hypertable_1_1_byte_string.html">ByteString</a> value;
<a name="l00478"></a>00478   uint32_t block_count = 0;
<a name="l00479"></a>00479   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> start_row, end_row;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="keywordflow">while</span> (log_reader-&gt;next((<span class="keyword">const</span> uint8_t **)&amp;base, &amp;len, &amp;header)) {
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     revision = header.<a class="code" href="class_hypertable_1_1_block_compression_header_commit_log.html#68ce703c74a4cbd3f3d0dcc7cfe67412">get_revision</a>();
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     ptr = base;
<a name="l00486"></a>00486     end = base + len;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     table_id.<a class="code" href="class_hypertable_1_1_table_identifier.html#e6ca97281bf7405729785a930e37a1ec">decode</a>(&amp;ptr, &amp;len);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="comment">// Fetch table info</span>
<a name="l00491"></a>00491     <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get(table_id.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info))
<a name="l00492"></a>00492       <span class="keywordflow">continue</span>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#964e910bedd2a7bf294277cf0d1ecf5c" title="Ensure space for additional data Will grow the space to 1.5 of the needed space with...">ensure</a>(table_id.<a class="code" href="class_hypertable_1_1_table_identifier.html#067d39338ef81a14bfff6957a6ece4f1">encoded_length</a>() + 12 + len);
<a name="l00495"></a>00495     dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#7644f842636d70afd7997b0950fdd2b2">clear</a>();
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> += 4;  <span class="comment">// skip size</span>
<a name="l00498"></a>00498     <a class="code" href="namespace_hypertable_1_1_serialization.html#855985be3bf7999195644c10e29a69ae" title="Encode a 64-bit integer in little-endian order.">encode_i64</a>(&amp;dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, revision);
<a name="l00499"></a>00499     table_id.<a class="code" href="class_hypertable_1_1_table_identifier.html#64566d666c41364b54934bbae2c681dd">encode</a>(&amp;dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>);
<a name="l00500"></a>00500     base = dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="keywordflow">while</span> (ptr &lt; end) {
<a name="l00503"></a>00503 
<a name="l00504"></a>00504       <span class="comment">// extract the key</span>
<a name="l00505"></a>00505       key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l00506"></a>00506       ptr += key.<a class="code" href="class_hypertable_1_1_byte_string.html#9220bf75429b9574f5f346fa47049055">length</a>();
<a name="l00507"></a>00507       <span class="keywordflow">if</span> (ptr &gt; end)
<a name="l00508"></a>00508         <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2c132f23d622a1e494c012aac83fbf7b6">Error::REQUEST_TRUNCATED</a>, <span class="stringliteral">"Problem decoding key"</span>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510       <span class="comment">// extract the value</span>
<a name="l00511"></a>00511       value.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l00512"></a>00512       ptr += value.<a class="code" href="class_hypertable_1_1_byte_string.html#9220bf75429b9574f5f346fa47049055">length</a>();
<a name="l00513"></a>00513       <span class="keywordflow">if</span> (ptr &gt; end)
<a name="l00514"></a>00514         <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2c132f23d622a1e494c012aac83fbf7b6">Error::REQUEST_TRUNCATED</a>, <span class="stringliteral">"Problem decoding value"</span>);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516       <span class="comment">// Look for containing range, add to stop mods if not found</span>
<a name="l00517"></a>00517       <span class="keywordflow">if</span> (!table_info-&gt;find_containing_range(key.<a class="code" href="class_hypertable_1_1_serialized_key.html#78f46a8a96c124a6105dd38904bc1984">row</a>(), range,
<a name="l00518"></a>00518                                              start_row, end_row))
<a name="l00519"></a>00519         <span class="keywordflow">continue</span>;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521       <span class="comment">// add key/value pair to buffer</span>
<a name="l00522"></a>00522       memcpy(dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>, ptr-key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>);
<a name="l00523"></a>00523       dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> += ptr-key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     uint32_t block_size = dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> - base;
<a name="l00528"></a>00528     base = dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a>;
<a name="l00529"></a>00529     <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;base, block_size);
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     <a class="code" href="class_hypertable_1_1_range_server.html#2e20a8d33760c108882ef475c1733388">replay_update</a>(0, dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a>, dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>());
<a name="l00532"></a>00532     block_count++;
<a name="l00533"></a>00533   }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535   <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Replayed %u blocks of updates from '%s'"</span>, block_count,
<a name="l00536"></a>00536            log_reader-&gt;get_log_dir().c_str());
<a name="l00537"></a>00537 }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keywordtype">void</span>
<a name="l00541"></a><a class="code" href="class_hypertable_1_1_range_server.html#6c53bc4a09f0b0a9c4284becb5af1c8c">00541</a> <a class="code" href="class_hypertable_1_1_range_server.html#6c53bc4a09f0b0a9c4284becb5af1c8c">RangeServer::compact</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table,
<a name="l00542"></a>00542                      <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec, uint8_t compaction_type) {
<a name="l00543"></a>00543   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l00544"></a>00544   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l00545"></a>00545   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00546"></a>00546   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l00547"></a>00547   <span class="keywordtype">bool</span> major = <span class="keyword">false</span>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   <span class="comment">// Check for major compaction</span>
<a name="l00550"></a>00550   <span class="keywordflow">if</span> (compaction_type == 1)
<a name="l00551"></a>00551     major = <span class="keyword">true</span>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt;<span class="stringliteral">"compacting\n"</span>&lt;&lt; *table &lt;&lt; *range_spec
<a name="l00554"></a>00554               &lt;&lt;<span class="stringliteral">"Compaction type="</span>&lt;&lt; (major ? <span class="stringliteral">"major"</span> : <span class="stringliteral">"minor"</span>) &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l00557"></a>00557     <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>();
<a name="l00558"></a>00558 
<a name="l00559"></a>00559   <span class="keywordflow">try</span> {
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table, table_info);
<a name="l00562"></a>00562 
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (!table_info-&gt;get_range(range_spec, range))
<a name="l00567"></a>00567       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>,
<a name="l00568"></a>00568                <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"%s[%s..%s]"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>,range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>,
<a name="l00569"></a>00569                       range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="comment">/*** FIX ME</span>
<a name="l00572"></a>00572 <span class="comment">    Global::maintenance_queue-&gt;add(new MaintenanceTaskCompaction(range, major));</span>
<a name="l00573"></a>00573 <span class="comment">    **/</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00576"></a>00576       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <a class="code" href="_logger_8h.html#42da343b7cd5f8d14c17e594611cdefd">HT_DEBUGF</a>(<span class="stringliteral">"Compaction (%s) scheduled for table '%s' end row '%s'"</span>,
<a name="l00579"></a>00579               (major ? <span class="stringliteral">"major"</span> : <span class="stringliteral">"minor"</span>), table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l00583"></a>00583     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00585"></a>00585       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587   }
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="keywordtype">void</span>
<a name="l00592"></a><a class="code" href="class_hypertable_1_1_range_server.html#de78caed1995e193be4a54a864883598">00592</a> <a class="code" href="class_hypertable_1_1_range_server.html#de78caed1995e193be4a54a864883598">RangeServer::create_scanner</a>(<a class="code" href="class_hypertable_1_1_response_callback_create_scanner.html">ResponseCallbackCreateScanner</a> *cb,
<a name="l00593"></a>00593     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec,
<a name="l00594"></a>00594     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_scan_spec.html" title="Represents a scan predicate.">ScanSpec</a> *scan_spec) {
<a name="l00595"></a>00595   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l00596"></a>00596   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l00597"></a>00597   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00598"></a>00598   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l00599"></a>00599   <a class="code" href="namespace_hypertable.html#027a752d2aa1fbf732e6fd4a331ffc56">CellListScannerPtr</a> scanner;
<a name="l00600"></a>00600   <span class="keywordtype">bool</span> more = <span class="keyword">true</span>;
<a name="l00601"></a>00601   uint32_t id;
<a name="l00602"></a>00602   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l00603"></a>00603   <a class="code" href="namespace_hypertable.html#3125aa98d9d4a9a4557de4703da95b9a">ScanContextPtr</a> scan_ctx;
<a name="l00604"></a>00604   <span class="keywordtype">bool</span> decrement_needed=<span class="keyword">false</span>;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"Creating scanner:\n"</span>&lt;&lt; *table &lt;&lt; *range_spec
<a name="l00607"></a>00607                &lt;&lt; *scan_spec &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l00610"></a>00610     <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>(table, range_spec);
<a name="l00611"></a>00611 
<a name="l00612"></a>00612   <span class="keywordflow">try</span> {
<a name="l00613"></a>00613     <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> rbuf;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (scan_spec-&gt;<a class="code" href="class_hypertable_1_1_scan_spec.html#cbbace1748a5cc940534978c7bf18eb3">row_intervals</a>.size() &gt; 0) {
<a name="l00616"></a>00616       <span class="keywordflow">if</span> (scan_spec-&gt;<a class="code" href="class_hypertable_1_1_scan_spec.html#cbbace1748a5cc940534978c7bf18eb3">row_intervals</a>.size() &gt; 1)
<a name="l00617"></a>00617         <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a79e34c7f45ec9e9de73d907cc68954f">Error::RANGESERVER_BAD_SCAN_SPEC</a>,
<a name="l00618"></a>00618                  <span class="stringliteral">"can only scan one row interval"</span>);
<a name="l00619"></a>00619       <span class="keywordflow">if</span> (scan_spec-&gt;<a class="code" href="class_hypertable_1_1_scan_spec.html#e605cfc3c6f99107ce9de1e0258dfcfb">cell_intervals</a>.size() &gt; 0)
<a name="l00620"></a>00620         <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a79e34c7f45ec9e9de73d907cc68954f">Error::RANGESERVER_BAD_SCAN_SPEC</a>,
<a name="l00621"></a>00621                  <span class="stringliteral">"both row and cell intervals defined"</span>);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (scan_spec-&gt;<a class="code" href="class_hypertable_1_1_scan_spec.html#e605cfc3c6f99107ce9de1e0258dfcfb">cell_intervals</a>.size() &gt; 1)
<a name="l00625"></a>00625       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a79e34c7f45ec9e9de73d907cc68954f">Error::RANGESERVER_BAD_SCAN_SPEC</a>,
<a name="l00626"></a>00626                <span class="stringliteral">"can only scan one cell interval"</span>);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table, table_info);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (!table_info-&gt;get_range(range_spec, range))
<a name="l00631"></a>00631       <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>, <span class="stringliteral">"(a) %s[%s..%s]"</span>,
<a name="l00632"></a>00632                 table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     schema = table_info-&gt;get_schema();
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="comment">// verify schema</span>
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (schema-&gt;get_generation() != table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>) {
<a name="l00638"></a>00638       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2ba7f6b260c71a394562e9db9b6fd2cee">Error::RANGESERVER_GENERATION_MISMATCH</a>,
<a name="l00639"></a>00639                (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"RangeServer Schema generation for table '"</span>
<a name="l00640"></a>00640                + table_info-&gt;get_name() + <span class="stringliteral">"' is "</span> +
<a name="l00641"></a>00641                schema-&gt;get_generation() + <span class="stringliteral">" but supplied is "</span>
<a name="l00642"></a>00642                + table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>);
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     range-&gt;increment_scan_counter();
<a name="l00646"></a>00646     decrement_needed = <span class="keyword">true</span>;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     <span class="comment">// Check to see if range jus shrunk</span>
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (strcmp(range-&gt;start_row().c_str(), range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>) ||
<a name="l00650"></a>00650         strcmp(range-&gt;end_row().c_str(), range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>))
<a name="l00651"></a>00651       <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>, <span class="stringliteral">"(b) %s[%s..%s]"</span>,
<a name="l00652"></a>00652                 table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     scan_ctx = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_scan_context.html" title="Scan context information.">ScanContext</a>(range-&gt;get_scan_revision(),
<a name="l00655"></a>00655                                scan_spec, range_spec, schema);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     scanner = range-&gt;create_scanner(scan_ctx);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     range-&gt;decrement_scan_counter();
<a name="l00660"></a>00660     decrement_needed = <span class="keyword">false</span>;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="keywordtype">size_t</span> count;
<a name="l00663"></a>00663     more = <a class="code" href="namespace_hypertable.html#d8a0ae3a35f6c44996fe0770345bb296">FillScanBlock</a>(scanner, rbuf, &amp;count);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordtype">id</span> = (more) ? <a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.put(scanner, range, table) : 0;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     <a class="code" href="_logger_8h.html#42da343b7cd5f8d14c17e594611cdefd">HT_DEBUGF</a>(<span class="stringliteral">"Successfully created scanner (id=%u) on table '%s', returning "</span>
<a name="l00668"></a>00668               <span class="stringliteral">"%d k/v pairs"</span>, <span class="keywordtype">id</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, (<span class="keywordtype">int</span>)count);
<a name="l00669"></a>00669 
<a name="l00673"></a>00673     {
<a name="l00674"></a>00674       <span class="keywordtype">short</span> moreflag = more ? 0 : 1;
<a name="l00675"></a>00675       <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> ext(rbuf);
<a name="l00676"></a>00676       <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback_create_scanner.html#c2e45e2455723cc33c676a5fe816b72b">response</a>(moreflag, <span class="keywordtype">id</span>, ext)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00677"></a>00677         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00678"></a>00678       }
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680   }
<a name="l00681"></a>00681   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l00682"></a>00682     <span class="keywordtype">int</span> error;
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (decrement_needed)
<a name="l00684"></a>00684       range-&gt;decrement_scan_counter();
<a name="l00685"></a>00685     <span class="keywordflow">if</span> (e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>() == <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>)
<a name="l00686"></a>00686       <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l00687"></a>00687     <span class="keywordflow">else</span>
<a name="l00688"></a>00688       <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l00689"></a>00689     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00690"></a>00690       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00691"></a>00691   }
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="class_hypertable_1_1_range_server.html#ae08c923d147d88f4832550b43e572a0">00695</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#ae08c923d147d88f4832550b43e572a0">RangeServer::destroy_scanner</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint32_t scanner_id) {
<a name="l00696"></a>00696   <a class="code" href="_logger_8h.html#42da343b7cd5f8d14c17e594611cdefd">HT_DEBUGF</a>(<span class="stringliteral">"destroying scanner id=%u"</span>, scanner_id);
<a name="l00697"></a>00697   <a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.<a class="code" href="class_hypertable_1_1_scanner_map.html#a5d355d7737720f3e1a70f9721cd4864" title="This method removes the entry in the scanner map corresponding to the given id.">remove</a>(scanner_id);
<a name="l00698"></a>00698   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="keywordtype">void</span>
<a name="l00703"></a><a class="code" href="class_hypertable_1_1_range_server.html#fe27da92bc5cedbbdbf83ba10c8f7463">00703</a> <a class="code" href="class_hypertable_1_1_range_server.html#fe27da92bc5cedbbdbf83ba10c8f7463">RangeServer::fetch_scanblock</a>(<a class="code" href="class_hypertable_1_1_response_callback_fetch_scanblock.html">ResponseCallbackFetchScanblock</a> *cb,
<a name="l00704"></a>00704                              uint32_t scanner_id) {
<a name="l00705"></a>00705   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l00706"></a>00706   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l00707"></a>00707   <a class="code" href="namespace_hypertable.html#027a752d2aa1fbf732e6fd4a331ffc56">CellListScannerPtr</a> scanner;
<a name="l00708"></a>00708   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l00709"></a>00709   <span class="keywordtype">bool</span> more = <span class="keyword">true</span>;
<a name="l00710"></a>00710   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> rbuf;
<a name="l00711"></a>00711   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00712"></a>00712   <a class="code" href="class_hypertable_1_1_table_identifier_managed.html" title="Wrapper for TableIdentifier.">TableIdentifierManaged</a> scanner_table;
<a name="l00713"></a>00713   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"Scanner ID = "</span> &lt;&lt; scanner_id &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <span class="keywordflow">try</span> {
<a name="l00718"></a>00718 
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.<span class="keyword">get</span>(scanner_id, scanner, range, scanner_table))
<a name="l00720"></a>00720       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b24993ce1514cffdb9b1970a50e2c461ac">Error::RANGESERVER_INVALID_SCANNER_ID</a>,
<a name="l00721"></a>00721                <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"scanner ID %d"</span>, scanner_id));
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(&amp;scanner_table, table_info);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     schema = table_info-&gt;get_schema();
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="comment">// verify schema</span>
<a name="l00728"></a>00728     <span class="keywordflow">if</span> (schema-&gt;get_generation() != scanner_table.<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>) {
<a name="l00729"></a>00729       <a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.<a class="code" href="class_hypertable_1_1_scanner_map.html#a5d355d7737720f3e1a70f9721cd4864" title="This method removes the entry in the scanner map corresponding to the given id.">remove</a>(scanner_id);
<a name="l00730"></a>00730       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2ba7f6b260c71a394562e9db9b6fd2cee">Error::RANGESERVER_GENERATION_MISMATCH</a>,
<a name="l00731"></a>00731                <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"RangeServer Schema generation for table '%s' is %d but "</span>
<a name="l00732"></a>00732                       <span class="stringliteral">"scanner has generation %d"</span>, scanner_table.<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>,
<a name="l00733"></a>00733                       schema-&gt;get_generation(), scanner_table.<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>));
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     range-&gt;add_bytes_read( rbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() );
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="keywordtype">size_t</span> count;
<a name="l00739"></a>00739     more = <a class="code" href="namespace_hypertable.html#d8a0ae3a35f6c44996fe0770345bb296">FillScanBlock</a>(scanner, rbuf, &amp;count);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (!more)
<a name="l00742"></a>00742       <a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.<a class="code" href="class_hypertable_1_1_scanner_map.html#a5d355d7737720f3e1a70f9721cd4864" title="This method removes the entry in the scanner map corresponding to the given id.">remove</a>(scanner_id);
<a name="l00743"></a>00743 
<a name="l00747"></a>00747     {
<a name="l00748"></a>00748       <span class="keywordtype">short</span> moreflag = more ? 0 : 1;
<a name="l00749"></a>00749       <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> ext(rbuf);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751       <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback_fetch_scanblock.html#5f24001e908bd6eb5050e32c58759d56">response</a>(moreflag, scanner_id, ext)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00752"></a>00752         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00753"></a>00753 
<a name="l00754"></a>00754       <a class="code" href="_logger_8h.html#42da343b7cd5f8d14c17e594611cdefd">HT_DEBUGF</a>(<span class="stringliteral">"Successfully fetched %u bytes (%d k/v pairs) of scan data"</span>,
<a name="l00755"></a>00755                 ext.<a class="code" href="class_hypertable_1_1_static_buffer.html#6548d44a4d3539650d3b90f423cc62b8">size</a>-4, (<span class="keywordtype">int</span>)count);
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   }
<a name="l00759"></a>00759   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l00760"></a>00760     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00762"></a>00762       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00763"></a>00763   }
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="keywordtype">void</span>
<a name="l00768"></a><a class="code" href="class_hypertable_1_1_range_server.html#b3646d1415276e5e1edcadd3701529f6">00768</a> <a class="code" href="class_hypertable_1_1_range_server.html#b3646d1415276e5e1edcadd3701529f6">RangeServer::load_range</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table,
<a name="l00769"></a>00769     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec, <span class="keyword">const</span> <span class="keywordtype">char</span> *transfer_log_dir,
<a name="l00770"></a>00770     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_state.html" title="Holds the persistent state of a Range.">RangeState</a> *range_state) {
<a name="l00771"></a>00771   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l00772"></a>00772   <a class="code" href="namespace_hypertable.html#a11c0e04e8944428cc219a8357a8d6f4">TableMutatorPtr</a> mutator;
<a name="l00773"></a>00773   <a class="code" href="class_hypertable_1_1_key_spec.html">KeySpec</a> key;
<a name="l00774"></a>00774   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> metadata_key_str;
<a name="l00775"></a>00775   <span class="keywordtype">bool</span> is_root;
<a name="l00776"></a>00776   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l00777"></a>00777   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l00778"></a>00778   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00779"></a>00779   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l00780"></a>00780   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> table_dfsdir;
<a name="l00781"></a>00781   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> range_dfsdir;
<a name="l00782"></a>00782   <span class="keywordtype">char</span> md5DigestStr[33];
<a name="l00783"></a>00783   <span class="keywordtype">bool</span> register_table = <span class="keyword">false</span>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785   <span class="keywordflow">try</span> {
<a name="l00786"></a>00786 
<a name="l00787"></a>00787     <span class="comment">// this needs to be here to avoid a race condition with drop_table</span>
<a name="l00788"></a>00788     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#6022cea6deb2bafcccfe0100c801d937">m_dropped_table_id_cache</a>-&gt;contains(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>)) {
<a name="l00789"></a>00789       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Table %s (id=%d) has been dropped"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l00790"></a>00790       cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b29b1ad838b2614a9479650ce6b0bdb633">Error::RANGESERVER_TABLE_DROPPED</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>);
<a name="l00791"></a>00791       <span class="keywordflow">return</span>;
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795       <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#faf5e7171838874c206709975273432b">m_drop_table_mutex</a>);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797       is_root = table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0 &amp;&amp; (*range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a> == 0)
<a name="l00798"></a>00798         &amp;&amp; !strcmp(range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>, <a class="code" href="class_hypertable_1_1_key.html#1d3faf7ddb325905e9546c8c08c3d9f6">Key::END_ROOT_ROW</a>);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800       <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt;<span class="stringliteral">"Loading range: "</span>&lt;&lt; *table &lt;&lt;<span class="stringliteral">" "</span>&lt;&lt; *range_spec &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802       <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#6022cea6deb2bafcccfe0100c801d937">m_dropped_table_id_cache</a>-&gt;contains(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>)) {
<a name="l00803"></a>00803         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Table %s (id=%d) has been dropped"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l00804"></a>00804         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b29b1ad838b2614a9479650ce6b0bdb633">Error::RANGESERVER_TABLE_DROPPED</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>);
<a name="l00805"></a>00805         <span class="keywordflow">return</span>;
<a name="l00806"></a>00806       }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808       <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#5ea9ad1309259018f06b75d57db29498">Global::failure_inducer</a>)
<a name="l00809"></a>00809         <a class="code" href="class_hypertable_1_1_global.html#5ea9ad1309259018f06b75d57db29498">Global::failure_inducer</a>-&gt;<a class="code" href="class_hypertable_1_1_failure_inducer.html#bbb89f5f5162692889f281b344ebc59c">maybe_fail</a>(<span class="stringliteral">"load-range-1"</span>);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l00812"></a>00812         <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>();
<a name="l00813"></a>00813 
<a name="l00815"></a>00815       {
<a name="l00816"></a>00816         <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00817"></a>00817         <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info)) {
<a name="l00818"></a>00818           table_info = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table_info.html">TableInfo</a>(<a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>, table, schema);
<a name="l00819"></a>00819           register_table = <span class="keyword">true</span>;
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821       }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823       <span class="comment">// Verify schema, this will create the Schema object and add it to</span>
<a name="l00824"></a>00824       <span class="comment">// table_info if it doesn't exist</span>
<a name="l00825"></a>00825       <a class="code" href="class_hypertable_1_1_range_server.html#39ba022e023e8cf65ea584d3b0254f44">verify_schema</a>(table_info, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827       <span class="keywordflow">if</span> (register_table)
<a name="l00828"></a>00828         <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;set(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info);
<a name="l00829"></a>00829 
<a name="l00833"></a>00833       <span class="keywordflow">if</span> (table_info-&gt;get_range(range_spec, range))
<a name="l00834"></a>00834         <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b28a9d6598cea3d2f4fdb721a7f59fc2f3">Error::RANGESERVER_RANGE_ALREADY_LOADED</a>, (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>
<a name="l00835"></a>00835                  +<span class="stringliteral">"["</span>+ range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a> +<span class="stringliteral">".."</span>+ range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a> +<span class="stringliteral">"]"</span>);
<a name="l00836"></a>00836 
<a name="l00840"></a>00840       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a>) {
<a name="l00841"></a>00841         <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l00842"></a>00842         <span class="comment">// double-check locking (works fine on x86 and amd64 but may fail</span>
<a name="l00843"></a>00843         <span class="comment">// on other archs without using a memory barrier</span>
<a name="l00844"></a>00844         <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a>)
<a name="l00845"></a>00845           <a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table.html" title="Represents an open table.">Table</a>(<a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, <a class="code" href="class_hypertable_1_1_range_server.html#54bfa807ec69ce26647fd65272aaff53">m_conn_manager</a>,
<a name="l00846"></a>00846                                              <a class="code" href="class_hypertable_1_1_global.html#33b51399cb1ff91ce74611044160d07a">Global::hyperspace</a>, <span class="stringliteral">"METADATA"</span>);
<a name="l00847"></a>00847       }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849       schema = table_info-&gt;get_schema();
<a name="l00850"></a>00850 
<a name="l00855"></a>00855       {
<a name="l00856"></a>00856         assert(*range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a> != 0);
<a name="l00857"></a>00857         <a class="code" href="md5_8cc.html#5ed908adb13f21c8d086c70a2a0c723b" title="Get the hex string of MD5 of null terminated input.">md5_string</a>(range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>, md5DigestStr);
<a name="l00858"></a>00858         md5DigestStr[24] = 0;
<a name="l00859"></a>00859         table_dfsdir = (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"/hypertable/tables/"</span> + table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <span class="keywordflow">foreach</span>(<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html">Schema::AccessGroup</a> *ag, schema-&gt;get_access_groups()) {
<a name="l00862"></a>00862           <span class="comment">// notice the below variables are different "range" vs. "table"</span>
<a name="l00863"></a>00863           range_dfsdir = table_dfsdir + <span class="stringliteral">"/"</span> + ag-&gt;<a class="code" href="struct_hypertable_1_1_schema_1_1_access_group.html#f73dc29e25d8ce7ca2b67c15a3ced902">name</a> + <span class="stringliteral">"/"</span> + md5DigestStr;
<a name="l00864"></a>00864           <a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(range_dfsdir);
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866       }
<a name="l00867"></a>00867     }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     range = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range.html" title="Represents a table row range.">Range</a>(<a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>, table, schema, range_spec,
<a name="l00870"></a>00870                       table_info.get(), range_state);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     {
<a name="l00873"></a>00873       <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#faf5e7171838874c206709975273432b">m_drop_table_mutex</a>);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875       <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#6022cea6deb2bafcccfe0100c801d937">m_dropped_table_id_cache</a>-&gt;contains(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>)) {
<a name="l00876"></a>00876         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Table %s (id=%d) has been dropped"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l00877"></a>00877         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b29b1ad838b2614a9479650ce6b0bdb633">Error::RANGESERVER_TABLE_DROPPED</a>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>);
<a name="l00878"></a>00878         <span class="keywordflow">return</span>;
<a name="l00879"></a>00879       }
<a name="l00880"></a>00880 
<a name="l00884"></a>00884       <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0) {
<a name="l00885"></a>00885         <span class="keywordflow">if</span> (is_root) {
<a name="l00886"></a>00886           <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(<a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/root"</span>);
<a name="l00887"></a>00887           <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a>
<a name="l00888"></a>00888                                            + <span class="stringliteral">"/root"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>);
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a> == 0) {
<a name="l00891"></a>00891           <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(<a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/metadata"</span>);
<a name="l00892"></a>00892           <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>,
<a name="l00893"></a>00893                                                <a class="code" href="class_hypertable_1_1_global.html#acf23b8e85f263ab81a17a8e4910ac8d">Global::log_dir</a> + <span class="stringliteral">"/metadata"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>);
<a name="l00894"></a>00894         }
<a name="l00895"></a>00895       }
<a name="l00896"></a>00896 
<a name="l00902"></a>00902       <span class="keywordflow">if</span> (transfer_log_dir &amp;&amp; *transfer_log_dir) {
<a name="l00903"></a>00903         <a class="code" href="namespace_hypertable.html#a403476082b15bf1a679d6e624394056">CommitLogReaderPtr</a> commit_log_reader =
<a name="l00904"></a>00904           <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log_reader.html">CommitLogReader</a>(<a class="code" href="class_hypertable_1_1_global.html#398cae8d4baba15bf528e3f93bf7d584">Global::dfs</a>, transfer_log_dir, <span class="keyword">true</span>);
<a name="l00905"></a>00905         <span class="keywordflow">if</span> (!commit_log_reader-&gt;empty()) {
<a name="l00906"></a>00906           <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a> *log;
<a name="l00907"></a>00907           <span class="keywordflow">if</span> (is_root)
<a name="l00908"></a>00908             log = <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>;
<a name="l00909"></a>00909           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0)
<a name="l00910"></a>00910             log = <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>;
<a name="l00911"></a>00911           <span class="keywordflow">else</span>
<a name="l00912"></a>00912             log = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914           <span class="keywordflow">if</span> ((error = log-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#245b4d6060ca725d3c4630a417563571" title="Links an external log into this log.">link_log</a>(commit_log_reader.get())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00915"></a>00915             <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(error, <span class="stringliteral">"Unable to link transfer log (%s) into commit log(%s)"</span>,
<a name="l00916"></a>00916                       transfer_log_dir, log-&gt;<a class="code" href="class_hypertable_1_1_commit_log_base.html#d67b5d288f29f12b75e119cb03eee190">get_log_dir</a>().c_str());
<a name="l00917"></a>00917 
<a name="l00918"></a>00918           range-&gt;replay_transfer_log(commit_log_reader.get());
<a name="l00919"></a>00919 
<a name="l00920"></a>00920           <span class="comment">// transfer the in-memory log fragments</span>
<a name="l00921"></a>00921           log-&gt;<a class="code" href="class_hypertable_1_1_commit_log_base.html#663711cab54898f0612a2b78e7f9426d">stitch_in</a>(commit_log_reader.get());
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923       }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925       table_info-&gt;add_range(range);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927       <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>)
<a name="l00928"></a>00928         <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>-&gt;<a class="code" href="class_hypertable_1_1_range_server_meta_log.html#04f5ee127e35377fc531992fac258b78">log_range_loaded</a>(*table, *range_spec, *range_state);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931 
<a name="l00938"></a>00938     <span class="keywordflow">if</span> (!is_root) {
<a name="l00939"></a>00939       metadata_key_str = <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"%lu:%s"</span>, (<a class="code" href="namespace_hypertable.html#ef3ce232ba4129a8c9b691a614505f9a">Lu</a>)table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l00940"></a>00940 
<a name="l00944"></a>00944       mutator = <a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a>-&gt;create_mutator();
<a name="l00945"></a>00945 
<a name="l00946"></a>00946       key.<a class="code" href="class_hypertable_1_1_key_spec.html#40369f5a201a674f92d5b20d1d154396">row</a> = metadata_key_str.c_str();
<a name="l00947"></a>00947       key.<a class="code" href="class_hypertable_1_1_key_spec.html#ff2126e370d03427e6209eca7211feff">row_len</a> = strlen(metadata_key_str.c_str());
<a name="l00948"></a>00948       key.<a class="code" href="class_hypertable_1_1_key_spec.html#62878b08e5b98e9e78ec6317fd0f9b40">column_family</a> = <span class="stringliteral">"Location"</span>;
<a name="l00949"></a>00949       key.<a class="code" href="class_hypertable_1_1_key_spec.html#67418ffbae9c2eb8fa8525bb496e55f2">column_qualifier</a> = 0;
<a name="l00950"></a>00950       key.<a class="code" href="class_hypertable_1_1_key_spec.html#4fab3b4e8b573592e4fe3a6d1bf08776">column_qualifier_len</a> = 0;
<a name="l00951"></a>00951       mutator-&gt;set(key, <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>.c_str(),
<a name="l00952"></a>00952                    <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>.length());
<a name="l00953"></a>00953       mutator-&gt;flush();
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     <span class="keywordflow">else</span> {  <span class="comment">//root</span>
<a name="l00956"></a>00956       uint64_t handle;
<a name="l00957"></a>00957       <a class="code" href="namespace_hyperspace.html#caac2c6eb284451eb2a0a0dea6caead5">HandleCallbackPtr</a> null_callback;
<a name="l00958"></a>00958       uint32_t oflags = <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9f19c89ca87d7b3de63bd78fe36a493622" title="Open file for reading.">OPEN_FLAG_READ</a> | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9f1d5a78002d883f613cfcb38d6386da1c" title="Open file for writing.">OPEN_FLAG_WRITE</a> | <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9ff848fd6c46eb9eac3931523edd9df8af" title="Create file if it does not exist.">OPEN_FLAG_CREATE</a>;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960       <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"Loading root METADATA range"</span>);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962       <span class="keywordflow">try</span> {
<a name="l00963"></a>00963         handle = <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;open(<span class="stringliteral">"/hypertable/root"</span>, oflags, null_callback);
<a name="l00964"></a>00964         <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;attr_set(handle, <span class="stringliteral">"Location"</span>, <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>.c_str(),
<a name="l00965"></a>00965                                <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>.length());
<a name="l00966"></a>00966         <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;close(handle);
<a name="l00967"></a>00967       }
<a name="l00968"></a>00968       <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00969"></a>00969         <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; <span class="stringliteral">"Problem setting attribute 'location' on Hyperspace "</span>
<a name="l00970"></a>00970           <span class="stringliteral">"file '/hypertable/root'"</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00971"></a>00971         <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l00972"></a>00972         <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00973"></a>00973       }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00978"></a>00978       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00979"></a>00979     <span class="keywordflow">else</span>
<a name="l00980"></a>00980       <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Successfully loaded range %s[%s..%s]"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>,
<a name="l00981"></a>00981                range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983   }
<a name="l00984"></a>00984   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l00985"></a>00985     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l00987"></a>00987       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00988"></a>00988   }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keywordtype">void</span>
<a name="l00993"></a><a class="code" href="class_hypertable_1_1_range_server.html#39f6aed93287eb52245a484f03cf0286">00993</a> <a class="code" href="class_hypertable_1_1_range_server.html#39f6aed93287eb52245a484f03cf0286">RangeServer::update_schema</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb,
<a name="l00994"></a>00994     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table, <span class="keyword">const</span> <span class="keywordtype">char</span> *schema_str) {
<a name="l00995"></a>00995   <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#faf5e7171838874c206709975273432b">m_drop_table_mutex</a>);
<a name="l00996"></a>00996   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l00997"></a>00997   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt;<span class="stringliteral">"Updating schema for: "</span>&lt;&lt; *table &lt;&lt;<span class="stringliteral">" schema = "</span>&lt;&lt;
<a name="l01000"></a>01000       schema_str &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002   <span class="keywordflow">try</span> {
<a name="l01006"></a>01006     schema = <a class="code" href="class_hypertable_1_1_schema.html#05b45dcae5ecf3c28d06067d8f74b8e1">Schema::new_instance</a>(schema_str, strlen(schema_str), <span class="keyword">true</span>);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">if</span> (!schema-&gt;is_valid()) {
<a name="l01009"></a>01009       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b254dae7b84a730a0ea7fde81f16da7458">Error::RANGESERVER_SCHEMA_PARSE_ERROR</a>,
<a name="l01010"></a>01010         (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>) <span class="stringliteral">"Update schema Parse Error for table '"</span>
<a name="l01011"></a>01011         + table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a> + <span class="stringliteral">"' : "</span> + schema-&gt;get_error_string());
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table, table_info);
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     table_info-&gt;update_schema(schema);
<a name="l01017"></a>01017 
<a name="l01018"></a>01018   }
<a name="l01019"></a>01019   <span class="keywordflow">catch</span>(<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01020"></a>01020     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l01021"></a>01021     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what());
<a name="l01022"></a>01022     <span class="keywordflow">return</span>;
<a name="l01023"></a>01023   }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Successfully updated schema for: "</span>&lt;&lt; *table &lt;&lt; HT_END;
<a name="l01026"></a>01026   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01027"></a>01027   <span class="keywordflow">return</span>;
<a name="l01028"></a>01028 }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030 
<a name="l01031"></a>01031 <span class="keywordtype">void</span>
<a name="l01032"></a><a class="code" href="class_hypertable_1_1_range_server.html#3f19c18fc12d4095f542ddddccd83054">01032</a> <a class="code" href="class_hypertable_1_1_range_server.html#3f19c18fc12d4095f542ddddccd83054">RangeServer::transform_key</a>(<a class="code" href="class_hypertable_1_1_byte_string.html">ByteString</a> &amp;bskey, <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> *dest_bufp,
<a name="l01033"></a>01033                            int64_t auto_revision, int64_t *revisionp) {
<a name="l01034"></a>01034   <span class="keywordtype">size_t</span> len;
<a name="l01035"></a>01035   <span class="keyword">const</span> uint8_t *<a class="code" href="lzoconf_8h.html#edc63c09328e8dcce47e667c1cb0e36b">ptr</a>;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037   len = bskey.<a class="code" href="class_hypertable_1_1_byte_string.html#7024f8172399458767093dbb26d86b48">decode_length</a>(&amp;ptr);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039   <span class="keywordflow">if</span> (*ptr == <a class="code" href="class_hypertable_1_1_key.html#c0b1593798461dc7db66ae562d3a2015">Key::AUTO_TIMESTAMP</a>) {
<a name="l01040"></a>01040     dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#964e910bedd2a7bf294277cf0d1ecf5c" title="Ensure space for additional data Will grow the space to 1.5 of the needed space with...">ensure</a>( (ptr-bskey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>) + len + 9 );
<a name="l01041"></a>01041     <a class="code" href="namespace_hypertable_1_1_serialization.html#76485e00d47270563670c2c108eaeac2" title="Encode a integer (up to 32-bit) in variable length encoding.">Serialization::encode_vi32</a>(&amp;dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, len+8);
<a name="l01042"></a>01042     memcpy(dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, ptr, len);
<a name="l01043"></a>01043     *dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> = <a class="code" href="class_hypertable_1_1_key.html#e9596e4615477d7bcbd5103d3ec8fdf3">Key::HAVE_REVISION</a>
<a name="l01044"></a>01044         | <a class="code" href="class_hypertable_1_1_key.html#6966325ec5f0d94836b946a16a1ddd36">Key::HAVE_TIMESTAMP</a> | <a class="code" href="class_hypertable_1_1_key.html#98be59a52e61ec8370d2a989522cff27">Key::REV_IS_TS</a>;
<a name="l01045"></a>01045     dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> += len;
<a name="l01046"></a>01046     <a class="code" href="class_hypertable_1_1_key.html#4513330d716a9049b3677629282a4cd8">Key::encode_ts64</a>(&amp;dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, auto_revision);
<a name="l01047"></a>01047     *revisionp = auto_revision;
<a name="l01048"></a>01048     bskey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr + len;
<a name="l01049"></a>01049   }
<a name="l01050"></a>01050   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ptr == <a class="code" href="class_hypertable_1_1_key.html#6966325ec5f0d94836b946a16a1ddd36">Key::HAVE_TIMESTAMP</a>) {
<a name="l01051"></a>01051     dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#964e910bedd2a7bf294277cf0d1ecf5c" title="Ensure space for additional data Will grow the space to 1.5 of the needed space with...">ensure</a>( (ptr-bskey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>) + len + 9 );
<a name="l01052"></a>01052     <a class="code" href="namespace_hypertable_1_1_serialization.html#76485e00d47270563670c2c108eaeac2" title="Encode a integer (up to 32-bit) in variable length encoding.">Serialization::encode_vi32</a>(&amp;dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, len+8);
<a name="l01053"></a>01053     memcpy(dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, ptr, len);
<a name="l01054"></a>01054     *dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> = <a class="code" href="class_hypertable_1_1_key.html#e9596e4615477d7bcbd5103d3ec8fdf3">Key::HAVE_REVISION</a>
<a name="l01055"></a>01055         | <a class="code" href="class_hypertable_1_1_key.html#6966325ec5f0d94836b946a16a1ddd36">Key::HAVE_TIMESTAMP</a>;
<a name="l01056"></a>01056     dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> += len;
<a name="l01057"></a>01057     <a class="code" href="class_hypertable_1_1_key.html#4513330d716a9049b3677629282a4cd8">Key::encode_ts64</a>(&amp;dest_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>, auto_revision);
<a name="l01058"></a>01058     *revisionp = auto_revision;
<a name="l01059"></a>01059     bskey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr + len;
<a name="l01060"></a>01060   }
<a name="l01061"></a>01061   <span class="keywordflow">else</span> {
<a name="l01062"></a>01062     <a class="code" href="_logger_8h.html#cf985e8f1a1bebe7d622115e4b3e08a6">HT_ASSERT</a>(!<span class="stringliteral">"unknown key control flag"</span>);
<a name="l01063"></a>01063   }
<a name="l01064"></a>01064 
<a name="l01065"></a>01065   <span class="keywordflow">return</span>;
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 <span class="keyword">namespace </span>{
<a name="l01070"></a>01070 
<a name="l01071"></a>01071   <span class="keyword">struct </span>UpdateExtent {
<a name="l01072"></a>01072     <span class="keyword">const</span> uint8_t *base;
<a name="l01073"></a>01073     uint64_t len;
<a name="l01074"></a>01074   };
<a name="l01075"></a>01075 
<a name="l01076"></a>01076   <span class="keyword">struct </span>SendBackRec {
<a name="l01077"></a>01077     <span class="keywordtype">int</span> error;
<a name="l01078"></a>01078     uint32_t count;
<a name="l01079"></a>01079     uint32_t offset;
<a name="l01080"></a>01080     uint32_t len;
<a name="l01081"></a>01081   };
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   <span class="keyword">struct </span>RangeUpdateInfo {
<a name="l01084"></a>01084     <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l01085"></a>01085     <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> *bufp;
<a name="l01086"></a>01086     uint64_t offset;
<a name="l01087"></a>01087     uint64_t len;
<a name="l01088"></a>01088   };
<a name="l01089"></a>01089 
<a name="l01090"></a>01090 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="keywordtype">void</span>
<a name="l01093"></a><a class="code" href="class_hypertable_1_1_range_server.html#479667a9f62e6bd25e063fa50f493c53">01093</a> <a class="code" href="class_hypertable_1_1_range_server.html#479667a9f62e6bd25e063fa50f493c53">RangeServer::commit_log_sync</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb) {
<a name="l01094"></a>01094   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l01095"></a>01095   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l01096"></a>01096   <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>* commit_log = 0;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"received commit_log_sync request"</span>&lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l01101"></a>01101     <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>();
<a name="l01102"></a>01102 
<a name="l01103"></a>01103   <span class="comment">// Global commit log is only available after local recovery</span>
<a name="l01104"></a>01104   commit_log = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106   <span class="keywordflow">try</span> {
<a name="l01107"></a>01107     commit_log-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#feb8d301e247a37fe3116787b2393ca8" title="Sync previous updates written to commit log.">sync</a>();
<a name="l01108"></a>01108     <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt; <span class="stringliteral">"commit log synced"</span> &lt;&lt; HT_END;
<a name="l01109"></a>01109   }
<a name="l01110"></a>01110   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01111"></a>01111     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Exception caught: %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>()));
<a name="l01112"></a>01112     error = e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>();
<a name="l01113"></a>01113     errmsg = e.what();
<a name="l01114"></a>01114   }
<a name="l01115"></a>01115 
<a name="l01119"></a>01119   <span class="keywordflow">if</span> (error == <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l01120"></a>01120     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01121"></a>01121       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01122"></a>01122   }
<a name="l01123"></a>01123   <span class="keywordflow">else</span> {
<a name="l01124"></a>01124     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"%s '%s'"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error), errmsg.c_str());
<a name="l01125"></a>01125     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(error, errmsg)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01126"></a>01126       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01127"></a>01127   }
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 
<a name="l01131"></a>01131 <span class="keywordtype">void</span>
<a name="l01132"></a><a class="code" href="class_hypertable_1_1_range_server.html#a81f641d5bb88b1bfb28abcbe1e8bc49">01132</a> <a class="code" href="class_hypertable_1_1_range_server.html#a81f641d5bb88b1bfb28abcbe1e8bc49">RangeServer::update</a>(<a class="code" href="class_hypertable_1_1_response_callback_update.html">ResponseCallbackUpdate</a> *cb, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table,
<a name="l01133"></a>01133                     uint32_t count, <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> &amp;buffer, uint32_t flags) {
<a name="l01134"></a>01134   <span class="keyword">const</span> uint8_t *mod, *mod_end;
<a name="l01135"></a>01135   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> errmsg;
<a name="l01136"></a>01136   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l01137"></a>01137   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l01138"></a>01138   int64_t last_revision;
<a name="l01139"></a>01139   int64_t latest_range_revision;
<a name="l01140"></a>01140   <span class="keyword">const</span> <span class="keywordtype">char</span> *row;
<a name="l01141"></a>01141   <a class="code" href="class_hypertable_1_1_split_predicate.html">SplitPredicate</a> split_predicate;
<a name="l01142"></a>01142   <a class="code" href="namespace_hypertable.html#81b8680a25dc2eb43d53e24e44042c46">CommitLogPtr</a> splitlog;
<a name="l01143"></a>01143   <span class="keywordtype">bool</span> split_pending;
<a name="l01144"></a>01144   <a class="code" href="class_hypertable_1_1_serialized_key.html">SerializedKey</a> key;
<a name="l01145"></a>01145   <a class="code" href="class_hypertable_1_1_byte_string.html">ByteString</a> value;
<a name="l01146"></a>01146   <span class="keywordtype">bool</span> a_locked = <span class="keyword">false</span>;
<a name="l01147"></a>01147   <span class="keywordtype">bool</span> b_locked = <span class="keyword">false</span>;
<a name="l01148"></a>01148   vector&lt;SendBackRec&gt; send_back_vector;
<a name="l01149"></a>01149   SendBackRec send_back;
<a name="l01150"></a>01150   uint32_t total_added = 0;
<a name="l01151"></a>01151   uint32_t split_added = 0;
<a name="l01152"></a>01152   std::vector&lt;RangeUpdateInfo&gt; range_vector;
<a name="l01153"></a>01153   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> root_buf;
<a name="l01154"></a>01154   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> go_buf;
<a name="l01155"></a>01155   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> *split_bufp = 0;
<a name="l01156"></a>01156   std::vector&lt;DynamicBufferPtr&gt; split_bufs;
<a name="l01157"></a>01157   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> *cur_bufp;
<a name="l01158"></a>01158   uint32_t misses = 0;
<a name="l01159"></a>01159   RangeUpdateInfo rui;
<a name="l01160"></a>01160   std::set&lt;Range *&gt; reference_set;
<a name="l01161"></a>01161   std::pair&lt;std::set&lt;Range *&gt;::iterator, <span class="keywordtype">bool</span>&gt; reference_set_state;
<a name="l01162"></a>01162   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> start_row, end_row;
<a name="l01163"></a>01163   std::vector&lt;RangePtr&gt; wait_ranges;
<a name="l01164"></a>01164   <span class="keywordtype">bool</span> wait_for_maintenance;
<a name="l01165"></a>01165   <span class="keywordtype">bool</span> sync = !((flags &amp; <a class="code" href="class_hypertable_1_1_range_server_protocol.html#4966cbac4d7723890da3e0b1bafe2bca37de91a9811b885a09952d5ee20011b0">RangeServerProtocol::UPDATE_FLAG_NO_LOG_SYNC</a>) ==
<a name="l01166"></a>01166       <a class="code" href="class_hypertable_1_1_range_server_protocol.html#4966cbac4d7723890da3e0b1bafe2bca37de91a9811b885a09952d5ee20011b0">RangeServerProtocol::UPDATE_FLAG_NO_LOG_SYNC</a>);
<a name="l01167"></a>01167 
<a name="l01168"></a>01168   <span class="comment">// Pre-allocate the go_buf - each key could expand by 8 or 9 bytes,</span>
<a name="l01169"></a>01169   <span class="comment">// if auto-assigned (8 for the ts or rev and maybe 1 for possible</span>
<a name="l01170"></a>01170   <span class="comment">// increase in vint length)</span>
<a name="l01171"></a>01171   <span class="keyword">const</span> uint32_t encoded_table_len = table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#067d39338ef81a14bfff6957a6ece4f1">encoded_length</a>();
<a name="l01172"></a>01172   go_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#1af91ec703645dbb3a91f62bbcb674ac" title="Reserve space for additional data Will grow the space to exactly what&amp;#39;s needed...">reserve</a>(encoded_table_len + buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#6548d44a4d3539650d3b90f423cc62b8">size</a> + (count * 9));
<a name="l01173"></a>01173   table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#64566d666c41364b54934bbae2c681dd">encode</a>(&amp;go_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>);
<a name="l01174"></a>01174 
<a name="l01175"></a>01175   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#efe4e1e48013da0d1dc47fd2c281c556">m_update_delay</a>)
<a name="l01176"></a>01176     poll(0, 0, <a class="code" href="class_hypertable_1_1_range_server.html#efe4e1e48013da0d1dc47fd2c281c556">m_update_delay</a>);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"Update:\n"</span>&lt;&lt; *table &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01179"></a>01179 
<a name="l01180"></a>01180   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l01181"></a>01181     <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>();
<a name="l01182"></a>01182 
<a name="l01183"></a>01183   <span class="comment">// Global commit log is only available after local recovery</span>
<a name="l01184"></a>01184   int64_t auto_revision = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#3daeb06956a2d8e70ddf799e1427491e" title="Atomically obtains a timestamp.">get_timestamp</a>();
<a name="l01185"></a>01185 
<a name="l01186"></a>01186   <span class="comment">// TODO: Sanity check mod data (checksum validation)</span>
<a name="l01187"></a>01187 
<a name="l01188"></a>01188   <span class="keywordflow">try</span> {
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table, table_info);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="comment">// verify schema</span>
<a name="l01193"></a>01193     <span class="keywordflow">if</span> (table_info-&gt;get_schema()-&gt;get_generation() != table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>)
<a name="l01194"></a>01194       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2ba7f6b260c71a394562e9db9b6fd2cee">Error::RANGESERVER_GENERATION_MISMATCH</a>,
<a name="l01195"></a>01195                (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"RangeServer Schema generation for table '"</span> +
<a name="l01196"></a>01196                table_info -&gt;get_name() + <span class="stringliteral">"' is "</span> +
<a name="l01197"></a>01197                table_info-&gt;get_schema()-&gt;get_generation()
<a name="l01198"></a>01198                + <span class="stringliteral">" but supplied is "</span> + table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200     mod_end = buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a> + buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#6548d44a4d3539650d3b90f423cc62b8">size</a>;
<a name="l01201"></a>01201     mod = buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203     <a class="code" href="class_hypertable_1_1_range_server.html#d46295cee548997911d93aad0ea2af61">m_update_mutex_a</a>.<a class="code" href="class_hypertable_1_1_mutex.html#e983884deff4292341b9133a3c0c7474">lock</a>();
<a name="l01204"></a>01204     a_locked = <span class="keyword">true</span>;
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="keywordflow">while</span> (mod &lt; mod_end) {
<a name="l01209"></a>01209       key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = mod;
<a name="l01210"></a>01210       row = key.<a class="code" href="class_hypertable_1_1_serialized_key.html#78f46a8a96c124a6105dd38904bc1984">row</a>();
<a name="l01211"></a>01211 
<a name="l01212"></a>01212       <span class="comment">// If the row key starts with '\0' then the buffer is probably</span>
<a name="l01213"></a>01213       <span class="comment">// corrupt, so mark the remaing key/value pairs as bad</span>
<a name="l01214"></a>01214       <span class="keywordflow">if</span> (*row == 0) {
<a name="l01215"></a>01215         send_back.error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b21d7d085edea1bdb20215b29ec3ef63d5">Error::BAD_KEY</a>;
<a name="l01216"></a>01216         send_back.count = count;  <span class="comment">// fix me !!!!</span>
<a name="l01217"></a>01217         send_back.offset = mod - buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>;
<a name="l01218"></a>01218         send_back.len = mod_end - mod;
<a name="l01219"></a>01219         send_back_vector.push_back(send_back);
<a name="l01220"></a>01220         memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01221"></a>01221         mod = mod_end;
<a name="l01222"></a>01222         <span class="keywordflow">continue</span>;
<a name="l01223"></a>01223       }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225       <span class="comment">// Look for containing range, add to stop mods if not found</span>
<a name="l01226"></a>01226       <span class="keywordflow">if</span> (!table_info-&gt;find_containing_range(row, rui.range,
<a name="l01227"></a>01227                                              start_row, end_row)) {
<a name="l01228"></a>01228         <span class="keywordflow">if</span> (send_back.error != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2769e163254af46335740c9ff2e12fedc">Error::RANGESERVER_OUT_OF_RANGE</a>
<a name="l01229"></a>01229             &amp;&amp; send_back.count &gt; 0) {
<a name="l01230"></a>01230           send_back_vector.push_back(send_back);
<a name="l01231"></a>01231           memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01232"></a>01232         }
<a name="l01233"></a>01233         <span class="keywordflow">if</span> (send_back.count == 0) {
<a name="l01234"></a>01234           send_back.error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2769e163254af46335740c9ff2e12fedc">Error::RANGESERVER_OUT_OF_RANGE</a>;
<a name="l01235"></a>01235           send_back.offset = mod - buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>;
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237         key.<a class="code" href="class_hypertable_1_1_byte_string.html#837721eefba6cf8cd76a89361c949a11">next</a>(); <span class="comment">// skip key</span>
<a name="l01238"></a>01238         key.<a class="code" href="class_hypertable_1_1_byte_string.html#837721eefba6cf8cd76a89361c949a11">next</a>(); <span class="comment">// skip value;</span>
<a name="l01239"></a>01239         mod = key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l01240"></a>01240         send_back.count++;
<a name="l01241"></a>01241         <span class="keywordflow">continue</span>;
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244       <span class="comment">// See if range has some other error preventing it from receiving updates</span>
<a name="l01245"></a>01245       <span class="keywordflow">if</span> ((error = rui.range-&gt;get_error()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l01246"></a>01246         <span class="keywordflow">if</span> (send_back.error != error &amp;&amp; send_back.count &gt; 0) {
<a name="l01247"></a>01247           send_back_vector.push_back(send_back);
<a name="l01248"></a>01248           memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01249"></a>01249         }
<a name="l01250"></a>01250         <span class="keywordflow">if</span> (send_back.count == 0) {
<a name="l01251"></a>01251           send_back.error = error;
<a name="l01252"></a>01252           send_back.offset = mod - buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>;
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254         key.<a class="code" href="class_hypertable_1_1_byte_string.html#837721eefba6cf8cd76a89361c949a11">next</a>(); <span class="comment">// skip key</span>
<a name="l01255"></a>01255         key.<a class="code" href="class_hypertable_1_1_byte_string.html#837721eefba6cf8cd76a89361c949a11">next</a>(); <span class="comment">// skip value;</span>
<a name="l01256"></a>01256         mod = key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l01257"></a>01257         send_back.count++;
<a name="l01258"></a>01258         <span class="keywordflow">continue</span>;
<a name="l01259"></a>01259       }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (send_back.count &gt; 0) {
<a name="l01262"></a>01262         send_back.len = (mod - buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>) - send_back.offset;
<a name="l01263"></a>01263         send_back_vector.push_back(send_back);
<a name="l01264"></a>01264         memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01265"></a>01265       }
<a name="l01266"></a>01266 
<a name="l01268"></a>01268       reference_set_state = reference_set.insert(rui.range.get());
<a name="l01269"></a>01269       <span class="keywordflow">if</span> (reference_set_state.second)
<a name="l01270"></a>01270         rui.range-&gt;increment_update_counter();
<a name="l01271"></a>01271 
<a name="l01272"></a>01272       <span class="comment">// Make sure range didn't just shrink</span>
<a name="l01273"></a>01273       <span class="keywordflow">if</span> (rui.range-&gt;start_row() != start_row ||
<a name="l01274"></a>01274           rui.range-&gt;end_row() != end_row) {
<a name="l01275"></a>01275         <span class="keywordflow">if</span> (reference_set_state.second) {
<a name="l01276"></a>01276           rui.range-&gt;decrement_update_counter();
<a name="l01277"></a>01277           reference_set.erase(rui.range.get());
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279         <span class="keywordflow">continue</span>;
<a name="l01280"></a>01280       }
<a name="l01281"></a>01281 
<a name="l01283"></a>01283       split_pending = rui.range-&gt;get_split_info(split_predicate, splitlog,
<a name="l01284"></a>01284                                                 &amp;latest_range_revision, wait_for_maintenance);
<a name="l01285"></a>01285       <span class="keywordflow">if</span> (wait_for_maintenance)
<a name="l01286"></a>01286         wait_ranges.push_back(rui.range);
<a name="l01287"></a>01287 
<a name="l01288"></a>01288       <span class="keywordtype">bool</span> in_split_off_region = <span class="keyword">false</span>;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290       <span class="comment">// Check for clock skew</span>
<a name="l01291"></a>01291       {
<a name="l01292"></a>01292         <a class="code" href="class_hypertable_1_1_byte_string.html">ByteString</a> tmp_key;
<a name="l01293"></a>01293         <span class="keyword">const</span> uint8_t *tmp;
<a name="l01294"></a>01294         int64_t difference, tmp_timestamp;
<a name="l01295"></a>01295         tmp_key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l01296"></a>01296         tmp_key.<a class="code" href="class_hypertable_1_1_byte_string.html#7024f8172399458767093dbb26d86b48">decode_length</a>(&amp;tmp);
<a name="l01297"></a>01297         <span class="keywordflow">if</span> ((*tmp &amp; <a class="code" href="class_hypertable_1_1_key.html#e9596e4615477d7bcbd5103d3ec8fdf3">Key::HAVE_REVISION</a>) == 0) {
<a name="l01298"></a>01298           <span class="keywordflow">if</span> (latest_range_revision &gt; <a class="code" href="namespace_hypertable.html#2f905de3237fa0a5ef08ffa80f89e19b">TIMESTAMP_NULL</a>
<a name="l01299"></a>01299               &amp;&amp; auto_revision &lt; latest_range_revision) {
<a name="l01300"></a>01300             tmp_timestamp = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#3daeb06956a2d8e70ddf799e1427491e" title="Atomically obtains a timestamp.">get_timestamp</a>();
<a name="l01301"></a>01301             <span class="keywordflow">if</span> (tmp_timestamp &gt; auto_revision)
<a name="l01302"></a>01302               auto_revision = tmp_timestamp;
<a name="l01303"></a>01303             <span class="keywordflow">if</span> (auto_revision &lt; latest_range_revision) {
<a name="l01304"></a>01304               difference = (int32_t)((latest_range_revision - auto_revision)
<a name="l01305"></a>01305                             / 1000LL);
<a name="l01306"></a>01306               <span class="keywordflow">if</span> (difference &gt; <a class="code" href="class_hypertable_1_1_range_server.html#11a39f53286620fa062a8bc81d5b4c68">m_max_clock_skew</a>)
<a name="l01307"></a>01307                 <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b21dad16254a3cbb4139642e8aeb557ffa">Error::RANGESERVER_CLOCK_SKEW</a>,
<a name="l01308"></a>01308                           <span class="stringliteral">"Clocks skew of %lld microseconds exceeds maximum "</span>
<a name="l01309"></a>01309                           <span class="stringliteral">"(%lld) range=%s"</span>, (<a class="code" href="namespace_hypertable.html#ce7eaaed51230ae858cf2843bc20cce5">Lld</a>)difference,
<a name="l01310"></a>01310                           (<a class="code" href="namespace_hypertable.html#ce7eaaed51230ae858cf2843bc20cce5">Lld</a>)<a class="code" href="class_hypertable_1_1_range_server.html#11a39f53286620fa062a8bc81d5b4c68">m_max_clock_skew</a>,
<a name="l01311"></a>01311                           rui.range-&gt;get_name().c_str());
<a name="l01312"></a>01312             }
<a name="l01313"></a>01313           }
<a name="l01314"></a>01314         }
<a name="l01315"></a>01315       }
<a name="l01316"></a>01316 
<a name="l01317"></a>01317       <span class="keywordflow">if</span> (split_pending) {
<a name="l01318"></a>01318         split_bufp = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a>();
<a name="l01319"></a>01319         split_bufs.push_back(split_bufp);
<a name="l01320"></a>01320         split_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#1af91ec703645dbb3a91f62bbcb674ac" title="Reserve space for additional data Will grow the space to exactly what&amp;#39;s needed...">reserve</a>(encoded_table_len);
<a name="l01321"></a>01321         table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#64566d666c41364b54934bbae2c681dd">encode</a>(&amp;split_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>);
<a name="l01322"></a>01322       }
<a name="l01323"></a>01323       <span class="keywordflow">else</span>
<a name="l01324"></a>01324         split_bufp = 0;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326       <span class="keywordflow">if</span> (rui.range-&gt;is_root())
<a name="l01327"></a>01327         cur_bufp = &amp;root_buf;
<a name="l01328"></a>01328       <span class="keywordflow">else</span>
<a name="l01329"></a>01329         cur_bufp = &amp;go_buf;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331       <span class="keywordflow">if</span> (cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> == 0) {
<a name="l01332"></a>01332         cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#1af91ec703645dbb3a91f62bbcb674ac" title="Reserve space for additional data Will grow the space to exactly what&amp;#39;s needed...">reserve</a>(encoded_table_len);
<a name="l01333"></a>01333         table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#64566d666c41364b54934bbae2c681dd">encode</a>(&amp;cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a>);
<a name="l01334"></a>01334       }
<a name="l01335"></a>01335 
<a name="l01336"></a>01336       rui.bufp = cur_bufp;
<a name="l01337"></a>01337       rui.offset = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>();
<a name="l01338"></a>01338 
<a name="l01339"></a>01339       <span class="keywordflow">while</span> (mod &lt; mod_end &amp;&amp; (end_row == <span class="stringliteral">""</span>
<a name="l01340"></a>01340              || (strcmp(row, end_row.c_str()) &lt;= 0))) {
<a name="l01341"></a>01341 
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (split_pending) {
<a name="l01343"></a>01343 
<a name="l01344"></a>01344           <span class="keywordflow">if</span> (split_predicate.<a class="code" href="class_hypertable_1_1_split_predicate.html#d829878e5adc1274f54a5a270bcf4212">split_off</a>(row)) {
<a name="l01345"></a>01345             <span class="keywordflow">if</span> (!in_split_off_region) {
<a name="l01346"></a>01346               rui.len = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() - rui.offset;
<a name="l01347"></a>01347               <span class="keywordflow">if</span> (rui.len)
<a name="l01348"></a>01348                 range_vector.push_back(rui);
<a name="l01349"></a>01349               cur_bufp = split_bufp;
<a name="l01350"></a>01350               rui.bufp = cur_bufp;
<a name="l01351"></a>01351               rui.offset = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>();
<a name="l01352"></a>01352               in_split_off_region = <span class="keyword">true</span>;
<a name="l01353"></a>01353             }
<a name="l01354"></a>01354             split_added++;
<a name="l01355"></a>01355           }
<a name="l01356"></a>01356           <span class="keywordflow">else</span> {
<a name="l01357"></a>01357             <span class="keywordflow">if</span> (in_split_off_region) {
<a name="l01358"></a>01358               rui.len = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() - rui.offset;
<a name="l01359"></a>01359               <span class="keywordflow">if</span> (rui.len)
<a name="l01360"></a>01360                 range_vector.push_back(rui);
<a name="l01361"></a>01361               cur_bufp = &amp;go_buf;
<a name="l01362"></a>01362               rui.bufp = cur_bufp;
<a name="l01363"></a>01363               rui.offset = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>();
<a name="l01364"></a>01364               in_split_off_region = <span class="keyword">false</span>;
<a name="l01365"></a>01365             }
<a name="l01366"></a>01366           }
<a name="l01367"></a>01367         }
<a name="l01368"></a>01368 
<a name="l01369"></a>01369         <span class="comment">// This will transform keys that need to be assigned a</span>
<a name="l01370"></a>01370         <span class="comment">// timestamp and/or revision number by re-writing the key</span>
<a name="l01371"></a>01371         <span class="comment">// with the added timestamp and/or revision tacked on to the end</span>
<a name="l01372"></a>01372         <a class="code" href="class_hypertable_1_1_range_server.html#3f19c18fc12d4095f542ddddccd83054">transform_key</a>(key, cur_bufp, ++auto_revision, &amp;last_revision);
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         <span class="comment">// Validate revision number</span>
<a name="l01375"></a>01375         <span class="keywordflow">if</span> (last_revision &lt; latest_range_revision) {
<a name="l01376"></a>01376           <span class="keywordflow">if</span> (last_revision != auto_revision)
<a name="l01377"></a>01377             <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26a1e13c39d95709a2a1ca12b5ab53b29">Error::RANGESERVER_REVISION_ORDER_ERROR</a>,
<a name="l01378"></a>01378                       <span class="stringliteral">"Supplied revision (%lld) is less than most recently "</span>
<a name="l01379"></a>01379                       <span class="stringliteral">"seen revision (%lld) for range %s"</span>,
<a name="l01380"></a>01380                       (<a class="code" href="namespace_hypertable.html#ce7eaaed51230ae858cf2843bc20cce5">Lld</a>)last_revision, (<a class="code" href="namespace_hypertable.html#ce7eaaed51230ae858cf2843bc20cce5">Lld</a>)latest_range_revision,
<a name="l01381"></a>01381                       rui.range-&gt;get_name().c_str());
<a name="l01382"></a>01382         }
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="comment">// Now copy the value (with sanity check)</span>
<a name="l01385"></a>01385         mod = key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l01386"></a>01386         key.<a class="code" href="class_hypertable_1_1_byte_string.html#837721eefba6cf8cd76a89361c949a11">next</a>(); <span class="comment">// skip value</span>
<a name="l01387"></a>01387         <a class="code" href="_logger_8h.html#cf985e8f1a1bebe7d622115e4b3e08a6">HT_ASSERT</a>(key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> &lt;= mod_end);
<a name="l01388"></a>01388         cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#f232bbce348a344cba925ebbc0eebc9d">add</a>(mod, key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>-mod);
<a name="l01389"></a>01389         mod = key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a>;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         total_added++;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393         <span class="keywordflow">if</span> (mod &lt; mod_end)
<a name="l01394"></a>01394           row = key.<a class="code" href="class_hypertable_1_1_serialized_key.html#78f46a8a96c124a6105dd38904bc1984">row</a>();
<a name="l01395"></a>01395       }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397       rui.len = cur_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() - rui.offset;
<a name="l01398"></a>01398       <span class="keywordflow">if</span> (rui.len)
<a name="l01399"></a>01399         range_vector.push_back(rui);
<a name="l01400"></a>01400       rui.range = 0;
<a name="l01401"></a>01401       rui.bufp = 0;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403       <span class="comment">// if there were split-off updates, write the split log entry</span>
<a name="l01404"></a>01404       <span class="keywordflow">if</span> (split_bufp &amp;&amp; split_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() &gt; encoded_table_len) {
<a name="l01405"></a>01405         <span class="keywordflow">if</span> ((error = splitlog-&gt;write(*split_bufp, last_revision)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01406"></a>01406           <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(error, <span class="stringliteral">"Problem writing %d bytes to split log"</span>,
<a name="l01407"></a>01407                     (<span class="keywordtype">int</span>)split_bufp-&gt;<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>());
<a name="l01408"></a>01408         splitlog = 0;
<a name="l01409"></a>01409       }
<a name="l01410"></a>01410     }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412     <a class="code" href="_logger_8h.html#42da343b7cd5f8d14c17e594611cdefd">HT_DEBUGF</a>(<span class="stringliteral">"Added %d (%d split off) updates to '%s'"</span>, total_added,
<a name="l01413"></a>01413               split_added, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>);
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="keywordflow">if</span> (send_back.count &gt; 0) {
<a name="l01416"></a>01416       send_back.len = (mod - buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#4556ecd07eda8b67d638f84c313ae2ec">base</a>) - send_back.offset;
<a name="l01417"></a>01417       send_back_vector.push_back(send_back);
<a name="l01418"></a>01418       memset(&amp;send_back, 0, <span class="keyword">sizeof</span>(send_back));
<a name="l01419"></a>01419     }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <a class="code" href="class_hypertable_1_1_range_server.html#a74887218e4fdd78c05bf3e18b19e4d3">m_update_mutex_b</a>.<a class="code" href="class_hypertable_1_1_mutex.html#e983884deff4292341b9133a3c0c7474">lock</a>();
<a name="l01422"></a>01422     b_locked = <span class="keyword">true</span>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     <a class="code" href="class_hypertable_1_1_range_server.html#d46295cee548997911d93aad0ea2af61">m_update_mutex_a</a>.<a class="code" href="class_hypertable_1_1_mutex.html#494652641c59ec219a6468b903e6051d">unlock</a>();
<a name="l01425"></a>01425     a_locked = <span class="keyword">false</span>;
<a name="l01426"></a>01426 
<a name="l01430"></a>01430     <span class="keywordflow">if</span> (root_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() &gt; encoded_table_len) {
<a name="l01431"></a>01431       <span class="keywordflow">if</span> ((error = <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>-&gt;write(root_buf, last_revision))
<a name="l01432"></a>01432           != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01433"></a>01433         <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(error, <span class="stringliteral">"Problem writing %d bytes to ROOT commit log"</span>,
<a name="l01434"></a>01434                   (<span class="keywordtype">int</span>)root_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>());
<a name="l01435"></a>01435     }
<a name="l01436"></a>01436 
<a name="l01440"></a>01440     <span class="keywordflow">if</span> (go_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() &gt; encoded_table_len) {
<a name="l01441"></a>01441       <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a> *log;
<a name="l01442"></a>01442       <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0) {
<a name="l01443"></a>01443         <a class="code" href="_logger_8h.html#cf985e8f1a1bebe7d622115e4b3e08a6">HT_ASSERT</a>(sync == <span class="keyword">true</span>);
<a name="l01444"></a>01444         log = <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>;
<a name="l01445"></a>01445       }
<a name="l01446"></a>01446       <span class="keywordflow">else</span>
<a name="l01447"></a>01447         log = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>;
<a name="l01448"></a>01448 
<a name="l01449"></a>01449       <span class="keywordflow">if</span> ((error = log-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#a520a6c3333e38774b9e909d41064d3a" title="Writes a block of updates to the commit log.">write</a>(go_buf, last_revision, sync)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01450"></a>01450         <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(error, <span class="stringliteral">"Problem writing %d bytes to commit log (%s)"</span>,
<a name="l01451"></a>01451                   (<span class="keywordtype">int</span>)go_buf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>(), log-&gt;<a class="code" href="class_hypertable_1_1_commit_log_base.html#d67b5d288f29f12b75e119cb03eee190">get_log_dir</a>().c_str());
<a name="l01452"></a>01452     }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> rangei=0; rangei&lt;range_vector.size(); rangei++) {
<a name="l01455"></a>01455 
<a name="l01459"></a>01459       {
<a name="l01460"></a>01460         <a class="code" href="class_hypertable_1_1_locker.html" title="boost::mutex::scoped_lock use lock_ops&amp;lt;mutex&amp;gt;::lock/unlock in pre 1.35 which...">Locker&lt;Range&gt;</a> lock(*range_vector[rangei].range);
<a name="l01461"></a>01461         <a class="code" href="class_hypertable_1_1_key.html" title="Provides access to internal components of opaque key.">Key</a> key_comps;
<a name="l01462"></a>01462         uint8_t *<a class="code" href="lzoconf_8h.html#edc63c09328e8dcce47e667c1cb0e36b">ptr</a> = range_vector[rangei].bufp-&gt;base
<a name="l01463"></a>01463             + range_vector[rangei].offset;
<a name="l01464"></a>01464         uint8_t *end = ptr + range_vector[rangei].len;
<a name="l01465"></a>01465         range_vector[rangei].range-&gt;add_bytes_written( range_vector[rangei].len );
<a name="l01466"></a>01466         <span class="keywordflow">while</span> (ptr &lt; end) {
<a name="l01467"></a>01467           key.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l01468"></a>01468           key_comps.<a class="code" href="class_hypertable_1_1_key.html#0948f36e3a1d720cb93cbd593ff3b0ee" title="Parses the opaque key and loads the components into the member variables.">load</a>(key);
<a name="l01469"></a>01469           ptr += key_comps.<a class="code" href="class_hypertable_1_1_key.html#04d3c142c9f358f8ac268edbf1f2bba2">length</a>;
<a name="l01470"></a>01470           value.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l01471"></a>01471           ptr += value.<a class="code" href="class_hypertable_1_1_byte_string.html#9220bf75429b9574f5f346fa47049055">length</a>();
<a name="l01472"></a>01472           range_vector[rangei].range-&gt;add(key_comps, value);
<a name="l01473"></a>01473         }
<a name="l01474"></a>01474       }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476       <span class="keywordflow">if</span> (range_vector[rangei].range-&gt;need_maintenance() &amp;&amp;
<a name="l01477"></a>01477           !<a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a>-&gt;is_scheduled(range_vector[rangei].range.get())) {
<a name="l01478"></a>01478         <a class="code" href="class_hypertable_1_1_range_server.html#5a4d6782e80bb75021ee2ce5597c77da">m_maintenance_scheduler</a>-&gt;need_scheduling();
<a name="l01479"></a>01479         <a class="code" href="class_hypertable_1_1_range_server.html#8f3c96bb59d8be15c83d79ab4ee97e1b">m_timer_handler</a>-&gt;<a class="code" href="class_hypertable_1_1_timer_interface.html#314130ac6c36adb67b39baf4e434a453">schedule_maintenance</a>();
<a name="l01480"></a>01480       }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482     }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#b505b1af088f5a2655acb2ef8e4acc2e">Global::verbose</a> &amp;&amp; misses)
<a name="l01485"></a>01485       <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Sent back %d updates because out-of-range"</span>, misses);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l01488"></a>01488   }
<a name="l01489"></a>01489   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01490"></a>01490     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Exception caught: %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>()));
<a name="l01491"></a>01491     error = e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>();
<a name="l01492"></a>01492     errmsg = e.what();
<a name="l01493"></a>01493   }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495   <span class="comment">// decrement usage counters for all referenced ranges</span>
<a name="l01496"></a>01496   <span class="keywordflow">foreach</span>(<a class="code" href="class_hypertable_1_1_range.html" title="Represents a table row range.">Range</a> *range, reference_set)
<a name="l01497"></a>01497     range-&gt;<a class="code" href="class_hypertable_1_1_range.html#f83562d5885bdfdcea0c814dbb074fd4">decrement_update_counter</a>();
<a name="l01498"></a>01498 
<a name="l01499"></a>01499   <span class="keywordflow">if</span> (b_locked)
<a name="l01500"></a>01500     <a class="code" href="class_hypertable_1_1_range_server.html#a74887218e4fdd78c05bf3e18b19e4d3">m_update_mutex_b</a>.<a class="code" href="class_hypertable_1_1_mutex.html#494652641c59ec219a6468b903e6051d">unlock</a>();
<a name="l01501"></a>01501   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a_locked)
<a name="l01502"></a>01502     <a class="code" href="class_hypertable_1_1_range_server.html#d46295cee548997911d93aad0ea2af61">m_update_mutex_a</a>.<a class="code" href="class_hypertable_1_1_mutex.html#494652641c59ec219a6468b903e6051d">unlock</a>();
<a name="l01503"></a>01503 
<a name="l01507"></a>01507   <span class="keywordflow">foreach</span>(<a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range, wait_ranges)
<a name="l01508"></a>01508     range-&gt;wait_for_maintenance_to_complete();
<a name="l01509"></a>01509 
<a name="l01510"></a>01510   <a class="code" href="class_hypertable_1_1_range_server.html#5a4d6782e80bb75021ee2ce5597c77da">m_maintenance_scheduler</a>-&gt;update_stats_bytes_loaded( buffer.<a class="code" href="class_hypertable_1_1_static_buffer.html#6548d44a4d3539650d3b90f423cc62b8">size</a> );
<a name="l01511"></a>01511 
<a name="l01512"></a>01512   <span class="keywordflow">if</span> (error == <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l01516"></a>01516     <span class="keywordflow">if</span> (!send_back_vector.empty()) {
<a name="l01517"></a>01517       <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> ext(<span class="keyword">new</span> uint8_t [send_back_vector.size() * 16],
<a name="l01518"></a>01518                        send_back_vector.size() * 16);
<a name="l01519"></a>01519       uint8_t *<a class="code" href="lzoconf_8h.html#edc63c09328e8dcce47e667c1cb0e36b">ptr</a> = ext.base;
<a name="l01520"></a>01520       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;send_back_vector.size(); i++) {
<a name="l01521"></a>01521         <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;ptr, send_back_vector[i].error);
<a name="l01522"></a>01522         <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;ptr, send_back_vector[i].count);
<a name="l01523"></a>01523         <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;ptr, send_back_vector[i].offset);
<a name="l01524"></a>01524         <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;ptr, send_back_vector[i].len);
<a name="l01525"></a>01525         <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"omega Sending back error %x, count %d, offset %d, len %d"</span>,
<a name="l01526"></a>01526                  send_back_vector[i].error, send_back_vector[i].count,
<a name="l01527"></a>01527                  send_back_vector[i].offset, send_back_vector[i].len);
<a name="l01528"></a>01528       }
<a name="l01529"></a>01529       <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback_update.html#55ea9647b96849334e1e8ec81be5a6c0">response</a>(ext)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01530"></a>01530         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01531"></a>01531     }
<a name="l01532"></a>01532     <span class="keywordflow">else</span> {
<a name="l01533"></a>01533       <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01534"></a>01534         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01535"></a>01535     }
<a name="l01536"></a>01536   }
<a name="l01537"></a>01537   <span class="keywordflow">else</span> {
<a name="l01538"></a>01538     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"%s '%s'"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error), errmsg.c_str());
<a name="l01539"></a>01539     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(error, errmsg)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01540"></a>01540       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01541"></a>01541   }
<a name="l01542"></a>01542 }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544 
<a name="l01545"></a>01545 <span class="keywordtype">void</span>
<a name="l01546"></a><a class="code" href="class_hypertable_1_1_range_server.html#9f23e0810d13cd472857c51a82dec01a">01546</a> <a class="code" href="class_hypertable_1_1_range_server.html#9f23e0810d13cd472857c51a82dec01a">RangeServer::drop_table</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table) {
<a name="l01547"></a>01547   <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#faf5e7171838874c206709975273432b">m_drop_table_mutex</a>);
<a name="l01548"></a>01548   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l01549"></a>01549   std::vector&lt;RangePtr&gt; range_vector;
<a name="l01550"></a>01550   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> metadata_prefix;
<a name="l01551"></a>01551   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> metadata_key;
<a name="l01552"></a>01552   <a class="code" href="namespace_hypertable.html#a11c0e04e8944428cc219a8357a8d6f4">TableMutatorPtr</a> mutator;
<a name="l01553"></a>01553   <a class="code" href="class_hypertable_1_1_key_spec.html">KeySpec</a> key;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555   <a class="code" href="class_hypertable_1_1_range_server.html#6022cea6deb2bafcccfe0100c801d937">m_dropped_table_id_cache</a>-&gt;insert(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l01556"></a>01556 
<a name="l01557"></a>01557   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"drop table "</span> &lt;&lt; table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559   <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>)
<a name="l01560"></a>01560     <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">wait_for_recovery_finish</a>();
<a name="l01561"></a>01561 
<a name="l01562"></a>01562   <span class="comment">// create METADATA table mutator for clearing 'Location' columns</span>
<a name="l01563"></a>01563   mutator = <a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a>-&gt;create_mutator();
<a name="l01564"></a>01564 
<a name="l01565"></a>01565   <span class="comment">// initialize key structure</span>
<a name="l01566"></a>01566   memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
<a name="l01567"></a>01567   key.<a class="code" href="class_hypertable_1_1_key_spec.html#62878b08e5b98e9e78ec6317fd0f9b40">column_family</a> = <span class="stringliteral">"Location"</span>;
<a name="l01568"></a>01568 
<a name="l01569"></a>01569   <span class="keywordflow">try</span> {
<a name="l01570"></a>01570 
<a name="l01571"></a>01571     <span class="comment">// For each range in dropped table, Set the 'drop' bit and clear</span>
<a name="l01572"></a>01572     <span class="comment">// the 'Location' column of the corresponding METADATA entry</span>
<a name="l01573"></a>01573     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;remove(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info)) {
<a name="l01574"></a>01574       metadata_prefix = <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">""</span>) + table_info-&gt;get_id() + <span class="stringliteral">":"</span>;
<a name="l01575"></a>01575       table_info-&gt;get_range_vector(range_vector);
<a name="l01576"></a>01576       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;range_vector.size(); i++) {
<a name="l01577"></a>01577         range_vector[i]-&gt;drop();
<a name="l01578"></a>01578         metadata_key = metadata_prefix + range_vector[i]-&gt;end_row();
<a name="l01579"></a>01579         key.<a class="code" href="class_hypertable_1_1_key_spec.html#40369f5a201a674f92d5b20d1d154396">row</a> = metadata_key.c_str();
<a name="l01580"></a>01580         key.<a class="code" href="class_hypertable_1_1_key_spec.html#ff2126e370d03427e6209eca7211feff">row_len</a> = metadata_key.length();
<a name="l01581"></a>01581         mutator-&gt;set(key, <span class="stringliteral">"!"</span>, 1);
<a name="l01582"></a>01582       }
<a name="l01583"></a>01583     }
<a name="l01584"></a>01584     <span class="keywordflow">else</span> {
<a name="l01585"></a>01585       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"drop_table '%s' id=%u - table not found"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>,
<a name="l01586"></a>01586                 table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l01587"></a>01587     }
<a name="l01588"></a>01588     mutator-&gt;flush();
<a name="l01589"></a>01589   }
<a name="l01590"></a>01590   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l01591"></a>01591     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem clearing 'Location' columns of METADATA - %s"</span>,
<a name="l01592"></a>01592               <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>()));
<a name="l01593"></a>01593     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), <span class="stringliteral">"Problem clearing 'Location' columns of METADATA"</span>);
<a name="l01594"></a>01594     <span class="keywordflow">return</span>;
<a name="l01595"></a>01595   }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;range_vector.size(); i++)
<a name="l01598"></a>01598     range_vector[i]-&gt;wait_for_maintenance_to_complete();
<a name="l01599"></a>01599 
<a name="l01600"></a>01600   <span class="comment">// write range transaction entry</span>
<a name="l01601"></a>01601   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>)
<a name="l01602"></a>01602     <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>-&gt;<a class="code" href="class_hypertable_1_1_range_server_meta_log.html#0bb7836f231948a91262886dbb219509">log_drop_table</a>(*table);
<a name="l01603"></a>01603 
<a name="l01604"></a>01604   <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Successfully dropped table '%s'"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>);
<a name="l01605"></a>01605 
<a name="l01606"></a>01606   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01607"></a>01607 }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609 
<a name="l01610"></a><a class="code" href="class_hypertable_1_1_range_server.html#eed04a7d62ccce3d2196e928a5eb7cd3">01610</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#eed04a7d62ccce3d2196e928a5eb7cd3">RangeServer::dump_stats</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb) {
<a name="l01611"></a>01611   <a class="code" href="namespace_hypertable.html#23154088d6446725d9fc7374f6da9d90">RangeStatsVector</a> range_data;
<a name="l01612"></a>01612   <a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html">AccessGroup::MaintenanceData</a> *ag_data;
<a name="l01613"></a>01613   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> ag_name;
<a name="l01614"></a>01614   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> trace_str = <span class="stringliteral">"STAT ***** RangeServer::dump_stats() *****\n"</span>;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616   <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"dump_stats"</span>);
<a name="l01617"></a>01617 
<a name="l01618"></a>01618   <a class="code" href="class_hypertable_1_1_range_server.html#895afb7bfefc7a87c9123fba1673f0d8">m_stats_gatherer</a>-&gt;fetch(range_data);
<a name="l01619"></a>01619 
<a name="l01620"></a>01620   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;range_data.size(); i++) {
<a name="l01621"></a>01621     <span class="keywordflow">for</span> (ag_data = range_data[i]-&gt;agdata; ag_data; ag_data = ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#b0c132dca9f7ba04d197d40b9388c241">next</a>) {
<a name="l01622"></a>01622       ag_name = range_data[i]-&gt;range-&gt;get_name() + <span class="stringliteral">"("</span> + ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#6159fe841bc981c556c86691b31ae036">ag</a>-&gt;<a class="code" href="class_hypertable_1_1_access_group.html#16b18419ff5c4ba43362df7e40f75752">get_name</a>() + <span class="stringliteral">")"</span>;
<a name="l01623"></a>01623       trace_str += <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"STAT "</span>) + ag_name + <span class="stringliteral">"\tecr\t"</span> + ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#7524468a59831967fa01002715c24362">earliest_cached_revision</a> + <span class="stringliteral">"\n"</span>;
<a name="l01624"></a>01624       trace_str += <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"STAT "</span>) + ag_name + <span class="stringliteral">"\tmemory\t"</span> + ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#d544b54e5d5d10df7404d385948e35bc">mem_used</a> + <span class="stringliteral">"\n"</span>;
<a name="l01625"></a>01625       trace_str += <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"STAT "</span>) + ag_name + <span class="stringliteral">"\tdisk\t"</span> + ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#98356e2102e38e2d456e6e395222985f">disk_used</a> + <span class="stringliteral">"\n"</span>;
<a name="l01626"></a>01626       trace_str += <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"STAT "</span>) + ag_name + <span class="stringliteral">"\tscanners\t"</span> + ag_data-&gt;<a class="code" href="class_hypertable_1_1_access_group_1_1_maintenance_data.html#a41554c4406e522695bb8ade0aa003e0">outstanding_scanners</a> + <span class="stringliteral">"\n"</span>;
<a name="l01627"></a>01627     }
<a name="l01628"></a>01628   }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>) {
<a name="l01631"></a>01631     trace_str += <span class="stringliteral">"STAT *** ROOT commit log fragment info ***\n"</span>;
<a name="l01632"></a>01632     <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#0c13678133b2e96860b79240ee398e95" title="Returns the stats on all commit log fragments.">get_stats</a>(trace_str);
<a name="l01633"></a>01633   }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>) {
<a name="l01636"></a>01636     trace_str += <span class="stringliteral">"STAT *** METADATA commit log fragment info ***\n"</span>;
<a name="l01637"></a>01637     <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#0c13678133b2e96860b79240ee398e95" title="Returns the stats on all commit log fragments.">get_stats</a>(trace_str);
<a name="l01638"></a>01638   }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>) {
<a name="l01641"></a>01641     trace_str += <span class="stringliteral">"STAT *** USER commit log fragment info ***\n"</span>;
<a name="l01642"></a>01642     <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#0c13678133b2e96860b79240ee398e95" title="Returns the stats on all commit log fragments.">get_stats</a>(trace_str);
<a name="l01643"></a>01643   }
<a name="l01644"></a>01644 
<a name="l01645"></a>01645   cout &lt;&lt; <a class="code" href="namespace_hypertable_1_1_logger.html#2c3eba91176547027114524d91a37a50">flush</a> &lt;&lt; trace_str &lt;&lt; <a class="code" href="namespace_hypertable_1_1_logger.html#2c3eba91176547027114524d91a37a50">flush</a>;
<a name="l01646"></a>01646 
<a name="l01647"></a>01647   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01648"></a>01648 }
<a name="l01649"></a>01649 
<a name="l01650"></a><a class="code" href="class_hypertable_1_1_range_server.html#237db5987d9cd9264fbdd7728f96d138">01650</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#237db5987d9cd9264fbdd7728f96d138">RangeServer::get_statistics</a>(<a class="code" href="class_hypertable_1_1_response_callback_get_statistics.html">ResponseCallbackGetStatistics</a> *cb) {
<a name="l01651"></a>01651   std::vector&lt;TableInfoPtr&gt; table_vec;
<a name="l01652"></a>01652   std::vector&lt;RangePtr&gt; range_vec;
<a name="l01653"></a>01653   <a class="code" href="class_hypertable_1_1_range_server_stat.html" title="Statistics of a RangeServer.">RangeServerStat</a> stat;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655   <a class="code" href="_logger_8h.html#da519b780d0c3598663706cc3da0bc50">HT_DEBUG</a>(<span class="stringliteral">"get_statistics"</span>);
<a name="l01656"></a>01656 
<a name="l01657"></a>01657   <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get_all(table_vec);
<a name="l01658"></a>01658 
<a name="l01659"></a>01659   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;table_vec.size(); i++) {
<a name="l01660"></a>01660     range_vec.clear();
<a name="l01661"></a>01661     table_vec[i]-&gt;get_range_vector(range_vec);
<a name="l01662"></a>01662     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;range_vec.size(); i++) {
<a name="l01663"></a>01663       <a class="code" href="class_hypertable_1_1_range_stat.html" title="Statistics of a Range.">RangeStat</a> rstat;
<a name="l01664"></a>01664       range_vec[i]-&gt;get_statistics(&amp;rstat);
<a name="l01665"></a>01665       stat.<a class="code" href="class_hypertable_1_1_range_server_stat.html#fa20acf47b925337e04abc6bf5863e4c">range_stats</a>.push_back(rstat);
<a name="l01666"></a>01666     }
<a name="l01667"></a>01667   }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669   <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> ext(stat.<a class="code" href="class_hypertable_1_1_range_server_stat.html#7c6ebd3b5a1af178c5d360172ca9dde6">encoded_length</a>());
<a name="l01670"></a>01670   uint8_t *bufp = ext.base;
<a name="l01671"></a>01671   stat.<a class="code" href="class_hypertable_1_1_range_server_stat.html#4e0a2cc7b4adb6b5aa6e93ae2d78c433">encode</a>(&amp;bufp);
<a name="l01672"></a>01672 
<a name="l01673"></a>01673   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback_get_statistics.html#5b068022cbe74ff26d7ffbefd7b1ba32">response</a>(ext);
<a name="l01674"></a>01674 }
<a name="l01675"></a>01675 
<a name="l01676"></a>01676 
<a name="l01677"></a><a class="code" href="class_hypertable_1_1_range_server.html#ccaa5f9f41be96aff5863b022407bf52">01677</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#ccaa5f9f41be96aff5863b022407bf52">RangeServer::replay_begin</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint16_t group) {
<a name="l01678"></a>01678   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> replay_log_dir = <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"/hypertable/servers/%s/log/replay"</span>,
<a name="l01679"></a>01679                                  <a class="code" href="class_hypertable_1_1_global.html#b0b5057c66b6bb112a01b75996cb9a08">Global::location</a>.c_str());
<a name="l01680"></a>01680 
<a name="l01681"></a>01681   <a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> = group;
<a name="l01682"></a>01682 
<a name="l01683"></a>01683   <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"replay_start group=%d"</span>, <a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a>);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685   <a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a> = 0;
<a name="l01686"></a>01686 
<a name="l01687"></a>01687   <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;clear_ranges();
<a name="l01688"></a>01688 
<a name="l01692"></a>01692   <span class="keywordflow">try</span> { <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#660432655395f24be406d4c1a781087d" title="Recursively removes a directory asynchronously.">rmdir</a>(replay_log_dir); }
<a name="l01693"></a>01693   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01694"></a>01694     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem removing replay log directory: %s"</span>, e.what());
<a name="l01695"></a>01695     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"Problem removing replay log directory: %s"</span>,
<a name="l01696"></a>01696               e.what()));
<a name="l01697"></a>01697     <span class="keywordflow">return</span>;
<a name="l01698"></a>01698   }
<a name="l01699"></a>01699 
<a name="l01703"></a>01703   <span class="keywordflow">try</span> { <a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#4479f8cdf6cbb10dc87c1db3c77bd706" title="Creates a directory asynchronously.">mkdirs</a>(replay_log_dir); }
<a name="l01704"></a>01704   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01705"></a>01705     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating replay log directory: %s "</span>, e.what());
<a name="l01706"></a>01706     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"Problem creating replay log directory: %s"</span>,
<a name="l01707"></a>01707               e.what()));
<a name="l01708"></a>01708     <span class="keywordflow">return</span>;
<a name="l01709"></a>01709   }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711   <a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a>(<a class="code" href="class_hypertable_1_1_global.html#b7d27f59ab29d2d917b4fe55cfed2138">Global::log_dfs</a>, replay_log_dir, <a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>);
<a name="l01712"></a>01712 
<a name="l01713"></a>01713   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01714"></a>01714 }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716 
<a name="l01717"></a>01717 <span class="keywordtype">void</span>
<a name="l01718"></a><a class="code" href="class_hypertable_1_1_range_server.html#f4b90628d255314341ec3c3b02048fe9">01718</a> <a class="code" href="class_hypertable_1_1_range_server.html#f4b90628d255314341ec3c3b02048fe9">RangeServer::replay_load_range</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb,
<a name="l01719"></a>01719     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec,
<a name="l01720"></a>01720     <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_state.html" title="Holds the persistent state of a Range.">RangeState</a> *range_state) {
<a name="l01721"></a>01721   <span class="keywordtype">int</span> error = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l01722"></a>01722   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema;
<a name="l01723"></a>01723   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l01724"></a>01724   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l01725"></a>01725   <span class="keywordtype">bool</span> register_table = <span class="keyword">false</span>;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a>&lt;&lt; <span class="stringliteral">"replay_load_range\n"</span>&lt;&lt; *table &lt;&lt; *range_spec &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729   <span class="keywordflow">try</span> {
<a name="l01730"></a>01730 
<a name="l01733"></a>01733     <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info)) {
<a name="l01734"></a>01734       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info))
<a name="l01735"></a>01735         table_info = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table_info.html">TableInfo</a>(<a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>, table, schema);
<a name="l01736"></a>01736       <span class="keywordflow">else</span>
<a name="l01737"></a>01737         table_info = table_info-&gt;create_shallow_copy();
<a name="l01738"></a>01738       register_table = <span class="keyword">true</span>;
<a name="l01739"></a>01739     }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="comment">// Verify schema, this will create the Schema object and add it to</span>
<a name="l01742"></a>01742     <span class="comment">// table_info if it doesn't exist</span>
<a name="l01743"></a>01743     <a class="code" href="class_hypertable_1_1_range_server.html#39ba022e023e8cf65ea584d3b0254f44">verify_schema</a>(table_info, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#30552d7531d122a5843deab20815344b">generation</a>);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (register_table)
<a name="l01746"></a>01746       <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;set(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info);
<a name="l01747"></a>01747 
<a name="l01751"></a>01751     <span class="keywordflow">if</span> (table_info-&gt;get_range(range_spec, range))
<a name="l01752"></a>01752       <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b28a9d6598cea3d2f4fdb721a7f59fc2f3">Error::RANGESERVER_RANGE_ALREADY_LOADED</a>, <span class="stringliteral">"%s[%s..%s]"</span>,
<a name="l01753"></a>01753                 table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l01754"></a>01754 
<a name="l01758"></a>01758     <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a>) {
<a name="l01759"></a>01759       <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l01760"></a>01760       <a class="code" href="class_hypertable_1_1_global.html#0a4b53d7f94746672c572f663427fa59">Global::metadata_table</a> = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_table.html" title="Represents an open table.">Table</a>(<a class="code" href="class_hypertable_1_1_range_server.html#c8c4e6b82bdcf6db5aeac6e879698c15">m_props</a>, <a class="code" href="class_hypertable_1_1_range_server.html#54bfa807ec69ce26647fd65272aaff53">m_conn_manager</a>,
<a name="l01761"></a>01761           <a class="code" href="class_hypertable_1_1_global.html#33b51399cb1ff91ce74611044160d07a">Global::hyperspace</a>, <span class="stringliteral">"METADATA"</span>);
<a name="l01762"></a>01762     }
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     schema = table_info-&gt;get_schema();
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     range = <span class="keyword">new</span> <a class="code" href="class_hypertable_1_1_range.html" title="Represents a table row range.">Range</a>(<a class="code" href="class_hypertable_1_1_range_server.html#6db46bad934df76ba8b8a1ed9c3adb0b">m_master_client</a>, table, schema, range_spec,
<a name="l01767"></a>01767                           table_info.get(), range_state);
<a name="l01768"></a>01768 
<a name="l01769"></a>01769     range-&gt;recovery_initialize();
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     table_info-&gt;add_range(range);
<a name="l01772"></a>01772 
<a name="l01773"></a>01773     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>)
<a name="l01774"></a>01774       <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>-&gt;<a class="code" href="class_hypertable_1_1_range_server_meta_log.html#04f5ee127e35377fc531992fac258b78">log_range_loaded</a>(*table, *range_spec, *range_state);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l01777"></a>01777       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending OK response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779     <span class="keywordflow">else</span> {
<a name="l01780"></a>01780       <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Successfully replay loaded range %s[%s..%s]"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>,
<a name="l01781"></a>01781                range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>);
<a name="l01782"></a>01782     }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784   }
<a name="l01785"></a>01785   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l01786"></a>01786     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l01787"></a>01787     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01788"></a>01788       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01789"></a>01789   }
<a name="l01790"></a>01790 }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 
<a name="l01793"></a>01793 
<a name="l01794"></a>01794 <span class="keywordtype">void</span>
<a name="l01795"></a><a class="code" href="class_hypertable_1_1_range_server.html#2e20a8d33760c108882ef475c1733388">01795</a> <a class="code" href="class_hypertable_1_1_range_server.html#2e20a8d33760c108882ef475c1733388">RangeServer::replay_update</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, <span class="keyword">const</span> uint8_t *data,
<a name="l01796"></a>01796                            <span class="keywordtype">size_t</span> len) {
<a name="l01797"></a>01797   <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> table_identifier;
<a name="l01798"></a>01798   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l01799"></a>01799   <a class="code" href="class_hypertable_1_1_serialized_key.html">SerializedKey</a> serkey;
<a name="l01800"></a>01800   <a class="code" href="class_hypertable_1_1_byte_string.html">ByteString</a> bsvalue;
<a name="l01801"></a>01801   <a class="code" href="class_hypertable_1_1_key.html" title="Provides access to internal components of opaque key.">Key</a> key;
<a name="l01802"></a>01802   <span class="keyword">const</span> uint8_t *<a class="code" href="lzoconf_8h.html#edc63c09328e8dcce47e667c1cb0e36b">ptr</a> = data;
<a name="l01803"></a>01803   <span class="keyword">const</span> uint8_t *end = data + len;
<a name="l01804"></a>01804   <span class="keyword">const</span> uint8_t *block_end;
<a name="l01805"></a>01805   uint32_t block_size;
<a name="l01806"></a>01806   <span class="keywordtype">size_t</span> remaining = len;
<a name="l01807"></a>01807   <span class="keyword">const</span> <span class="keywordtype">char</span> *row;
<a name="l01808"></a>01808   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> err_msg;
<a name="l01809"></a>01809   int64_t revision;
<a name="l01810"></a>01810   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l01811"></a>01811   <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> start_row, end_row;
<a name="l01812"></a>01812   <span class="keywordtype">int</span> error;
<a name="l01813"></a>01813 
<a name="l01814"></a>01814   <span class="comment">//HT_DEBUGF("replay_update - length=%ld", len);</span>
<a name="l01815"></a>01815 
<a name="l01816"></a>01816   <span class="keywordflow">try</span> {
<a name="l01817"></a>01817 
<a name="l01818"></a>01818     <span class="keywordflow">while</span> (ptr &lt; end) {
<a name="l01819"></a>01819 
<a name="l01820"></a>01820       <span class="comment">// decode key/value block size + revision</span>
<a name="l01821"></a>01821       block_size = <a class="code" href="namespace_hypertable_1_1_serialization.html#19437f0438392abdc4a62fde605d7707" title="Decode a 32-bit integer in little-endian order.">decode_i32</a>(&amp;ptr, &amp;remaining);
<a name="l01822"></a>01822       revision = <a class="code" href="namespace_hypertable_1_1_serialization.html#328e404dee6b6951756209d65e562bfe" title="Decode a 64-bit integer in little-endian order.">decode_i64</a>(&amp;ptr, &amp;remaining);
<a name="l01823"></a>01823 
<a name="l01824"></a>01824       <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a>) {
<a name="l01825"></a>01825         <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> dbuf(0, <span class="keyword">false</span>);
<a name="l01826"></a>01826         dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a> = (uint8_t *)ptr;
<a name="l01827"></a>01827         dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> = dbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a> + remaining;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829         <span class="keywordflow">if</span> ((error = <a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a>-&gt;write(dbuf, revision)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01830"></a>01830           <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(error, <span class="stringliteral">""</span>);
<a name="l01831"></a>01831       }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833       <span class="comment">// decode table identifier</span>
<a name="l01834"></a>01834       table_identifier.<a class="code" href="class_hypertable_1_1_table_identifier.html#e6ca97281bf7405729785a930e37a1ec">decode</a>(&amp;ptr, &amp;remaining);
<a name="l01835"></a>01835 
<a name="l01836"></a>01836       <span class="keywordflow">if</span> (block_size &gt; remaining)
<a name="l01837"></a>01837         <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20648ebe03f1c4c699e485cdb595a4ff7">Error::MALFORMED_REQUEST</a>, <span class="stringliteral">"Block (size=%lu) exceeds EOM"</span>,
<a name="l01838"></a>01838                   (<a class="code" href="namespace_hypertable.html#ef3ce232ba4129a8c9b691a614505f9a">Lu</a>)block_size);
<a name="l01839"></a>01839 
<a name="l01840"></a>01840       block_end = ptr + block_size;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842       <span class="comment">// Fetch table info</span>
<a name="l01843"></a>01843       <span class="keywordflow">if</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get(table_identifier.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info))
<a name="l01844"></a>01844         <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>, <span class="stringliteral">"Unable to find "</span>
<a name="l01845"></a>01845                   <span class="stringliteral">"table info for table name='%s' id=%lu"</span>,
<a name="l01846"></a>01846                   table_identifier.<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, (<a class="code" href="namespace_hypertable.html#ef3ce232ba4129a8c9b691a614505f9a">Lu</a>)table_identifier.<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>);
<a name="l01847"></a>01847 
<a name="l01848"></a>01848       <span class="keywordflow">while</span> (ptr &lt; block_end) {
<a name="l01849"></a>01849 
<a name="l01850"></a>01850         row = <a class="code" href="class_hypertable_1_1_serialized_key.html">SerializedKey</a>(ptr).row();
<a name="l01851"></a>01851 
<a name="l01852"></a>01852         <span class="comment">// Look for containing range, add to stop mods if not found</span>
<a name="l01853"></a>01853         <span class="keywordflow">if</span> (!table_info-&gt;find_containing_range(row, range,
<a name="l01854"></a>01854                                                start_row, end_row))
<a name="l01855"></a>01855           <a class="code" href="_error_8h.html#a274083bca13ee78497570285c908c80">HT_THROWF</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>, <span class="stringliteral">"Unable to find "</span>
<a name="l01856"></a>01856                     <span class="stringliteral">"range for row '%s'"</span>, row);
<a name="l01857"></a>01857 
<a name="l01858"></a>01858         serkey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860         <span class="keywordflow">while</span> (ptr &lt; block_end
<a name="l01861"></a>01861             &amp;&amp; (end_row == <span class="stringliteral">""</span> || (strcmp(row, end_row.c_str()) &lt;= 0))) {
<a name="l01862"></a>01862 
<a name="l01863"></a>01863           <span class="comment">// extract the key</span>
<a name="l01864"></a>01864           ptr += serkey.<a class="code" href="class_hypertable_1_1_byte_string.html#9220bf75429b9574f5f346fa47049055">length</a>();
<a name="l01865"></a>01865 
<a name="l01866"></a>01866           <span class="keywordflow">if</span> (ptr &gt; end)
<a name="l01867"></a>01867             <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2c132f23d622a1e494c012aac83fbf7b6">Error::REQUEST_TRUNCATED</a>, <span class="stringliteral">"Problem decoding key"</span>);
<a name="l01868"></a>01868 
<a name="l01869"></a>01869           bsvalue.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l01870"></a>01870           ptr += bsvalue.<a class="code" href="class_hypertable_1_1_byte_string.html#9220bf75429b9574f5f346fa47049055">length</a>();
<a name="l01871"></a>01871 
<a name="l01872"></a>01872           <span class="keywordflow">if</span> (ptr &gt; end)
<a name="l01873"></a>01873             <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2c132f23d622a1e494c012aac83fbf7b6">Error::REQUEST_TRUNCATED</a>, <span class="stringliteral">"Problem decoding value"</span>);
<a name="l01874"></a>01874 
<a name="l01875"></a>01875           key.<a class="code" href="class_hypertable_1_1_key.html#0948f36e3a1d720cb93cbd593ff3b0ee" title="Parses the opaque key and loads the components into the member variables.">load</a>(serkey);
<a name="l01876"></a>01876 
<a name="l01877"></a>01877           {
<a name="l01878"></a>01878             <a class="code" href="class_hypertable_1_1_locker.html" title="boost::mutex::scoped_lock use lock_ops&amp;lt;mutex&amp;gt;::lock/unlock in pre 1.35 which...">Locker&lt;Range&gt;</a> lock(*range);
<a name="l01879"></a>01879             range-&gt;add(key, bsvalue);
<a name="l01880"></a>01880           }
<a name="l01881"></a>01881           serkey.<a class="code" href="class_hypertable_1_1_byte_string.html#538ec5b176600856cab1646d59be7034">ptr</a> = ptr;
<a name="l01882"></a>01882 
<a name="l01883"></a>01883           <span class="keywordflow">if</span> (ptr &lt; block_end)
<a name="l01884"></a>01884             row = serkey.<a class="code" href="class_hypertable_1_1_serialized_key.html#78f46a8a96c124a6105dd38904bc1984">row</a>();
<a name="l01885"></a>01885         }
<a name="l01886"></a>01886       }
<a name="l01887"></a>01887     }
<a name="l01888"></a>01888 
<a name="l01889"></a>01889   }
<a name="l01890"></a>01890   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <span class="keywordflow">if</span> (e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>() == <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>)
<a name="l01893"></a>01893       <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01894"></a>01894     <span class="keywordflow">else</span>
<a name="l01895"></a>01895       <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01896"></a>01896 
<a name="l01897"></a>01897     <span class="keywordflow">if</span> (cb) {
<a name="l01898"></a>01898       cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"%s - %s"</span>, e.what(),
<a name="l01899"></a>01899                 <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>())));
<a name="l01900"></a>01900       <span class="keywordflow">return</span>;
<a name="l01901"></a>01901     }
<a name="l01902"></a>01902     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what());
<a name="l01903"></a>01903   }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905   <span class="keywordflow">if</span> (cb)
<a name="l01906"></a>01906     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01907"></a>01907 }
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 
<a name="l01910"></a><a class="code" href="class_hypertable_1_1_range_server.html#be76536903a7dc22641d3e973ac85d6f">01910</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#be76536903a7dc22641d3e973ac85d6f">RangeServer::replay_commit</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb) {
<a name="l01911"></a>01911   <span class="keywordtype">int</span> error;
<a name="l01912"></a>01912 
<a name="l01913"></a>01913   <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"replay_commit"</span>);
<a name="l01914"></a>01914 
<a name="l01915"></a>01915   <span class="keywordflow">try</span> {
<a name="l01916"></a>01916     <a class="code" href="class_hypertable_1_1_commit_log.html" title="Commit log for persisting range updates.">CommitLog</a> *log = 0;
<a name="l01917"></a>01917     std::vector&lt;RangePtr&gt; rangev;
<a name="l01918"></a>01918 
<a name="l01919"></a>01919     <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> == <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a123531ca682d698872694db71670db7700f05">RangeServerProtocol::GROUP_METADATA_ROOT</a>)
<a name="l01920"></a>01920       log = <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>;
<a name="l01921"></a>01921     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> == <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a12353ca8f49c958441f904fb75becb8a28bcc">RangeServerProtocol::GROUP_METADATA</a>)
<a name="l01922"></a>01922       log = <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>;
<a name="l01923"></a>01923     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#27671266e08e944e683a88fe8043a722">m_replay_group</a> == <a class="code" href="class_hypertable_1_1_range_server_protocol.html#569ea5be8d1ada5550f46cd743a12353c4bde2c3e75ef39526acd717324f091f">RangeServerProtocol::GROUP_USER</a>)
<a name="l01924"></a>01924       log = <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>;
<a name="l01925"></a>01925 
<a name="l01927"></a>01927     <span class="keywordflow">if</span> ((error = log-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#245b4d6060ca725d3c4630a417563571" title="Links an external log into this log.">link_log</a>(<a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a>.get())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01928"></a>01928       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(error, <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>(<span class="stringliteral">"Problem linking replay log ("</span>)
<a name="l01929"></a>01929                + <a class="code" href="class_hypertable_1_1_range_server.html#669cc48117046309c415ca38dab8cd80">m_replay_log</a>-&gt;get_log_dir() + <span class="stringliteral">") into commit log ("</span>
<a name="l01930"></a>01930                + log-&gt;<a class="code" href="class_hypertable_1_1_commit_log_base.html#d67b5d288f29f12b75e119cb03eee190">get_log_dir</a>() + <span class="stringliteral">")"</span>);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932     <span class="comment">// Perform any range specific post-replay tasks</span>
<a name="l01933"></a>01933     <a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>-&gt;get_range_vector(rangev);
<a name="l01934"></a>01934     <span class="keywordflow">foreach</span>(<a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> &amp;range, rangev)
<a name="l01935"></a>01935       range-&gt;recovery_finalize();
<a name="l01936"></a>01936 
<a name="l01937"></a>01937     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;merge(<a class="code" href="class_hypertable_1_1_range_server.html#da8c75c92f4430832ec0bae24d2c5e27">m_replay_map</a>);
<a name="l01938"></a>01938 
<a name="l01939"></a>01939   }
<a name="l01940"></a>01940   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l01941"></a>01941     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"%s - %s"</span>, e.what(), <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>()));
<a name="l01942"></a>01942     <span class="keywordflow">if</span> (cb) {
<a name="l01943"></a>01943       cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what());
<a name="l01944"></a>01944       <span class="keywordflow">return</span>;
<a name="l01945"></a>01945     }
<a name="l01946"></a>01946     <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what());
<a name="l01947"></a>01947   }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949   <span class="keywordflow">if</span> (cb)
<a name="l01950"></a>01950     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01951"></a>01951 }
<a name="l01952"></a>01952 
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 
<a name="l01955"></a>01955 <span class="keywordtype">void</span>
<a name="l01956"></a><a class="code" href="class_hypertable_1_1_range_server.html#16b30301c17e08bb5364c1b1f0a40b22">01956</a> <a class="code" href="class_hypertable_1_1_range_server.html#16b30301c17e08bb5364c1b1f0a40b22">RangeServer::drop_range</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table,
<a name="l01957"></a>01957                         <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec) {
<a name="l01958"></a>01958   <a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> table_info;
<a name="l01959"></a>01959   <a class="code" href="namespace_hypertable.html#b7477ba1ad1221c9a7c627e413340ee5">RangePtr</a> range;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961   <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"drop_range\n"</span>&lt;&lt; *table &lt;&lt; *range_spec &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963   <span class="keywordflow">try</span> {
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get(table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a>, table_info);
<a name="l01966"></a>01966 
<a name="l01968"></a>01968     <span class="keywordflow">if</span> (!table_info-&gt;remove_range(range_spec, range))
<a name="l01969"></a>01969       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b272f250ef3a753ac81c466b499121e99a">Error::RANGESERVER_RANGE_NOT_FOUND</a>,
<a name="l01970"></a>01970                <a class="code" href="namespace_hypertable.html#baf99b188906f473b0ff1c3eaef925b4" title="Return a String using printf like format facilities vanilla snprintf is about 1.5x...">format</a>(<span class="stringliteral">"%s[%s..%s]"</span>, table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#c7e881a7ef2e13d766ca7497b044bcda">name</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#07e574487a466e0e25ef576163399de8">start_row</a>, range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>));
<a name="l01971"></a>01971 
<a name="l01972"></a>01972     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01973"></a>01973   }
<a name="l01974"></a>01974   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l01975"></a>01975     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; HT_END;
<a name="l01976"></a>01976     <span class="keywordtype">int</span> error = 0;
<a name="l01977"></a>01977     <span class="keywordflow">if</span> (cb &amp;&amp; (error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e.what())) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>)
<a name="l01978"></a>01978       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending error response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l01979"></a>01979   }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981 }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983 
<a name="l01984"></a><a class="code" href="class_hypertable_1_1_range_server.html#59802c02be25ff37e5e7d624bd73fe45">01984</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#59802c02be25ff37e5e7d624bd73fe45">RangeServer::shutdown</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb) {
<a name="l01985"></a>01985   std::vector&lt;TableInfoPtr&gt; table_vec;
<a name="l01986"></a>01986   std::vector&lt;RangePtr&gt; range_vec;
<a name="l01987"></a>01987 
<a name="l01988"></a>01988   (<a class="code" href="lzoconf_8h.html#383afb2a54f121de25b129d8943336eb">void</a>)cb;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990   <a class="code" href="class_hypertable_1_1_global.html#16fb59749485c260b3383c9535cfbfde">Global::maintenance_queue</a>-&gt;stop();
<a name="l01991"></a>01991 
<a name="l01992"></a>01992   <span class="comment">// block updates</span>
<a name="l01993"></a>01993   <a class="code" href="class_hypertable_1_1_range_server.html#d46295cee548997911d93aad0ea2af61">m_update_mutex_a</a>.<a class="code" href="class_hypertable_1_1_mutex.html#e983884deff4292341b9133a3c0c7474">lock</a>();
<a name="l01994"></a>01994   <a class="code" href="class_hypertable_1_1_range_server.html#a74887218e4fdd78c05bf3e18b19e4d3">m_update_mutex_b</a>.<a class="code" href="class_hypertable_1_1_mutex.html#e983884deff4292341b9133a3c0c7474">lock</a>();
<a name="l01995"></a>01995 
<a name="l01996"></a>01996   <span class="comment">// get the tables</span>
<a name="l01997"></a>01997   <a class="code" href="class_hypertable_1_1_range_server.html#705773314932cda47679eb844330f134">m_live_map</a>-&gt;get_all(table_vec);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999   <span class="comment">// add all ranges into the range vector</span>
<a name="l02000"></a>02000   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;table_vec.size(); i++)
<a name="l02001"></a>02001     table_vec[i]-&gt;get_range_vector(range_vec);
<a name="l02002"></a>02002 
<a name="l02003"></a>02003   <span class="comment">// increment the update counters</span>
<a name="l02004"></a>02004   <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;range_vec.size(); i++)
<a name="l02005"></a>02005     range_vec[i]-&gt;increment_update_counter();
<a name="l02006"></a>02006 
<a name="l02007"></a>02007   <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a> = 0;
<a name="l02008"></a>02008 
<a name="l02009"></a>02009   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>)
<a name="l02010"></a>02010     <a class="code" href="class_hypertable_1_1_global.html#37416121cd3990d877f3f705cfecd568">Global::range_log</a>-&gt;<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#a1cbdca477c8117ede0b7415cbdd5753" title="Close the metalog Implementation should handle multiple close calls.">close</a>();
<a name="l02011"></a>02011 
<a name="l02012"></a>02012   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>)
<a name="l02013"></a>02013     <a class="code" href="class_hypertable_1_1_global.html#288cff165d00198b4cdd70d751bebfdb">Global::root_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#a71a817375981ed756923923c8bacd94" title="Closes the log.">close</a>();
<a name="l02014"></a>02014 
<a name="l02015"></a>02015   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>)
<a name="l02016"></a>02016     <a class="code" href="class_hypertable_1_1_global.html#302705c8c3c7d46224d131c66d0302d8">Global::metadata_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#a71a817375981ed756923923c8bacd94" title="Closes the log.">close</a>();
<a name="l02017"></a>02017 
<a name="l02018"></a>02018   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>)
<a name="l02019"></a>02019     <a class="code" href="class_hypertable_1_1_global.html#55701f2a230e3ac96f208ca7b80d3f1c">Global::user_log</a>-&gt;<a class="code" href="class_hypertable_1_1_commit_log.html#a71a817375981ed756923923c8bacd94" title="Closes the log.">close</a>();
<a name="l02020"></a>02020 
<a name="l02021"></a>02021 }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023 
<a name="l02024"></a><a class="code" href="class_hypertable_1_1_range_server.html#39ba022e023e8cf65ea584d3b0254f44">02024</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#39ba022e023e8cf65ea584d3b0254f44">RangeServer::verify_schema</a>(<a class="code" href="namespace_hypertable.html#4dab50af662aa2eb8f7ebe08a2f4f48d">TableInfoPtr</a> &amp;table_info, uint32_t generation) {
<a name="l02025"></a>02025   <a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> valbuf;
<a name="l02026"></a>02026   <a class="code" href="namespace_hyperspace.html#caac2c6eb284451eb2a0a0dea6caead5">HandleCallbackPtr</a> null_handle_callback;
<a name="l02027"></a>02027   uint64_t handle;
<a name="l02028"></a>02028   <a class="code" href="namespace_hypertable.html#af3160d3193975ee13e5505c19974dcb">SchemaPtr</a> schema = table_info-&gt;get_schema();
<a name="l02029"></a>02029 
<a name="l02030"></a>02030   <span class="keywordflow">if</span> (schema.get() == 0 || schema-&gt;get_generation() &lt; generation) {
<a name="l02031"></a>02031     <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> tablefile = (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"/hypertable/tables/"</span> + table_info-&gt;get_name();
<a name="l02032"></a>02032 
<a name="l02033"></a>02033     handle = <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;open(tablefile.c_str(), <a class="code" href="namespace_hyperspace.html#5da1e559364d873f1e98608341d9ea9f19c89ca87d7b3de63bd78fe36a493622" title="Open file for reading.">OPEN_FLAG_READ</a>,
<a name="l02034"></a>02034                                 null_handle_callback);
<a name="l02035"></a>02035 
<a name="l02036"></a>02036     <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;attr_get(handle, <span class="stringliteral">"schema"</span>, valbuf);
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     <a class="code" href="class_hypertable_1_1_range_server.html#6b278433d5b5191f59f9c32e961b09ce">m_hyperspace</a>-&gt;close(handle);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040     schema = <a class="code" href="class_hypertable_1_1_schema.html#05b45dcae5ecf3c28d06067d8f74b8e1">Schema::new_instance</a>((<span class="keywordtype">char</span> *)valbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a>, valbuf.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>(), <span class="keyword">true</span>);
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     <span class="keywordflow">if</span> (!schema-&gt;is_valid())
<a name="l02043"></a>02043       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b254dae7b84a730a0ea7fde81f16da7458">Error::RANGESERVER_SCHEMA_PARSE_ERROR</a>,
<a name="l02044"></a>02044                (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"Schema Parse Error for table '"</span>
<a name="l02045"></a>02045                + table_info-&gt;get_name() + <span class="stringliteral">"' : "</span> + schema-&gt;get_error_string());
<a name="l02046"></a>02046 
<a name="l02047"></a>02047     table_info-&gt;update_schema(schema);
<a name="l02048"></a>02048 
<a name="l02049"></a>02049     <span class="comment">// Generation check ...</span>
<a name="l02050"></a>02050     <span class="keywordflow">if</span> (schema-&gt;get_generation() &lt; generation)
<a name="l02051"></a>02051       <a class="code" href="_error_8h.html#7d401d8c606e7f717e3b1ae0452895c8">HT_THROW</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2ba7f6b260c71a394562e9db9b6fd2cee">Error::RANGESERVER_GENERATION_MISMATCH</a>,
<a name="l02052"></a>02052                (<a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a>)<span class="stringliteral">"Fetched Schema generation for table '"</span>
<a name="l02053"></a>02053                + table_info-&gt;get_name() + <span class="stringliteral">"' is "</span> + schema-&gt;get_generation()
<a name="l02054"></a>02054                + <span class="stringliteral">" but supplied is "</span> + generation);
<a name="l02055"></a>02055   }
<a name="l02056"></a>02056 }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 
<a name="l02059"></a><a class="code" href="class_hypertable_1_1_range_server.html#c7c9c7f1942c314a031099248b94df19">02059</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#c7c9c7f1942c314a031099248b94df19">RangeServer::do_maintenance</a>() {
<a name="l02060"></a>02060 
<a name="l02061"></a>02061   <span class="keywordflow">try</span> {
<a name="l02062"></a>02062 
<a name="l02066"></a>02066     <a class="code" href="class_hypertable_1_1_global.html#573d1daddd6fa218db5b5431facc7694">Global::scanner_map</a>.<a class="code" href="class_hypertable_1_1_scanner_map.html#fd75307c71f6b7fb73b5a3104d4ff9d6" title="This method iterates through the scanner map purging mappings that have not been...">purge_expired</a>(<a class="code" href="class_hypertable_1_1_range_server.html#8c30ca2edf6d92f4bb1098abe709b223">m_scanner_ttl</a>);
<a name="l02067"></a>02067 
<a name="l02071"></a>02071     <a class="code" href="class_hypertable_1_1_range_server.html#5a4d6782e80bb75021ee2ce5597c77da">m_maintenance_scheduler</a>-&gt;set_low_memory_mode( <a class="code" href="class_hypertable_1_1_range_server.html#8f3c96bb59d8be15c83d79ab4ee97e1b">m_timer_handler</a>-&gt;<a class="code" href="class_hypertable_1_1_timer_interface.html#2c32c13dbb2a216d9fed693919eb314e">low_memory</a>() );
<a name="l02072"></a>02072 
<a name="l02076"></a>02076     <a class="code" href="class_hypertable_1_1_range_server.html#5a4d6782e80bb75021ee2ce5597c77da">m_maintenance_scheduler</a>-&gt;schedule();
<a name="l02077"></a>02077 
<a name="l02078"></a>02078   }
<a name="l02079"></a>02079   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Hypertable::Exception</a> &amp;e) {
<a name="l02080"></a>02080     <a class="code" href="_logger_8h.html#92469733c369eec23e81bdd53e233985">HT_ERROR_OUT</a> &lt;&lt; e &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l02081"></a>02081   }
<a name="l02082"></a>02082 
<a name="l02083"></a>02083   <span class="comment">// Notify timer handler so that it can resume</span>
<a name="l02084"></a>02084   <a class="code" href="class_hypertable_1_1_range_server.html#8f3c96bb59d8be15c83d79ab4ee97e1b">m_timer_handler</a>-&gt;<a class="code" href="class_hypertable_1_1_timer_interface.html#e4c3abee85cf8cd8f028e98cc57466d2">complete_maintenance_notify</a>();
<a name="l02085"></a>02085 
<a name="l02086"></a>02086   <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Memory Usage: %llu bytes"</span>, (<a class="code" href="namespace_hypertable.html#85c40099ee846f8b60b73c30c6ee2162">Llu</a>)<a class="code" href="class_hypertable_1_1_global.html#c5a71b47a9c909db915648eda97a1db2">Global::memory_tracker</a>.balance());
<a name="l02087"></a>02087   <span class="keywordflow">if</span> (<a class="code" href="class_hypertable_1_1_range_server.html#8f3c96bb59d8be15c83d79ab4ee97e1b">m_timer_handler</a>-&gt;<a class="code" href="class_hypertable_1_1_timer_interface.html#2c32c13dbb2a216d9fed693919eb314e">low_memory</a>())
<a name="l02088"></a>02088     <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"Application queue PAUSED due to low memory condition"</span>);
<a name="l02089"></a>02089 }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091 
<a name="l02092"></a>02092 
<a name="l02093"></a><a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">02093</a> <span class="keywordtype">void</span> <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">RangeServer::wait_for_recovery_finish</a>() {
<a name="l02094"></a>02094   <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l02095"></a>02095   <span class="keywordflow">while</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>) {
<a name="l02096"></a>02096     <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Waiting for recovery to complete..."</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l02097"></a>02097     <a class="code" href="class_hypertable_1_1_range_server.html#0c1595ad6ee450d2127e2c86bbf07611">m_replay_finished_cond</a>.wait(lock);
<a name="l02098"></a>02098   }
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 <span class="keywordtype">void</span>
<a name="l02103"></a><a class="code" href="class_hypertable_1_1_range_server.html#6a92ebd91dc0d9a3bab4cb4121776b96">02103</a> <a class="code" href="class_hypertable_1_1_range_server.html#a05ab4feec23133d28357cd725dfa322">RangeServer::wait_for_recovery_finish</a>(<span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_table_identifier.html" title="Identifies a specific table and generation.">TableIdentifier</a> *table,
<a name="l02104"></a>02104                                       <span class="keyword">const</span> <a class="code" href="class_hypertable_1_1_range_spec.html" title="Identifies a range.">RangeSpec</a> *range_spec) {
<a name="l02105"></a>02105   <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_range_server.html#c10802d880e9555abe8c4aff259e4431">m_mutex</a>);
<a name="l02106"></a>02106   <span class="keywordflow">if</span> (table-&gt;<a class="code" href="class_hypertable_1_1_table_identifier.html#413901de0724f5f917199d1a251f4af4">id</a> == 0) {
<a name="l02107"></a>02107     <span class="keywordflow">if</span> (!strcmp(range_spec-&gt;<a class="code" href="class_hypertable_1_1_range_spec.html#beafe30f1c7e3ea3ea5f6c7aada9c899">end_row</a>, <a class="code" href="class_hypertable_1_1_key.html#1d3faf7ddb325905e9546c8c08c3d9f6">Key::END_ROOT_ROW</a>)) {
<a name="l02108"></a>02108       <span class="keywordflow">while</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#3aa1d704353b7c6211378173ed73a9fd">m_root_replay_finished</a>) {
<a name="l02109"></a>02109         <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Waiting for ROOT recovery to complete..."</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l02110"></a>02110         <a class="code" href="class_hypertable_1_1_range_server.html#0ab83ccf84357d37aaa9cb6118539891">m_root_replay_finished_cond</a>.wait(lock);
<a name="l02111"></a>02111       }
<a name="l02112"></a>02112     }
<a name="l02113"></a>02113     <span class="keywordflow">else</span> {
<a name="l02114"></a>02114       <span class="keywordflow">while</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#20b33dca55f8509aa217388131f939db">m_metadata_replay_finished</a>) {
<a name="l02115"></a>02115         <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Waiting for METADATA recovery to complete..."</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l02116"></a>02116         <a class="code" href="class_hypertable_1_1_range_server.html#407cd9ca955934be1c623b692de1b837">m_metadata_replay_finished_cond</a>.wait(lock);
<a name="l02117"></a>02117       }
<a name="l02118"></a>02118     }
<a name="l02119"></a>02119   }
<a name="l02120"></a>02120   <span class="keywordflow">else</span> {
<a name="l02121"></a>02121     <span class="keywordflow">while</span> (!<a class="code" href="class_hypertable_1_1_range_server.html#fc7e6feb67cff697f460de5b7e86532b">m_replay_finished</a>) {
<a name="l02122"></a>02122       <a class="code" href="_logger_8h.html#95aca07db923e7bc3ff075b6e96ace4f">HT_INFO_OUT</a> &lt;&lt; <span class="stringliteral">"Waiting for recovery to complete..."</span> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l02123"></a>02123       <a class="code" href="class_hypertable_1_1_range_server.html#0c1595ad6ee450d2127e2c86bbf07611">m_replay_finished_cond</a>.wait(lock);
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125   }
<a name="l02126"></a>02126 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Aug 15 08:52:20 2009 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
