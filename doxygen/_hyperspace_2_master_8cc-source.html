<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hyperspace/Master.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_baadc7c4b53cf4594df7618997f6c732.html">Hyperspace</a></div>
<h1>Master.cc</h1><a href="_hyperspace_2_master_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> {
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;poll.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/xattr.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00035"></a>00035 }
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include "<a class="code" href="_error_8h.html">Common/Error.h</a>"</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include "<a class="code" href="_file_utils_8h.html">Common/FileUtils.h</a>"</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include "<a class="code" href="_string_ext_8h.html">Common/StringExt.h</a>"</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="_system_8h.html">Common/System.h</a>"</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="_dfs_broker_2_lib_2_client_8h.html">DfsBroker/Lib/Client.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="_schema_8h.html">Hypertable/Lib/Schema.h</a>"</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="_hyperspace_2_event_8h.html">Event.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="_notification_8h.html">Notification.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="_hyperspace_2_master_8h.html">Master.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="_session_8h.html">Session.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="_session_data_8h.html">SessionData.h</a>"</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">using namespace </span>Hypertable;
<a name="l00052"></a>00052 <span class="keyword">using namespace </span>Hyperspace;
<a name="l00053"></a>00053 <span class="keyword">using namespace </span>std;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">const</span> uint32_t Master::DEFAULT_MASTER_PORT;
<a name="l00056"></a>00056 <span class="keyword">const</span> uint32_t Master::DEFAULT_LEASE_INTERVAL;
<a name="l00057"></a>00057 <span class="keyword">const</span> uint32_t Master::DEFAULT_KEEPALIVE_INTERVAL;
<a name="l00058"></a>00058 
<a name="l00066"></a><a class="code" href="class_hyperspace_1_1_master.html#956af82223217fe754110710258621d3">00066</a> Master::Master(<a class="code" href="namespace_hypertable.html#e048a08bc9bd9505788d6e5823c948ae">ConnectionManagerPtr</a> &amp;connManagerPtr, <a class="code" href="namespace_hypertable.html#8c3eeb0c64dcf09ba41222b111894c12">PropertiesPtr</a> &amp;propsPtr, <a class="code" href="namespace_hyperspace.html#3e886fe6754f12ba9f134097157d2673">ServerKeepaliveHandlerPtr</a> &amp;keepaliveHandlerPtr) : m_verbose(false), m_next_handle_number(1), m_next_session_id(1) {
<a name="l00067"></a>00067   <span class="keyword">const</span> <span class="keywordtype">char</span> *dirname;
<a name="l00068"></a>00068   std::string str;
<a name="l00069"></a>00069   ssize_t xattrLen;
<a name="l00070"></a>00070   uint16_t port;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   <a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a> = propsPtr-&gt;get_bool(<span class="stringliteral">"Hypertable.Verbose"</span>, <span class="keyword">false</span>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074   <a class="code" href="class_hyperspace_1_1_master.html#78f7694247f776086456eaaae1fefd5b">m_lease_interval</a> = (uint32_t)propsPtr-&gt;get_int(<span class="stringliteral">"Hyperspace.Lease.Interval"</span>, <a class="code" href="class_hyperspace_1_1_master.html#85ba0ea52e3bcd34e7ea1696d5e37d7b">DEFAULT_LEASE_INTERVAL</a>);
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <a class="code" href="class_hyperspace_1_1_master.html#aa0d1cd2ea51b5ea02f4f2b2e48c7e23">m_keep_alive_interval</a> = (uint32_t)propsPtr-&gt;get_int(<span class="stringliteral">"Hyperspace.KeepAlive.Interval"</span>, <a class="code" href="class_hyperspace_1_1_master.html#5e0f7d47fdda5ded7aa6a9ba6d4598a1">DEFAULT_KEEPALIVE_INTERVAL</a>);
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="keywordflow">if</span> ((dirname = propsPtr-&gt;get(<span class="stringliteral">"Hyperspace.Master.Dir"</span>, 0)) == 0) {
<a name="l00079"></a>00079     <a class="code" href="_logger_8h.html#921dd3a93ee580255a43ff2160a38109">HT_ERROR</a>(<span class="stringliteral">"Property 'Hyperspace.Master.Dir' not found."</span>);
<a name="l00080"></a>00080     exit(1);
<a name="l00081"></a>00081   }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083   <span class="keywordflow">if</span> (dirname[strlen(dirname)-1] == <span class="charliteral">'/'</span>)
<a name="l00084"></a>00084     str = std::string(dirname, strlen(dirname)-1);
<a name="l00085"></a>00085   <span class="keywordflow">else</span>
<a name="l00086"></a>00086     str = dirname;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordflow">if</span> (dirname[0] == <span class="charliteral">'/'</span>)
<a name="l00089"></a>00089     <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> = str;
<a name="l00090"></a>00090   <span class="keywordflow">else</span>
<a name="l00091"></a>00091     <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> = System::installDir + <span class="stringliteral">"/"</span> + str;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   <span class="keywordflow">if</span> ((<a class="code" href="class_hyperspace_1_1_master.html#fa4b03cf5f97b0311bf2ff5caa71e9ca">m_base_fd</a> = ::<a class="code" href="class_hyperspace_1_1_master.html#3450dd11430c81890fe28a463a45dff3" title="Open.">open</a>(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), O_RDONLY)) &lt; 0) {
<a name="l00094"></a>00094     <a class="code" href="_logger_8h.html#709eda39b0584732f8c822dfdada36f7">HT_WARNF</a>(<span class="stringliteral">"Unable to open base directory '%s' - will create."</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (!FileUtils::mkdirs(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str())) {
<a name="l00096"></a>00096       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Unable to create base directory %s - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00097"></a>00097       exit(1);
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099     <span class="keywordflow">if</span> ((<a class="code" href="class_hyperspace_1_1_master.html#fa4b03cf5f97b0311bf2ff5caa71e9ca">m_base_fd</a> = ::<a class="code" href="class_hyperspace_1_1_master.html#3450dd11430c81890fe28a463a45dff3" title="Open.">open</a>(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), O_RDONLY)) &lt; 0) {
<a name="l00100"></a>00100       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Unable to open base directory %s - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00101"></a>00101       exit(1);
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103   }
<a name="l00104"></a>00104 
<a name="l00108"></a>00108   <span class="keywordflow">if</span> (flock(<a class="code" href="class_hyperspace_1_1_master.html#fa4b03cf5f97b0311bf2ff5caa71e9ca">m_base_fd</a>, LOCK_EX | LOCK_NB) != 0) {
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (errno == EWOULDBLOCK) {
<a name="l00110"></a>00110       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Base directory '%s' is locked by another process."</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str());
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112     <span class="keywordflow">else</span> {
<a name="l00113"></a>00113       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Unable to lock base directory '%s' - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     exit(1);
<a name="l00116"></a>00116   }
<a name="l00117"></a>00117 
<a name="l00121"></a>00121   <span class="keywordflow">if</span> ((xattrLen = FileUtils::getxattr(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), <span class="stringliteral">"generation"</span>, &amp;<a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a>, <span class="keyword">sizeof</span>(uint32_t))) &lt; 0) {
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (errno == ENOATTR) {
<a name="l00123"></a>00123       cerr &lt;&lt; <span class="stringliteral">"'generation' attribute not found on base dir, creating ..."</span> &lt;&lt; endl;
<a name="l00124"></a>00124       <a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a> = 1;
<a name="l00125"></a>00125       <span class="keywordflow">if</span> (FileUtils::setxattr(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), <span class="stringliteral">"generation"</span>, &amp;<a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a>, <span class="keyword">sizeof</span>(uint32_t), XATTR_CREATE) == -1) {
<a name="l00126"></a>00126         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'generation' on base dir '%s' - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00127"></a>00127         exit(1);
<a name="l00128"></a>00128       }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     <span class="keywordflow">else</span> {
<a name="l00131"></a>00131       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Unable to read extended attribute 'generation' on base dir '%s' - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00132"></a>00132       exit(1);
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135   <span class="keywordflow">else</span> {
<a name="l00136"></a>00136     <a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a>++;
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (FileUtils::setxattr(<a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), <span class="stringliteral">"generation"</span>, &amp;<a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a>, <span class="keyword">sizeof</span>(uint32_t), XATTR_REPLACE) == -1) {
<a name="l00138"></a>00138       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'generation' on base dir '%s' - %s"</span>, <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a>.c_str(), strerror(errno));
<a name="l00139"></a>00139       exit(1);
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141   }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> rootNodePtr = <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_node_data.html">NodeData</a>();
<a name="l00144"></a>00144   rootNodePtr-&gt;name = <span class="stringliteral">"/"</span>;
<a name="l00145"></a>00145   <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>[<span class="stringliteral">"/"</span>] = rootNodePtr;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   port = propsPtr-&gt;get_int(<span class="stringliteral">"Hyperspace.Master.Port"</span>, <a class="code" href="class_hyperspace_1_1_master.html#359887d9840acd73850aafa567ef0034">DEFAULT_MASTER_PORT</a>);
<a name="l00148"></a>00148   <a class="code" href="namespace_hypertable_1_1_logger.html#0886f5be21dbafebc5a9d0724aed33d5">InetAddr::initialize</a>(&amp;<a class="code" href="class_hyperspace_1_1_master.html#5d57a150539189795c452165d8dd3615">m_local_addr</a>, INADDR_ANY, port);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150   <a class="code" href="class_hyperspace_1_1_master.html#fc45c1592d3ac18c2d2812900c2e29c6">m_keepalive_handler_ptr</a>.reset( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_server_keepalive_handler.html">ServerKeepaliveHandler</a>(connManagerPtr-&gt;get_comm(), <span class="keyword">this</span>) );
<a name="l00151"></a>00151   keepaliveHandlerPtr = <a class="code" href="class_hyperspace_1_1_master.html#fc45c1592d3ac18c2d2812900c2e29c6">m_keepalive_handler_ptr</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00154"></a>00154     cout &lt;&lt; <span class="stringliteral">"Hyperspace.Lease.Interval="</span> &lt;&lt; <a class="code" href="class_hyperspace_1_1_master.html#78f7694247f776086456eaaae1fefd5b">m_lease_interval</a> &lt;&lt; endl;
<a name="l00155"></a>00155     cout &lt;&lt; <span class="stringliteral">"Hyperspace.KeepAlive.Interval="</span> &lt;&lt; <a class="code" href="class_hyperspace_1_1_master.html#aa0d1cd2ea51b5ea02f4f2b2e48c7e23">m_keep_alive_interval</a> &lt;&lt; endl;
<a name="l00156"></a>00156     cout &lt;&lt; <span class="stringliteral">"Hyperspace.Master.Dir="</span> &lt;&lt; <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> &lt;&lt; endl;
<a name="l00157"></a>00157     cout &lt;&lt; <span class="stringliteral">"Generation="</span> &lt;&lt; <a class="code" href="class_hyperspace_1_1_master.html#61be2490ab22f16ad3f77b30cf2ab387">m_generation</a> &lt;&lt; endl;
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="class_hyperspace_1_1_master.html#20f70958ed75532ba672af1b780f59eb">00163</a> <a class="code" href="class_hyperspace_1_1_master.html#20f70958ed75532ba672af1b780f59eb">Master::~Master</a>() {<a class="code" href="class_hyperspace_1_1_master.html#0e3ef8b78c4c8825a9ea7bcb769f552e"></a>
<a name="l00164"></a>00164 <a class="code" href="class_hyperspace_1_1_master.html#0e3ef8b78c4c8825a9ea7bcb769f552e">  ::close</a>(<a class="code" href="class_hyperspace_1_1_master.html#fa4b03cf5f97b0311bf2ff5caa71e9ca">m_base_fd</a>);
<a name="l00165"></a>00165   <span class="keywordflow">return</span>;
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="class_hyperspace_1_1_master.html#56daab02dae50f0b0facb14ba268911f">00169</a> uint64_t <a class="code" href="class_hyperspace_1_1_master.html#56daab02dae50f0b0facb14ba268911f" title="Creates a new session by allocating a new SessionData object, obtaining a new session...">Master::create_session</a>(<span class="keyword">struct</span> sockaddr_in &amp;addr) {
<a name="l00170"></a>00170   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#d278d8aafc97c4d91ca85bb1387591b7">m_session_map_mutex</a>);
<a name="l00171"></a>00171   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00172"></a>00172   uint64_t sessionId = <a class="code" href="class_hyperspace_1_1_master.html#31fbb7aaa2a6575f541414c17e94036a">m_next_session_id</a>++;
<a name="l00173"></a>00173   sessionPtr = <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_session_data.html">SessionData</a>(addr, <a class="code" href="class_hyperspace_1_1_master.html#78f7694247f776086456eaaae1fefd5b">m_lease_interval</a>, sessionId);
<a name="l00174"></a>00174   <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>[sessionId] = sessionPtr;
<a name="l00175"></a>00175   <a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.push_back(sessionPtr);
<a name="l00176"></a>00176   <span class="keywordflow">return</span> sessionId;
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 
<a name="l00180"></a><a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42">00180</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">Master::get_session</a>(uint64_t sessionId, <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> &amp;sessionPtr) {
<a name="l00181"></a>00181   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#d278d8aafc97c4d91ca85bb1387591b7">m_session_map_mutex</a>);
<a name="l00182"></a>00182   SessionMapT::iterator iter = <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.find(sessionId);
<a name="l00183"></a>00183   <span class="keywordflow">if</span> (iter == <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.end())
<a name="l00184"></a>00184     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00185"></a>00185   sessionPtr = (*iter).second;
<a name="l00186"></a>00186   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="class_hyperspace_1_1_master.html#e0f0f5042b33d761466f71309951682a">00189</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#e0f0f5042b33d761466f71309951682a">Master::destroy_session</a>(uint64_t sessionId) {
<a name="l00190"></a>00190   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#d278d8aafc97c4d91ca85bb1387591b7">m_session_map_mutex</a>);
<a name="l00191"></a>00191   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00192"></a>00192   SessionMapT::iterator iter = <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.find(sessionId);
<a name="l00193"></a>00193   <span class="keywordflow">if</span> (iter == <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.end())
<a name="l00194"></a>00194     <span class="keywordflow">return</span>;
<a name="l00195"></a>00195   sessionPtr = (*iter).second;
<a name="l00196"></a>00196   <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.erase(sessionId);
<a name="l00197"></a>00197   sessionPtr-&gt;expire();
<a name="l00198"></a>00198   <span class="comment">// force it to top of expiration heap</span>
<a name="l00199"></a>00199   boost::xtime_get(&amp;sessionPtr-&gt;expireTime, boost::TIME_UTC);
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 
<a name="l00203"></a><a class="code" href="class_hyperspace_1_1_master.html#a603e0921663151fb1401e45b5fd9271">00203</a> <span class="keywordtype">int</span> <a class="code" href="class_hyperspace_1_1_master.html#a603e0921663151fb1401e45b5fd9271" title="Attempts to renew the session lease for session with the given ID.">Master::renew_session_lease</a>(uint64_t sessionId) {
<a name="l00204"></a>00204   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#d278d8aafc97c4d91ca85bb1387591b7">m_session_map_mutex</a>);  
<a name="l00205"></a>00205 
<a name="l00206"></a>00206   SessionMapT::iterator iter = <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.find(sessionId);
<a name="l00207"></a>00207   <span class="keywordflow">if</span> (iter == <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.end())
<a name="l00208"></a>00208     <span class="keywordflow">return</span> <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <span class="keywordflow">if</span> (!(*iter).second-&gt;renew_lease())
<a name="l00211"></a>00211     <span class="keywordflow">return</span> <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   <span class="keywordflow">return</span> <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>;
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="class_hyperspace_1_1_master.html#ef909ac89ebdd7ddb6d1d6cdd6617f96">00216</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#ef909ac89ebdd7ddb6d1d6cdd6617f96">Master::next_expired_session</a>(<a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> &amp;sessionPtr) {
<a name="l00217"></a>00217   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#d278d8aafc97c4d91ca85bb1387591b7">m_session_map_mutex</a>);
<a name="l00218"></a>00218   <span class="keyword">struct </span><a class="code" href="struct_hyperspace_1_1lt_session_data.html">ltSessionData</a> compFunc;
<a name="l00219"></a>00219   boost::xtime now;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   boost::xtime_get(&amp;now, boost::TIME_UTC);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.size() &gt; 0) {
<a name="l00224"></a>00224     std::make_heap(<a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.begin(), <a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.end(), compFunc);
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>[0]-&gt;is_expired(now)) {
<a name="l00226"></a>00226       sessionPtr = <a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>[0];
<a name="l00227"></a>00227       std::pop_heap(<a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.begin(), <a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.end(), compFunc);
<a name="l00228"></a>00228       <a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.resize(<a class="code" href="class_hyperspace_1_1_master.html#b5177498a5d3267ec14bbb36071e3006">m_session_heap</a>.size()-1);
<a name="l00229"></a>00229       <a class="code" href="class_hyperspace_1_1_master.html#84ec72b900ec1967ff488abf5675279b">m_session_map</a>.erase(sessionPtr-&gt;id);
<a name="l00230"></a>00230       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00231"></a>00231     }    
<a name="l00232"></a>00232   }
<a name="l00233"></a>00233   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00240"></a><a class="code" href="class_hyperspace_1_1_master.html#ff4b480032f1e1efeb10bb8276c00e57">00240</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#ff4b480032f1e1efeb10bb8276c00e57">Master::remove_expired_sessions</a>() {
<a name="l00241"></a>00241   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00242"></a>00242   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00243"></a>00243   std::string errMsg;
<a name="l00244"></a>00244   
<a name="l00245"></a>00245   <span class="keywordflow">while</span> (<a class="code" href="class_hyperspace_1_1_master.html#ef909ac89ebdd7ddb6d1d6cdd6617f96">next_expired_session</a>(sessionPtr)) {
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00248"></a>00248       <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Expiring session %lld"</span>, sessionPtr-&gt;id);
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     sessionPtr-&gt;expire();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     {
<a name="l00254"></a>00254       boost::mutex::scoped_lock slock(sessionPtr-&gt;mutex);
<a name="l00255"></a>00255       <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00256"></a>00256       <span class="keywordflow">for</span> (set&lt;uint64_t&gt;::iterator iter = sessionPtr-&gt;handles.begin(); iter != sessionPtr-&gt;handles.end(); iter++) {
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00258"></a>00258           <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"Destroying handle %lld"</span>, *iter);
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260         <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#1fa21ff1fa94cab4baed30b36034b6f2">destroy_handle</a>(*iter, &amp;error, errMsg, <span class="keyword">false</span>)) {
<a name="l00261"></a>00261           <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem destroying handle - %s (%s)"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error), errMsg.c_str());
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263       }
<a name="l00264"></a>00264       sessionPtr-&gt;handles.clear();
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266   }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00274"></a><a class="code" href="class_hyperspace_1_1_master.html#5e909d404b996afece1431c00e63e65b">00274</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#5e909d404b996afece1431c00e63e65b">Master::create_handle</a>(uint64_t *handlep, <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr) {
<a name="l00275"></a>00275   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#08708caf5e61a7ca0fd5194607c9d591">m_handle_map_mutex</a>);
<a name="l00276"></a>00276   *handlep = ++<a class="code" href="class_hyperspace_1_1_master.html#380fec971fede649713239226a71c73c">m_next_handle_number</a>;
<a name="l00277"></a>00277   handlePtr = <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_handle_data.html">HandleData</a>();
<a name="l00278"></a>00278   handlePtr-&gt;id = *handlep;
<a name="l00279"></a>00279   handlePtr-&gt;locked = <span class="keyword">false</span>;
<a name="l00280"></a>00280   <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>[*handlep] = handlePtr;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00286"></a><a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">00286</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">Master::get_handle_data</a>(uint64_t handle, <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr) {
<a name="l00287"></a>00287   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#08708caf5e61a7ca0fd5194607c9d591">m_handle_map_mutex</a>);
<a name="l00288"></a>00288   HandleMapT::iterator iter = <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>.find(handle);
<a name="l00289"></a>00289   <span class="keywordflow">if</span> (iter == <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>.end())
<a name="l00290"></a>00290     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00291"></a>00291   handlePtr = (*iter).second;
<a name="l00292"></a>00292   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00298"></a><a class="code" href="class_hyperspace_1_1_master.html#0cddc709db5afce8e1999104033bdade">00298</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#0cddc709db5afce8e1999104033bdade">Master::remove_handle_data</a>(uint64_t handle, <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr) {
<a name="l00299"></a>00299   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#08708caf5e61a7ca0fd5194607c9d591">m_handle_map_mutex</a>);
<a name="l00300"></a>00300   HandleMapT::iterator iter = <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>.find(handle);
<a name="l00301"></a>00301   <span class="keywordflow">if</span> (iter == <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>.end())
<a name="l00302"></a>00302     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00303"></a>00303   handlePtr = (*iter).second;
<a name="l00304"></a>00304   <a class="code" href="class_hyperspace_1_1_master.html#2916c2864ab1fc4075d4ece0f517e345">m_handle_map</a>.erase(iter);
<a name="l00305"></a>00305   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 
<a name="l00314"></a><a class="code" href="class_hyperspace_1_1_master.html#ad89f05cb7592ad720d9bd6b4ae72a2b">00314</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#ad89f05cb7592ad720d9bd6b4ae72a2b" title="This method creates a directory with absolute path &amp;#39;name&amp;#39;.">Master::mkdir</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, <span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00315"></a>00315   std::string absName;
<a name="l00316"></a>00316   <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> parentNodePtr;
<a name="l00317"></a>00317   std::string childName;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00320"></a>00320     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"mkdir(sessionId=%lld, name=%s)"</span>, sessionId, name);
<a name="l00321"></a>00321   }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76" title="Locates the parent &amp;#39;node&amp;#39; of the given pathname.">find_parent_node</a>(name, parentNodePtr, childName)) {
<a name="l00324"></a>00324     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26b8a455adfa95b9c7036a395d5d5e2f2">Error::HYPERSPACE_FILE_EXISTS</a>, <span class="stringliteral">"directory '/' exists"</span>);
<a name="l00325"></a>00325     <span class="keywordflow">return</span>;
<a name="l00326"></a>00326   }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   assert(name[0] == <span class="charliteral">'/'</span> &amp;&amp; name[strlen(name)-1] != <span class="charliteral">'/'</span>);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   {
<a name="l00331"></a>00331     boost::mutex::scoped_lock nodeLock(parentNodePtr-&gt;mutex);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     absName = <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> + name;
<a name="l00334"></a>00334     
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (::<a class="code" href="class_hyperspace_1_1_master.html#ad89f05cb7592ad720d9bd6b4ae72a2b" title="This method creates a directory with absolute path &amp;#39;name&amp;#39;.">mkdir</a>(absName.c_str(), 0755) &lt; 0) {
<a name="l00336"></a>00336       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00337"></a>00337       <span class="keywordflow">return</span>;
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339     <span class="keywordflow">else</span> {
<a name="l00340"></a>00340       <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f5977454aa828131048d44521b94589b2aef">EVENT_MASK_CHILD_NODE_ADDED</a>, childName) );
<a name="l00341"></a>00341       <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(parentNodePtr.get(), eventPtr);
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343   }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 
<a name="l00353"></a><a class="code" href="class_hyperspace_1_1_master.html#79329c126c6ee68ebb62262b36831090">00353</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#79329c126c6ee68ebb62262b36831090" title="Delete.">Master::unlink</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, <span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00354"></a>00354   std::string absName;
<a name="l00355"></a>00355   <span class="keyword">struct </span>stat statbuf;
<a name="l00356"></a>00356   std::string childName;
<a name="l00357"></a>00357   <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> parentNodePtr;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00360"></a>00360     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"unlink(sessionId=%lld, name=%s)"</span>, sessionId, name);
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="keywordflow">if</span> (!strcmp(name, <span class="stringliteral">"/"</span>)) {
<a name="l00364"></a>00364     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b27085d1fbbde510ecf9a285113cc62406">Error::HYPERSPACE_PERMISSION_DENIED</a>, <span class="stringliteral">"Cannot remove '/' directory"</span>);
<a name="l00365"></a>00365     <span class="keywordflow">return</span>;
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76" title="Locates the parent &amp;#39;node&amp;#39; of the given pathname.">find_parent_node</a>(name, parentNodePtr, childName)) {
<a name="l00369"></a>00369     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b280d6ae041bebcdd03e0c06a63f553eb6">Error::HYPERSPACE_BAD_PATHNAME</a>, name);
<a name="l00370"></a>00370     <span class="keywordflow">return</span>;
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   assert(name[0] == <span class="charliteral">'/'</span> &amp;&amp; name[strlen(name)-1] != <span class="charliteral">'/'</span>);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   {
<a name="l00376"></a>00376     boost::mutex::scoped_lock nodeLock(parentNodePtr-&gt;mutex);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     absName = <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> + name;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (stat(absName.c_str(), &amp;statbuf) &lt; 0) {
<a name="l00381"></a>00381       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00382"></a>00382       <span class="keywordflow">return</span>;
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384     <span class="keywordflow">else</span> {
<a name="l00385"></a>00385       <span class="keywordflow">if</span> (statbuf.st_mode &amp; S_IFDIR) {
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (rmdir(absName.c_str()) &lt; 0) {
<a name="l00387"></a>00387           <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00388"></a>00388           <span class="keywordflow">return</span>;
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390       }
<a name="l00391"></a>00391       <span class="keywordflow">else</span> {
<a name="l00392"></a>00392         <span class="keywordflow">if</span> (::<a class="code" href="class_hyperspace_1_1_master.html#79329c126c6ee68ebb62262b36831090" title="Delete.">unlink</a>(absName.c_str()) &lt; 0) {
<a name="l00393"></a>00393           <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00394"></a>00394           <span class="keywordflow">return</span>;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396       }
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">// deliver event notifications</span>
<a name="l00400"></a>00400     {
<a name="l00401"></a>00401       <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f597bdb816ac6d2ec117efa256a8984c3404">EVENT_MASK_CHILD_NODE_REMOVED</a>, childName) );
<a name="l00402"></a>00402       <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(parentNodePtr.get(), eventPtr);
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 
<a name="l00415"></a><a class="code" href="class_hyperspace_1_1_master.html#3450dd11430c81890fe28a463a45dff3">00415</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#3450dd11430c81890fe28a463a45dff3" title="Open.">Master::open</a>(<a class="code" href="class_hyperspace_1_1_response_callback_open.html">ResponseCallbackOpen</a> *cb, uint64_t sessionId, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, uint32_t flags, uint32_t eventMask, std::vector&lt;AttributeT&gt; &amp;initAttrs) {
<a name="l00416"></a>00416   std::string absName;
<a name="l00417"></a>00417   std::string childName;
<a name="l00418"></a>00418   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00419"></a>00419   <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> nodePtr;
<a name="l00420"></a>00420   <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> parentNodePtr;
<a name="l00421"></a>00421   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00422"></a>00422   <span class="keywordtype">bool</span> created = <span class="keyword">false</span>;
<a name="l00423"></a>00423   <span class="keywordtype">bool</span> isDirectory = <span class="keyword">false</span>;
<a name="l00424"></a>00424   <span class="keywordtype">bool</span> existed;
<a name="l00425"></a>00425   uint64_t handle;
<a name="l00426"></a>00426   <span class="keyword">struct </span>stat statbuf;
<a name="l00427"></a>00427   <span class="keywordtype">int</span> oflags = 0;
<a name="l00428"></a>00428   ssize_t <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>;
<a name="l00429"></a>00429   <span class="keywordtype">bool</span> lockNotify = <span class="keyword">false</span>;
<a name="l00430"></a>00430   uint32_t lockMode = 0;
<a name="l00431"></a>00431   uint64_t lockGeneration = 0;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00434"></a>00434     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"open(sessionId=%lld, fname=%s, flags=0x%x, eventMask=0x%x)"</span>, sessionId, name, flags, eventMask);
<a name="l00435"></a>00435     cout &lt;&lt; <a class="code" href="namespace_hypertable_1_1_logger.html#2c3eba91176547027114524d91a37a50">flush</a>;
<a name="l00436"></a>00436   }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   assert(name[0] == <span class="charliteral">'/'</span>);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   absName = <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> + name;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00443"></a>00443     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00444"></a>00444     <span class="keywordflow">return</span>;
<a name="l00445"></a>00445   }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76" title="Locates the parent &amp;#39;node&amp;#39; of the given pathname.">find_parent_node</a>(name, parentNodePtr, childName)) {
<a name="l00448"></a>00448     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b280d6ae041bebcdd03e0c06a63f553eb6">Error::HYPERSPACE_BAD_PATHNAME</a>, name);
<a name="l00449"></a>00449     <span class="keywordflow">return</span>;
<a name="l00450"></a>00450   }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="comment">// If path name to open is "/", then create a dummy NodeData object for</span>
<a name="l00453"></a>00453   <span class="comment">// the parent because the previous call will return the node itself as</span>
<a name="l00454"></a>00454   <span class="comment">// the parent, causing the second of the following two mutex locks to hang</span>
<a name="l00455"></a>00455   <span class="keywordflow">if</span> (!strcmp(name, <span class="stringliteral">"/"</span>))
<a name="l00456"></a>00456     parentNodePtr = <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_node_data.html">NodeData</a>();
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   <a class="code" href="class_hyperspace_1_1_master.html#ff1ec2cfae047970907e8ae624320ae4" title="Safely obtains the node with the given pathname from the NodeMap, creating one and...">get_node</a>(name, nodePtr);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   {
<a name="l00461"></a>00461     boost::mutex::scoped_lock parentLock(parentNodePtr-&gt;mutex);
<a name="l00462"></a>00462     boost::mutex::scoped_lock nodeLock(nodePtr-&gt;mutex);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac24703749af526604b052b73f18444af250b419a8" title="Atomically open and lock file shared, fail if can&amp;#39;t.">OPEN_FLAG_LOCK_SHARED</a>) == OPEN_FLAG_LOCK_SHARED) {
<a name="l00465"></a>00465       <span class="keywordflow">if</span> (nodePtr-&gt;exclusiveLockHandle != 0) {
<a name="l00466"></a>00466         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2049235d4d2b6cb0a79f8dc104ea01c75">Error::HYPERSPACE_LOCK_CONFLICT</a>, <span class="stringliteral">""</span>);
<a name="l00467"></a>00467         <span class="keywordflow">return</span>;
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469       lockMode = <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>;
<a name="l00470"></a>00470       <span class="keywordflow">if</span> (nodePtr-&gt;sharedLockHandles.empty())
<a name="l00471"></a>00471         lockNotify = <span class="keyword">true</span>;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac2470374991ab02931b9ea3d82697bfdbc45897fd" title="atomically open and lock file exclusive, fail if can&amp;#39;t">OPEN_FLAG_LOCK_EXCLUSIVE</a>) == OPEN_FLAG_LOCK_EXCLUSIVE) {
<a name="l00474"></a>00474       <span class="keywordflow">if</span> (nodePtr-&gt;exclusiveLockHandle != 0 || !nodePtr-&gt;sharedLockHandles.empty()) {
<a name="l00475"></a>00475         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2049235d4d2b6cb0a79f8dc104ea01c75">Error::HYPERSPACE_LOCK_CONFLICT</a>, <span class="stringliteral">""</span>);
<a name="l00476"></a>00476         <span class="keywordflow">return</span>;
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478       lockMode = <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>;
<a name="l00479"></a>00479       lockNotify = <span class="keyword">true</span>;
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (stat(absName.c_str(), &amp;statbuf) != 0) {
<a name="l00483"></a>00483       <span class="keywordflow">if</span> (errno == ENOENT)
<a name="l00484"></a>00484         existed = <span class="keyword">false</span>;
<a name="l00485"></a>00485       <span class="keywordflow">else</span> {
<a name="l00486"></a>00486         <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00487"></a>00487         <span class="keywordflow">return</span>;
<a name="l00488"></a>00488       }
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490     <span class="keywordflow">else</span> {
<a name="l00491"></a>00491       existed = <span class="keyword">true</span>;
<a name="l00492"></a>00492       <span class="keywordflow">if</span> (statbuf.st_mode &amp; S_IFDIR) {
<a name="l00497"></a>00497         isDirectory = <span class="keyword">true</span>;
<a name="l00498"></a>00498         oflags = O_RDONLY;
<a name="l00499"></a>00499 <span class="preprocessor">#if defined(__linux__)</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>        oflags |= O_DIRECTORY;
<a name="l00501"></a>00501 <span class="preprocessor">#endif</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>      }
<a name="l00503"></a>00503     }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="keywordflow">if</span> (!isDirectory)
<a name="l00506"></a>00506       oflags = O_RDWR;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="keywordflow">if</span> (existed &amp;&amp; (flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac24703749f848fd6c46eb9eac3931523edd9df8af" title="Create file if it does not exist.">OPEN_FLAG_CREATE</a>) &amp;&amp; (flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac247037493ccd192d153eca9bf368bfd29f838a18" title="Error if create and file exists.">OPEN_FLAG_EXCL</a>)) {
<a name="l00509"></a>00509       cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26b8a455adfa95b9c7036a395d5d5e2f2">Error::HYPERSPACE_FILE_EXISTS</a>, <span class="stringliteral">"mode=CREATE|EXCL"</span>);
<a name="l00510"></a>00510       <span class="keywordflow">return</span>;
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (nodePtr-&gt;fd &lt; 0) {
<a name="l00514"></a>00514 
<a name="l00515"></a>00515       <span class="keywordflow">if</span> (existed &amp;&amp; (flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac24703749d15bd5e99b1bf3cdc5566e1b99e1dfac" title="Used in conjunction with CREATE to create an ephemeral file.">OPEN_FLAG_TEMP</a>)) {
<a name="l00516"></a>00516         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26b8a455adfa95b9c7036a395d5d5e2f2">Error::HYPERSPACE_FILE_EXISTS</a>, <span class="stringliteral">"Unable to open TEMP file because it exists and is permanent"</span>);
<a name="l00517"></a>00517         <span class="keywordflow">return</span>;
<a name="l00518"></a>00518       }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (!existed) {
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (flags &amp; OPEN_FLAG_CREATE)
<a name="l00522"></a>00522           oflags |= O_CREAT;
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (flags &amp; OPEN_FLAG_EXCL)
<a name="l00524"></a>00524           oflags |= O_EXCL;
<a name="l00525"></a>00525       }
<a name="l00526"></a>00526       nodePtr-&gt;fd =<a class="code" href="class_hyperspace_1_1_master.html#3450dd11430c81890fe28a463a45dff3" title="Open."> ::open</a>(absName.c_str(), oflags, 0644);
<a name="l00527"></a>00527       <span class="keywordflow">if</span> (nodePtr-&gt;fd &lt; 0) {
<a name="l00528"></a>00528         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"open(%s, 0x%x, 0644) failed (errno=%d) - %s"</span>, absName.c_str(), oflags, errno, strerror(errno));
<a name="l00529"></a>00529         <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00530"></a>00530         <span class="keywordflow">return</span>;
<a name="l00531"></a>00531       }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533       <span class="comment">// Read/create 'lock.generation' attribute</span>
<a name="l00534"></a>00534 
<a name="l00535"></a>00535       len = FileUtils::fgetxattr(nodePtr-&gt;fd, <span class="stringliteral">"lock.generation"</span>, &amp;nodePtr-&gt;lockGeneration, <span class="keyword">sizeof</span>(uint64_t));
<a name="l00536"></a>00536       <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (errno == ENOATTR) {
<a name="l00538"></a>00538           nodePtr-&gt;lockGeneration = 1;
<a name="l00539"></a>00539           <span class="keywordflow">if</span> (FileUtils::fsetxattr(nodePtr-&gt;fd, <span class="stringliteral">"lock.generation"</span>, &amp;nodePtr-&gt;lockGeneration, <span class="keyword">sizeof</span>(uint64_t), 0) == -1) {
<a name="l00540"></a>00540             <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'lock.generation' on file '%s' - %s"</span>,
<a name="l00541"></a>00541                          name, strerror(errno));
<a name="l00542"></a>00542             <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00543"></a>00543           }
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545         <span class="keywordflow">else</span> {
<a name="l00546"></a>00546           <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem reading extended attribute 'lock.generation' on file '%s' - %s"</span>,
<a name="l00547"></a>00547                        name, strerror(errno));
<a name="l00548"></a>00548           <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         len = <span class="keyword">sizeof</span>(int64_t);
<a name="l00551"></a>00551       }
<a name="l00552"></a>00552       assert(len == <span class="keyword">sizeof</span>(int64_t));
<a name="l00553"></a>00553 
<a name="l00557"></a>00557       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;initAttrs.size(); i++) {
<a name="l00558"></a>00558         <span class="keywordflow">if</span> (FileUtils::fsetxattr(nodePtr-&gt;fd, initAttrs[i].name, initAttrs[i].value, initAttrs[i].valueLen, 0) == -1) {
<a name="l00559"></a>00559           <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute '%s' on file '%s' - %s"</span>,
<a name="l00560"></a>00560                        initAttrs[i].name, name, strerror(errno));
<a name="l00561"></a>00561           <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563       }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="keywordflow">if</span> (flags &amp; OPEN_FLAG_TEMP) {
<a name="l00566"></a>00566         nodePtr-&gt;ephemeral = <span class="keyword">true</span>;<a class="code" href="class_hyperspace_1_1_master.html#79329c126c6ee68ebb62262b36831090" title="Delete."></a>
<a name="l00567"></a>00567 <a class="code" href="class_hyperspace_1_1_master.html#79329c126c6ee68ebb62262b36831090" title="Delete.">	::unlink</a>(absName.c_str());
<a name="l00568"></a>00568       }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     <span class="keywordflow">else</span> {
<a name="l00572"></a>00572       <span class="keywordflow">if</span> (existed &amp;&amp; (flags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac24703749d15bd5e99b1bf3cdc5566e1b99e1dfac" title="Used in conjunction with CREATE to create an ephemeral file.">OPEN_FLAG_TEMP</a>) &amp;&amp; !nodePtr-&gt;ephemeral) {
<a name="l00573"></a>00573         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26b8a455adfa95b9c7036a395d5d5e2f2">Error::HYPERSPACE_FILE_EXISTS</a>, <span class="stringliteral">"Unable to open TEMP file because it exists and is permanent"</span>);
<a name="l00574"></a>00574         <span class="keywordflow">return</span>;
<a name="l00575"></a>00575       }
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (!existed)
<a name="l00579"></a>00579       created = <span class="keyword">true</span>;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <a class="code" href="class_hyperspace_1_1_master.html#5e909d404b996afece1431c00e63e65b">create_handle</a>(&amp;handle, handlePtr);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     handlePtr-&gt;node = nodePtr.get();
<a name="l00584"></a>00584     handlePtr-&gt;openFlags = flags;
<a name="l00585"></a>00585     handlePtr-&gt;eventMask = eventMask;
<a name="l00586"></a>00586     handlePtr-&gt;sessionPtr = sessionPtr;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     sessionPtr-&gt;add_handle(handle);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="keywordflow">if</span> (created) {
<a name="l00591"></a>00591       <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f5977454aa828131048d44521b94589b2aef">EVENT_MASK_CHILD_NODE_ADDED</a>, childName) );
<a name="l00592"></a>00592       <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(parentNodePtr.get(), eventPtr);
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (lockMode != 0) {
<a name="l00599"></a>00599       handlePtr-&gt;node-&gt;lockGeneration++;
<a name="l00600"></a>00600       <span class="keywordflow">if</span> (FileUtils::fsetxattr(handlePtr-&gt;node-&gt;fd, <span class="stringliteral">"lock.generation"</span>, &amp;handlePtr-&gt;node-&gt;lockGeneration, <span class="keyword">sizeof</span>(uint64_t), 0) == -1) {
<a name="l00601"></a>00601         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'lock.generation' on file '%s' - %s"</span>,
<a name="l00602"></a>00602                      handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00603"></a>00603         exit(1);
<a name="l00604"></a>00604       }
<a name="l00605"></a>00605       lockGeneration = handlePtr-&gt;node-&gt;lockGeneration;
<a name="l00606"></a>00606       handlePtr-&gt;node-&gt;currentLockMode = lockMode;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       <a class="code" href="class_hyperspace_1_1_master.html#ba41a14ec09b0a09b735bc498c2311f8" title="Assumes node is locked.">lock_handle</a>(handlePtr, lockMode);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610       <span class="comment">// deliver notification to handles to this same node</span>
<a name="l00611"></a>00611       <span class="keywordflow">if</span> (lockNotify) {
<a name="l00612"></a>00612         <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_lock_acquired.html" title="EventLockAcquired class.">EventLockAcquired</a>(lockMode) );
<a name="l00613"></a>00613         <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr);
<a name="l00614"></a>00614       }
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     handlePtr-&gt;node-&gt;add_handle(handle, handlePtr);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621   cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_open.html#ae726fa832c65264cb79a9b3cd0d2ba6">response</a>(handle, created, lockGeneration);
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 
<a name="l00628"></a><a class="code" href="class_hyperspace_1_1_master.html#0e3ef8b78c4c8825a9ea7bcb769f552e">00628</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#0e3ef8b78c4c8825a9ea7bcb769f552e">Master::close</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, uint64_t handle) {
<a name="l00629"></a>00629   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00630"></a>00630   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00631"></a>00631   std::string errMsg;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00634"></a>00634     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"close(session=%lld, handle=%lld)"</span>, sessionId, handle);
<a name="l00635"></a>00635   }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00638"></a>00638     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00639"></a>00639     <span class="keywordflow">return</span>;
<a name="l00640"></a>00640   }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   {
<a name="l00643"></a>00643     boost::mutex::scoped_lock slock(sessionPtr-&gt;mutex);
<a name="l00644"></a>00644     <span class="keywordtype">size_t</span> n = sessionPtr-&gt;handles.erase(handle);
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (n) {
<a name="l00646"></a>00646       <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#1fa21ff1fa94cab4baed30b36034b6f2">destroy_handle</a>(handle, &amp;error, errMsg)) {
<a name="l00647"></a>00647         cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(error, errMsg);
<a name="l00648"></a>00648         <span class="keywordflow">return</span>;
<a name="l00649"></a>00649       }
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651   }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653   <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00654"></a>00654     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending back response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00655"></a>00655   }
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 
<a name="l00663"></a><a class="code" href="class_hyperspace_1_1_master.html#d764f26d5cacaa788e65895a9bd3bea4">00663</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#d764f26d5cacaa788e65895a9bd3bea4">Master::attr_set</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, uint64_t handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">void</span> *value, <span class="keywordtype">size_t</span> valueLen) {
<a name="l00664"></a>00664   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00665"></a>00665   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00666"></a>00666   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00669"></a>00669     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"attrset(session=%lld, handle=%lld, name=%s, valueLen=%d)"</span>, sessionId, handle, name, valueLen);
<a name="l00670"></a>00670   }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00673"></a>00673     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00674"></a>00674     <span class="keywordflow">return</span>;
<a name="l00675"></a>00675   }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l00678"></a>00678     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l00679"></a>00679     <span class="keywordflow">return</span>;
<a name="l00680"></a>00680   }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682   {
<a name="l00683"></a>00683     boost::mutex::scoped_lock nodeLock(handlePtr-&gt;node-&gt;mutex);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="keywordflow">if</span> (FileUtils::fsetxattr(handlePtr-&gt;node-&gt;fd, name, value, valueLen, 0) == -1) {
<a name="l00686"></a>00686       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute '%s' on file '%s' - %s"</span>,
<a name="l00687"></a>00687                    name, handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00688"></a>00688       <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f5976bfffbd4da4ca2cb7ee950e458efdbf2">EVENT_MASK_ATTR_SET</a>, name) );
<a name="l00692"></a>00692     <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr);
<a name="l00693"></a>00693   }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695   <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00696"></a>00696     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending back response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 
<a name="l00705"></a><a class="code" href="class_hyperspace_1_1_master.html#ad7b4fca2da241c193b8e293b46f5702">00705</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#ad7b4fca2da241c193b8e293b46f5702">Master::attr_get</a>(<a class="code" href="class_hyperspace_1_1_response_callback_attr_get.html">ResponseCallbackAttrGet</a> *cb, uint64_t sessionId, uint64_t handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00706"></a>00706   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00707"></a>00707   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00708"></a>00708   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00709"></a>00709   <span class="keywordtype">int</span> alen;
<a name="l00710"></a>00710   uint8_t *buf = 0;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00713"></a>00713     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"attrget(session=%lld, handle=%lld, name=%s)"</span>, sessionId, handle, name);
<a name="l00714"></a>00714   }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00717"></a>00717     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00718"></a>00718     <span class="keywordflow">return</span>;
<a name="l00719"></a>00719   }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l00722"></a>00722     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l00723"></a>00723     <span class="keywordflow">return</span>;
<a name="l00724"></a>00724   }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726   {
<a name="l00727"></a>00727     boost::mutex::scoped_lock nodeLock(handlePtr-&gt;node-&gt;mutex);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="keywordflow">if</span> ((alen = FileUtils::fgetxattr(handlePtr-&gt;node-&gt;fd, name, 0, 0)) &lt; 0) {
<a name="l00730"></a>00730       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem determining size of extended attribute '%s' on file '%s' - %s"</span>,
<a name="l00731"></a>00731                    name, handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00732"></a>00732       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00733"></a>00733       <span class="keywordflow">return</span>;
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     buf = <span class="keyword">new</span> uint8_t [ alen + 8 ];
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="keywordflow">if</span> ((alen = FileUtils::fgetxattr(handlePtr-&gt;node-&gt;fd, name, buf, alen)) &lt; 0) {
<a name="l00739"></a>00739       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem determining size of extended attribute '%s' on file '%s' - %s"</span>,
<a name="l00740"></a>00740                    name, handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00741"></a>00741       <a class="code" href="_logger_8h.html#f0cc4993dc7f22a9ffd0918c8d69af3c">HT_ABORT</a>;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743   }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745   {
<a name="l00746"></a>00746     <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> buffer(buf, alen);
<a name="l00747"></a>00747     <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_attr_get.html#ac6fb02a95074c1e5348f518a3e550e3">response</a>(buffer)) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00748"></a>00748       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending back response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750   }
<a name="l00751"></a>00751   
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 
<a name="l00756"></a><a class="code" href="class_hyperspace_1_1_master.html#57a190cc05b5852add1fb0aeb2928dbf">00756</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#57a190cc05b5852add1fb0aeb2928dbf">Master::attr_del</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, uint64_t handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00757"></a>00757   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00758"></a>00758   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00759"></a>00759   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00762"></a>00762     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"attrdel(session=%lld, handle=%lld, name=%s)"</span>, sessionId, handle, name);
<a name="l00763"></a>00763   }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00766"></a>00766     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00767"></a>00767     <span class="keywordflow">return</span>;
<a name="l00768"></a>00768   }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l00771"></a>00771     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l00772"></a>00772     <span class="keywordflow">return</span>;
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   {
<a name="l00776"></a>00776     boost::mutex::scoped_lock nodeLock(handlePtr-&gt;node-&gt;mutex);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (FileUtils::fremovexattr(handlePtr-&gt;node-&gt;fd, name) == -1) {
<a name="l00779"></a>00779       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem removing extended attribute '%s' on file '%s' - %s"</span>,
<a name="l00780"></a>00780                    name, handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00781"></a>00781       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00782"></a>00782       <span class="keywordflow">return</span>;
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f5976b7953f3c88177ca9cb2fa1f679e59cc">EVENT_MASK_ATTR_DEL</a>, name) );
<a name="l00786"></a>00786     <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr);
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789   <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>()) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00790"></a>00790     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending back response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00791"></a>00791   }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="class_hyperspace_1_1_master.html#73d483effd69e28848ae355c9d3fa3bb">00796</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#73d483effd69e28848ae355c9d3fa3bb">Master::exists</a>(<a class="code" href="class_hyperspace_1_1_response_callback_exists.html">ResponseCallbackExists</a> *cb, uint64_t sessionId, <span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00797"></a>00797   std::string absName;
<a name="l00798"></a>00798   <span class="keywordtype">int</span> <a class="code" href="_range_server_8cc.html#11614f44ef4d939bdd984953346a7572">error</a>;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00801"></a>00801     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"exists(sessionId=%lld, name=%s)"</span>, sessionId, name);
<a name="l00802"></a>00802   }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804   assert(name[0] == <span class="charliteral">'/'</span> &amp;&amp; name[strlen(name)-1] != <span class="charliteral">'/'</span>);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806   absName = <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> + name;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808   <span class="keywordflow">if</span> ((error = cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_exists.html#17792662a7c78a0549b3207e025ae735">response</a>( FileUtils::exists(absName.c_str()) )) != <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b20a5285a55ffe0563faf08208db78e4a6">Error::OK</a>) {
<a name="l00809"></a>00809     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem sending back response - %s"</span>, <a class="code" href="namespace_hypertable_1_1_error.html#aa9a88a896e9afc2abf07a4dafcc4444">Error::get_text</a>(error));
<a name="l00810"></a>00810   }
<a name="l00811"></a>00811 }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 
<a name="l00814"></a><a class="code" href="class_hyperspace_1_1_master.html#f94a0b1ff5f93b886e178ea5a88e02f2">00814</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#f94a0b1ff5f93b886e178ea5a88e02f2">Master::readdir</a>(<a class="code" href="class_hyperspace_1_1_response_callback_readdir.html">ResponseCallbackReaddir</a> *cb, uint64_t sessionId, uint64_t handle) {
<a name="l00815"></a>00815   std::string absName;
<a name="l00816"></a>00816   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00817"></a>00817   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00818"></a>00818   <span class="keyword">struct </span><a class="code" href="struct_hyperspace_1_1_dir_entry_t.html" title="Listing information for each node within a directory.">DirEntryT</a> dentry;
<a name="l00819"></a>00819   std::vector&lt;struct DirEntryT&gt; listing;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00822"></a>00822     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"readdir(session=%lld, handle=%lld)"</span>, sessionId, handle);
<a name="l00823"></a>00823   }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00826"></a>00826     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00827"></a>00827     <span class="keywordflow">return</span>;
<a name="l00828"></a>00828   }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l00831"></a>00831     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l00832"></a>00832     <span class="keywordflow">return</span>;
<a name="l00833"></a>00833   }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835   {
<a name="l00836"></a>00836     boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(handlePtr-&gt;node-&gt;mutex);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     absName = <a class="code" href="class_hyperspace_1_1_master.html#6467ad31ce40d1d6349f65bea65710dc">m_base_dir</a> + handlePtr-&gt;node-&gt;name;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     DIR *dirp = opendir(absName.c_str());
<a name="l00841"></a>00841 
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (dirp == 0) {
<a name="l00843"></a>00843       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00844"></a>00844       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"opendir('%s') failed - %s"</span>, absName.c_str(), strerror(errno));
<a name="l00845"></a>00845       <span class="keywordflow">return</span>;
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keyword">struct </span>dirent dent;
<a name="l00849"></a>00849     <span class="keyword">struct </span>dirent *dp;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (readdir_r(dirp, &amp;dent, &amp;dp) != 0) {
<a name="l00852"></a>00852       <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00853"></a>00853       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"readdir('%s') failed - %s"</span>, absName.c_str(), strerror(errno));
<a name="l00854"></a>00854       (<a class="code" href="lzoconf_8h.html#383afb2a54f121de25b129d8943336eb">void</a>)closedir(dirp);
<a name="l00855"></a>00855       <span class="keywordflow">return</span>;
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">while</span> (dp != 0) {
<a name="l00859"></a>00859 
<a name="l00860"></a>00860       <span class="keywordflow">if</span> (dp-&gt;d_name[0] != 0 &amp;&amp; strcmp(dp-&gt;d_name, <span class="stringliteral">"."</span>) &amp;&amp; strcmp(dp-&gt;d_name, <span class="stringliteral">".."</span>)) {
<a name="l00861"></a>00861         dentry.<a class="code" href="struct_hyperspace_1_1_dir_entry_t.html#f400575917a0a67040ad67d51fc78747" title="Boolean value indicating whether or not this entry is a directory.">isDirectory</a> = (dp-&gt;d_type == DT_DIR);
<a name="l00862"></a>00862         dentry.<a class="code" href="struct_hyperspace_1_1_dir_entry_t.html#7fab3fc8035d21d9e0ac0b39f169ab5f" title="Directory entry name.">name</a> = dp-&gt;d_name;
<a name="l00863"></a>00863         listing.push_back(dentry);
<a name="l00864"></a>00864       }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866       <span class="keywordflow">if</span> (readdir_r(dirp, &amp;dent, &amp;dp) != 0) {
<a name="l00867"></a>00867         <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">report_error</a>(cb);
<a name="l00868"></a>00868         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"readdir('%s') failed - %s"</span>, absName.c_str(), strerror(errno));
<a name="l00869"></a>00869         (<a class="code" href="lzoconf_8h.html#383afb2a54f121de25b129d8943336eb">void</a>)closedir(dirp);
<a name="l00870"></a>00870         <span class="keywordflow">return</span>;
<a name="l00871"></a>00871       }
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873     (<a class="code" href="lzoconf_8h.html#383afb2a54f121de25b129d8943336eb">void</a>)closedir(dirp);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875   }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877   cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_readdir.html#4224b41e70dd6b5827cce6d64a48e462">response</a>(listing);
<a name="l00878"></a>00878 }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 
<a name="l00882"></a><a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">00882</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">Master::lock</a>(<a class="code" href="class_hyperspace_1_1_response_callback_lock.html">ResponseCallbackLock</a> *cb, uint64_t sessionId, uint64_t handle, uint32_t mode, <span class="keywordtype">bool</span> tryAcquire) {
<a name="l00883"></a>00883   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l00884"></a>00884   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l00885"></a>00885   <span class="keywordtype">bool</span> notify = <span class="keyword">true</span>;
<a name="l00886"></a>00886   
<a name="l00887"></a>00887   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l00888"></a>00888     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"lock(session=%lld, handle=%lld, mode=0x%x, tryAcquire=%d)"</span>, sessionId, handle, mode, tryAcquire);
<a name="l00889"></a>00889   }
<a name="l00890"></a>00890 
<a name="l00891"></a>00891   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l00892"></a>00892     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l00893"></a>00893     <span class="keywordflow">return</span>;
<a name="l00894"></a>00894   }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l00897"></a>00897     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l00898"></a>00898     <span class="keywordflow">return</span>;
<a name="l00899"></a>00899   }
<a name="l00900"></a>00900 
<a name="l00901"></a>00901   <span class="keywordflow">if</span> (!(handlePtr-&gt;openFlags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac24703749d9984b4e533df577fc4e39478065ea24" title="Open file for locking.">OPEN_FLAG_LOCK</a>)) {
<a name="l00902"></a>00902     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b29503cc2aefef532aa72b83cca13bb44d">Error::HYPERSPACE_MODE_RESTRICTION</a>, <span class="stringliteral">"handle not open for locking"</span>);
<a name="l00903"></a>00903     <span class="keywordflow">return</span>;
<a name="l00904"></a>00904   }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906   <span class="keywordflow">if</span> (!(handlePtr-&gt;openFlags &amp; <a class="code" href="namespace_hyperspace.html#ec471c22ce7c508c84ea82ac247037491d5a78002d883f613cfcb38d6386da1c" title="Open file for writing.">OPEN_FLAG_WRITE</a>)) {
<a name="l00907"></a>00907     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b29503cc2aefef532aa72b83cca13bb44d">Error::HYPERSPACE_MODE_RESTRICTION</a>, <span class="stringliteral">"handle not open for writing"</span>);
<a name="l00908"></a>00908     <span class="keywordflow">return</span>;
<a name="l00909"></a>00909   }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911   {
<a name="l00912"></a>00912     boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(handlePtr-&gt;node-&gt;mutex);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     <span class="keywordflow">if</span> (handlePtr-&gt;node-&gt;currentLockMode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>) {
<a name="l00915"></a>00915       <span class="keywordflow">if</span> (tryAcquire)
<a name="l00916"></a>00916         cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573adab10339d972c57d22da4f2eda5f01cfb9" title="Exclusive lock attempt failed because another has it locked.">LOCK_STATUS_BUSY</a>);
<a name="l00917"></a>00917       <span class="keywordflow">else</span> {
<a name="l00918"></a>00918         handlePtr-&gt;node-&gt;pendingLockRequests.push_back( <a class="code" href="class_hyperspace_1_1_lock_request.html">LockRequest</a>(handle, mode) );
<a name="l00919"></a>00919         cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573ada4c116c2382a43ffb4ca991d338bdfc85" title="Lock attempt pending (internal use only).">LOCK_STATUS_PENDING</a>);
<a name="l00920"></a>00920       }
<a name="l00921"></a>00921       <span class="keywordflow">return</span>;
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handlePtr-&gt;node-&gt;currentLockMode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>) {
<a name="l00924"></a>00924       <span class="keywordflow">if</span> (mode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>) {
<a name="l00925"></a>00925         <span class="keywordflow">if</span> (tryAcquire)
<a name="l00926"></a>00926           cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573adab10339d972c57d22da4f2eda5f01cfb9" title="Exclusive lock attempt failed because another has it locked.">LOCK_STATUS_BUSY</a>);
<a name="l00927"></a>00927         <span class="keywordflow">else</span> {
<a name="l00928"></a>00928           handlePtr-&gt;node-&gt;pendingLockRequests.push_back( <a class="code" href="class_hyperspace_1_1_lock_request.html">LockRequest</a>(handle, mode) );
<a name="l00929"></a>00929           cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573ada4c116c2382a43ffb4ca991d338bdfc85" title="Lock attempt pending (internal use only).">LOCK_STATUS_PENDING</a>);
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931         <span class="keywordflow">return</span>;
<a name="l00932"></a>00932       }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934       assert(mode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>);
<a name="l00935"></a>00935 
<a name="l00936"></a>00936       <span class="keywordflow">if</span> (!handlePtr-&gt;node-&gt;pendingLockRequests.empty()) {
<a name="l00937"></a>00937         handlePtr-&gt;node-&gt;pendingLockRequests.push_back( <a class="code" href="class_hyperspace_1_1_lock_request.html">LockRequest</a>(handle, mode) );
<a name="l00938"></a>00938         cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573ada4c116c2382a43ffb4ca991d338bdfc85" title="Lock attempt pending (internal use only).">LOCK_STATUS_PENDING</a>);
<a name="l00939"></a>00939         <span class="keywordflow">return</span>;
<a name="l00940"></a>00940       }
<a name="l00941"></a>00941     }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="comment">// at this point we're OK to acquire the lock</span>
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (mode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a> &amp;&amp; !handlePtr-&gt;node-&gt;sharedLockHandles.empty())
<a name="l00946"></a>00946       notify = <span class="keyword">false</span>;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     handlePtr-&gt;node-&gt;lockGeneration++;
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (FileUtils::fsetxattr(handlePtr-&gt;node-&gt;fd, <span class="stringliteral">"lock.generation"</span>, &amp;handlePtr-&gt;node-&gt;lockGeneration, <span class="keyword">sizeof</span>(uint64_t), 0) == -1) {
<a name="l00950"></a>00950       <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'lock.generation' on file '%s' - %s"</span>,
<a name="l00951"></a>00951                    handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l00952"></a>00952       exit(1);
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954     handlePtr-&gt;node-&gt;currentLockMode = mode;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <a class="code" href="class_hyperspace_1_1_master.html#ba41a14ec09b0a09b735bc498c2311f8" title="Assumes node is locked.">lock_handle</a>(handlePtr, mode);
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     <span class="comment">// deliver notification to handles to this same node</span>
<a name="l00959"></a>00959     <span class="keywordflow">if</span> (notify) {
<a name="l00960"></a>00960       <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_lock_acquired.html" title="EventLockAcquired class.">EventLockAcquired</a>(mode) );
<a name="l00961"></a>00961       <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr);
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     cb-&gt;<a class="code" href="class_hyperspace_1_1_response_callback_lock.html#ef16196b48ce0fd8bc6884194f238e44">response</a>(<a class="code" href="namespace_hyperspace.html#191dddd17c5b8c29ed8e3bad31573ada56091f24bea9a4fc33d05c4608c4b7b2" title="Lock successfully granted.">LOCK_STATUS_GRANTED</a>, handlePtr-&gt;node-&gt;lockGeneration);
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00971"></a><a class="code" href="class_hyperspace_1_1_master.html#ba41a14ec09b0a09b735bc498c2311f8">00971</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#ba41a14ec09b0a09b735bc498c2311f8" title="Assumes node is locked.">Master::lock_handle</a>(<a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr, uint32_t mode) {
<a name="l00972"></a>00972   <span class="keywordflow">if</span> (mode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>)
<a name="l00973"></a>00973     handlePtr-&gt;node-&gt;sharedLockHandles.insert(handlePtr-&gt;id);
<a name="l00974"></a>00974   <span class="keywordflow">else</span> {
<a name="l00975"></a>00975     assert(mode == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>);
<a name="l00976"></a>00976     handlePtr-&gt;node-&gt;exclusiveLockHandle = handlePtr-&gt;id;
<a name="l00977"></a>00977   }
<a name="l00978"></a>00978   handlePtr-&gt;locked = <span class="keyword">true</span>;
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00984"></a><a class="code" href="class_hyperspace_1_1_master.html#e56e417cd8525554d81035c4f07acfc6">00984</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#e56e417cd8525554d81035c4f07acfc6" title="Assumes node is locked.">Master::lock_handle_with_notification</a>(<a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr, uint32_t mode, <span class="keywordtype">bool</span> waitForNotify) {
<a name="l00985"></a>00985 
<a name="l00986"></a>00986   <a class="code" href="class_hyperspace_1_1_master.html#ba41a14ec09b0a09b735bc498c2311f8" title="Assumes node is locked.">lock_handle</a>(handlePtr, mode);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988   <span class="comment">// deliver notification to handles to this same node</span>
<a name="l00989"></a>00989   {
<a name="l00990"></a>00990     <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_lock_granted.html" title="EventLockGranted class.">EventLockGranted</a>(mode, handlePtr-&gt;node-&gt;lockGeneration) );
<a name="l00991"></a>00991     <a class="code" href="class_hyperspace_1_1_master.html#06888d56d30be847aeaaad824a3454d5" title="Assumes node is locked.">deliver_event_notification</a>(handlePtr, eventPtr, waitForNotify);
<a name="l00992"></a>00992   }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 
<a name="l01001"></a><a class="code" href="class_hyperspace_1_1_master.html#cfa7143f16c6093ba80329ccd65bca66">01001</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#cfa7143f16c6093ba80329ccd65bca66">Master::release</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb, uint64_t sessionId, uint64_t handle) {
<a name="l01002"></a>01002   <a class="code" href="namespace_hyperspace.html#bf8a2306f11c783cfc4c53778e399a95">SessionDataPtr</a> sessionPtr;
<a name="l01003"></a>01003   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005   <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#74924c1db7e0185ad3101079fe639193">m_verbose</a>) {
<a name="l01006"></a>01006     <a class="code" href="_logger_8h.html#4dcbf79f28e1da27d954a2648db871fa">HT_INFOF</a>(<span class="stringliteral">"release(session=%lld, handle=%lld)"</span>, sessionId, handle);
<a name="l01007"></a>01007   }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#9ba969edf9f0eccac1ed2238dc524d42" title="Obtains the SessionData object for the given id from the session map.">get_session</a>(sessionId, sessionPtr)) {
<a name="l01010"></a>01010     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2a38fc4a0041daa6515f752d5793980e7">Error::HYPERSPACE_EXPIRED_SESSION</a>, <span class="stringliteral">""</span>);
<a name="l01011"></a>01011     <span class="keywordflow">return</span>;
<a name="l01012"></a>01012   }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(handle, handlePtr)) {
<a name="l01015"></a>01015     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>, std::string(<span class="stringliteral">"handle="</span>) + handle);
<a name="l01016"></a>01016     <span class="keywordflow">return</span>;
<a name="l01017"></a>01017   }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019   <a class="code" href="class_hyperspace_1_1_master.html#a315368a161dd995dd04232e7d709de9">release_lock</a>(handlePtr);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021   cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#c01df9aab4b447a359dfa41c9597aa7d" title="Sends a a simple success response back to the client which is just simply the 4-byte...">response_ok</a>();
<a name="l01022"></a>01022 }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024 
<a name="l01025"></a><a class="code" href="class_hyperspace_1_1_master.html#a315368a161dd995dd04232e7d709de9">01025</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#a315368a161dd995dd04232e7d709de9">Master::release_lock</a>(<a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr, <span class="keywordtype">bool</span> waitForNotify) {
<a name="l01026"></a>01026   boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(handlePtr-&gt;node-&gt;mutex);
<a name="l01027"></a>01027   vector&lt;HandleDataPtr&gt; nextLockHandles;
<a name="l01028"></a>01028   <span class="keywordtype">int</span> nextMode = 0;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030   <span class="keywordflow">if</span> (handlePtr-&gt;locked) {
<a name="l01031"></a>01031     <span class="keywordflow">if</span> (handlePtr-&gt;node-&gt;exclusiveLockHandle != 0) {
<a name="l01032"></a>01032       assert(handlePtr-&gt;id == handlePtr-&gt;node-&gt;exclusiveLockHandle);
<a name="l01033"></a>01033       handlePtr-&gt;node-&gt;exclusiveLockHandle = 0;
<a name="l01034"></a>01034     }
<a name="l01035"></a>01035     <span class="keywordflow">else</span> {
<a name="l01036"></a>01036       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count = handlePtr-&gt;node-&gt;sharedLockHandles.erase(handlePtr-&gt;id);
<a name="l01037"></a>01037       assert(count);
<a name="l01038"></a>01038       (<a class="code" href="lzoconf_8h.html#383afb2a54f121de25b129d8943336eb">void</a>)count;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     handlePtr-&gt;locked = <span class="keyword">false</span>;
<a name="l01041"></a>01041   }
<a name="l01042"></a>01042   <span class="keywordflow">else</span>
<a name="l01043"></a>01043     <span class="keywordflow">return</span>;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045   <span class="comment">// deliver LOCK_RELEASED notifications if no more locks held on node</span>
<a name="l01046"></a>01046   <span class="keywordflow">if</span> (handlePtr-&gt;node-&gt;sharedLockHandles.empty()) {
<a name="l01047"></a>01047     <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"About to deliver lock released notifications"</span>);
<a name="l01048"></a>01048     <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_lock_released.html" title="EventLockReleased class.">EventLockReleased</a>() );
<a name="l01049"></a>01049     <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr, waitForNotify);
<a name="l01050"></a>01050     <a class="code" href="_logger_8h.html#48f83639f21ec6e588ce69306cd25b28">HT_INFO</a>(<span class="stringliteral">"Finished delivering lock released notifications"</span>);
<a name="l01051"></a>01051   }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053   handlePtr-&gt;node-&gt;currentLockMode = 0;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055   <span class="keywordflow">if</span> (!handlePtr-&gt;node-&gt;pendingLockRequests.empty()) {
<a name="l01056"></a>01056     <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> nextHandlePtr;
<a name="l01057"></a>01057     <span class="keyword">const</span> <a class="code" href="class_hyperspace_1_1_lock_request.html">LockRequest</a> &amp;frontLockReq = handlePtr-&gt;node-&gt;pendingLockRequests.front();
<a name="l01058"></a>01058     <span class="keywordflow">if</span> (frontLockReq.<a class="code" href="class_hyperspace_1_1_lock_request.html#05a4e54a0a1692224f73d6818a3de553">mode</a> == <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>) {
<a name="l01059"></a>01059       nextMode = <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb363b144e7ad5ae055a93f10ed5963d680b" title="Lock exclusive mode.">LOCK_MODE_EXCLUSIVE</a>;
<a name="l01060"></a>01060       <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(frontLockReq.<a class="code" href="class_hyperspace_1_1_lock_request.html#1490dba31343a4f9a29e50aa04c14fe8">handle</a>, nextHandlePtr))
<a name="l01061"></a>01061         nextLockHandles.push_back(nextHandlePtr);
<a name="l01062"></a>01062       handlePtr-&gt;node-&gt;pendingLockRequests.pop_front();
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064     <span class="keywordflow">else</span> {
<a name="l01065"></a>01065       nextMode = <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>;
<a name="l01066"></a>01066       <span class="keywordflow">do</span> {
<a name="l01067"></a>01067         <span class="keyword">const</span> <a class="code" href="class_hyperspace_1_1_lock_request.html">LockRequest</a> &amp;lockreq = handlePtr-&gt;node-&gt;pendingLockRequests.front();
<a name="l01068"></a>01068         <span class="keywordflow">if</span> (lockreq.<a class="code" href="class_hyperspace_1_1_lock_request.html#05a4e54a0a1692224f73d6818a3de553">mode</a> != <a class="code" href="namespace_hyperspace.html#06f80df4c12ec847cc1e13c65e4fdb36a1f6396ff13d0c16f758594f7e7d0b8e" title="Lock in shared mode.">LOCK_MODE_SHARED</a>)
<a name="l01069"></a>01069           <span class="keywordflow">break</span>;
<a name="l01070"></a>01070         <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#800dbc2eb68a553e25088c23c5382d78">get_handle_data</a>(lockreq.<a class="code" href="class_hyperspace_1_1_lock_request.html#1490dba31343a4f9a29e50aa04c14fe8">handle</a>, nextHandlePtr))
<a name="l01071"></a>01071           nextLockHandles.push_back(nextHandlePtr);
<a name="l01072"></a>01072         handlePtr-&gt;node-&gt;pendingLockRequests.pop_front();
<a name="l01073"></a>01073       } <span class="keywordflow">while</span> (!handlePtr-&gt;node-&gt;pendingLockRequests.empty());
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (!nextLockHandles.empty()) {
<a name="l01077"></a>01077 
<a name="l01078"></a>01078       handlePtr-&gt;node-&gt;lockGeneration++;
<a name="l01079"></a>01079       <span class="keywordflow">if</span> (FileUtils::fsetxattr(handlePtr-&gt;node-&gt;fd, <span class="stringliteral">"lock.generation"</span>, &amp;handlePtr-&gt;node-&gt;lockGeneration, <span class="keyword">sizeof</span>(uint64_t), 0) == -1) {
<a name="l01080"></a>01080         <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Problem creating extended attribute 'lock.generation' on file '%s' - %s"</span>,
<a name="l01081"></a>01081                      handlePtr-&gt;node-&gt;name.c_str(), strerror(errno));
<a name="l01082"></a>01082         exit(1);
<a name="l01083"></a>01083       }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085       handlePtr-&gt;node-&gt;currentLockMode = nextMode;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;nextLockHandles.size(); i++) {
<a name="l01088"></a>01088         assert(handlePtr-&gt;id != nextLockHandles[i]-&gt;id);
<a name="l01089"></a>01089         <a class="code" href="class_hyperspace_1_1_master.html#e56e417cd8525554d81035c4f07acfc6" title="Assumes node is locked.">lock_handle_with_notification</a>(nextLockHandles[i], nextMode, waitForNotify);
<a name="l01090"></a>01090       }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092       <span class="comment">// deliver notification to handles to this same node</span>
<a name="l01093"></a>01093       {
<a name="l01094"></a>01094         <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_lock_acquired.html" title="EventLockAcquired class.">EventLockAcquired</a>(nextMode) );
<a name="l01095"></a>01095         <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(handlePtr-&gt;node, eventPtr, waitForNotify);
<a name="l01096"></a>01096       }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   }
<a name="l01101"></a>01101   
<a name="l01102"></a>01102 }
<a name="l01103"></a>01103 
<a name="l01104"></a>01104 
<a name="l01108"></a><a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b">01108</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#631dcd174faee7255073daf5ed8b719b" title="report_error">Master::report_error</a>(<a class="code" href="class_hypertable_1_1_response_callback.html" title="This class is used to deliver responses, corresponding to a request, back to a client...">ResponseCallback</a> *cb) {
<a name="l01109"></a>01109   <span class="keywordtype">char</span> errbuf[128];
<a name="l01110"></a>01110   errbuf[0] = 0;
<a name="l01111"></a>01111   strerror_r(errno, errbuf, 128);
<a name="l01112"></a>01112   <span class="keywordflow">if</span> (errno == ENOTDIR || errno == ENAMETOOLONG || errno == ENOENT)
<a name="l01113"></a>01113     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b280d6ae041bebcdd03e0c06a63f553eb6">Error::HYPERSPACE_BAD_PATHNAME</a>, errbuf);
<a name="l01114"></a>01114   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EACCES || errno == EPERM)
<a name="l01115"></a>01115     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b27085d1fbbde510ecf9a285113cc62406">Error::HYPERSPACE_PERMISSION_DENIED</a>, errbuf);
<a name="l01116"></a>01116   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EEXIST)
<a name="l01117"></a>01117     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b26b8a455adfa95b9c7036a395d5d5e2f2">Error::HYPERSPACE_FILE_EXISTS</a>, errbuf);
<a name="l01118"></a>01118   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == ENOATTR)
<a name="l01119"></a>01119     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2796a9a0f4c5b8caeb5c8e1ef40424d38">Error::HYPERSPACE_ATTR_NOT_FOUND</a>, errbuf);
<a name="l01120"></a>01120   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (errno == EISDIR)
<a name="l01121"></a>01121     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2b3aec9b205db9f2837326f15251f9d5e">Error::HYPERSPACE_IS_DIRECTORY</a>, errbuf);
<a name="l01122"></a>01122   <span class="keywordflow">else</span> {
<a name="l01123"></a>01123     <a class="code" href="_logger_8h.html#a7782b40800c410a4406ef4a23bf8b36">HT_ERRORF</a>(<span class="stringliteral">"Unknown error, errno = %d"</span>, errno);
<a name="l01124"></a>01124     cb-&gt;<a class="code" href="class_hypertable_1_1_response_callback.html#23ae6f4608ce15b4c4909a859ff12f1d" title="Sends an error response back to the client.">error</a>(<a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b24fc66eff07e88f901401d406b1ca07e8">Error::HYPERSPACE_IO_ERROR</a>, errbuf);
<a name="l01125"></a>01125   }
<a name="l01126"></a>01126 }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128 
<a name="l01129"></a>01129 
<a name="l01133"></a><a class="code" href="class_hyperspace_1_1_master.html#5bc5eee8561b704ac258640b2ea49141">01133</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#5bc5eee8561b704ac258640b2ea49141">Master::normalize_name</a>(std::string name, std::string &amp;normal) {
<a name="l01134"></a>01134   normal = <span class="stringliteral">""</span>;
<a name="l01135"></a>01135   <span class="keywordflow">if</span> (name[0] != <span class="charliteral">'/'</span>)
<a name="l01136"></a>01136     normal += <span class="stringliteral">"/"</span>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138   <span class="keywordflow">if</span> (name.find(<span class="charliteral">'/'</span>, name.length()-1) == string::npos)
<a name="l01139"></a>01139     normal += name;
<a name="l01140"></a>01140   <span class="keywordflow">else</span>
<a name="l01141"></a>01141     normal += name.substr(0, name.length()-1);
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 
<a name="l01148"></a><a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a">01148</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">Master::deliver_event_notifications</a>(<a class="code" href="class_hyperspace_1_1_node_data.html">NodeData</a> *node, <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> &amp;eventPtr, <span class="keywordtype">bool</span> waitForNotify) {
<a name="l01149"></a>01149   <span class="keywordtype">int</span> notifications = 0;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151   <span class="comment">// log event</span>
<a name="l01152"></a>01152 
<a name="l01153"></a>01153   <span class="keywordflow">for</span> (HandleMapT::iterator iter = node-&gt;<a class="code" href="class_hyperspace_1_1_node_data.html#d58dc4f9adee3dce9c2d39687b20afa4">handleMap</a>.begin(); iter != node-&gt;<a class="code" href="class_hyperspace_1_1_node_data.html#d58dc4f9adee3dce9c2d39687b20afa4">handleMap</a>.end(); iter++) {
<a name="l01154"></a>01154     <span class="comment">//HT_INFOF("Delivering notification (%d == %d)", (*iter).second-&gt;eventMask, eventPtr-&gt;get_mask());</span>
<a name="l01155"></a>01155     <span class="keywordflow">if</span> ((*iter).second-&gt;eventMask &amp; eventPtr-&gt;get_mask()) {
<a name="l01156"></a>01156       (*iter).second-&gt;sessionPtr-&gt;add_notification( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_notification.html">Notification</a>((*iter).first, eventPtr) );
<a name="l01157"></a>01157       <a class="code" href="class_hyperspace_1_1_master.html#fc45c1592d3ac18c2d2812900c2e29c6">m_keepalive_handler_ptr</a>-&gt;deliver_event_notifications((*iter).second-&gt;sessionPtr-&gt;id);
<a name="l01158"></a>01158       notifications++;
<a name="l01159"></a>01159     }
<a name="l01160"></a>01160   }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   <span class="keywordflow">if</span> (waitForNotify &amp;&amp; notifications)
<a name="l01163"></a>01163     eventPtr-&gt;wait_for_notifications();
<a name="l01164"></a>01164 }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166 
<a name="l01170"></a><a class="code" href="class_hyperspace_1_1_master.html#06888d56d30be847aeaaad824a3454d5">01170</a> <span class="keywordtype">void</span> <a class="code" href="class_hyperspace_1_1_master.html#06888d56d30be847aeaaad824a3454d5" title="Assumes node is locked.">Master::deliver_event_notification</a>(<a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> &amp;handlePtr, <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> &amp;eventPtr, <span class="keywordtype">bool</span> waitForNotify) {
<a name="l01171"></a>01171 
<a name="l01172"></a>01172   <span class="comment">// log event</span>
<a name="l01173"></a>01173 
<a name="l01174"></a>01174   handlePtr-&gt;sessionPtr-&gt;add_notification( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_notification.html">Notification</a>(handlePtr-&gt;id, eventPtr) );
<a name="l01175"></a>01175   <a class="code" href="class_hyperspace_1_1_master.html#fc45c1592d3ac18c2d2812900c2e29c6">m_keepalive_handler_ptr</a>-&gt;deliver_event_notifications(handlePtr-&gt;sessionPtr-&gt;id);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177   <span class="keywordflow">if</span> (waitForNotify)
<a name="l01178"></a>01178     eventPtr-&gt;wait_for_notifications();
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 
<a name="l01183"></a>01183 
<a name="l01187"></a><a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76">01187</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76" title="Locates the parent &amp;#39;node&amp;#39; of the given pathname.">Master::find_parent_node</a>(std::string normalName, <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> &amp;parentNodePtr, std::string &amp;childName) {
<a name="l01188"></a>01188   NodeMapT::iterator nodeIter;
<a name="l01189"></a>01189   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lastSlash = normalName.rfind(<span class="stringliteral">"/"</span>, normalName.length());
<a name="l01190"></a>01190   std::string parentName;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192   <span class="keywordflow">if</span> (lastSlash &gt; 0) {
<a name="l01193"></a>01193     boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#f551e5b32ccd050cb2e94ba84a53af2c">m_node_map_mutex</a>);
<a name="l01194"></a>01194     parentName = normalName.substr(0, lastSlash);
<a name="l01195"></a>01195     childName = normalName.substr(lastSlash+1);
<a name="l01196"></a>01196     nodeIter = <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.find(parentName);
<a name="l01197"></a>01197     <span class="keywordflow">if</span> (nodeIter != <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.end())
<a name="l01198"></a>01198       parentNodePtr = (*nodeIter).second;
<a name="l01199"></a>01199     <span class="keywordflow">else</span> {
<a name="l01200"></a>01200       parentNodePtr = <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_node_data.html">NodeData</a>();
<a name="l01201"></a>01201       parentNodePtr-&gt;name = parentName;
<a name="l01202"></a>01202       <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>[parentName] = parentNodePtr;
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01205"></a>01205   }
<a name="l01206"></a>01206   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastSlash == 0) {
<a name="l01207"></a>01207     boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(<a class="code" href="class_hyperspace_1_1_master.html#f551e5b32ccd050cb2e94ba84a53af2c">m_node_map_mutex</a>);
<a name="l01208"></a>01208     parentName = <span class="stringliteral">"/"</span>;
<a name="l01209"></a>01209     nodeIter = <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.find(parentName);
<a name="l01210"></a>01210     assert (nodeIter != <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.end());
<a name="l01211"></a>01211     childName = normalName.substr(1);
<a name="l01212"></a>01212     parentNodePtr = (*nodeIter).second;
<a name="l01213"></a>01213     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01214"></a>01214   }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01217"></a>01217 }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 
<a name="l01223"></a><a class="code" href="class_hyperspace_1_1_master.html#1fa21ff1fa94cab4baed30b36034b6f2">01223</a> <span class="keywordtype">bool</span> <a class="code" href="class_hyperspace_1_1_master.html#1fa21ff1fa94cab4baed30b36034b6f2">Master::destroy_handle</a>(uint64_t handle, <span class="keywordtype">int</span> *errorp, std::string &amp;errMsg, <span class="keywordtype">bool</span> waitForNotify) {
<a name="l01224"></a>01224   <a class="code" href="namespace_hyperspace.html#10c2f43e6bf999559f90bad8c67500fc">HandleDataPtr</a> handlePtr;
<a name="l01225"></a>01225   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="class_hypertable_1_1_reference_count.html#a1737a12bc070a1db3c0b86e6d5d5fb4">refCount</a> = 0;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227   <span class="keywordflow">if</span> (!<a class="code" href="class_hyperspace_1_1_master.html#0cddc709db5afce8e1999104033bdade">remove_handle_data</a>(handle, handlePtr)) {
<a name="l01228"></a>01228     *errorp = <a class="code" href="namespace_hypertable_1_1_error.html#73c48f53deb2941a8c0ef156a899c3b2273e468803825b74423058594a7920e6">Error::HYPERSPACE_INVALID_HANDLE</a>;
<a name="l01229"></a>01229     errMsg = std::string(<span class="stringliteral">"handle="</span>) + handle;
<a name="l01230"></a>01230     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01231"></a>01231   }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233   {
<a name="l01234"></a>01234     boost::mutex::scoped_lock <a class="code" href="class_hyperspace_1_1_master.html#d751999f9658f26d0ec873ea2c572b6c">lock</a>(handlePtr-&gt;node-&gt;mutex);
<a name="l01235"></a>01235 
<a name="l01236"></a>01236     handlePtr-&gt;node-&gt;remove_handle(handlePtr-&gt;id);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     refCount = handlePtr-&gt;node-&gt;reference_count();
<a name="l01239"></a>01239   }
<a name="l01240"></a>01240 
<a name="l01241"></a>01241   <a class="code" href="class_hyperspace_1_1_master.html#a315368a161dd995dd04232e7d709de9">release_lock</a>(handlePtr, waitForNotify);
<a name="l01242"></a>01242 
<a name="l01243"></a>01243   <span class="keywordflow">if</span> (refCount == 0) {
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     handlePtr-&gt;node-&gt;close();
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <span class="keywordflow">if</span> (handlePtr-&gt;node-&gt;ephemeral) {
<a name="l01248"></a>01248       std::string childName;
<a name="l01249"></a>01249       <a class="code" href="namespace_hyperspace.html#ea6276fa0665b02c8f6f505c2255a2f1">NodeDataPtr</a> parentNodePtr;
<a name="l01250"></a>01250 
<a name="l01251"></a>01251       <span class="keywordflow">if</span> (<a class="code" href="class_hyperspace_1_1_master.html#39e066b74760dda221432f001417fd76" title="Locates the parent &amp;#39;node&amp;#39; of the given pathname.">find_parent_node</a>(handlePtr-&gt;node-&gt;name, parentNodePtr, childName)) {
<a name="l01252"></a>01252         <a class="code" href="namespace_hyperspace.html#5a0d997757fe62feaa83461afd2abe54">HyperspaceEventPtr</a> eventPtr( <span class="keyword">new</span> <a class="code" href="class_hyperspace_1_1_event_named.html" title="EventNamed class.">EventNamed</a>(<a class="code" href="namespace_hyperspace.html#8faaea70d69604e80613dd4e8da8f597bdb816ac6d2ec117efa256a8984c3404">EVENT_MASK_CHILD_NODE_REMOVED</a>, childName) );
<a name="l01253"></a>01253         <a class="code" href="class_hyperspace_1_1_master.html#6788b5933fb41311f3146522cfac221a" title="Assumes node is locked.">deliver_event_notifications</a>(parentNodePtr.get(), eventPtr, waitForNotify);
<a name="l01254"></a>01254       }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256       <span class="comment">// remove node</span>
<a name="l01257"></a>01257       NodeMapT::iterator nodeIter = <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.find(handlePtr-&gt;node-&gt;name);
<a name="l01258"></a>01258       <span class="keywordflow">if</span> (nodeIter != <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.end())
<a name="l01259"></a>01259         <a class="code" href="class_hyperspace_1_1_master.html#cb4dd035d420703d7df1cf2a07a10773">m_node_map</a>.erase(nodeIter);
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261   }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01264"></a>01264 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri May 23 14:50:26 2008 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
