<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/Lib/bmz/bmzip.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ad5135801673f2e4c4e1be66fcd2e528.html">Lib</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_636d9f0bc773a215f705e2de9f182c4e.html">bmz</a></div>
<h1>bmzip.c</h1><a href="bmzip_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="compat-c_8h.html">Common/compat-c.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="_string_8h.html">string.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef HT_NO_MMAP</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;sys/mman.h&gt;</span>
<a name="l00035"></a><a class="code" href="bmzip_8c.html#aaa0b5800f099956fcd73b793930d26b">00035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmz-test_8c.html#de42f0ac72d07366d11d775d0c10f76a" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">s_no_mmap</a> = 0;
<a name="l00036"></a>00036 <span class="preprocessor">#else</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmz-test_8c.html#de42f0ac72d07366d11d775d0c10f76a" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">s_no_mmap</a> = 1;
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor">#include "<a class="code" href="bmz-internal_8h.html">bmz-internal.h</a>"</span>
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="bmzip_8c.html#0e8eb00dc36b0e1f76093ea95f7cea28">00042</a> <span class="preprocessor">#define BMZ_MAGIC       "BMZ"</span>
<a name="l00043"></a><a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define BMZIP_VER       0x0110</span>
<a name="l00044"></a><a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define BMZ_HEADER_SZ   (strlen(BMZ_MAGIC) + 2 + 1 + 6 + 4)</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="bmzip_8c.html#f075eb20e1928c94a890e00e7b7b4474">00046</a> <span class="preprocessor">#define BMZ_A_PACK      0</span>
<a name="l00047"></a><a class="code" href="bmzip_8c.html#f4ddd3d497fe8c0fd2b249ec88ce5476">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define BMZ_A_UNPACK    1</span>
<a name="l00048"></a><a class="code" href="bmzip_8c.html#9e4cea0e9ab633418f0396723179fb8a">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define BMZ_A_LIST      2</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span>
<a name="l00050"></a><a class="code" href="bmzip_8c.html#347cf28c48a7885c722f1d5cd97e4bb1">00050</a> <span class="preprocessor">#define BMZ_O_BM_ONLY   1</span>
<a name="l00051"></a><a class="code" href="bmzip_8c.html#56d651a8e77fa22a5c0e873d575010fc">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define BMZ_O_STREAM    2       </span><span class="comment">/* TODO */</span>
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="bmzip_8c.html#e3a497195d617519e5353ea7b417940f">00053</a> <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">/* To silence warnings in format strings */</span>
<a name="l00056"></a><a class="code" href="bmzip_8c.html#060a01232b5aabfce404ef5b2dafdba7">00056</a> <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>;
<a name="l00057"></a><a class="code" href="bmzip_8c.html#bd0e9dfdb207906e611de2be4cb7b135">00057</a> <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="bmzip_8c.html#47d76825dabd7c310f81492d1e6d65f6">00059</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a> = 0;
<a name="l00060"></a><a class="code" href="bmzip_8c.html#0317a9ca721949733e3e0061c7823ee9">00060</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmz-test_8c.html#0317a9ca721949733e3e0061c7823ee9">s_bm_dump</a> = 0;
<a name="l00061"></a><a class="code" href="bmzip_8c.html#1a08a5b0ea7667c4859f2b4df4abd850">00061</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmzip_8c.html#1a08a5b0ea7667c4859f2b4df4abd850">s_bm_hash</a> = 0;
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="bmzip_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">00063</a> <span class="preprocessor">#define LOG(_lvl_, _fmt_, ...) if (s_verbosity &gt;= _lvl_) do { \</span>
<a name="l00064"></a>00064 <span class="preprocessor">  fprintf(stderr, "bmzip: %s: " _fmt_, __FUNCTION__, ##__VA_ARGS__); \</span>
<a name="l00065"></a>00065 <span class="preprocessor">  if (errno) fprintf(stderr, ": %s", strerror(errno)); \</span>
<a name="l00066"></a>00066 <span class="preprocessor">  putc('\n', stderr); \</span>
<a name="l00067"></a>00067 <span class="preprocessor">} while (0)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="bmzip_8c.html#f369d408fd5724ef306a7731a697af9d">00069</a> <span class="preprocessor">#define WARN(_fmt_, ...) do { \</span>
<a name="l00070"></a>00070 <span class="preprocessor">  LOG(0, "warning: " _fmt_, ##__VA_ARGS__); \</span>
<a name="l00071"></a>00071 <span class="preprocessor">} while (0)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>
<a name="l00073"></a><a class="code" href="bmzip_8c.html#57d9be48a2d2312a1e3303af874430ac">00073</a> <span class="preprocessor">#define DIE(_fmt_, ...) do { \</span>
<a name="l00074"></a>00074 <span class="preprocessor">  LOG(0, "fatal: " _fmt_, ##__VA_ARGS__); \</span>
<a name="l00075"></a>00075 <span class="preprocessor">  exit(1); \</span>
<a name="l00076"></a>00076 <span class="preprocessor">} while (0)</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="bmzip_8c.html#f99a457bcf4c90162037062bb47affe7">00078</a> <span class="preprocessor">#define BMZ_ALIGN(_mem_, _n_) (Byte *)(_mem_) + _n_ - (((size_t)(_mem_))%(_n_))</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="bmzip_8c.html#108468943775a4de9d275cdf4fedaca8">00080</a> <span class="preprocessor">#define BMZ_READ_INT16(_p_, _n_) \</span>
<a name="l00081"></a>00081 <span class="preprocessor">  _n_ = (*_p_++ &lt;&lt; 8); \</span>
<a name="l00082"></a>00082 <span class="preprocessor">  _n_ |= (*_p_++)</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="bmzip_8c.html#5dc5e2313679f0238ab2e33975909db9">00084</a> <span class="preprocessor">#define BMZ_READ_INT32(_p_, _n_) \</span>
<a name="l00085"></a>00085 <span class="preprocessor">  _n_ = (*_p_++ &lt;&lt; 24); \</span>
<a name="l00086"></a>00086 <span class="preprocessor">  _n_ |= (*_p_++ &lt;&lt; 16); \</span>
<a name="l00087"></a>00087 <span class="preprocessor">  _n_ |= (*_p_++ &lt;&lt; 8); \</span>
<a name="l00088"></a>00088 <span class="preprocessor">  _n_ |= (*_p_++)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="bmzip_8c.html#014835df78278e8d1e3acf1f5df68a45">00090</a> <span class="preprocessor">#define BMZ_READ_INT48(_p_, _n_) \</span>
<a name="l00091"></a>00091 <span class="preprocessor">  _n_ = ((uint64_t)*_p_++ &lt;&lt; 40); \</span>
<a name="l00092"></a>00092 <span class="preprocessor">  _n_ |= ((uint64_t)*_p_++ &lt;&lt; 32); \</span>
<a name="l00093"></a>00093 <span class="preprocessor">  _n_ |= (*_p_++ &lt;&lt; 24); \</span>
<a name="l00094"></a>00094 <span class="preprocessor">  _n_ |= (*_p_++ &lt;&lt; 16); \</span>
<a name="l00095"></a>00095 <span class="preprocessor">  _n_ |= (*_p_++ &lt;&lt; 8); \</span>
<a name="l00096"></a>00096 <span class="preprocessor">  _n_ |= (*_p_++)</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="bmzip_8c.html#8c3e573857fc8d6302a1b5e00b70bfce">00098</a> <span class="preprocessor">#define BMZ_WRITE_INT16(_p_, _n_) \</span>
<a name="l00099"></a>00099 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 8); \</span>
<a name="l00100"></a>00100 <span class="preprocessor">  *_p_++ = (Byte)(_n_)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="bmzip_8c.html#5617212eca93255571eff97d0fa9f700">00102</a> <span class="preprocessor">#define BMZ_WRITE_INT32(_p_, _n_) \</span>
<a name="l00103"></a>00103 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 24); \</span>
<a name="l00104"></a>00104 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 16); \</span>
<a name="l00105"></a>00105 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 8); \</span>
<a name="l00106"></a>00106 <span class="preprocessor">  *_p_++ = (Byte)(_n_)</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a><a class="code" href="bmzip_8c.html#2c4b1f4942482e6059de319c8d875508">00108</a> <span class="preprocessor">#define BMZ_WRITE_INT48(_p_, _n_) \</span>
<a name="l00109"></a>00109 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 40); \</span>
<a name="l00110"></a>00110 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 32); \</span>
<a name="l00111"></a>00111 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 24); \</span>
<a name="l00112"></a>00112 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 16); \</span>
<a name="l00113"></a>00113 <span class="preprocessor">  *_p_++ = (Byte)(_n_ &gt;&gt; 8); \</span>
<a name="l00114"></a>00114 <span class="preprocessor">  *_p_++ = (Byte)(_n_)</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>
<a name="l00116"></a>00116 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00117"></a><a class="code" href="bmzip_8c.html#49322e63475d5cd473d3732b4de66ca5">00117</a> <a class="code" href="bmzip_8c.html#49322e63475d5cd473d3732b4de66ca5">read_bmz_header</a>(<span class="keywordtype">int</span> fd, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf) {
<a name="l00118"></a>00118   <span class="keywordflow">if</span> (read(fd, buf, <a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>) != <a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>)
<a name="l00119"></a>00119     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error reading bmz file header (%lu bytes)"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)<a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>);
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00123"></a><a class="code" href="bmzip_8c.html#74883689ec89cac218f7d56666936659">00123</a> <a class="code" href="bmzip_8c.html#74883689ec89cac218f7d56666936659">parse_bmz_header</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, uint16_t *version_p, uint64_t *orig_size_p,
<a name="l00124"></a>00124                 uint32_t *checksum_p, uint32_t *options) {
<a name="l00125"></a>00125   <span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *bp = buf;
<a name="l00126"></a>00126   <span class="keywordtype">size_t</span> magic_len = strlen(<a class="code" href="bmzip_8c.html#0e8eb00dc36b0e1f76093ea95f7cea28">BMZ_MAGIC</a>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="keywordflow">if</span> (memcmp(buf, <a class="code" href="bmzip_8c.html#0e8eb00dc36b0e1f76093ea95f7cea28">BMZ_MAGIC</a>, magic_len)) {
<a name="l00129"></a>00129     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"bad magic in file header (%lu bytes)"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)magic_len);
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131   bp += magic_len;
<a name="l00132"></a>00132   <a class="code" href="bmzip_8c.html#108468943775a4de9d275cdf4fedaca8">BMZ_READ_INT16</a>(bp, *version_p);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   <span class="keywordflow">if</span> (*version_p &gt; <a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a>)
<a name="l00135"></a>00135     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"incomaptible version: %04x"</span>, *version_p);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   *options = *bp++;
<a name="l00138"></a>00138   <a class="code" href="bmzip_8c.html#014835df78278e8d1e3acf1f5df68a45">BMZ_READ_INT48</a>(bp, *orig_size_p);
<a name="l00139"></a>00139   <a class="code" href="bmzip_8c.html#5dc5e2313679f0238ab2e33975909db9">BMZ_READ_INT32</a>(bp, *checksum_p);
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00143"></a><a class="code" href="bmzip_8c.html#2eae1d29965aa1fefe537ee8bf4aa0ec">00143</a> <a class="code" href="bmzip_8c.html#2eae1d29965aa1fefe537ee8bf4aa0ec">write_bmz_header</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">size_t</span> in_len, uint32_t checksum, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> options) {
<a name="l00144"></a>00144   <span class="keywordtype">char</span> buf[<a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>], *bp = buf;
<a name="l00145"></a>00145   uint64_t orig_size = in_len;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147   strcpy(buf, <a class="code" href="bmzip_8c.html#0e8eb00dc36b0e1f76093ea95f7cea28">BMZ_MAGIC</a>);
<a name="l00148"></a>00148   bp += strlen(<a class="code" href="bmzip_8c.html#0e8eb00dc36b0e1f76093ea95f7cea28">BMZ_MAGIC</a>);
<a name="l00149"></a>00149   <a class="code" href="bmzip_8c.html#8c3e573857fc8d6302a1b5e00b70bfce">BMZ_WRITE_INT16</a>(bp, <a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a>);
<a name="l00150"></a>00150   *bp++ = options;
<a name="l00151"></a>00151   <a class="code" href="bmzip_8c.html#2c4b1f4942482e6059de319c8d875508">BMZ_WRITE_INT48</a>(bp, orig_size);
<a name="l00152"></a>00152   <a class="code" href="bmzip_8c.html#5617212eca93255571eff97d0fa9f700">BMZ_WRITE_INT32</a>(bp, checksum);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <span class="keywordflow">if</span> (write(fd, buf, <a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>) != <a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>)
<a name="l00155"></a>00155     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error writing header (%lu bytes)"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)<a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>);
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00159"></a><a class="code" href="bmzip_8c.html#f10f408420daca8903b0b7f9715a9e29">00159</a> <a class="code" href="bmzip_8c.html#f10f408420daca8903b0b7f9715a9e29">do_list</a>(<span class="keywordtype">int</span> fd) {
<a name="l00160"></a>00160   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> buf[<a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>];
<a name="l00161"></a>00161   uint16_t <a class="code" href="namespace_hypertable.html#85aefb3a6fd2dae58e2349c41a0d5387">version</a>;
<a name="l00162"></a>00162   uint64_t orig_size, <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a>;
<a name="l00163"></a>00163   uint32_t checksum, options;
<a name="l00164"></a>00164   <span class="keyword">struct </span>stat st;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (fstat(fd, &amp;st) != 0) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error getting stat from file (%d)"</span>, fd);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168   size = st.st_size;
<a name="l00169"></a>00169   <a class="code" href="bmzip_8c.html#49322e63475d5cd473d3732b4de66ca5">read_bmz_header</a>(fd, buf);
<a name="l00170"></a>00170   <a class="code" href="bmzip_8c.html#74883689ec89cac218f7d56666936659">parse_bmz_header</a>(buf, &amp;version, &amp;orig_size, &amp;checksum, &amp;options);
<a name="l00171"></a>00171   printf(<span class="stringliteral">"%8s%16s%16s%8s\n"</span>, <span class="stringliteral">"version"</span>, <span class="stringliteral">"compressed"</span>, <span class="stringliteral">"uncompressed"</span>, <span class="stringliteral">"ratio"</span>);
<a name="l00172"></a>00172   printf(<span class="stringliteral">"    %04x%16llu%16llu%7.2f%%\n"</span>, version, (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)size,
<a name="l00173"></a>00173          (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)orig_size, orig_size ? size * 100. / orig_size : 1);
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="bmzip_8c.html#bfb46c87e8a9007a6fb1a8e0dea7679f">00177</a> <a class="code" href="bmzip_8c.html#bfb46c87e8a9007a6fb1a8e0dea7679f">do_pack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> buf_len,
<a name="l00178"></a>00178         <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> options) {
<a name="l00179"></a>00179   <span class="keywordtype">size_t</span> buflen = <a class="code" href="bmz_8c.html#565eb981fe7e7a2fc1fefc47ef491b8e" title="Compute bmz compression output buffer length.">bmz_pack_buflen</a>(in_len), out_len = buflen;
<a name="l00180"></a>00180   <span class="keywordtype">size_t</span> worklen = <a class="code" href="bmz_8c.html#c0b1526bfbf81c4511a27afee751d010" title="Return size of work memory for bmz compression.">bmz_pack_worklen</a>(in_len, fp_len);
<a name="l00181"></a>00181   <span class="keywordtype">int</span> ret, bm_only = (options &amp; <a class="code" href="bmzip_8c.html#347cf28c48a7885c722f1d5cd97e4bb1">BMZ_O_BM_ONLY</a>) || <a class="code" href="bmz-test_8c.html#0317a9ca721949733e3e0061c7823ee9">s_bm_dump</a>;
<a name="l00182"></a>00182   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *out, *work_mem;
<a name="l00183"></a>00183 
<a name="l00184"></a>00184   <span class="keywordflow">if</span> (bm_only) {
<a name="l00185"></a>00185     out_len = in_len + 1;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (buf_len &gt; in_len + worklen) {
<a name="l00188"></a>00188       out = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in + in_len;
<a name="l00189"></a>00189       work_mem = out + out_len;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     <span class="keywordflow">else</span> {
<a name="l00192"></a>00192       out = malloc(worklen); <span class="comment">/* bmz_pack_worklen includes out_len for bm */</span>
<a name="l00193"></a>00193 
<a name="l00194"></a>00194       <span class="keywordflow">if</span> (!out)
<a name="l00195"></a>00195         <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error allocating %lu bytes memory"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)worklen);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197       work_mem = out + out_len;
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     <span class="comment">/* calling internal API need to align work memory */</span>
<a name="l00200"></a>00200     work_mem = <a class="code" href="bmzip_8c.html#f99a457bcf4c90162037062bb47affe7">BMZ_ALIGN</a>(work_mem, 8);
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf_len &gt; buflen + worklen) {
<a name="l00203"></a>00203     work_mem = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in + buflen;
<a name="l00204"></a>00204     out = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in; <span class="comment">/* inplace */</span>
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206   <span class="keywordflow">else</span> {
<a name="l00207"></a>00207     out = malloc(buflen + worklen);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (!out)
<a name="l00210"></a>00210       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error allocating %lu bytes memory"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)buflen + worklen);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     work_mem = out + buflen;
<a name="l00213"></a>00213   }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (bm_only) {
<a name="l00216"></a>00216     ret = <a class="code" href="bmz-internal_8h.html#c4e27a682bb63aabd805edf34a6b330f">bmz_bm_pack_mask</a>(in, in_len, out, &amp;out_len, offset, fp_len,
<a name="l00217"></a>00217                            work_mem, 257);
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (ret != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>)
<a name="l00219"></a>00219       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error encoding bm output (error %d)"</span>, ret);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (<a class="code" href="bmz-test_8c.html#0317a9ca721949733e3e0061c7823ee9">s_bm_dump</a>) {
<a name="l00222"></a>00222       <span class="keywordflow">if</span> ((ret = <a class="code" href="bmz-internal_8h.html#fa1f001946fb0576f3f3dd9c9fe29199">bmz_bm_dump</a>(out, out_len)) != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>)
<a name="l00223"></a>00223         <a class="code" href="bmzip_8c.html#f369d408fd5724ef306a7731a697af9d">WARN</a>(<span class="stringliteral">"error dumping bm encoding (ret=%d)"</span>, ret);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225       <span class="keywordflow">return</span>;
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ret = <a class="code" href="bmz_8c.html#56feb9141bd6c6ece9151c4f40b8c638" title="Perform bmz compression.">bmz_pack</a>(in, in_len, out, &amp;out_len, offset, fp_len,
<a name="l00229"></a>00229                            (<a class="code" href="bmzip_8c.html#1a08a5b0ea7667c4859f2b4df4abd850">s_bm_hash</a> &lt;&lt; 24), work_mem))
<a name="l00230"></a>00230            != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>) {
<a name="l00231"></a>00231     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error compressing input (error %d)"</span>, ret);
<a name="l00232"></a>00232   }
<a name="l00233"></a>00233   <a class="code" href="bmzip_8c.html#2eae1d29965aa1fefe537ee8bf4aa0ec">write_bmz_header</a>(1, in_len, <a class="code" href="bmz_8c.html#054672aaf755771f6fa521b21b42a419" title="A fast checksum (adler32) function that might be useful.">bmz_checksum</a>(out, out_len), options);
<a name="l00234"></a>00234   write(1, out, out_len);
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00238"></a><a class="code" href="bmzip_8c.html#21025b473508205189dfc20c4ecb1389">00238</a> <a class="code" href="bmzip_8c.html#21025b473508205189dfc20c4ecb1389">do_unpack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> buf_len) {
<a name="l00239"></a>00239   <span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *bp = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in;
<a name="l00240"></a>00240   uint16_t <a class="code" href="namespace_hypertable.html#85aefb3a6fd2dae58e2349c41a0d5387">version</a>;
<a name="l00241"></a>00241   uint64_t orig_size;
<a name="l00242"></a>00242   uint32_t checksum, cs, options;
<a name="l00243"></a>00243   <span class="keywordtype">size_t</span> outlen, worklen, <a class="code" href="_range_server_8cc.html#ccdb2dff228b7a3ea4c3f61937a82412">len</a> = in_len - <a class="code" href="bmzip_8c.html#218c2ae4bcec84f418db33f846718a45">BMZ_HEADER_SZ</a>;
<a name="l00244"></a>00244   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *out, *workmem;
<a name="l00245"></a>00245   <span class="keywordtype">int</span> ret;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <span class="keywordflow">if</span> (in_len &lt; BMZ_HEADER_SZ) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"file truncated (size: %lu)"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)in_len);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <a class="code" href="bmzip_8c.html#74883689ec89cac218f7d56666936659">parse_bmz_header</a>(bp, &amp;version, &amp;orig_size, &amp;checksum, &amp;options);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="keywordflow">if</span> (orig_size &gt; INT_MAX &amp;&amp; <span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>) == 4)
<a name="l00252"></a>00252     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"original file size %llu requires 64-bit version of bmzip"</span>,
<a name="l00253"></a>00253         (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)orig_size);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   bp += BMZ_HEADER_SZ;
<a name="l00256"></a>00256   buf_len -= BMZ_HEADER_SZ;
<a name="l00257"></a>00257   cs = <a class="code" href="bmz_8c.html#054672aaf755771f6fa521b21b42a419" title="A fast checksum (adler32) function that might be useful.">bmz_checksum</a>(bp, len);
<a name="l00258"></a>00258   outlen = orig_size;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   <span class="keywordflow">if</span> (cs != checksum)
<a name="l00261"></a>00261     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"checksum mismatch (expecting %x, got %x)."</span>, checksum, cs);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="keywordflow">if</span> (options &amp; <a class="code" href="bmzip_8c.html#347cf28c48a7885c722f1d5cd97e4bb1">BMZ_O_BM_ONLY</a>) {
<a name="l00264"></a>00264     out = buf_len &gt; in_len + orig_size ? (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a>*)bp + len : malloc(outlen);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">if</span> ((ret = <a class="code" href="bmz-internal_8h.html#2597fab94d23d868c24c1d3878f01756">bmz_bm_unpack</a>(bp, len, out, &amp;outlen)) != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>)
<a name="l00267"></a>00267       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error decoding bm input (error %d)"</span>, ret);
<a name="l00268"></a>00268   }
<a name="l00269"></a>00269   <span class="keywordflow">else</span> {
<a name="l00270"></a>00270     worklen = <a class="code" href="bmz_8c.html#8a29912372c85a850b530ba8143034dc" title="Return size of work memory for bmz decompression.">bmz_unpack_worklen</a>(orig_size &gt; len ? orig_size : len);
<a name="l00271"></a>00271     out = (buf_len &gt; outlen + worklen) ? (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)bp : malloc(outlen + worklen);
<a name="l00272"></a>00272     workmem = out + outlen;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> ((ret = <a class="code" href="bmz_8c.html#a251ec18664698ab168a138221b37c6a" title="Perform bmz decompression.">bmz_unpack</a>(bp, len, out, &amp;outlen, workmem)) != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>)
<a name="l00275"></a>00275       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error decompressing (error %d)"</span>, ret);
<a name="l00276"></a>00276   }
<a name="l00277"></a>00277   <span class="keywordflow">if</span> (orig_size != outlen)
<a name="l00278"></a>00278     <a class="code" href="bmzip_8c.html#f369d408fd5724ef306a7731a697af9d">WARN</a>(<span class="stringliteral">"size mismatch (expecting %llu, got %llu)"</span>,
<a name="l00279"></a>00279          (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)orig_size, (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)outlen);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   write(1, out, outlen);
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00285"></a><a class="code" href="bmzip_8c.html#51431ed5a819683c7796b4ea635cbef7">00285</a> <a class="code" href="bmzip_8c.html#51431ed5a819683c7796b4ea635cbef7">do_block</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#ccdb2dff228b7a3ea4c3f61937a82412">len</a>, <span class="keywordtype">size_t</span> buf_len, <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>,
<a name="l00286"></a>00286          <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> options) {
<a name="l00287"></a>00287   <span class="keywordflow">switch</span> (action) {
<a name="l00288"></a>00288   <span class="keywordflow">case</span> <a class="code" href="bmzip_8c.html#f075eb20e1928c94a890e00e7b7b4474">BMZ_A_PACK</a>:
<a name="l00289"></a>00289     <a class="code" href="bmzip_8c.html#bfb46c87e8a9007a6fb1a8e0dea7679f">do_pack</a>(in, len, buf_len, offset, fp_len, options);
<a name="l00290"></a>00290     <span class="keywordflow">break</span>;
<a name="l00291"></a>00291   <span class="keywordflow">case</span> <a class="code" href="bmzip_8c.html#f4ddd3d497fe8c0fd2b249ec88ce5476">BMZ_A_UNPACK</a>:
<a name="l00292"></a>00292     <a class="code" href="bmzip_8c.html#21025b473508205189dfc20c4ecb1389">do_unpack</a>(in, len, buf_len);
<a name="l00293"></a>00293     <span class="keywordflow">break</span>;
<a name="l00294"></a>00294   <span class="keywordflow">default</span>:
<a name="l00295"></a>00295     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"unknown action: %d"</span>, action);
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00300"></a><a class="code" href="bmzip_8c.html#8f1a0c95867c49c84c70b33869041c65">00300</a> <a class="code" href="bmz-test_8c.html#61637dcf83e2e87dd48ef0cdcc7a7ee3">read_from_fp</a>(FILE *fp, <span class="keywordtype">size_t</span> *len_p, <span class="keywordtype">size_t</span> *size_p) {
<a name="l00301"></a>00301   <span class="keywordtype">char</span> *data = NULL;
<a name="l00302"></a>00302   <span class="keywordtype">char</span> buf[65536];
<a name="l00303"></a>00303   int64_t <a class="code" href="_range_server_8cc.html#ccdb2dff228b7a3ea4c3f61937a82412">len</a> = 0, <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a> = 0, ret;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="keywordflow">while</span> ((ret = fread(buf, 1, <span class="keyword">sizeof</span>(buf), fp)) &gt; 0) {
<a name="l00306"></a>00306     len += ret;
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (len &gt; INT_MAX)
<a name="l00308"></a>00308       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"reading from stdin for data size greater than 2GB "</span>
<a name="l00309"></a>00309           <span class="stringliteral">"not yet supported (current size: %lld)"</span>, (<span class="keywordtype">long</span> <span class="keywordtype">long</span>)len);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (len &gt; <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a>) {
<a name="l00312"></a>00312       <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a> = (len + 16) * 5 / 2;
<a name="l00313"></a>00313       data = realloc(data, <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a>);
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     memcpy(data + len - ret, buf, ret);
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317   *len_p = len;
<a name="l00318"></a>00318   *size_p = <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a>;
<a name="l00319"></a>00319   <span class="keywordflow">return</span> data;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00323"></a><a class="code" href="bmzip_8c.html#80c8a1e0abf4c21a0427cd37ab6de156">00323</a> <a class="code" href="bmzip_8c.html#80c8a1e0abf4c21a0427cd37ab6de156">read_from_fd</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">size_t</span> *len_p, <span class="keywordtype">size_t</span> *size_p) {
<a name="l00324"></a>00324   <span class="keyword">struct </span>stat st;
<a name="l00325"></a>00325   <span class="keywordtype">void</span> *data = NULL;
<a name="l00326"></a>00326   <span class="keywordtype">size_t</span> sz;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328   <span class="keywordflow">if</span> (fstat(fd, &amp;st) != 0) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"cannot stat fd &lt;%d&gt;"</span>, fd);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   <span class="keywordflow">if</span> (st.st_size &gt; INT_MAX &amp;&amp; <span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>) == 4)
<a name="l00331"></a>00331     <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"file size %llu requires 64-bit version of bmzip"</span>,
<a name="l00332"></a>00332         (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)st.st_size);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334   sz = *len_p = *size_p = st.st_size;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   <span class="keywordflow">if</span> (!sz) <span class="keywordflow">return</span> data;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="keywordflow">if</span> (!<a class="code" href="bmz-test_8c.html#de42f0ac72d07366d11d775d0c10f76a" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">s_no_mmap</a>) {
<a name="l00339"></a>00339 <span class="preprocessor">#ifndef HT_NO_MMAP</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>    <a class="code" href="bmz-test_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">LOG</a>(1, <span class="stringliteral">"mmapping file (size: %lu)..."</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)sz);
<a name="l00341"></a>00341     data = mmap(NULL, sz, PROT_READ, MAP_PRIVATE, fd, 0);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (!data || (<span class="keywordtype">void</span> *)-1 == data) {
<a name="l00344"></a>00344       <a class="code" href="bmz-test_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">LOG</a>(1, <span class="stringliteral">"mmap failed on fd %d"</span>, fd);
<a name="l00345"></a>00345       errno = 0;
<a name="l00346"></a>00346       <a class="code" href="bmz-test_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">LOG</a>(1, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"trying alternative"</span>);
<a name="l00347"></a>00347       data = NULL;
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 <span class="preprocessor">#endif</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>  }
<a name="l00351"></a>00351   <span class="keywordflow">if</span> (!data) {
<a name="l00352"></a>00352     <a class="code" href="bmz-test_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">LOG</a>(1, <span class="stringliteral">"reading file (size: %lu) into memory..."</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)sz);
<a name="l00353"></a>00353     data = malloc(sz);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (!data) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"cannot allocate %lu bytes memory"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)sz);
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (read(fd, data, sz) != sz) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"error reading %lu bytes"</span>, (<a class="code" href="bmz-test_8c.html#bd0e9dfdb207906e611de2be4cb7b135">Lu</a>)sz);
<a name="l00358"></a>00358   }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordflow">return</span> data;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00364"></a><a class="code" href="bmzip_8c.html#924c59747250df044d83dfe68b5163e0">00364</a> <a class="code" href="bmzip_8c.html#924c59747250df044d83dfe68b5163e0">input_from_stdin</a>(<span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">int</span> action, <span class="keywordtype">int</span> options) {
<a name="l00365"></a>00365   <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#ccdb2dff228b7a3ea4c3f61937a82412">len</a>, buf_len;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   <span class="keywordflow">if</span> (action == <a class="code" href="bmzip_8c.html#9e4cea0e9ab633418f0396723179fb8a">BMZ_A_LIST</a>) {
<a name="l00368"></a>00368     <a class="code" href="bmzip_8c.html#f10f408420daca8903b0b7f9715a9e29">do_list</a>(0);
<a name="l00369"></a>00369   }
<a name="l00370"></a>00370   <span class="keywordflow">else</span> {
<a name="l00371"></a>00371     <span class="keywordtype">void</span> *data = <a class="code" href="bmz-test_8c.html#61637dcf83e2e87dd48ef0cdcc7a7ee3">read_from_fp</a>(stdin, &amp;len, &amp;buf_len);
<a name="l00372"></a>00372     <a class="code" href="bmzip_8c.html#51431ed5a819683c7796b4ea635cbef7">do_block</a>(data, len, buf_len, offset, fp_len, action, options);
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00377"></a><a class="code" href="bmzip_8c.html#197035a6f7497ffb3184b4bc459ca498">00377</a> <a class="code" href="bmzip_8c.html#197035a6f7497ffb3184b4bc459ca498">input_from_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname, <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">int</span> action,
<a name="l00378"></a>00378                 <span class="keywordtype">int</span> options) {
<a name="l00379"></a>00379   <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#ccdb2dff228b7a3ea4c3f61937a82412">len</a>, buf_len;
<a name="l00380"></a>00380   <span class="keywordtype">int</span> fd = open(fname, O_RDONLY, 0);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   <span class="keywordflow">if</span> (fd == -1) <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"cannot open '%s'"</span>, fname);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="keywordflow">if</span> (action == <a class="code" href="bmzip_8c.html#9e4cea0e9ab633418f0396723179fb8a">BMZ_A_LIST</a>) {
<a name="l00385"></a>00385     <a class="code" href="bmzip_8c.html#f10f408420daca8903b0b7f9715a9e29">do_list</a>(fd);
<a name="l00386"></a>00386   }
<a name="l00387"></a>00387   <span class="keywordflow">else</span> {
<a name="l00388"></a>00388     <span class="keywordtype">void</span> *data = <a class="code" href="bmzip_8c.html#80c8a1e0abf4c21a0427cd37ab6de156">read_from_fd</a>(fd, &amp;len, &amp;buf_len);
<a name="l00389"></a>00389     <a class="code" href="bmzip_8c.html#51431ed5a819683c7796b4ea635cbef7">do_block</a>(data, len, buf_len, offset, fp_len, action, options);
<a name="l00390"></a>00390   }
<a name="l00391"></a>00391   <span class="comment">/* close and free etc. are omitted intentionally */</span>
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00395"></a><a class="code" href="bmzip_8c.html#fec682fc1ae7a54c525af4d6c49af0be">00395</a> <a class="code" href="bmzip_8c.html#fec682fc1ae7a54c525af4d6c49af0be">bm_hash</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00396"></a>00396 
<a name="l00397"></a>00397   <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"mod"</span>, name))             <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#bdd4ffb59c09910bb6187afb9d81a680" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BMZ_HASH_MOD</a>;
<a name="l00398"></a>00398   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"mod16x2"</span>, name))    <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#98eddc5603e74b3d34930cc2b8bd806e">BMZ_HASH_MOD16X2</a>;
<a name="l00399"></a>00399   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"mask16x2"</span>, name))   <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#fa4019afd464eb9044696285482042fa">BMZ_HASH_MASK16X2</a>;
<a name="l00400"></a>00400   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"mask"</span>, name))       <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#1bf2311a8eccf8da1d429bec69fda5fe">BMZ_HASH_MASK</a>;
<a name="l00401"></a>00401   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"mask32x2"</span>, name))   <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#eff04f542211021ab9025be24d5eee0f">BMZ_HASH_MASK32X2</a>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"unknown hash: %s"</span>, name);
<a name="l00404"></a>00404   <span class="keywordflow">return</span> 0;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="compat-c_8h.html#dc5949cc900c9dfe835aafd60d9326bc">HT_NORETURN</a>
<a name="l00408"></a><a class="code" href="bmzip_8c.html#205dba4551789664cfc5102f70a4a716">00408</a> <a class="code" href="bmz-test_8c.html#35ee06182a68a7e4ddf45e3b888e60c1">show_usage</a>() {
<a name="l00409"></a>00409   fprintf(stderr, <span class="stringliteral">"%s%s"</span>, <span class="comment">/* c89 string literal limit is 509 */</span>
<a name="l00410"></a>00410     <span class="stringliteral">"usage: bmzip [options] [&lt;file&gt;]\n"</span>
<a name="l00411"></a>00411     <span class="stringliteral">"-d, --decompress         decompress to stdout\n"</span>
<a name="l00412"></a>00412     <span class="stringliteral">"--verbose[=level]        show some diagnostic messages\n"</span>
<a name="l00413"></a>00413     <span class="stringliteral">"-l, --list               list compressed file info\n"</span>
<a name="l00414"></a>00414     <span class="stringliteral">"-h, --help               show this message\n"</span>
<a name="l00415"></a>00415     <span class="stringliteral">"--offset    &lt;number&gt;     expert: bm encoding start offset\n"</span>
<a name="l00416"></a>00416     <span class="stringliteral">"--fp-len    &lt;number&gt;     expert: bm encoding fingerprint size\n"</span>
<a name="l00417"></a>00417     <span class="stringliteral">"--bm-thresh &lt;number&gt;     expert: bm hash collision threshold\n"</span>,
<a name="l00418"></a>00418     <span class="stringliteral">"--bm-hash   &lt;name&gt;       expert: use &lt;name&gt; as bm hash\n"</span>
<a name="l00419"></a>00419     <span class="stringliteral">"--bm-only                expert: skip lz compression\n"</span>
<a name="l00420"></a>00420     <span class="stringliteral">"--bm-dump                expert: dump human readable bm encoding\n"</span>
<a name="l00421"></a>00421     <span class="stringliteral">"--no-mmap                expert: do not use mmap\n"</span>);
<a name="l00422"></a>00422   exit(0);
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="keywordtype">int</span>
<a name="l00426"></a><a class="code" href="bmzip_8c.html#dacbe0175a79dff748855d8c9839f82b">00426</a> <a class="code" href="sample_client_8cc.html#3c04138a5bfe5d72780bb7e82a18e627" title="main function">main</a>(<span class="keywordtype">int</span> ac, <span class="keywordtype">char</span> *av[]) {
<a name="l00427"></a>00427   <span class="keywordtype">char</span> **ia = av + 1, **a_end = av + ac;
<a name="l00428"></a>00428   <span class="comment">/* defaults */</span>
<a name="l00429"></a>00429   <span class="keywordtype">size_t</span> fp_len = 64, <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a> = 0;
<a name="l00430"></a>00430   <span class="keywordtype">int</span> bm_thresh = 0, action = <a class="code" href="bmzip_8c.html#f075eb20e1928c94a890e00e7b7b4474">BMZ_A_PACK</a>, options = 0;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432   <span class="keywordflow">for</span> (; ia &lt; a_end; ++ia) {
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"-d"</span>, *ia) ||
<a name="l00434"></a>00434         !strcmp(<span class="stringliteral">"--decompress"</span>, *ia))           action = <a class="code" href="bmzip_8c.html#f4ddd3d497fe8c0fd2b249ec88ce5476">BMZ_A_UNPACK</a>;
<a name="l00435"></a>00435     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--verbose"</span>, *ia))         <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a> = 1;
<a name="l00436"></a>00436     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--verbose="</span>, *ia))        <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a> = atoi(*ia + 9);
<a name="l00437"></a>00437     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--offset"</span>, *ia))          <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a> = atoi(*++ia);
<a name="l00438"></a>00438     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--fp-len"</span>, *ia))          fp_len = atoi(*++ia);
<a name="l00439"></a>00439     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--bm-only"</span>, *ia))         options |= <a class="code" href="bmzip_8c.html#347cf28c48a7885c722f1d5cd97e4bb1">BMZ_O_BM_ONLY</a>;
<a name="l00440"></a>00440     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--bm-dump"</span>, *ia))         <a class="code" href="bmz-test_8c.html#0317a9ca721949733e3e0061c7823ee9">s_bm_dump</a> = 1;
<a name="l00441"></a>00441     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--no-mmap"</span>, *ia))         <a class="code" href="bmz-test_8c.html#de42f0ac72d07366d11d775d0c10f76a" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">s_no_mmap</a> = 1;
<a name="l00442"></a>00442     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--bm-thresh"</span>, *ia))       bm_thresh = atoi(*++ia);
<a name="l00443"></a>00443     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--bm-hash"</span>, *ia))         <a class="code" href="bmzip_8c.html#1a08a5b0ea7667c4859f2b4df4abd850">s_bm_hash</a> = <a class="code" href="bmzip_8c.html#fec682fc1ae7a54c525af4d6c49af0be">bm_hash</a>(*++ia);
<a name="l00444"></a>00444     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"-l"</span>, *ia) ||
<a name="l00445"></a>00445              !strcmp(<span class="stringliteral">"--list"</span>, *ia))            action = <a class="code" href="bmzip_8c.html#9e4cea0e9ab633418f0396723179fb8a">BMZ_A_LIST</a>;
<a name="l00446"></a>00446     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"-h"</span>, *ia) ||
<a name="l00447"></a>00447              !strcmp(<span class="stringliteral">"--help"</span>, *ia)) {
<a name="l00448"></a>00448       <a class="code" href="bmz-test_8c.html#35ee06182a68a7e4ddf45e3b888e60c1">show_usage</a>();
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--version"</span>, *ia)) {
<a name="l00451"></a>00451       <a class="code" href="bmz-test_8c.html#75b66fc8fe89645e55a8a0c565bb7ecd">LOG</a>(0, <span class="stringliteral">"version %d.%d.%d.%d"</span>, <a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a> &gt;&gt; 12, (<a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a> &gt;&gt; 8) &amp; 0xf,
<a name="l00452"></a>00452           (<a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a> &gt;&gt; 4) &amp; 0xf, <a class="code" href="bmzip_8c.html#6a39cad583f9d41e8b3e151d6698d273">BMZIP_VER</a> &amp; 0xf);
<a name="l00453"></a>00453       exit(0);
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">"--"</span>, *ia)) {
<a name="l00456"></a>00456       ++ia;
<a name="l00457"></a>00457       <span class="keywordflow">break</span>;
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="charliteral">'-'</span> == **ia)
<a name="l00460"></a>00460       <a class="code" href="bmz-test_8c.html#57d9be48a2d2312a1e3303af874430ac">DIE</a>(<span class="stringliteral">"unknown option: %s\n"</span>, *ia);
<a name="l00461"></a>00461     <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463   <span class="keywordflow">if</span> (<a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a>)
<a name="l00464"></a>00464     <a class="code" href="bmz_8c.html#d74fc6f9c6dff79187315dbd77b94211" title="Set the verbosity of library for testing and debugging.">bmz_set_verbosity</a>(<a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="keywordflow">if</span> (bm_thresh)
<a name="l00467"></a>00467     <a class="code" href="bmz-internal_8h.html#afd166b1917ad7a7bc1eb4d9dc8db7a4">bmz_set_collision_thresh</a>(bm_thresh);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469   <span class="keywordflow">if</span> (ia &gt;= a_end)
<a name="l00470"></a>00470     <a class="code" href="bmzip_8c.html#924c59747250df044d83dfe68b5163e0">input_from_stdin</a>(<a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, fp_len, action, options);
<a name="l00471"></a>00471   <span class="keywordflow">else</span>
<a name="l00472"></a>00472     <a class="code" href="bmzip_8c.html#197035a6f7497ffb3184b4bc459ca498">input_from_file</a>(*ia, <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, fp_len, action, options);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="keywordflow">return</span> 0;
<a name="l00475"></a>00475 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Thu Jan 22 17:08:40 2009 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
