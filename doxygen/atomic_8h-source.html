<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Common/atomic.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c15830aad3a99e858e4f63b1b1579632.html">Common</a></div>
<h1>atomic.h</h1><a href="atomic_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#ifndef ATOMIC_H</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#define ATOMIC_H</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>
<a name="l00025"></a>00025 <span class="comment">/*</span>
<a name="l00026"></a>00026 <span class="comment"> * Atomic operations that C can't guarantee us.  Useful for</span>
<a name="l00027"></a>00027 <span class="comment"> * resource counting etc..</span>
<a name="l00028"></a>00028 <span class="comment"> */</span>
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9">00030</a> <span class="preprocessor">#define LOCK "lock ; "</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="comment">/*</span>
<a name="l00033"></a>00033 <span class="comment"> * Make sure gcc doesn't try to be clever and move things around</span>
<a name="l00034"></a>00034 <span class="comment"> * on us. We need to use _exactly_ the address the user gave us,</span>
<a name="l00035"></a>00035 <span class="comment"> * not some alias that contains the same information.</span>
<a name="l00036"></a>00036 <span class="comment"> */</span>
<a name="l00037"></a><a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keyword">volatile</span> <span class="keywordtype">int</span> counter; } <a class="code" href="structatomic__t.html">atomic_t</a>;
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="atomic_8h.html#adfbba86627ee7eeb07e04f712550f73">00039</a> <span class="preprocessor">#define ATOMIC_INIT(i)  { (i) }</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="atomic_8h.html#1414350b98d3d1dc33887f9da5878542">00047</a> <span class="preprocessor">#define atomic_read(v)          ((v)-&gt;counter)</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="atomic_8h.html#f7cad706a5bba06487b2011794061922">00056</a> <span class="preprocessor">#define atomic_set(v,i)         (((v)-&gt;counter) = (i))</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00065"></a><a class="code" href="atomic_8h.html#7abb2a98ebfd289ae30ea2e013219d49">00065</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">void</span> <a class="code" href="atomic_8h.html#7abb2a98ebfd289ae30ea2e013219d49" title="atomic_add - add integer to atomic variable">atomic_add</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067         __asm__ __volatile__(
<a name="l00068"></a>00068                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"addl %1,%0"</span>
<a name="l00069"></a>00069                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>)
<a name="l00070"></a>00070                 :<span class="stringliteral">"ir"</span> (i), <span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>));
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00080"></a><a class="code" href="atomic_8h.html#84fc94018cf738df7c0e62747d99cb5a">00080</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">void</span> <a class="code" href="atomic_8h.html#84fc94018cf738df7c0e62747d99cb5a" title="atomic_sub - subtract the atomic variable">atomic_sub</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082         __asm__ __volatile__(
<a name="l00083"></a>00083                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"subl %1,%0"</span>
<a name="l00084"></a>00084                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>)
<a name="l00085"></a>00085                 :<span class="stringliteral">"ir"</span> (i), <span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>));
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 
<a name="l00096"></a><a class="code" href="atomic_8h.html#212b07d03c1ffb219e12107f09f6453a">00096</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#212b07d03c1ffb219e12107f09f6453a" title="atomic_add_return - add and return">atomic_add_return</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098   <span class="keywordtype">int</span> __i;
<a name="l00099"></a>00099   <span class="comment">/* Modern 486+ processor */</span>
<a name="l00100"></a>00100   __i = i;
<a name="l00101"></a>00101   __asm__ __volatile__(
<a name="l00102"></a>00102                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"xaddl %0, %1"</span>
<a name="l00103"></a>00103                 :<span class="stringliteral">"+r"</span> (i), <span class="stringliteral">"+m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>)
<a name="l00104"></a>00104                 : : <span class="stringliteral">"memory"</span>);
<a name="l00105"></a>00105   <span class="keywordflow">return</span> i + __i;
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="atomic_8h.html#3773f91d8c52ec9675faab41e2f5ed66">00108</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#3773f91d8c52ec9675faab41e2f5ed66">atomic_sub_return</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110   <span class="keywordflow">return</span> <a class="code" href="atomic_8h.html#212b07d03c1ffb219e12107f09f6453a" title="atomic_add_return - add and return">atomic_add_return</a>(-i,v);
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00123"></a><a class="code" href="atomic_8h.html#80a3daad64ad057b95fdc1e0f3ad3232">00123</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#80a3daad64ad057b95fdc1e0f3ad3232" title="atomic_sub_and_test - subtract value from variable and test result">atomic_sub_and_test</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         __asm__ __volatile__(
<a name="l00128"></a>00128                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"subl %2,%0; sete %1"</span>
<a name="l00129"></a>00129                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>), <span class="stringliteral">"=qm"</span> (c)
<a name="l00130"></a>00130                 :<span class="stringliteral">"ir"</span> (i), <span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>) : <span class="stringliteral">"memory"</span>);
<a name="l00131"></a>00131         <span class="keywordflow">return</span> c;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00140"></a><a class="code" href="atomic_8h.html#8fc6b0729a9de37de8f4ec8792fc84fe">00140</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">void</span> <a class="code" href="atomic_8h.html#8fc6b0729a9de37de8f4ec8792fc84fe" title="atomic_inc - increment atomic variable">atomic_inc</a>(<a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142         __asm__ __volatile__(
<a name="l00143"></a>00143                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"incl %0"</span>
<a name="l00144"></a>00144                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>)
<a name="l00145"></a>00145                 :<span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>));
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00154"></a><a class="code" href="atomic_8h.html#0423d42645a2cd4390c64f537499c786">00154</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">void</span> <a class="code" href="atomic_8h.html#0423d42645a2cd4390c64f537499c786" title="atomic_dec - decrement atomic variable">atomic_dec</a>(<a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         __asm__ __volatile__(
<a name="l00157"></a>00157                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"decl %0"</span>
<a name="l00158"></a>00158                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>)
<a name="l00159"></a>00159                 :<span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>));
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00170"></a><a class="code" href="atomic_8h.html#9911d165f831a1467c6feb92e94803ce">00170</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#9911d165f831a1467c6feb92e94803ce" title="atomic_dec_and_test - decrement and test">atomic_dec_and_test</a>(<a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         __asm__ __volatile__(
<a name="l00175"></a>00175                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"decl %0; sete %1"</span>
<a name="l00176"></a>00176                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>), <span class="stringliteral">"=qm"</span> (c)
<a name="l00177"></a>00177                 :<span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>) : <span class="stringliteral">"memory"</span>);
<a name="l00178"></a>00178         <span class="keywordflow">return</span> c != 0;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00189"></a><a class="code" href="atomic_8h.html#09c0cb23a1c79d0385c147d4ae65854a">00189</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#09c0cb23a1c79d0385c147d4ae65854a" title="atomic_inc_and_test - increment and test">atomic_inc_and_test</a>(<a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         __asm__ __volatile__(
<a name="l00194"></a>00194                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"incl %0; sete %1"</span>
<a name="l00195"></a>00195                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>), <span class="stringliteral">"=qm"</span> (c)
<a name="l00196"></a>00196                 :<span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>) : <span class="stringliteral">"memory"</span>);
<a name="l00197"></a>00197         <span class="keywordflow">return</span> c != 0;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00209"></a><a class="code" href="atomic_8h.html#5920f7b99048501fc09ace54cfff56da">00209</a> <span class="keyword">static</span> __inline__ <span class="keywordtype">int</span> <a class="code" href="atomic_8h.html#5920f7b99048501fc09ace54cfff56da" title="atomic_add_negative - add and test if negative">atomic_add_negative</a>(<span class="keywordtype">int</span> i, <a class="code" href="structatomic__t.html">atomic_t</a> *v)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         __asm__ __volatile__(
<a name="l00214"></a>00214                 <a class="code" href="atomic_8h.html#0376b2ead2de10bb7ab6a4d21ec304e9" title="Copyright (C) 2007 Doug Judd (Zvents, Inc.">LOCK</a> <span class="stringliteral">"addl %2,%0; sets %1"</span>
<a name="l00215"></a>00215                 :<span class="stringliteral">"=m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>), <span class="stringliteral">"=qm"</span> (c)
<a name="l00216"></a>00216                 :<span class="stringliteral">"ir"</span> (i), <span class="stringliteral">"m"</span> (v-&gt;<a class="code" href="structatomic__t.html#020ccc869804eafc5ef2e62c3cf63a36">counter</a>) : <span class="stringliteral">"memory"</span>);
<a name="l00217"></a>00217         <span class="keywordflow">return</span> c;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">/* These are x86-specific, used by some header files */</span>
<a name="l00221"></a><a class="code" href="atomic_8h.html#94d0a2ac311f156e6da39aa7e4cadfdd">00221</a> <span class="preprocessor">#define atomic_clear_mask(mask, addr) \</span>
<a name="l00222"></a>00222 <span class="preprocessor">__asm__ __volatile__(LOCK "andl %0,%1" \</span>
<a name="l00223"></a>00223 <span class="preprocessor">: : "r" (~(mask)),"m" (*addr) : "memory")</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>
<a name="l00225"></a><a class="code" href="atomic_8h.html#31fa242f313934b5ced4bce00b5e97fe">00225</a> <span class="preprocessor">#define atomic_set_mask(mask, addr) \</span>
<a name="l00226"></a>00226 <span class="preprocessor">__asm__ __volatile__(LOCK "orl %0,%1" \</span>
<a name="l00227"></a>00227 <span class="preprocessor">: : "r" (mask),"m" (*(addr)) : "memory")</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>
<a name="l00229"></a><a class="code" href="atomic_8h.html#9a5d8951b9c8bae6c060b2bf41a76d03">00229</a> <span class="preprocessor">#define atomic_inc_return(v)  (atomic_add_return(1,v))</span>
<a name="l00230"></a><a class="code" href="atomic_8h.html#aea8262792e217f9d545777bd1f466f1">00230</a> <span class="preprocessor"></span><span class="preprocessor">#define atomic_dec_return(v)  (atomic_sub_return(1,v))</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>
<a name="l00232"></a>00232 <span class="preprocessor">#endif // ATOMIC_H</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Thu Aug 14 23:00:25 2008 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
