<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/Lib/MetaLogDfsBase.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ad5135801673f2e4c4e1be66fcd2e528.html">Lib</a></div>
<h1>MetaLogDfsBase.cc</h1><a href="_meta_log_dfs_base_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="_compat_8h.html">Common/Compat.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="_logger_8h.html">Common/Logger.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="_serialization_8h.html">Common/Serialization.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_checksum_8h.html">Common/Checksum.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="_hypertable_2_lib_2_filesystem_8h.html">Filesystem.h</a>"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "<a class="code" href="_meta_log_dfs_base_8h.html">MetaLogDfsBase.h</a>"</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include "<a class="code" href="_meta_log_version_8h.html">MetaLogVersion.h</a>"</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">using namespace </span>Hypertable;
<a name="l00031"></a>00031 <span class="keyword">using namespace </span>Serialization;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="keyword">namespace </span>{
<a name="l00034"></a><a class="code" href="_meta_log_dfs_base_8cc.html#5cf4bf314464014c27932fc29b65c1a2">00034</a>   <span class="keyword">const</span> int32_t <a class="code" href="_meta_log_dfs_base_8cc.html#5cf4bf314464014c27932fc29b65c1a2">DFS_BUFFER_SIZE</a> = -1;  <span class="comment">// use dfs defaults</span>
<a name="l00035"></a><a class="code" href="_meta_log_dfs_base_8cc.html#25cb836c39eacdf5ec45aacc7fe192d4">00035</a>   <span class="keyword">const</span> int32_t <a class="code" href="_meta_log_dfs_base_8cc.html#25cb836c39eacdf5ec45aacc7fe192d4">DFS_NUM_REPLICAS</a> = -1; <span class="comment">// ditto</span>
<a name="l00036"></a><a class="code" href="_meta_log_dfs_base_8cc.html#3694567392a9ed542cf51a3e73dea701">00036</a>   <span class="keyword">const</span> int64_t <a class="code" href="_meta_log_dfs_base_8cc.html#3694567392a9ed542cf51a3e73dea701">DFS_BLOCK_SIZE</a> = -1;   <span class="comment">// ditto</span>
<a name="l00037"></a><a class="code" href="_meta_log_dfs_base_8cc.html#c75819c973a4f443673b0f0413f69c26">00037</a>   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="_meta_log_dfs_base_8cc.html#c75819c973a4f443673b0f0413f69c26">ML_ENTRY_BUFFER_RESERVE</a> = <a class="code" href="namespace_hypertable.html#ce6f9acaa29b01eb88692281d9e7a154d6bfd277f566ed30001568222610847f">ML_ENTRY_HEADER_SIZE</a> + 512;
<a name="l00038"></a><a class="code" href="_meta_log_dfs_base_8cc.html#c7c659848d47890b867b87da458ba9c3">00038</a>   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="_meta_log_dfs_base_8cc.html#c7c659848d47890b867b87da458ba9c3">DFS_XFER_SIZE</a> = 32768;
<a name="l00039"></a>00039 } <span class="comment">// local namespace</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#8689982ab6b3c7357047db337ffc0c20">00041</a> MetaLogDfsBase::MetaLogDfsBase(<a class="code" href="class_hypertable_1_1_filesystem.html" title="Abstract base class for a filesystem.">Filesystem</a> *fs, <span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> &amp;path)
<a name="l00042"></a>00042   : m_fd(-1), <a class="code" href="_master_gc_8cc.html#51a6a59072bffa39a9536f577d592c4a">m_fs</a>(fs), m_path(path) {
<a name="l00043"></a>00043   <span class="keywordflow">if</span> (fs &amp;&amp; !fs-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#e918339c060e60283516cd1478be601b" title="Determines if a file exists asynchronously.">exists</a>(path))
<a name="l00044"></a>00044     <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#ced2cb5905053fd6f775a204509232d5">m_fd</a> = <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#b398da24fe2e04bd9bab6d88f92e3978">create</a>(path);
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keywordtype">int</span>
<a name="l00048"></a><a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#b398da24fe2e04bd9bab6d88f92e3978">00048</a> <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#b398da24fe2e04bd9bab6d88f92e3978">MetaLogDfsBase::create</a>(<span class="keyword">const</span> <a class="code" href="namespace_hypertable.html#bd74d0aa26c0528285dc77325ca89511" title="We might want to use something better later, as std::string always causes a heap...">String</a> &amp;<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#afc02456ce5727025e430c41903fba2c">path</a>, <span class="keywordtype">bool</span> overwrite) {
<a name="l00049"></a>00049   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt;<span class="stringliteral">"path="</span>&lt;&lt; path &lt;&lt;<span class="stringliteral">" overwrite="</span>&lt;&lt; overwrite &lt;&lt;<span class="stringliteral">" buffer size="</span>
<a name="l00050"></a>00050       &lt;&lt; <a class="code" href="_meta_log_dfs_base_8cc.html#5cf4bf314464014c27932fc29b65c1a2">DFS_BUFFER_SIZE</a> &lt;&lt;<span class="stringliteral">" replicas="</span>&lt;&lt; <a class="code" href="_meta_log_dfs_base_8cc.html#25cb836c39eacdf5ec45aacc7fe192d4">DFS_NUM_REPLICAS</a> &lt;&lt;<span class="stringliteral">" block size="</span>
<a name="l00051"></a>00051       &lt;&lt; <a class="code" href="_meta_log_dfs_base_8cc.html#3694567392a9ed542cf51a3e73dea701">DFS_BLOCK_SIZE</a> &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00052"></a>00052   <span class="keywordflow">return</span> <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#8367fe1347135cd362ba0b7489903a49">m_fs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#6dbb0c7029273eb093b899ff1ebc427a" title="Creates a file asynchronously.">create</a>(path, overwrite, <a class="code" href="_meta_log_dfs_base_8cc.html#5cf4bf314464014c27932fc29b65c1a2">DFS_BUFFER_SIZE</a>, <a class="code" href="_meta_log_dfs_base_8cc.html#25cb836c39eacdf5ec45aacc7fe192d4">DFS_NUM_REPLICAS</a>,
<a name="l00053"></a>00053                       <a class="code" href="_meta_log_dfs_base_8cc.html#3694567392a9ed542cf51a3e73dea701">DFS_BLOCK_SIZE</a>);
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keywordtype">void</span>
<a name="l00057"></a><a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#a1cbdca477c8117ede0b7415cbdd5753">00057</a> <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#a1cbdca477c8117ede0b7415cbdd5753" title="Close the metalog Implementation should handle multiple close calls.">MetaLogDfsBase::close</a>() {
<a name="l00058"></a>00058   <span class="keywordflow">try</span> {
<a name="l00059"></a>00059     <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#8367fe1347135cd362ba0b7489903a49">m_fs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#d3deed031599d136309dc75369b72f6a" title="Closes a file asynchronously.">close</a>(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#ced2cb5905053fd6f775a204509232d5">m_fd</a>);
<a name="l00060"></a>00060   }
<a name="l00061"></a>00061   <span class="keywordflow">catch</span> (<a class="code" href="class_hypertable_1_1_exception.html" title="This is a generic exception class for Hypertable.">Exception</a> &amp;e) {
<a name="l00062"></a>00062     <a class="code" href="_error_8h.html#e61e8974d9d73f82af9b9597f21d194f">HT_THROW2F</a>(e.<a class="code" href="class_hypertable_1_1_exception.html#160a1277f173192e3b7993f60323a00b">code</a>(), e, <span class="stringliteral">"Error closing metalog: %s"</span>, <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#615d5828b64de6dc5bb30eaa2608da8c">m_path</a>.c_str());
<a name="l00063"></a>00063   }
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="keywordtype">void</span>
<a name="l00067"></a><a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#a1e1837e4a8f517a54e59985c126acf5">00067</a> <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#a1e1837e4a8f517a54e59985c126acf5" title="Write a metalog entry.">MetaLogDfsBase::write</a>(<a class="code" href="class_hypertable_1_1_meta_log_entry.html">MetaLogEntry</a> *entry) {
<a name="l00068"></a>00068   <a class="code" href="namespace_hypertable.html#40784200dfed22d08fc5b7329dd1f663">ScopedLock</a> lock(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#fd691dd0d07cb57a66af8b54752d72b0">m_mutex</a>);
<a name="l00069"></a>00069   <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#1af91ec703645dbb3a91f62bbcb674ac" title="Reserve space for additional data Will grow the space to exactly what&amp;#39;s needed...">reserve</a>(<a class="code" href="_meta_log_dfs_base_8cc.html#c75819c973a4f443673b0f0413f69c26">ML_ENTRY_BUFFER_RESERVE</a>);
<a name="l00070"></a>00070   <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#75bf05f5ca8497b2b53a744b8aa051a8">ptr</a> += <a class="code" href="namespace_hypertable.html#ce6f9acaa29b01eb88692281d9e7a154d6bfd277f566ed30001568222610847f">ML_ENTRY_HEADER_SIZE</a>;    <span class="comment">// reserve header space</span>
<a name="l00071"></a>00071   entry-&gt;<a class="code" href="class_hypertable_1_1_meta_log_entry.html#47ea176165006361e61158f43ba840b1" title="Serialize to buffer.">write</a>(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>);                  <span class="comment">// serialize entry to buffer</span>
<a name="l00072"></a>00072   <span class="comment">// fill out the entry header</span>
<a name="l00073"></a>00073   uint8_t *p = <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a> + 4;          <span class="comment">// reserver 32-bit checksum space</span>
<a name="l00074"></a>00074   <a class="code" href="namespace_hypertable_1_1_serialization.html#855985be3bf7999195644c10e29a69ae" title="Encode a 64-bit integer in little-endian order.">encode_i64</a>(&amp;p, entry-&gt;<a class="code" href="class_hypertable_1_1_meta_log_entry.html#406cdb3f5a82956831dcfd7ccb41e76e">timestamp</a>);
<a name="l00075"></a>00075   *p++ = entry-&gt;<a class="code" href="class_hypertable_1_1_meta_log_entry.html#b0f440ac02762a21cb3b043a7a523170" title="Get the most derived type of the entry.">get_type</a>();
<a name="l00076"></a>00076   <span class="keywordtype">size_t</span> payload_size = <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() - <a class="code" href="namespace_hypertable.html#ce6f9acaa29b01eb88692281d9e7a154d6bfd277f566ed30001568222610847f">ML_ENTRY_HEADER_SIZE</a>;
<a name="l00077"></a>00077   <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;p, payload_size);
<a name="l00078"></a>00078   p = <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a>;
<a name="l00079"></a>00079   uint32_t checksum = <a class="code" href="namespace_hypertable.html#1380d7acd2de773b097dcaf6fe35f685" title="Compute crc32 checksum.">crc32</a>(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#ef7acccec46adcb90a926977a61e99a4">base</a> + 4, <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>.<a class="code" href="class_hypertable_1_1_dynamic_buffer.html#63691b7eae8f01678606c60e69983471">fill</a>() - 4);
<a name="l00080"></a>00080   <a class="code" href="namespace_hypertable_1_1_serialization.html#aed56233ded46bd28e8d25fb2bd0a86b" title="Encode a 32-bit integer in little-endian order.">encode_i32</a>(&amp;p, checksum);
<a name="l00081"></a>00081   <span class="comment">// write to the dfs</span>
<a name="l00082"></a>00082   <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#3fe6e8d9533d8ef79304da50a5e90f21">write_unlocked</a>(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#60fef08c14b65f19f2b5e94ca442e6f8">m_buf</a>);
<a name="l00083"></a>00083   <a class="code" href="_logger_8h.html#75176db3f3b090dc47d4fb088f4fda24">HT_DEBUG_OUT</a> &lt;&lt; entry &lt;&lt;<span class="stringliteral">" payload="</span>&lt;&lt; payload_size &lt;&lt; <a class="code" href="_logger_8h.html#eba017ae55e6acb68f5873e157192427">HT_END</a>;
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keywordtype">void</span>
<a name="l00087"></a><a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#3fe6e8d9533d8ef79304da50a5e90f21">00087</a> <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#3fe6e8d9533d8ef79304da50a5e90f21">MetaLogDfsBase::write_unlocked</a>(<a class="code" href="class_hypertable_1_1_dynamic_buffer.html">DynamicBuffer</a> &amp;buf) {
<a name="l00088"></a>00088   <a class="code" href="class_hypertable_1_1_static_buffer.html">StaticBuffer</a> sbuf(buf);
<a name="l00089"></a>00089   <a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#8367fe1347135cd362ba0b7489903a49">m_fs</a>-&gt;<a class="code" href="class_hypertable_1_1_filesystem.html#acddb6f90f22984a0c8e0d0014ae5701" title="Appends data to a file asynchronously.">append</a>(<a class="code" href="class_hypertable_1_1_meta_log_dfs_base.html#ced2cb5905053fd6f775a204509232d5">m_fd</a>, sbuf, <a class="code" href="class_hypertable_1_1_filesystem.html#c485be360a73585f4494f44e77a44ea4fe18aecf03e894da2070932b6254d227">Filesystem::O_FLUSH</a>);
<a name="l00090"></a>00090 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Thu Jan 22 17:08:41 2009 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
