<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>hypertable: /Users/doug/src/hypertable/src/cc/Hypertable/Lib/bmz/bmz.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
  </ul>
</div>
<div class="nav">
<a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5708de38a757cb70589c505d18009990.html">doug</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_a5f6cd2e2a2b5320bbe75e5c719f1fee.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_752ad1e2f45ee7988941467b4eccee0e.html">hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9031e3d7c38caf639b0143600d70b482.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_f5aae9766518c5969fd00e3382787720.html">cc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_3be4c2a439d9f674975a3d94c602c8e3.html">Hypertable</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ad5135801673f2e4c4e1be66fcd2e528.html">Lib</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_636d9f0bc773a215f705e2de9f182c4e.html">bmz</a></div>
<h1>bmz.c</h1><a href="bmz_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00024"></a>00024 <span class="comment">/* Avoid platform specific stuff in this file */</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="_string_8h.html">string.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="code" href="_time_8h.html">time.h</a>&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include "<a class="code" href="bmz-internal_8h.html">bmz-internal.h</a>"</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include "../lzo/minilzo.h"</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/* Initial bases for computing Rabin Karp rolling hash */</span>
<a name="l00036"></a><a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6">00036</a> <span class="preprocessor">#define BM_B1 257</span>
<a name="l00037"></a><a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_B2 277</span>
<a name="l00038"></a><a class="code" href="bmz_8c.html#3a2abe993ac92e596721d71805ecb5dd">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_M1 0xffff</span>
<a name="l00039"></a><a class="code" href="bmz_8c.html#297c411c96dab287ba0c6ac6d44fc37b">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_M2 (0xffff - 4)</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">00041</a> <span class="preprocessor">#define BM_MASK16 0xffff</span>
<a name="l00042"></a><a class="code" href="bmz_8c.html#600b0943cd5113eceaf3c81a848c700c">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MASK24 0xffffff</span>
<a name="l00043"></a><a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MASK32 0xffffffff</span>
<a name="l00044"></a><a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MASKSZ BM_MASK32</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="comment">/* Escape character</span>
<a name="l00047"></a>00047 <span class="comment"> * Don't change without understanding BM_DECODE_POS</span>
<a name="l00048"></a>00048 <span class="comment"> */</span>
<a name="l00049"></a><a class="code" href="bmz_8c.html#9c199bd0f9500d69e1bff9654e1bb5e6">00049</a> <span class="preprocessor">#define BM_ESC 0xfe</span>
<a name="l00050"></a><a class="code" href="bmz_8c.html#d383ebd45dae976a91e37e4e321b5bba">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_LEN 0xfdffffffffffull </span><span class="comment">/* 253TB ought to be enough for any one! */</span>
<a name="l00051"></a><a class="code" href="bmz_8c.html#9cb450a24ea13fd519db9ed0d9214e11">00051</a> <span class="preprocessor">#define BM_MAX_1B  0xfd</span>
<a name="l00052"></a><a class="code" href="bmz_8c.html#d8ba787f3f6bc71e5331a1581bb6ca4b">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_2B  0xfdff</span>
<a name="l00053"></a><a class="code" href="bmz_8c.html#ba5fa25859bc9ef8a681faf1521fa706">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_3B  0xfdffff</span>
<a name="l00054"></a><a class="code" href="bmz_8c.html#370feac976a0c0999e06d1a0b695439e">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_4B  0xfdfffffful</span>
<a name="l00055"></a><a class="code" href="bmz_8c.html#cf7f8eded57778124f9cce8a3991135b">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_5B  0xfdffffffffull</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="comment">/* VInt limits */</span>
<a name="l00058"></a><a class="code" href="bmz_8c.html#a8e1cfb6a77acccf773493f07dbc99a3">00058</a> <span class="preprocessor">#define BM_MAX_V1B 0x7f</span>
<a name="l00059"></a><a class="code" href="bmz_8c.html#387871188c341355c98a84b41e7efc8c">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_V2B 0x3fff</span>
<a name="l00060"></a><a class="code" href="bmz_8c.html#e3bbb655369580456cad5f5b866c46cf">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_V3B 0x1fffff</span>
<a name="l00061"></a><a class="code" href="bmz_8c.html#80fe6ea4567358424f96990f309984ae">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_V4B 0xfffffff</span>
<a name="l00062"></a><a class="code" href="bmz_8c.html#7a88eb2ac7bc66319e8a4ba531544229">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_V5B 0x7ffffffffull</span>
<a name="l00063"></a><a class="code" href="bmz_8c.html#82ac15a2be75fc1b8ddd61e03f731b76">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_MAX_V6B 0x3ffffffffffull</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>
<a name="l00065"></a>00065 <span class="comment">/* Rolling hash collision thresholds */</span>
<a name="l00066"></a><a class="code" href="bmz_8c.html#935c0460dc376e44ef07a3948be2ebd0">00066</a> <span class="preprocessor">#define BM_COLLISION_ABORT_THRESH 1</span>
<a name="l00067"></a><a class="code" href="bmz_8c.html#f01eb6eb3b0933ff0cfe15f9bf372519">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define BM_ABORT_COLLISIONS \</span>
<a name="l00068"></a>00068 <span class="preprocessor">  ((BM_COLLISION_ABORT_THRESH + 1) * collision_thresh + 1)</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a>00070 <span class="comment">/* Some colors for debugging/dump output */</span>
<a name="l00071"></a><a class="code" href="bmz_8c.html#20a8d9069f5f5520d36488258b59f262">00071</a> <span class="preprocessor">#define BM_COLOR_DBG "\x1b[31m"         </span><span class="comment">/* red */</span>
<a name="l00072"></a><a class="code" href="bmz_8c.html#8e7fe3be3b3027269f4c0a277e63fc35">00072</a> <span class="preprocessor">#define BM_COLOR_ALT "\x1b[32m"         </span><span class="comment">/* green */</span>
<a name="l00073"></a><a class="code" href="bmz_8c.html#326de7dc61165ac27a86660869d4a8ed">00073</a> <span class="preprocessor">#define BM_COLOR_END "\x1b[m"</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="comment">/* May need to do something here, in case stdint.h is not available */</span>
<a name="l00076"></a><a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">00076</a> <span class="keyword">typedef</span> uint8_t <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a>;
<a name="l00077"></a><a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">00077</a> <span class="keyword">typedef</span> uint32_t <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>;
<a name="l00078"></a><a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">00078</a> <span class="keyword">typedef</span> uint64_t <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>;
<a name="l00079"></a><a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">00079</a> <span class="keyword">typedef</span> int64_t <a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a>;
<a name="l00080"></a><a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">00080</a> <span class="keyword">typedef</span> int32_t <a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a>;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">/* For printf %llu in case some system has funky headers */</span>
<a name="l00083"></a><a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">00083</a> <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> <a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/* For lookup table */</span>
<a name="l00086"></a><a class="code" href="bmz_8c.html#aa88c9fd9b3b71dde7639ea6a1cf546e">00086</a> <span class="preprocessor">#define BM_NPOS ((size_t)-1)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a>00088 <span class="comment">/* Aligning memory for work space */</span>
<a name="l00089"></a><a class="code" href="bmz_8c.html#7256db81ed30a8e28320df68f5535c10">00089</a> <span class="preprocessor">#define BM_ALIGN(_mem_, _n_) (Byte *)(_mem_) + _n_ - (((size_t)(_mem_))%(_n_))</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>
<a name="l00091"></a>00091 <span class="comment">/* Some prime numbers as candidates for RK hash bases in case of adaptation */</span>
<a name="l00092"></a><a class="code" href="bmz_8c.html#10f9d0db7f8c2f43464f680330a73ffa">00092</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="bmz_8c.html#10f9d0db7f8c2f43464f680330a73ffa">s_primes</a>[] = {
<a name="l00093"></a>00093            3,    5,    7,   11,   13,   17,   19,   23,   29,
<a name="l00094"></a>00094     31,   37,   41,   43,   47,   53,   59,   61,   67,   71,
<a name="l00095"></a>00095     73,   79,   83,   89,   97,  101,  103,  107,  109,  113,
<a name="l00096"></a>00096    127,  131,  137,  139,  149,  151,  157,  163,  167,  173,
<a name="l00097"></a>00097    179,  181,  191,  193,  197,  199,  211,  223,  227,  229,
<a name="l00098"></a>00098    233,  239,  241,  251,  257,  263,  269,  271,  277,  281,
<a name="l00099"></a>00099    283,  293,  307,  311,  313,  317,  331,  337,  347,  349,
<a name="l00100"></a>00100    353,  359,  367,  373,  379,  383,  389,  397,  401,  409,
<a name="l00101"></a>00101    419,  421,  431,  433,  439,  443,  449,  457,  461,  463,
<a name="l00102"></a>00102    467,  479,  487,  491,  499,  503,  509,  521,  523,  541,
<a name="l00103"></a>00103    547,  557,  563,  569,  571,  577,  587,  593,  599,  601,
<a name="l00104"></a>00104    607,  613,  617,  619,  631,  641,  643,  647,  653,  659,
<a name="l00105"></a>00105    661,  673,  677,  683,  691,  701,  709,  719,  727,  733,
<a name="l00106"></a>00106    739,  743,  751,  757,  761,  769,  773,  787,  797,  809,
<a name="l00107"></a>00107    811,  821,  823,  827,  829,  839,  853,  857,  859,  863,
<a name="l00108"></a>00108    877,  881,  883,  887,  907,  911,  919,  929,  937,  941,
<a name="l00109"></a>00109    947,  953,  967,  971,  977,  983,  991,  997, 1009, 1013,
<a name="l00110"></a>00110   1019, 1021, 1031, 1033, 1039, 1049, 1051, 1061, 1063, 1069,
<a name="l00111"></a>00111   1087, 1091, 1093, 1097, 1103, 1109, 1117, 1123, 1129, 1151,
<a name="l00112"></a>00112   1153, 1163, 1171, 1181, 1187, 1193, 1201, 1213, 1217, 1223,
<a name="l00113"></a>00113   1229, 1231, 1237, 1249, 1259, 1277, 1279, 1283, 1289, 1291,
<a name="l00114"></a>00114   1297, 1301, 1303, 1307, 1319, 1321, 1327, 1361, 1367, 1373,
<a name="l00115"></a>00115   1381, 1399, 1409, 1423, 1427, 1429, 1433, 1439, 1447, 1451,
<a name="l00116"></a>00116   1453, 1459, 1471, 1481, 1483, 1487, 1489, 1493, 1499, 1511,
<a name="l00117"></a>00117   1523, 1531, 1543, 1549, 1553, 1559, 1567, 1571, 1579, 1583,
<a name="l00118"></a>00118   1597, 1601, 1607, 1609, 1613, 1619, 1621, 1627, 1637, 1657,
<a name="l00119"></a>00119   1663, 1667, 1669, 1693, 1697, 1699, 1709, 1721, 1723, 1733,
<a name="l00120"></a>00120   1741, 1747, 1753, 1759, 1777, 1783, 1787, 1789, 1801, 1811,
<a name="l00121"></a>00121   1823, 1831, 1847, 1861, 1867, 1871, 1873, 1877, 1879, 1889,
<a name="l00122"></a>00122   1901, 1907, 1913, 1931, 1933, 1949, 1951, 1973, 1979, 1987,
<a name="l00123"></a>00123   1993, 1997, 1999, 2003, 2011, 2017, 2027, 2029, 2039, 2053,
<a name="l00124"></a>00124   2063, 2069, 2081, 2083, 2087, 2089, 2099, 2111, 2113, 2129,
<a name="l00125"></a>00125   2131, 2137, 2141, 2143, 2153, 2161, 2179, 2203, 2207, 2213,
<a name="l00126"></a>00126   2221, 2237, 2239, 2243, 2251, 2267, 2269, 2273, 2281, 2287,
<a name="l00127"></a>00127   2293, 2297, 2309, 2311, 2333, 2339, 2341, 2347, 2351, 2357,
<a name="l00128"></a>00128   2371, 2377, 2381, 2383, 2389, 2393, 2399, 2411, 2417, 2423,
<a name="l00129"></a>00129   2437, 2441, 2447, 2459, 2467, 2473, 2477, 2503, 2521, 2531,
<a name="l00130"></a>00130   2539, 2543, 2549, 2551, 2557, 2579, 2591, 2593, 2609, 2617,
<a name="l00131"></a>00131   2621, 2633, 2647, 2657, 2659, 2663, 2671, 2677, 2683, 2687,
<a name="l00132"></a>00132   2689, 2693, 2699, 2707, 2711, 2713, 2719, 2729, 2731, 2741,
<a name="l00133"></a>00133   2749, 2753, 2767, 2777, 2789, 2791, 2797, 2801, 2803, 2819,
<a name="l00134"></a>00134   2833, 2837, 2843, 2851, 2857, 2861, 2879, 2887, 2897, 2903,
<a name="l00135"></a>00135   2909, 2917, 2927, 2939, 2953, 2957, 2963, 2969, 2971, 2999,
<a name="l00136"></a>00136   3001, 3011, 3019, 3023, 3037, 3041, 3049, 3061, 3067, 3079,
<a name="l00137"></a>00137   3083, 3089, 3109, 3119, 3121, 3137, 3163, 3167, 3169, 3181,
<a name="l00138"></a>00138   3187, 3191, 3203, 3209, 3217, 3221, 3229, 3251, 3253, 3257,
<a name="l00139"></a>00139   3259, 3271, 3299, 3301, 3307, 3313, 3319, 3323, 3329, 3331,
<a name="l00140"></a>00140   3343, 3347, 3359, 3361, 3371, 3373, 3389, 3391, 3407, 3413,
<a name="l00141"></a>00141   3433, 3449, 3457, 3461, 3463, 3467, 3469, 3491, 3499, 3511,
<a name="l00142"></a>00142   3517, 3527, 3529, 3533, 3539, 3541, 3547, 3557, 3559, 3571,
<a name="l00143"></a>00143   3581, 3583, 3593, 3607, 3613, 3617, 3623, 3631, 3637, 3643,
<a name="l00144"></a>00144   3659, 3671, 3673, 3677, 3691, 3697, 3701, 3709, 3719, 3727,
<a name="l00145"></a>00145   3733, 3739, 3761, 3767, 3769, 3779, 3793, 3797, 3803, 3821,
<a name="l00146"></a>00146   3823, 3833, 3847, 3851, 3853, 3863, 3877, 3881, 3889, 3907,
<a name="l00147"></a>00147   3911, 3917, 3919, 3923, 3929, 3931, 3943, 3947, 3967, 3989,
<a name="l00148"></a>00148   4001, 4003, 4007, 4013, 4019, 4021, 4027, 4049, 4051, 4057,
<a name="l00149"></a>00149   4073, 4079, 4091, 4093, 4099, 4111, 4127, 4129, 4133, 4139,
<a name="l00150"></a>00150   4153, 4157, 4159, 4177, 4201, 4211, 4217, 4219, 4229, 4231,
<a name="l00151"></a>00151   4241, 4243, 4253, 4259, 4261, 4271, 4273, 4283, 4289, 4297,
<a name="l00152"></a>00152   4327, 4337, 4339, 4349, 4357, 4363, 4373, 4391, 4397, 4409,
<a name="l00153"></a>00153   4421, 4423, 4441, 4447, 4451, 4457, 4463, 4481, 4483, 4493,
<a name="l00154"></a>00154   4507, 4513, 4517, 4519, 4523, 4547, 4549, 4561, 4567, 4583,
<a name="l00155"></a>00155   4591, 4597, 4603, 4621, 4637, 4639, 4643, 4649, 4651, 4657,
<a name="l00156"></a>00156   4663, 4673, 4679, 4691, 4703, 4721, 4723, 4729, 4733, 4751,
<a name="l00157"></a>00157   4759, 4783, 4787, 4789, 4793, 4799, 4801, 4813, 4817, 4831,
<a name="l00158"></a>00158   4861, 4871, 4877, 4889, 4903, 4909, 4919, 4931, 4933, 4937,
<a name="l00159"></a>00159   4943, 4951, 4957, 4967, 4969, 4973, 4987, 4993, 4999, 5003,
<a name="l00160"></a>00160   5009, 5011, 5021, 5023, 5039, 5051, 5059, 5077, 5081, 5087,
<a name="l00161"></a>00161   5099, 5101, 5107, 5113, 5119, 5147, 5153, 5167, 5171, 5179,
<a name="l00162"></a>00162   5189, 5197, 5209, 5227, 5231, 5233, 5237, 5261, 5273, 5279,
<a name="l00163"></a>00163   5281, 5297, 5303, 5309, 5323, 5333, 5347, 5351, 5381, 5387,
<a name="l00164"></a>00164   5393, 5399, 5407, 5413, 5417, 5419, 5431, 5437, 5441, 5443,
<a name="l00165"></a>00165   5449, 5471, 5477, 5479, 5483, 5501, 5503, 5507, 5519, 5521,
<a name="l00166"></a>00166   5527, 5531, 5557, 5563, 5569, 5573, 5581, 5591, 5623, 5639,
<a name="l00167"></a>00167   5641, 5647, 5651, 5653, 5657, 5659, 5669, 5683, 5689, 5693,
<a name="l00168"></a>00168   5701, 5711, 5717, 5737, 5741, 5743, 5749, 5779, 5783, 5791,
<a name="l00169"></a>00169   5801, 5807, 5813, 5821, 5827, 5839, 5843, 5849, 5851, 5857,
<a name="l00170"></a>00170   5861, 5867, 5869, 5879, 5881, 5897, 5903, 5923, 5927, 5939,
<a name="l00171"></a>00171   5953, 5981, 5987, 6007, 6011, 6029, 6037, 6043, 6047, 6053,
<a name="l00172"></a>00172   6067, 6073, 6079, 6089, 6091, 6101, 6113, 6121, 6131, 6133,
<a name="l00173"></a>00173   6143, 6151, 6163, 6173, 6197, 6199, 6203, 6211, 6217, 6221,
<a name="l00174"></a>00174   6229, 6247, 6257, 6263, 6269, 6271, 6277, 6287, 6299, 6301,
<a name="l00175"></a>00175   6311, 6317, 6323, 6329, 6337, 6343, 6353, 6359, 6361, 6367,
<a name="l00176"></a>00176   6373, 6379, 6389, 6397, 6421, 6427, 6449, 6451, 6469, 6473,
<a name="l00177"></a>00177   6481, 6491, 6521, 6529, 6547, 6551, 6553, 6563, 6569, 6571,
<a name="l00178"></a>00178   6577, 6581, 6599, 6607, 6619, 6637, 6653, 6659, 6661, 6673,
<a name="l00179"></a>00179   6679, 6689, 6691, 6701, 6703, 6709, 6719, 6733, 6737, 6761,
<a name="l00180"></a>00180   6763, 6779, 6781, 6791, 6793, 6803, 6823, 6827, 6829, 6833,
<a name="l00181"></a>00181   6841, 6857, 6863, 6869, 6871, 6883, 6899, 6907, 6911, 6917,
<a name="l00182"></a>00182   6947, 6949, 6959, 6961, 6967, 6971, 6977, 6983, 6991, 6997,
<a name="l00183"></a>00183   7001, 7013, 7019, 7027, 7039, 7043, 7057, 7069, 7079, 7103,
<a name="l00184"></a>00184   7109, 7121, 7127, 7129, 7151, 7159, 7177, 7187, 7193, 7207,
<a name="l00185"></a>00185   7211, 7213, 7219, 7229, 7237, 7243, 7247, 7253, 7283, 7297,
<a name="l00186"></a>00186   7307, 7309, 7321, 7331, 7333, 7349, 7351, 7369, 7393, 7411,
<a name="l00187"></a>00187   7417, 7433, 7451, 7457, 7459, 7477, 7481, 7487, 7489, 7499,
<a name="l00188"></a>00188   7507, 7517, 7523, 7529, 7537, 7541, 7547, 7549, 7559, 7561,
<a name="l00189"></a>00189   7573, 7577, 7583, 7589, 7591, 7603, 7607, 7621, 7639, 7643,
<a name="l00190"></a>00190   7649, 7669, 7673, 7681, 7687, 7691, 7699, 7703, 7717, 7723,
<a name="l00191"></a>00191   7727, 7741, 7753, 7757, 7759, 7789, 7793, 7817, 7823, 7829,
<a name="l00192"></a>00192   7841, 7853, 7867, 7873, 7877, 7879, 7883, 7901, 7907, 7919,
<a name="l00193"></a>00193   7927, 7933, 7937, 7949, 7951, 7963, 7993, 8009, 8011, 8017
<a name="l00194"></a>00194 };
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="comment">/* Hash collision adaption threshold */</span>
<a name="l00197"></a><a class="code" href="bmz_8c.html#bfb9ee65c38910bae26d0b1c8541bd8e">00197</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="bmz_8c.html#bfb9ee65c38910bae26d0b1c8541bd8e">s_collision_thresh</a> = 0;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="comment">/* Logging/messaging facilities */</span>
<a name="l00200"></a><a class="code" href="bmz_8c.html#47d76825dabd7c310f81492d1e6d65f6">00200</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a> = 0;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00203"></a><a class="code" href="bmz_8c.html#f280456043f10cd33f360169af9905f0">00203</a> <a class="code" href="bmz_8c.html#f280456043f10cd33f360169af9905f0">builtin_out</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>) {
<a name="l00204"></a>00204   fwrite(buf, 1, len, stderr);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keyword">static</span> <a class="code" href="compat-c_8h.html#dc5949cc900c9dfe835aafd60d9326bc">HT_NORETURN</a> <span class="keywordtype">void</span>
<a name="l00208"></a><a class="code" href="bmz_8c.html#b921c9e0b1f80884c1f0a377a8e46e37">00208</a> <a class="code" href="bmz_8c.html#b921c9e0b1f80884c1f0a377a8e46e37">builtin_die</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {
<a name="l00209"></a>00209   fputs(msg, stderr);
<a name="l00210"></a>00210   exit(1);
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="bmz_8c.html#c78b3e74cee35639084e645d7d8ec206">00213</a> <span class="keyword">static</span> <a class="code" href="bmz_8h.html#9fd74bef47df6f09d3d29e60976b2f47" title="Signature of the messaging/logging procedure.">BmzOutProc</a> <a class="code" href="bmz_8c.html#c78b3e74cee35639084e645d7d8ec206">s_out_proc</a> = <a class="code" href="bmz_8c.html#f280456043f10cd33f360169af9905f0">builtin_out</a>;
<a name="l00214"></a><a class="code" href="bmz_8c.html#41e7f0b377bc62c1e231f0d9522f7d69">00214</a> <span class="keyword">static</span> <a class="code" href="bmz_8h.html#9b1c9ad46d1b72efe7ec1b0d21c84ca7" title="Signature of the fatal procedure.">BmzDieProc</a> <a class="code" href="bmz_8c.html#41e7f0b377bc62c1e231f0d9522f7d69">s_die_proc</a> = <a class="code" href="bmz_8c.html#b921c9e0b1f80884c1f0a377a8e46e37">builtin_die</a>;
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="bmz_8c.html#bb4926e4303ea0d7e586d5cbcf00e2dc">00216</a> <span class="preprocessor">#define BM_LOG(_level_, _fmt_, ...) if (s_verbosity &gt;= _level_) do { \</span>
<a name="l00217"></a>00217 <span class="preprocessor">  char msg[256]; \</span>
<a name="l00218"></a>00218 <span class="preprocessor">  int len = snprintf(msg, sizeof(msg), "%s: " _fmt_, __FUNCTION__, \</span>
<a name="l00219"></a>00219 <span class="preprocessor">                     ##__VA_ARGS__); \</span>
<a name="l00220"></a>00220 <span class="preprocessor">  s_out_proc(msg, len); \</span>
<a name="l00221"></a>00221 <span class="preprocessor">} while (0)</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a><a class="code" href="bmz_8c.html#2daaf15a596958f980e85be129b9463b">00223</a> <span class="preprocessor">#define BM_LOG_(_level_, _buf_, _len_) if (s_verbosity &gt;= _level_) do { \</span>
<a name="l00224"></a>00224 <span class="preprocessor">  s_out_proc((char *)_buf_, _len_); \</span>
<a name="l00225"></a>00225 <span class="preprocessor">} while (0)</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span>
<a name="l00227"></a><a class="code" href="bmz_8c.html#98322961a1ae4dfc89a56c9d27a3339b">00227</a> <span class="preprocessor">#define BM_DIE(_fmt_, ...) do { \</span>
<a name="l00228"></a>00228 <span class="preprocessor">  char msg[256]; \</span>
<a name="l00229"></a>00229 <span class="preprocessor">  snprintf(msg, sizeof(msg), "fatal: %s: " _fmt_ "\n", \</span>
<a name="l00230"></a>00230 <span class="preprocessor">           __FUNCTION__, ##__VA_ARGS__); \</span>
<a name="l00231"></a>00231 <span class="preprocessor">  s_die_proc(msg); \</span>
<a name="l00232"></a>00232 <span class="preprocessor">} while (0)</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>
<a name="l00234"></a><a class="code" href="bmz_8c.html#b66b3e096507cd190f39cac9e7eea9a0">00234</a> <span class="preprocessor">#define BM_CHECK(_cond_) \</span>
<a name="l00235"></a>00235 <span class="preprocessor">    if (_cond_); else BM_DIE("%s:%d: expects: %s", \</span>
<a name="l00236"></a>00236 <span class="preprocessor">                             __FILE__, __LINE__, #_cond_)</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span>
<a name="l00238"></a>00238 <span class="keywordtype">int</span>
<a name="l00239"></a><a class="code" href="bmz_8h.html#867dd77949a5046678dda3a23e9e2040">00239</a> <a class="code" href="bmz_8c.html#d74fc6f9c6dff79187315dbd77b94211" title="Set the verbosity of library for testing and debugging.">bmz_set_verbosity</a>(<span class="keywordtype">int</span> verbosity) {
<a name="l00240"></a>00240   <span class="keywordtype">int</span> old = <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a>;
<a name="l00241"></a>00241   <a class="code" href="bmz-test_8c.html#47d76825dabd7c310f81492d1e6d65f6">s_verbosity</a> = verbosity;
<a name="l00242"></a>00242   <span class="keywordflow">return</span> old;
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <a class="code" href="bmz_8h.html#9fd74bef47df6f09d3d29e60976b2f47" title="Signature of the messaging/logging procedure.">BmzOutProc</a>
<a name="l00246"></a><a class="code" href="bmz_8h.html#44c9bc4df084b10b245ff25745c52fe0">00246</a> <a class="code" href="bmz_8c.html#54c73c654653ef00f8537627f9853e4a" title="Set messaging/logging procedure.">bmz_set_out_proc</a>(<a class="code" href="bmz_8h.html#9fd74bef47df6f09d3d29e60976b2f47" title="Signature of the messaging/logging procedure.">BmzOutProc</a> proc) {
<a name="l00247"></a>00247   <a class="code" href="bmz_8h.html#9fd74bef47df6f09d3d29e60976b2f47" title="Signature of the messaging/logging procedure.">BmzOutProc</a> old = <a class="code" href="bmz_8c.html#c78b3e74cee35639084e645d7d8ec206">s_out_proc</a>;
<a name="l00248"></a>00248   <a class="code" href="bmz_8c.html#c78b3e74cee35639084e645d7d8ec206">s_out_proc</a> = proc;
<a name="l00249"></a>00249   <span class="keywordflow">return</span> old;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="keywordtype">int</span>
<a name="l00253"></a><a class="code" href="bmz_8c.html#77c4c987054558b5c8ef55f0085bfddb">00253</a> <a class="code" href="bmz-internal_8h.html#afd166b1917ad7a7bc1eb4d9dc8db7a4">bmz_set_collision_thresh</a>(<span class="keywordtype">int</span> thresh) {
<a name="l00254"></a>00254   <span class="keywordtype">int</span> old = <a class="code" href="bmz_8c.html#bfb9ee65c38910bae26d0b1c8541bd8e">s_collision_thresh</a>;
<a name="l00255"></a>00255   <a class="code" href="bmz_8c.html#bfb9ee65c38910bae26d0b1c8541bd8e">s_collision_thresh</a> = thresh;
<a name="l00256"></a>00256   <span class="keywordflow">return</span> old;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="comment">/* Pick one or two primes out of 1009</span>
<a name="l00260"></a>00260 <span class="comment"> * used for adaptive hashing in face of bad data</span>
<a name="l00261"></a>00261 <span class="comment"> */</span>
<a name="l00262"></a>00262 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00263"></a><a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">00263</a> <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(<span class="keywordtype">size_t</span> excluded) {
<a name="l00264"></a>00264   <span class="keyword">const</span> <span class="keywordtype">size_t</span> n = <span class="keyword">sizeof</span>(<a class="code" href="bmz_8c.html#10f9d0db7f8c2f43464f680330a73ffa">s_primes</a>) / <span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>);
<a name="l00265"></a>00265   <span class="keywordtype">size_t</span> i = 0;
<a name="l00266"></a>00266    <span class="comment">/* Don't really care if rand/srand are not thread-safe for</span>
<a name="l00267"></a>00267 <span class="comment">    * predictable results, as long as it doesn't crash.</span>
<a name="l00268"></a>00268 <span class="comment">    */</span>
<a name="l00269"></a>00269   <span class="keyword">static</span> <span class="keywordtype">int</span> sranded = 0;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271   <span class="keywordflow">if</span> (!sranded) {
<a name="l00272"></a>00272     srand(time(NULL));
<a name="l00273"></a>00273     sranded = 1;
<a name="l00274"></a>00274   }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="keywordflow">for</span> (; i &lt; n; ++i) {
<a name="l00277"></a>00277     <span class="comment">/* random() in os x and bsd is better, but not in glibc yet. */</span>
<a name="l00278"></a>00278     <span class="keywordtype">size_t</span> s = <a class="code" href="bmz_8c.html#10f9d0db7f8c2f43464f680330a73ffa">s_primes</a>[rand() % n];
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (s != excluded) <span class="keywordflow">return</span> s;
<a name="l00280"></a>00280   }
<a name="l00281"></a>00281   <span class="comment">/* Safety net, though highly unlikely (1/1009^1009) to reach here */</span>
<a name="l00282"></a>00282   <span class="keywordflow">return</span> 8111;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00286"></a><a class="code" href="bmz_8c.html#a6dc90230ff6c47606d2f8db961c5f64">00286</a> <a class="code" href="bmz_8c.html#a6dc90230ff6c47606d2f8db961c5f64">bm_lut_size</a>(<span class="keywordtype">size_t</span> n) {
<a name="l00287"></a>00287   <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> x = n; <span class="comment">/* size_t could be 64-bit */</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289   <span class="keywordflow">do</span> {
<a name="l00290"></a>00290     <span class="comment">/* power of 2 for mask mod */</span>
<a name="l00291"></a>00291     x |= (x &gt;&gt; 1);
<a name="l00292"></a>00292     x |= (x &gt;&gt; 2);
<a name="l00293"></a>00293     x |= (x &gt;&gt; 4);
<a name="l00294"></a>00294     x |= (x &gt;&gt; 8);
<a name="l00295"></a>00295     x |= (x &gt;&gt; 16);
<a name="l00296"></a>00296     x |= (x &gt;&gt; 32);
<a name="l00297"></a>00297     ++x;
<a name="l00298"></a>00298   } <span class="keywordflow">while</span> (x &lt; n * 8 / 5); <span class="comment">/* avoid too much probes */</span>
<a name="l00299"></a>00299   <span class="keywordflow">return</span> x;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="struct_bm_lut_entry.html">00302</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00303"></a><a class="code" href="struct_bm_lut_entry.html#e04504b2154328c970808172848b5ac2">00303</a>   <span class="keywordtype">size_t</span> hash;
<a name="l00304"></a><a class="code" href="struct_bm_lut_entry.html#a41bc0bd29590a7a954c757b0bd84936">00304</a>   <span class="keywordtype">size_t</span> pos;
<a name="l00305"></a>00305 } <a class="code" href="struct_bm_lut_entry.html">BmLutEntry</a>;
<a name="l00306"></a>00306 
<a name="l00307"></a><a class="code" href="struct_bm_lut.html">00307</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00308"></a><a class="code" href="struct_bm_lut.html#495eadbb7431d1a5d4d81b4393ed6cbe">00308</a>   <span class="keywordtype">size_t</span> <a class="code" href="lzoconf_8h.html#ab9257c30c984af77be6bc46d052d45d">size</a>, collisions, adapts, probes;
<a name="l00309"></a><a class="code" href="struct_bm_lut.html#88ca31d432e8efc8daad1717ae76de48">00309</a>   <a class="code" href="struct_bm_lut_entry.html">BmLutEntry</a> *entries;
<a name="l00310"></a>00310 } <a class="code" href="struct_bm_lut.html">BmLut</a>;
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00313"></a><a class="code" href="bmz_8c.html#3e22f24fbee4ba50fe59ff6e22685260">00313</a> <a class="code" href="bmz_8c.html#3e22f24fbee4ba50fe59ff6e22685260">init_bmlut</a>(<a class="code" href="struct_bm_lut.html">BmLut</a> *table, <span class="keywordtype">size_t</span> n, <span class="keywordtype">void</span> *work_mem) {
<a name="l00314"></a>00314   <a class="code" href="struct_bm_lut_entry.html">BmLutEntry</a> *p, *endp;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316   table-&gt;<a class="code" href="struct_bm_lut.html#2eed5d422fea0ed68c27f013c1fca81a">probes</a> = table-&gt;<a class="code" href="struct_bm_lut.html#0e0e28dea18df4631142363008b3171d">adapts</a> = table-&gt;<a class="code" href="struct_bm_lut.html#b4aed3fcb18ec4ac9e4ebdf96a5aa2c6">collisions</a> = 0;
<a name="l00317"></a>00317   table-&gt;<a class="code" href="struct_bm_lut.html#495eadbb7431d1a5d4d81b4393ed6cbe">size</a> = <a class="code" href="bmz_8c.html#a6dc90230ff6c47606d2f8db961c5f64">bm_lut_size</a>(n);
<a name="l00318"></a>00318   table-&gt;<a class="code" href="struct_bm_lut.html#88ca31d432e8efc8daad1717ae76de48">entries</a> = (<a class="code" href="struct_bm_lut_entry.html">BmLutEntry</a> *) work_mem;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320   <span class="keywordflow">for</span> (p = table-&gt;<a class="code" href="struct_bm_lut.html#88ca31d432e8efc8daad1717ae76de48">entries</a>, endp = p + table-&gt;<a class="code" href="struct_bm_lut.html#495eadbb7431d1a5d4d81b4393ed6cbe">size</a>; p &lt; endp; ++p)
<a name="l00321"></a>00321     p-&gt;<a class="code" href="struct_bm_lut_entry.html#a41bc0bd29590a7a954c757b0bd84936">pos</a> = <a class="code" href="bmz_8c.html#aa88c9fd9b3b71dde7639ea6a1cf546e">BM_NPOS</a>;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323   <a class="code" href="bmz_8c.html#bb4926e4303ea0d7e586d5cbcf00e2dc">BM_LOG</a>(1, <span class="stringliteral">"n(fps): %llu, size: %llu\n"</span>, (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)n, (<a class="code" href="bmz_8c.html#060a01232b5aabfce404ef5b2dafdba7">Llu</a>)table-&gt;<a class="code" href="struct_bm_lut.html#495eadbb7431d1a5d4d81b4393ed6cbe">size</a>);
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">/* Simple hash lookup with probing */</span>
<a name="l00327"></a><a class="code" href="bmz_8c.html#fe1149146fd03bb884f82fa9ffd7cadf">00327</a> <span class="preprocessor">#define BM_LOOKUP(_lut_, _hash_, _entry_) do { \</span>
<a name="l00328"></a>00328 <span class="preprocessor">  size_t sz = _lut_.size, idx = (_hash_) &amp; (sz - 1), probes = 0; \</span>
<a name="l00329"></a>00329 <span class="preprocessor">  BmLutEntry *b = _lut_.entries, *p = b + idx, *endp = b + sz; \</span>
<a name="l00330"></a>00330 <span class="preprocessor">  \</span>
<a name="l00331"></a>00331 <span class="preprocessor">  while (p-&gt;pos != BM_NPOS) { \</span>
<a name="l00332"></a>00332 <span class="preprocessor">    if (p-&gt;hash == _hash_) break; \</span>
<a name="l00333"></a>00333 <span class="preprocessor">    ++p; \</span>
<a name="l00334"></a>00334 <span class="preprocessor">    if (p &gt;= endp) p = b; \</span>
<a name="l00335"></a>00335 <span class="preprocessor">    ++probes; \</span>
<a name="l00336"></a>00336 <span class="preprocessor">  } \</span>
<a name="l00337"></a>00337 <span class="preprocessor">  if (probes) _lut_.probes += probes; \</span>
<a name="l00338"></a>00338 <span class="preprocessor">  _entry_ = p; \</span>
<a name="l00339"></a>00339 <span class="preprocessor">} while (0)</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>
<a name="l00341"></a>00341 <span class="comment">/* Classical/generic Rabin Karp */</span>
<a name="l00342"></a><a class="code" href="bmz_8c.html#896dfa8c79888329cf2f449aa2a33344">00342</a> <span class="preprocessor">#define R_HASH_MOD_BODY(_int_type_) \</span>
<a name="l00343"></a>00343 <span class="preprocessor">  _int_type_ h = 0, p = 1; \</span>
<a name="l00344"></a>00344 <span class="preprocessor">  \</span>
<a name="l00345"></a>00345 <span class="preprocessor">  while (len--) { \</span>
<a name="l00346"></a>00346 <span class="preprocessor">    h += p * buf[len]; \</span>
<a name="l00347"></a>00347 <span class="preprocessor">    h %= m; \</span>
<a name="l00348"></a>00348 <span class="preprocessor">    p *= b; \</span>
<a name="l00349"></a>00349 <span class="preprocessor">    p %= m; \</span>
<a name="l00350"></a>00350 <span class="preprocessor">  } \</span>
<a name="l00351"></a>00351 <span class="preprocessor">  return h</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span>
<a name="l00353"></a>00353 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00354"></a><a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">00354</a> <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <span class="keywordtype">size_t</span> b, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> m) {
<a name="l00355"></a>00355   <a class="code" href="bmz_8c.html#896dfa8c79888329cf2f449aa2a33344">R_HASH_MOD_BODY</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>);
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00359"></a><a class="code" href="bmz_8c.html#bc84243032062674c67dbf86bec581b5">00359</a> <a class="code" href="bmz_8c.html#bc84243032062674c67dbf86bec581b5">r_hash_mod32</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m) {
<a name="l00360"></a>00360   <a class="code" href="bmz_8c.html#896dfa8c79888329cf2f449aa2a33344">R_HASH_MOD_BODY</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>);
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">/* D* rolling hash family (Andrew Trigdell's thesis p72-73) */</span>
<a name="l00364"></a>00364 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00365"></a><a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">00365</a> <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b2,
<a name="l00366"></a>00366                <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m2) {
<a name="l00367"></a>00367   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#bc84243032062674c67dbf86bec581b5">r_hash_mod32</a>(buf, len, b1, m1) &lt;&lt; 16) |
<a name="l00368"></a>00368          <a class="code" href="bmz_8c.html#bc84243032062674c67dbf86bec581b5">r_hash_mod32</a>(buf, len, b2, m2);
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 <span class="comment">/* Compute (x^n) % m */</span>
<a name="l00372"></a><a class="code" href="bmz_8c.html#e9deca273700619bff01ff599ec00e45">00372</a> <span class="preprocessor">#define POW_MOD_BODY(_pow_fun_, _int_type_) \</span>
<a name="l00373"></a>00373 <span class="preprocessor">  if (n == 0) return 1; \</span>
<a name="l00374"></a>00374 <span class="preprocessor">  if (n == 1) return x % m; \</span>
<a name="l00375"></a>00375 <span class="preprocessor">  { \</span>
<a name="l00376"></a>00376 <span class="preprocessor">    _int_type_ sqr = (x * x) % m; \</span>
<a name="l00377"></a>00377 <span class="preprocessor">    _int_type_ pow = _pow_fun_(sqr, n / 2, m); \</span>
<a name="l00378"></a>00378 <span class="preprocessor">    if (n &amp; 1) return (pow * x) % m; \</span>
<a name="l00379"></a>00379 <span class="preprocessor">    return pow % m; \</span>
<a name="l00380"></a>00380 <span class="preprocessor">  }</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>
<a name="l00382"></a>00382 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00383"></a><a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">00383</a> <a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> x, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> n, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> m) {
<a name="l00384"></a>00384   <a class="code" href="bmz_8c.html#e9deca273700619bff01ff599ec00e45">POW_MOD_BODY</a>(<a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>)
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00388"></a><a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">00388</a> <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> x, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> n, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m) {
<a name="l00389"></a>00389   <a class="code" href="bmz_8c.html#e9deca273700619bff01ff599ec00e45">POW_MOD_BODY</a>(<a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>)
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">/* update rolling hash */</span>
<a name="l00393"></a><a class="code" href="bmz_8c.html#2b1a8aee2254b9911077c29452366629">00393</a> <span class="preprocessor">#define UPDATE_HASH_MOD_BODY \</span>
<a name="l00394"></a>00394 <span class="preprocessor">  h *= b; \</span>
<a name="l00395"></a>00395 <span class="preprocessor">  h -= (out * pow_n) % m; \</span>
<a name="l00396"></a>00396 <span class="preprocessor">  h += in; \</span>
<a name="l00397"></a>00397 <span class="preprocessor">  if (h &lt; 0) h += m; \</span>
<a name="l00398"></a>00398 <span class="preprocessor">  return (h % m)</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>
<a name="l00400"></a>00400 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a>
<a name="l00401"></a><a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">00401</a> <a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">update_hash_mod</a>(<a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a> h, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> in, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> out, <a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a> pow_n, <a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a> b, <a class="code" href="bmz_8c.html#2de3f49eadcae5078cd57134586ee25d">Int64</a> m) {
<a name="l00402"></a>00402   <a class="code" href="bmz_8c.html#2b1a8aee2254b9911077c29452366629">UPDATE_HASH_MOD_BODY</a>;
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a>
<a name="l00406"></a><a class="code" href="bmz_8c.html#2c292c66c72c043a04ec837620ac735d">00406</a> <a class="code" href="bmz_8c.html#2c292c66c72c043a04ec837620ac735d">update_hash_mod32</a>(<a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a> h, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> in, <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> out, <a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a> pow_n, <a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a> b, <a class="code" href="bmz_8c.html#20b0c262d9ef5d263888e463dfa99638">Int32</a> m) {
<a name="l00407"></a>00407   <a class="code" href="bmz_8c.html#2b1a8aee2254b9911077c29452366629">UPDATE_HASH_MOD_BODY</a>;
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00411"></a><a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">00411</a> <a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">update_hash_mod16x2</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> h, <span class="keywordtype">int</span> in, <span class="keywordtype">int</span> out, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> pow1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> pow2,
<a name="l00412"></a>00412                     <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b2, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m2) {
<a name="l00413"></a>00413   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#2c292c66c72c043a04ec837620ac735d">update_hash_mod32</a>((h &gt;&gt; 16), in, out, pow1, b1, m1) &lt;&lt; 16) |
<a name="l00414"></a>00414          <a class="code" href="bmz_8c.html#2c292c66c72c043a04ec837620ac735d">update_hash_mod32</a>((h &amp; <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>), in, out, pow2, b2, m2);
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">/* Faster hash using mask instead of mod </span>
<a name="l00418"></a>00418 <span class="comment"> * m needs to be power-of-2</span>
<a name="l00419"></a>00419 <span class="comment"> */</span>
<a name="l00420"></a><a class="code" href="bmz_8c.html#c0dd9c2150acb8a98d78544cb664db25">00420</a> <span class="preprocessor">#define R_HASH_MASK_BODY(int_type) \</span>
<a name="l00421"></a>00421 <span class="preprocessor">  int_type h = 0, p = 1; \</span>
<a name="l00422"></a>00422 <span class="preprocessor">  \</span>
<a name="l00423"></a>00423 <span class="preprocessor">  while (len--) { \</span>
<a name="l00424"></a>00424 <span class="preprocessor">    h += p * buf[len]; \</span>
<a name="l00425"></a>00425 <span class="preprocessor">    h &amp;= m; \</span>
<a name="l00426"></a>00426 <span class="preprocessor">    p *= b; \</span>
<a name="l00427"></a>00427 <span class="preprocessor">    p &amp;= m; \</span>
<a name="l00428"></a>00428 <span class="preprocessor">  } \</span>
<a name="l00429"></a>00429 <span class="preprocessor">  return h</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>
<a name="l00431"></a>00431 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00432"></a><a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">00432</a> <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> m) {
<a name="l00433"></a>00433   <a class="code" href="bmz_8c.html#c0dd9c2150acb8a98d78544cb664db25">R_HASH_MASK_BODY</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>);
<a name="l00434"></a>00434 }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00437"></a><a class="code" href="bmz_8c.html#4516cbfb4ab191bf8a08b5c7cf18dfec">00437</a> <a class="code" href="bmz_8c.html#4516cbfb4ab191bf8a08b5c7cf18dfec">r_hash_mask32</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m) {
<a name="l00438"></a>00438   <a class="code" href="bmz_8c.html#c0dd9c2150acb8a98d78544cb664db25">R_HASH_MASK_BODY</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>);
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="comment">/* C* rolling hash family (see D* above) */</span>
<a name="l00442"></a>00442 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00443"></a><a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">00443</a> <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b2) {
<a name="l00444"></a>00444   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#4516cbfb4ab191bf8a08b5c7cf18dfec">r_hash_mask32</a>(buf, len, b1, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>) &lt;&lt; 16) |
<a name="l00445"></a>00445          <a class="code" href="bmz_8c.html#4516cbfb4ab191bf8a08b5c7cf18dfec">r_hash_mask32</a>(buf, len, b2, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>);
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00449"></a><a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">00449</a> <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(<span class="keyword">const</span> <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *buf, <span class="keywordtype">size_t</span> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b1, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b2) {
<a name="l00450"></a>00450   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(buf, len, b1, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>) &lt;&lt; 32) |
<a name="l00451"></a>00451          <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(buf, len, b2, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>);
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="bmz_8c.html#83a4bdc319b67ba680555a69a620a877">00454</a> <span class="preprocessor">#define POW_MASK_BODY(_pow_fun_, _int_type_) \</span>
<a name="l00455"></a>00455 <span class="preprocessor">  if (n == 0) return 1; \</span>
<a name="l00456"></a>00456 <span class="preprocessor">  if (n == 1) return (x &amp; m); \</span>
<a name="l00457"></a>00457 <span class="preprocessor">  { \</span>
<a name="l00458"></a>00458 <span class="preprocessor">    _int_type_ sqr = (x * x) &amp; m; \</span>
<a name="l00459"></a>00459 <span class="preprocessor">    _int_type_ pow = _pow_fun_(sqr, n / 2, m); \</span>
<a name="l00460"></a>00460 <span class="preprocessor">    if (n &amp; 1) return ((pow * x) &amp; m); \</span>
<a name="l00461"></a>00461 <span class="preprocessor">    return (pow &amp; m); \</span>
<a name="l00462"></a>00462 <span class="preprocessor">  }</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span>
<a name="l00464"></a>00464 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00465"></a><a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">00465</a> <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> x, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> n, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> m) {
<a name="l00466"></a>00466   <a class="code" href="bmz_8c.html#83a4bdc319b67ba680555a69a620a877">POW_MASK_BODY</a>(<a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>)
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="keyword">static</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00470"></a><a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">00470</a> <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> x, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> n, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m) {
<a name="l00471"></a>00471   <a class="code" href="bmz_8c.html#83a4bdc319b67ba680555a69a620a877">POW_MASK_BODY</a>(<a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>)
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a><a class="code" href="bmz_8c.html#0e900ed0e4a7cf7bd59ec0a3a32ccf0b">00474</a> <span class="preprocessor">#define UPDATE_HASH_MASK_BODY \</span>
<a name="l00475"></a>00475 <span class="preprocessor">  h *= b; \</span>
<a name="l00476"></a>00476 <span class="preprocessor">  h -= (out * pow_n) &amp; m; \</span>
<a name="l00477"></a>00477 <span class="preprocessor">  h += in; \</span>
<a name="l00478"></a>00478 <span class="preprocessor">  return (h &amp; m)</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span>
<a name="l00480"></a>00480 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00481"></a><a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">00481</a> <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> h, <span class="keywordtype">int</span> in, <span class="keywordtype">int</span> out, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> pow_n, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> m) {
<a name="l00482"></a>00482   <a class="code" href="bmz_8c.html#0e900ed0e4a7cf7bd59ec0a3a32ccf0b">UPDATE_HASH_MASK_BODY</a>;
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00486"></a><a class="code" href="bmz_8c.html#d72afb79c6b15ac43b9039b4d92e43c2">00486</a> <a class="code" href="bmz_8c.html#d72afb79c6b15ac43b9039b4d92e43c2">update_hash_mask32</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> h, <span class="keywordtype">int</span> in, <span class="keywordtype">int</span> out, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> pow_n,
<a name="l00487"></a>00487                    <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> m) {
<a name="l00488"></a>00488   <a class="code" href="bmz_8c.html#0e900ed0e4a7cf7bd59ec0a3a32ccf0b">UPDATE_HASH_MASK_BODY</a>;
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a>
<a name="l00492"></a><a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">00492</a> <a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">update_hash_mask16x2</a>(<a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> h, <span class="keywordtype">int</span> in, <span class="keywordtype">int</span> out, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> pow1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> pow2,
<a name="l00493"></a>00493                      <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b1, <a class="code" href="bmz_8c.html#7e8aeec7b6541935dfc6f608cd5170ce">UInt32</a> b2) {
<a name="l00494"></a>00494   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#d72afb79c6b15ac43b9039b4d92e43c2">update_hash_mask32</a>((h &gt;&gt; 16), in, out, pow1, b1, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>) &lt;&lt; 16) |
<a name="l00495"></a>00495          <a class="code" href="bmz_8c.html#d72afb79c6b15ac43b9039b4d92e43c2">update_hash_mask32</a>((h &amp; <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>), in, out, pow2, b2, BM_MASK16);
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a>
<a name="l00499"></a><a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">00499</a> <a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">update_hash_mask32x2</a>(<a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> h, <span class="keywordtype">int</span> in, <span class="keywordtype">int</span> out, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> pow1, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> pow2,
<a name="l00500"></a>00500                      <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b1, <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b2) {
<a name="l00501"></a>00501   <span class="keywordflow">return</span> (<a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>((h &gt;&gt; 32), in, out, pow1, b1, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>) &lt;&lt; 32) |
<a name="l00502"></a>00502          <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>((h &amp; <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>), in, out, pow2, b2, BM_MASK32);
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="comment">/* External AP Ifor computing the hashes */</span>
<a name="l00506"></a>00506 <span class="keywordtype">size_t</span>
<a name="l00507"></a><a class="code" href="bmz_8c.html#51414c69d7f91181d717e1080f232909">00507</a> <a class="code" href="bmz-internal_8h.html#9e4a85d85f38e28f9cd256817a9f9ac7">bmz_hash_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> b, <span class="keywordtype">size_t</span> m) {
<a name="l00508"></a>00508   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, b, m);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="keywordtype">size_t</span>
<a name="l00512"></a><a class="code" href="bmz_8c.html#8f4e32ea73e79441e2ea168d467cb17c">00512</a> <a class="code" href="bmz-internal_8h.html#35dd10b114c906724d2ffea8f5cb3a34">bmz_hash_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2,
<a name="l00513"></a>00513                  <span class="keywordtype">size_t</span> m1, <span class="keywordtype">size_t</span> m2) {
<a name="l00514"></a>00514   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, b1, b2, m1, m2);
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="keywordtype">size_t</span>
<a name="l00518"></a><a class="code" href="bmz_8c.html#151c2e6ef99102508f6362f78ea9ce22">00518</a> <a class="code" href="bmz-internal_8h.html#ce3001e9a346bb9ba44d4a4d208b2713">bmz_hash_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00519"></a>00519   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, b1, b2);
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="keywordtype">size_t</span>
<a name="l00523"></a><a class="code" href="bmz_8c.html#6035f6df882fc2aefacf4fd092e729a4">00523</a> <a class="code" href="bmz-internal_8h.html#5a48634aa7840c305c8655e1451f2764">bmz_hash_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> b) {
<a name="l00524"></a>00524   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, b, <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>);
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="keywordtype">size_t</span>
<a name="l00528"></a><a class="code" href="bmz_8c.html#566e375919c4bdff981d9be73e7e9548">00528</a> <a class="code" href="bmz-internal_8h.html#aa67454550845f3fe5619d284042baff">bmz_hash_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00529"></a>00529   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, b1, b2);
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="comment">/* Verify the rolling hashes */</span>
<a name="l00533"></a><a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">00533</a> <span class="preprocessor">#define BM_HASH_CHECK_BODY(_init_hash_, _rehash_, _update_hash_) \</span>
<a name="l00534"></a>00534 <span class="preprocessor">  size_t hash; \</span>
<a name="l00535"></a>00535 <span class="preprocessor">  Byte *in = (Byte *)src, *ip = in, *in_end = in + in_len; \</span>
<a name="l00536"></a>00536 <span class="preprocessor">  int errs = 0; \</span>
<a name="l00537"></a>00537 <span class="preprocessor">  \</span>
<a name="l00538"></a>00538 <span class="preprocessor">  BM_CHECK(fp_len &lt; in_len); \</span>
<a name="l00539"></a>00539 <span class="preprocessor">  _init_hash_; \</span>
<a name="l00540"></a>00540 <span class="preprocessor">  \</span>
<a name="l00541"></a>00541 <span class="preprocessor">  for (; ip &lt; in_end - fp_len - 1; ++ip) { \</span>
<a name="l00542"></a>00542 <span class="preprocessor">    size_t h0 = _rehash_; \</span>
<a name="l00543"></a>00543 <span class="preprocessor">    hash = _update_hash_; \</span>
<a name="l00544"></a>00544 <span class="preprocessor">    if (h0 != hash) { \</span>
<a name="l00545"></a>00545 <span class="preprocessor">      BM_LOG(0, "mismatch at pos %ld: %lx vs %lx\n", \</span>
<a name="l00546"></a>00546 <span class="preprocessor">             (long)(ip - in), (long)h0, (long)hash); \</span>
<a name="l00547"></a>00547 <span class="preprocessor">      ++errs; \</span>
<a name="l00548"></a>00548 <span class="preprocessor">    } \</span>
<a name="l00549"></a>00549 <span class="preprocessor">  } \</span>
<a name="l00550"></a>00550 <span class="preprocessor">  BM_LOG(1, "total errors: %d\n", errs); \</span>
<a name="l00551"></a>00551 <span class="preprocessor">  return errs ? BMZ_E_ERROR : BMZ_E_OK</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>
<a name="l00553"></a><a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">00553</a> <span class="preprocessor">#define BM_HASH_BENCH_BODY(_init_hash_, _update_hash_) \</span>
<a name="l00554"></a>00554 <span class="preprocessor">  size_t hash; \</span>
<a name="l00555"></a>00555 <span class="preprocessor">  Byte *in = (Byte *)src, *ip = in, *in_end = in + in_len; \</span>
<a name="l00556"></a>00556 <span class="preprocessor">  \</span>
<a name="l00557"></a>00557 <span class="preprocessor">  BM_CHECK(fp_len &lt; in_len); \</span>
<a name="l00558"></a>00558 <span class="preprocessor">  _init_hash_; \</span>
<a name="l00559"></a>00559 <span class="preprocessor">  \</span>
<a name="l00560"></a>00560 <span class="preprocessor">  for (; ip &lt; in_end - fp_len - 1; ++ip) { \</span>
<a name="l00561"></a>00561 <span class="preprocessor">    hash = _update_hash_; \</span>
<a name="l00562"></a>00562 <span class="preprocessor">  } \</span>
<a name="l00563"></a>00563 <span class="preprocessor">  BM_LOG(1, "last hash: %lx\n", (long)hash) </span><span class="comment">/* or the loop gets optimized out */</span>
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="keywordtype">int</span>
<a name="l00566"></a><a class="code" href="bmz_8c.html#dcde1d30851c065141ac0cc91adb00e6">00566</a> <a class="code" href="bmz-internal_8h.html#072350968f57c8d31e9f8aedd4cba72c">bmz_check_hash_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00567"></a>00567                    <span class="keywordtype">size_t</span> b, <span class="keywordtype">size_t</span> m) {
<a name="l00568"></a>00568   <span class="keywordtype">size_t</span> pow_n;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   <a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">BM_HASH_CHECK_BODY</a>(hash = <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(in, fp_len, b, m);
<a name="l00571"></a>00571                      pow_n = <a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>(b, fp_len, m),
<a name="l00572"></a>00572                      <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(ip + 1, fp_len, b, m),
<a name="l00573"></a>00573                      <a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">update_hash_mod</a>(hash, ip[fp_len], *ip, pow_n, b, m));
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 <span class="keywordtype">void</span>
<a name="l00577"></a><a class="code" href="bmz_8c.html#2645f51ec076232181efd2d2bc43ca60">00577</a> <a class="code" href="bmz_8c.html#2645f51ec076232181efd2d2bc43ca60">bmz_bench_hash_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l00578"></a>00578   <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> b = <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, m = <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>;
<a name="l00579"></a>00579   <span class="keywordtype">size_t</span> pow_n;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   <a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">BM_HASH_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(in, fp_len, b, m);
<a name="l00582"></a>00582                      pow_n = <a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>(b, fp_len, m),
<a name="l00583"></a>00583                      <a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">update_hash_mod</a>(hash, ip[fp_len], *ip, pow_n, b, m));
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="keywordtype">int</span>
<a name="l00587"></a><a class="code" href="bmz_8c.html#917085c9b7603b2c511d1c4e43054319">00587</a> <a class="code" href="bmz-internal_8h.html#67fe2486bb930f877b98df160e586118">bmz_check_hash_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00588"></a>00588                        <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2, <span class="keywordtype">size_t</span> m1, <span class="keywordtype">size_t</span> m2) {
<a name="l00589"></a>00589   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591   <a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">BM_HASH_CHECK_BODY</a>(hash = <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(in, fp_len, b1, b2, m1, m2);
<a name="l00592"></a>00592                      pow_n_b1 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b1, fp_len, m1);
<a name="l00593"></a>00593                      pow_n_b2 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b2, fp_len, m2),
<a name="l00594"></a>00594                      <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(ip + 1, fp_len, b1, b2, m1, m2),
<a name="l00595"></a>00595                      <a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">update_hash_mod16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00596"></a>00596                                          pow_n_b2, b1, b2, m1, m2));
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="keywordtype">void</span>
<a name="l00600"></a><a class="code" href="bmz_8c.html#1ebbf707141f49c7046cfb8a2821503c">00600</a> <a class="code" href="bmz_8c.html#1ebbf707141f49c7046cfb8a2821503c">bmz_bench_hash_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l00601"></a>00601   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2, b1 = <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, b2 = <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>, m1 = <a class="code" href="bmz_8c.html#3a2abe993ac92e596721d71805ecb5dd">BM_M1</a>, m2 = <a class="code" href="bmz_8c.html#297c411c96dab287ba0c6ac6d44fc37b">BM_M2</a>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603   <a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">BM_HASH_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(in, fp_len, b1, b2, m1, m2);
<a name="l00604"></a>00604                      pow_n_b1 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b1, fp_len, m1);
<a name="l00605"></a>00605                      pow_n_b2 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b2, fp_len, m2),
<a name="l00606"></a>00606                      <a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">update_hash_mod16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00607"></a>00607                                          pow_n_b2, b1, b2, m1, m2));
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610 <span class="keywordtype">int</span>
<a name="l00611"></a><a class="code" href="bmz_8c.html#e8345798abb4f1c668028a8e476939ac">00611</a> <a class="code" href="bmz-internal_8h.html#7199bb8aff836ba54a0232bb05a40649">bmz_check_hash_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00612"></a>00612                         <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00613"></a>00613   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615   <a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">BM_HASH_CHECK_BODY</a>(hash = <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(in, fp_len, b1, b2);
<a name="l00616"></a>00616                      pow_n_b1 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b1, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>);
<a name="l00617"></a>00617                      pow_n_b2 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b2, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>),
<a name="l00618"></a>00618                      <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(ip + 1, fp_len, b1, b2),
<a name="l00619"></a>00619                      <a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">update_hash_mask16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00620"></a>00620                                           pow_n_b2, b1, b2));
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="keywordtype">void</span>
<a name="l00624"></a><a class="code" href="bmz_8c.html#a99b94e1d0fcedae48b61091759897ea">00624</a> <a class="code" href="bmz_8c.html#a99b94e1d0fcedae48b61091759897ea">bmz_bench_hash_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l00625"></a>00625   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2, b1 = <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, b2 = <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627   <a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">BM_HASH_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(in, fp_len, b1, b2);
<a name="l00628"></a>00628                      pow_n_b1 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b1, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>);
<a name="l00629"></a>00629                      pow_n_b2 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b2, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>),
<a name="l00630"></a>00630                      <a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">update_hash_mask16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00631"></a>00631                                           pow_n_b2, b1, b2));
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="keywordtype">int</span>
<a name="l00635"></a><a class="code" href="bmz_8c.html#9f43588c4c7ffc07489c8b637f69fcc0">00635</a> <a class="code" href="bmz-internal_8h.html#f94fe91db774464aa3d8fcf55b6787fb">bmz_check_hash_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00636"></a>00636                     <span class="keywordtype">size_t</span> b) {
<a name="l00637"></a>00637   <span class="keywordtype">size_t</span> pow_n, m = <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639   <a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">BM_HASH_CHECK_BODY</a>(hash = <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(in, fp_len, b, m);
<a name="l00640"></a>00640                      pow_n = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b, fp_len, m),
<a name="l00641"></a>00641                      <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(ip + 1, fp_len, b, m),
<a name="l00642"></a>00642                      <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>(hash, ip[fp_len], *ip, pow_n, b, m));
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 <span class="keywordtype">void</span>
<a name="l00646"></a><a class="code" href="bmz_8c.html#394d25735e5e4cbc98c45584c1bd5cba">00646</a> <a class="code" href="bmz_8c.html#394d25735e5e4cbc98c45584c1bd5cba">bmz_bench_hash_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l00647"></a>00647   <span class="keywordtype">size_t</span> pow_n, b = <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, m = <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649   <a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">BM_HASH_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(in, fp_len, b, m);
<a name="l00650"></a>00650                      pow_n = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b, fp_len, m),
<a name="l00651"></a>00651                      <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>(hash, *ip, ip[fp_len], pow_n, b, m));
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="keywordtype">int</span>
<a name="l00655"></a><a class="code" href="bmz_8c.html#c49f711f41dda07cdcd2441b1ba53f3f">00655</a> <a class="code" href="bmz-internal_8h.html#7743a8d358d878bcd90a82e0b0ebc0bd">bmz_check_hash_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00656"></a>00656                         <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00657"></a>00657   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659   <a class="code" href="bmz_8c.html#13c93806a04a35593eedec5bc6dab731">BM_HASH_CHECK_BODY</a>(hash = <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(in, fp_len, b1, b2);
<a name="l00660"></a>00660                      pow_n_b1 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b1, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>);
<a name="l00661"></a>00661                      pow_n_b2 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b2, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>),
<a name="l00662"></a>00662                      <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(ip + 1, fp_len, b1, b2),
<a name="l00663"></a>00663                      <a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">update_hash_mask32x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00664"></a>00664                                           pow_n_b2, b1, b2));
<a name="l00665"></a>00665 }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 <span class="keywordtype">void</span>
<a name="l00668"></a><a class="code" href="bmz_8c.html#a85e1140566a34605619db37e031dbe0">00668</a> <a class="code" href="bmz_8c.html#a85e1140566a34605619db37e031dbe0">bmz_bench_hash_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l00669"></a>00669   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2, b1 = <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, b2 = <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <a class="code" href="bmz_8c.html#2ee174ea33e719d763465efca051656b">BM_HASH_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(in, fp_len, b1, b2);
<a name="l00672"></a>00672                      pow_n_b1 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b1, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>);
<a name="l00673"></a>00673                      pow_n_b2 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b2, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>),
<a name="l00674"></a>00674                      <a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">update_hash_mask32x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00675"></a>00675                                           pow_n_b2, b1, b2));
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="keywordtype">void</span>
<a name="l00679"></a><a class="code" href="bmz_8c.html#bf0da1e3e71047f7bbda1788c81199ae">00679</a> <a class="code" href="bmz-internal_8h.html#090a25b4499c1b5bfdc051208aa74ca0">bmz_bench_hash</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">unsigned</span> type) {
<a name="l00680"></a>00680   <span class="keywordtype">size_t</span> fp_len = 100;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682   <span class="keywordflow">switch</span> (type) {
<a name="l00683"></a>00683   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#bdd4ffb59c09910bb6187afb9d81a680" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BMZ_HASH_MOD</a>:
<a name="l00684"></a>00684     <a class="code" href="bmz_8c.html#2645f51ec076232181efd2d2bc43ca60">bmz_bench_hash_mod</a>(in, in_len, fp_len);
<a name="l00685"></a>00685     <span class="keywordflow">break</span>;
<a name="l00686"></a>00686   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#98eddc5603e74b3d34930cc2b8bd806e">BMZ_HASH_MOD16X2</a>:
<a name="l00687"></a>00687     <a class="code" href="bmz_8c.html#1ebbf707141f49c7046cfb8a2821503c">bmz_bench_hash_mod16x2</a>(in, in_len, fp_len);
<a name="l00688"></a>00688     <span class="keywordflow">break</span>;
<a name="l00689"></a>00689   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#fa4019afd464eb9044696285482042fa">BMZ_HASH_MASK16X2</a>:
<a name="l00690"></a>00690     <a class="code" href="bmz_8c.html#a99b94e1d0fcedae48b61091759897ea">bmz_bench_hash_mask16x2</a>(in, in_len, fp_len);
<a name="l00691"></a>00691     <span class="keywordflow">break</span>;
<a name="l00692"></a>00692   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#1bf2311a8eccf8da1d429bec69fda5fe">BMZ_HASH_MASK</a>:
<a name="l00693"></a>00693     <a class="code" href="bmz_8c.html#394d25735e5e4cbc98c45584c1bd5cba">bmz_bench_hash_mask</a>(in, in_len, fp_len);
<a name="l00694"></a>00694     <span class="keywordflow">break</span>;
<a name="l00695"></a>00695   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#eff04f542211021ab9025be24d5eee0f">BMZ_HASH_MASK32X2</a>:
<a name="l00696"></a>00696     <a class="code" href="bmz_8c.html#a85e1140566a34605619db37e031dbe0">bmz_bench_hash_mask32x2</a>(in, in_len, fp_len);
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 <span class="comment">/* Benchmark lookup table performance */</span>
<a name="l00701"></a><a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">00701</a> <span class="preprocessor">#define BM_LUT_BENCH_BODY(_init_hash_, _update_hash_) \</span>
<a name="l00702"></a>00702 <span class="preprocessor">  size_t hash; \</span>
<a name="l00703"></a>00703 <span class="preprocessor">  Byte *in = (Byte *)src, *ip = in, *in_end = in + in_len; \</span>
<a name="l00704"></a>00704 <span class="preprocessor">  size_t scan_len = in_len - fp_len, c, boundary; \</span>
<a name="l00705"></a>00705 <span class="preprocessor">  BmLut lut; \</span>
<a name="l00706"></a>00706 <span class="preprocessor">  BmLutEntry *entry; \</span>
<a name="l00707"></a>00707 <span class="preprocessor">  \</span>
<a name="l00708"></a>00708 <span class="preprocessor">  BM_CHECK(fp_len &lt; in_len); \</span>
<a name="l00709"></a>00709 <span class="preprocessor">  init_bmlut(&amp;lut, in_len / fp_len, work_mem); \</span>
<a name="l00710"></a>00710 <span class="preprocessor">  _init_hash_; \</span>
<a name="l00711"></a>00711 <span class="preprocessor">  \</span>
<a name="l00712"></a>00712 <span class="preprocessor">  for (boundary = fp_len; ip &lt; in_end - fp_len - 1; ++ip) { \</span>
<a name="l00713"></a>00713 <span class="preprocessor">    size_t pos = ip - in; \</span>
<a name="l00714"></a>00714 <span class="preprocessor">    BM_LOOKUP(lut, hash, entry); \</span>
<a name="l00715"></a>00715 <span class="preprocessor">    \</span>
<a name="l00716"></a>00716 <span class="preprocessor">    if (entry-&gt;pos != BM_NPOS) { \</span>
<a name="l00717"></a>00717 <span class="preprocessor">      if (memcmp(in + entry-&gt;pos, ip, fp_len) != 0) ++lut.collisions; \</span>
<a name="l00718"></a>00718 <span class="preprocessor">    } \</span>
<a name="l00719"></a>00719 <span class="preprocessor">    if (pos == boundary) { \</span>
<a name="l00720"></a>00720 <span class="preprocessor">      entry-&gt;hash = hash; \</span>
<a name="l00721"></a>00721 <span class="preprocessor">      entry-&gt;pos = pos; \</span>
<a name="l00722"></a>00722 <span class="preprocessor">      boundary += fp_len; \</span>
<a name="l00723"></a>00723 <span class="preprocessor">    } \</span>
<a name="l00724"></a>00724 <span class="preprocessor">    hash = _update_hash_; \</span>
<a name="l00725"></a>00725 <span class="preprocessor">  } \</span>
<a name="l00726"></a>00726 <span class="preprocessor">  c = lut.collisions; \</span>
<a name="l00727"></a>00727 <span class="preprocessor">  BM_LOG(1, "length: %llu, lut.size: %llu, lut.collisions: %llu (eff. bits: " \</span>
<a name="l00728"></a>00728 <span class="preprocessor">         "%.3f), lut.probes: %llu (%.3f/lu)\n", (Llu)in_len, (Llu)lut.size, \</span>
<a name="l00729"></a>00729 <span class="preprocessor">         (Llu)c, c ? log((double)in_len / fp_len * scan_len / c) / log(2) \</span>
<a name="l00730"></a>00730 <span class="preprocessor">                   : sizeof(size_t) * 8., \</span>
<a name="l00731"></a>00731 <span class="preprocessor">         (Llu)lut.probes, (double)lut.probes / scan_len)</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>
<a name="l00733"></a>00733 <span class="keywordtype">void</span>
<a name="l00734"></a><a class="code" href="bmz_8c.html#41bc6414f49a98485a15518388794adb">00734</a> <a class="code" href="bmz-internal_8h.html#aa453cf135c0ae6a8f4b7b7cde769d19">bmz_bench_lut_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00735"></a>00735                   <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b, <span class="keywordtype">size_t</span> m) {
<a name="l00736"></a>00736   <span class="keywordtype">size_t</span> pow_n;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738   <a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">BM_LUT_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(in, fp_len, b, m);
<a name="l00739"></a>00739                     pow_n = <a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>(b, fp_len, m),
<a name="l00740"></a>00740                     <a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">update_hash_mod</a>(hash, ip[fp_len], *ip, pow_n, b, m));
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="keywordtype">void</span>
<a name="l00744"></a><a class="code" href="bmz_8c.html#436599853e8707d64a66134687147119">00744</a> <a class="code" href="bmz-internal_8h.html#00a52b982301f5a44350fcfb090e3c84">bmz_bench_lut_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00745"></a>00745                       <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2,
<a name="l00746"></a>00746                       <span class="keywordtype">size_t</span> m1, <span class="keywordtype">size_t</span> m2) {
<a name="l00747"></a>00747   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749   <a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">BM_LUT_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(in, fp_len, b1, b2, m1, m2);
<a name="l00750"></a>00750                     pow_n_b1 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b1, fp_len, m1);
<a name="l00751"></a>00751                     pow_n_b2 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b2, fp_len, m2),
<a name="l00752"></a>00752                     <a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">update_hash_mod16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00753"></a>00753                                         pow_n_b2, b1, b2, m1, m2));
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 <span class="keywordtype">void</span>
<a name="l00757"></a><a class="code" href="bmz_8c.html#d9b78f58d7120f018b3db9d4fc447fb8">00757</a> <a class="code" href="bmz-internal_8h.html#0017ee26c2be2aedd868ad0dba85602a">bmz_bench_lut_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00758"></a>00758                    <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00759"></a>00759   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">BM_LUT_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(in, fp_len, b1, b2);
<a name="l00762"></a>00762                     pow_n_b1 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b1, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>);
<a name="l00763"></a>00763                     pow_n_b2 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b2, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>),
<a name="l00764"></a>00764                     <a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">update_hash_mask16x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00765"></a>00765                                          pow_n_b2, b1, b2));
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 <span class="keywordtype">void</span>
<a name="l00769"></a><a class="code" href="bmz_8c.html#26433db31f0978edf8d402900f85b8c9">00769</a> <a class="code" href="bmz-internal_8h.html#16b71eebba7afc93ef888256989bdc87">bmz_bench_lut_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00770"></a>00770                    <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b) {
<a name="l00771"></a>00771   <span class="keywordtype">size_t</span> pow_n, m = <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773   <a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">BM_LUT_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(in, fp_len, b, m);
<a name="l00774"></a>00774                     pow_n = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b, fp_len, m),
<a name="l00775"></a>00775                     <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>(hash, *ip, ip[fp_len], pow_n, b, m));
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="keywordtype">void</span>
<a name="l00779"></a><a class="code" href="bmz_8c.html#7ba9c67bf79bde1fd6f72290cba35927">00779</a> <a class="code" href="bmz-internal_8h.html#490cd5046fb877083989aa49501665ea">bmz_bench_lut_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len,
<a name="l00780"></a>00780                        <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l00781"></a>00781   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783   <a class="code" href="bmz_8c.html#d8b4942b3198b7a90229febb93cf58fb">BM_LUT_BENCH_BODY</a>(hash = <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(in, fp_len, b1, b2);
<a name="l00784"></a>00784                     pow_n_b1 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b1, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>);
<a name="l00785"></a>00785                     pow_n_b2 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b2, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>),
<a name="l00786"></a>00786                     <a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">update_hash_mask32x2</a>(hash, ip[fp_len], *ip, pow_n_b1,
<a name="l00787"></a>00787                                          pow_n_b2, b1, b2));
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">/* One way to debug macro laden code:</span>
<a name="l00791"></a>00791 <span class="comment"> * gcc -E % | sed '/^\#/d' | gnuindent -st -i2 -kr &gt; bmzpp.c</span>
<a name="l00792"></a>00792 <span class="comment"> */</span>
<a name="l00793"></a>00793 
<a name="l00794"></a><a class="code" href="bmz_8c.html#94b4d1ed238e8468b72a77dd4208d1a4">00794</a> <span class="preprocessor">#define BM_NEED_IN(_n_) \</span>
<a name="l00795"></a>00795 <span class="preprocessor">  if ((int)(in_end - ip) &lt; (int)(_n_)) goto input_overrun</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>
<a name="l00797"></a><a class="code" href="bmz_8c.html#ae4764ce9dab784ab6fae469830de3e7">00797</a> <span class="preprocessor">#define BM_NEED_OUT(_n_) \</span>
<a name="l00798"></a>00798 <span class="preprocessor">  if ((int)(out_end - op) &lt; (int)(_n_)) goto output_overrun</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>
<a name="l00800"></a><a class="code" href="bmz_8c.html#fdf8ef52829e1cfba7131b73b1b9a7e5">00800</a> <span class="preprocessor">#define BM_ENCODE_OUTPUT(_op_, _ip_, _ip_end_) \</span>
<a name="l00801"></a>00801 <span class="preprocessor">  while (_ip_ &lt; _ip_end_) { \</span>
<a name="l00802"></a>00802 <span class="preprocessor">    if (*_ip_ == BM_ESC) { \</span>
<a name="l00803"></a>00803 <span class="preprocessor">      BM_NEED_OUT(1); \</span>
<a name="l00804"></a>00804 <span class="preprocessor">      *_op_++ = BM_ESC; \</span>
<a name="l00805"></a>00805 <span class="preprocessor">    } \</span>
<a name="l00806"></a>00806 <span class="preprocessor">    BM_NEED_OUT(1); \</span>
<a name="l00807"></a>00807 <span class="preprocessor">    *_op_++ = *_ip_++; \</span>
<a name="l00808"></a>00808 <span class="preprocessor">  }</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>
<a name="l00810"></a>00810 <span class="comment">/* Less comparison and earlier termination for uncompressible stuff */</span>
<a name="l00811"></a><a class="code" href="bmz_8c.html#5c080e81322e6ec87283e51819efa2df">00811</a> <span class="preprocessor">#define BM_ENCODE_FINAL_OUTPUT(_op_, _ip_, _ip_end_) \</span>
<a name="l00812"></a>00812 <span class="preprocessor">  BM_NEED_OUT((_ip_end_) - (_ip_)); </span><span class="comment">/* at least */</span> \
<a name="l00813"></a>00813   while (_ip_ &lt; _ip_end_) { \
<a name="l00814"></a>00814     if (*_ip_ == BM_ESC) { \
<a name="l00815"></a>00815       BM_NEED_OUT((_ip_end_) - (_ip_) + 1); \
<a name="l00816"></a>00816       *_op_++ = BM_ESC; \
<a name="l00817"></a>00817     } \
<a name="l00818"></a>00818     *_op_++ = *_ip_++; \
<a name="l00819"></a>00819   }
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="bmz_8c.html#84624dd4fe31deea743b94ef38802a38">00821</a> <span class="preprocessor">#define BM_ENCODE_PASS do { \</span>
<a name="l00822"></a>00822 <span class="preprocessor">  *out = 0; \</span>
<a name="l00823"></a>00823 <span class="preprocessor">  memcpy(out + 1, in, in_len); \</span>
<a name="l00824"></a>00824 <span class="preprocessor">  *out_len_p = in_len + 1; \</span>
<a name="l00825"></a>00825 <span class="preprocessor">  BM_ENCODE_STAT("no reduction"); \</span>
<a name="l00826"></a>00826 <span class="preprocessor">  return BMZ_E_OK; \</span>
<a name="l00827"></a>00827 <span class="preprocessor">} while (0)</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span>
<a name="l00829"></a><a class="code" href="bmz_8c.html#8e38c354cfa66cff0555130101d42d84">00829</a> <span class="preprocessor">#define BM_ENCODE_INT(_op_, _n_, _width_) do { \</span>
<a name="l00830"></a>00830 <span class="preprocessor">  UInt64 _n = _n_; \</span>
<a name="l00831"></a>00831 <span class="preprocessor">  switch (_width_) { \</span>
<a name="l00832"></a>00832 <span class="preprocessor">  case 1: \</span>
<a name="l00833"></a>00833 <span class="preprocessor">    *_op_++ = (Byte) _n; \</span>
<a name="l00834"></a>00834 <span class="preprocessor">    break; \</span>
<a name="l00835"></a>00835 <span class="preprocessor">  case 2: \</span>
<a name="l00836"></a>00836 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 8); \</span>
<a name="l00837"></a>00837 <span class="preprocessor">    *_op_++ = (Byte)(_n); \</span>
<a name="l00838"></a>00838 <span class="preprocessor">    break; \</span>
<a name="l00839"></a>00839 <span class="preprocessor">  case 3: \</span>
<a name="l00840"></a>00840 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 16); \</span>
<a name="l00841"></a>00841 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 8); \</span>
<a name="l00842"></a>00842 <span class="preprocessor">    *_op_++ = (Byte)(_n); \</span>
<a name="l00843"></a>00843 <span class="preprocessor">    break; \</span>
<a name="l00844"></a>00844 <span class="preprocessor">  case 4: \</span>
<a name="l00845"></a>00845 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 24); \</span>
<a name="l00846"></a>00846 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 16); \</span>
<a name="l00847"></a>00847 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 8); \</span>
<a name="l00848"></a>00848 <span class="preprocessor">    *_op_++ = (Byte)(_n); \</span>
<a name="l00849"></a>00849 <span class="preprocessor">    break; \</span>
<a name="l00850"></a>00850 <span class="preprocessor">  case 5: \</span>
<a name="l00851"></a>00851 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 32); \</span>
<a name="l00852"></a>00852 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 24); \</span>
<a name="l00853"></a>00853 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 16); \</span>
<a name="l00854"></a>00854 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 8); \</span>
<a name="l00855"></a>00855 <span class="preprocessor">    *_op_++ = (Byte)(_n); \</span>
<a name="l00856"></a>00856 <span class="preprocessor">    break; \</span>
<a name="l00857"></a>00857 <span class="preprocessor">  case 6: \</span>
<a name="l00858"></a>00858 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 40); \</span>
<a name="l00859"></a>00859 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 32); \</span>
<a name="l00860"></a>00860 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 24); \</span>
<a name="l00861"></a>00861 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 16); \</span>
<a name="l00862"></a>00862 <span class="preprocessor">    *_op_++ = (Byte)(_n &gt;&gt; 8); \</span>
<a name="l00863"></a>00863 <span class="preprocessor">    *_op_++ = (Byte)(_n); \</span>
<a name="l00864"></a>00864 <span class="preprocessor">    break; \</span>
<a name="l00865"></a>00865 <span class="preprocessor">  default: \</span>
<a name="l00866"></a>00866 <span class="preprocessor">    BM_DIE("%s", "256TB ought to be enough for anyone!"); \</span>
<a name="l00867"></a>00867 <span class="preprocessor">  } \</span>
<a name="l00868"></a>00868 <span class="preprocessor">} while (0)</span>
<a name="l00869"></a>00869 <span class="preprocessor"></span>
<a name="l00870"></a><a class="code" href="bmz_8c.html#a639647b4e7f89068466d0c7f2e4a965">00870</a> <span class="preprocessor">#define BM_ENCODE_VINT(_op_, _n_, _width_) do { \</span>
<a name="l00871"></a>00871 <span class="preprocessor">  UInt64 _n = _n_; \</span>
<a name="l00872"></a>00872 <span class="preprocessor">  switch (_width_) { \</span>
<a name="l00873"></a>00873 <span class="preprocessor">  case 1: \</span>
<a name="l00874"></a>00874 <span class="preprocessor">    *_op_++ = (Byte)((_n) &amp; 0x7f); \</span>
<a name="l00875"></a>00875 <span class="preprocessor">    break; \</span>
<a name="l00876"></a>00876 <span class="preprocessor">  case 2: \</span>
<a name="l00877"></a>00877 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00878"></a>00878 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) &amp; 0x7f); \</span>
<a name="l00879"></a>00879 <span class="preprocessor">    break; \</span>
<a name="l00880"></a>00880 <span class="preprocessor">  case 3: \</span>
<a name="l00881"></a>00881 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00882"></a>00882 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) | 0x80); \</span>
<a name="l00883"></a>00883 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 14) &amp; 0x7f); \</span>
<a name="l00884"></a>00884 <span class="preprocessor">    break; \</span>
<a name="l00885"></a>00885 <span class="preprocessor">  case 4: \</span>
<a name="l00886"></a>00886 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00887"></a>00887 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) | 0x80); \</span>
<a name="l00888"></a>00888 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 14) | 0x80); \</span>
<a name="l00889"></a>00889 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 21) &amp; 0x7f); \</span>
<a name="l00890"></a>00890 <span class="preprocessor">    break; \</span>
<a name="l00891"></a>00891 <span class="preprocessor">  case 5: \</span>
<a name="l00892"></a>00892 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00893"></a>00893 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) | 0x80); \</span>
<a name="l00894"></a>00894 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 14) | 0x80); \</span>
<a name="l00895"></a>00895 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 21) | 0x80); \</span>
<a name="l00896"></a>00896 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 28) &amp; 0x7f); \</span>
<a name="l00897"></a>00897 <span class="preprocessor">    break; \</span>
<a name="l00898"></a>00898 <span class="preprocessor">  case 6: \</span>
<a name="l00899"></a>00899 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00900"></a>00900 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) | 0x80); \</span>
<a name="l00901"></a>00901 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 14) | 0x80); \</span>
<a name="l00902"></a>00902 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 21) | 0x80); \</span>
<a name="l00903"></a>00903 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 28) | 0x80); \</span>
<a name="l00904"></a>00904 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 35) &amp; 0x7f); \</span>
<a name="l00905"></a>00905 <span class="preprocessor">    break; \</span>
<a name="l00906"></a>00906 <span class="preprocessor">  case 7: \</span>
<a name="l00907"></a>00907 <span class="preprocessor">    *_op_++ = (Byte)(_n | 0x80); \</span>
<a name="l00908"></a>00908 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 7) | 0x80); \</span>
<a name="l00909"></a>00909 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 14) | 0x80); \</span>
<a name="l00910"></a>00910 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 21) | 0x80); \</span>
<a name="l00911"></a>00911 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 28) | 0x80); \</span>
<a name="l00912"></a>00912 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 35) | 0x80); \</span>
<a name="l00913"></a>00913 <span class="preprocessor">    *_op_++ = (Byte)((_n &gt;&gt; 42) &amp; 0x7f); \</span>
<a name="l00914"></a>00914 <span class="preprocessor">    break; \</span>
<a name="l00915"></a>00915 <span class="preprocessor">  default: \</span>
<a name="l00916"></a>00916 <span class="preprocessor">    BM_DIE("%s", "512TB ought to be enough for anyone!"); \</span>
<a name="l00917"></a>00917 <span class="preprocessor">  } \</span>
<a name="l00918"></a>00918 <span class="preprocessor">} while (0)</span>
<a name="l00919"></a>00919 <span class="preprocessor"></span>
<a name="l00920"></a><a class="code" href="bmz_8c.html#432fdd3de586a736a05049e6c9df3d16">00920</a> <span class="preprocessor">#define BM_DECODE_VINT(_n_) do { \</span>
<a name="l00921"></a>00921 <span class="preprocessor">  BM_NEED_IN(1); \</span>
<a name="l00922"></a>00922 <span class="preprocessor">  _n_ = (*ip++ &amp; 0x7f); \</span>
<a name="l00923"></a>00923 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00924"></a>00924 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00925"></a>00925 <span class="preprocessor">    _n_ |= ((*ip++ &amp; 0x7f) &lt;&lt; 7); \</span>
<a name="l00926"></a>00926 <span class="preprocessor">  } else break; \</span>
<a name="l00927"></a>00927 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00928"></a>00928 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00929"></a>00929 <span class="preprocessor">    _n_ |= ((*ip++ &amp; 0x7f) &lt;&lt; 14); \</span>
<a name="l00930"></a>00930 <span class="preprocessor">  } else break; \</span>
<a name="l00931"></a>00931 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00932"></a>00932 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00933"></a>00933 <span class="preprocessor">    _n_ |= ((*ip++ &amp; 0x7f) &lt;&lt; 21); \</span>
<a name="l00934"></a>00934 <span class="preprocessor">  } else break; \</span>
<a name="l00935"></a>00935 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00936"></a>00936 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00937"></a>00937 <span class="preprocessor">    _n_ |= ((UInt64)(*ip++ &amp; 0x7f) &lt;&lt; 28); \</span>
<a name="l00938"></a>00938 <span class="preprocessor">  } else break; \</span>
<a name="l00939"></a>00939 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00940"></a>00940 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00941"></a>00941 <span class="preprocessor">    _n_ |= ((UInt64)(*ip++ &amp; 0x7f) &lt;&lt; 35); \</span>
<a name="l00942"></a>00942 <span class="preprocessor">  } else break; \</span>
<a name="l00943"></a>00943 <span class="preprocessor">  if (ip[-1] &amp; 0x80) { \</span>
<a name="l00944"></a>00944 <span class="preprocessor">    BM_NEED_IN(1); \</span>
<a name="l00945"></a>00945 <span class="preprocessor">    _n_ |= ((UInt64)(*ip++ &amp; 0x7f) &lt;&lt; 42); \</span>
<a name="l00946"></a>00946 <span class="preprocessor">  } \</span>
<a name="l00947"></a>00947 <span class="preprocessor">} while (0)</span>
<a name="l00948"></a>00948 <span class="preprocessor"></span>
<a name="l00949"></a><a class="code" href="bmz_8c.html#d102315d03358488b5e6c51bf68c0178">00949</a> <span class="preprocessor">#define BM_INT_WIDTH(_n_) \</span>
<a name="l00950"></a>00950 <span class="preprocessor">  (_n_ &gt; BM_MAX_5B ? 6 : \</span>
<a name="l00951"></a>00951 <span class="preprocessor">   (_n_ &gt; BM_MAX_4B ? 5 : \</span>
<a name="l00952"></a>00952 <span class="preprocessor">    (_n_ &gt; BM_MAX_3B ? 4 : \</span>
<a name="l00953"></a>00953 <span class="preprocessor">     (_n_ &gt; BM_MAX_2B ? 3 : \</span>
<a name="l00954"></a>00954 <span class="preprocessor">      (_n_ &gt; BM_MAX_1B ? 2 : 1)))))</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span>
<a name="l00956"></a><a class="code" href="bmz_8c.html#08ae62314ba41e6012ba3ed01fb4980a">00956</a> <span class="preprocessor">#define BM_VINT_WIDTH(_n_) \</span>
<a name="l00957"></a>00957 <span class="preprocessor">  (_n_ &gt; BM_MAX_V6B ? 7 : \</span>
<a name="l00958"></a>00958 <span class="preprocessor">   (_n_ &gt; BM_MAX_V5B ? 6 : \</span>
<a name="l00959"></a>00959 <span class="preprocessor">    (_n_ &gt; BM_MAX_V4B ? 5 : \</span>
<a name="l00960"></a>00960 <span class="preprocessor">     (_n_ &gt; BM_MAX_V3B ? 4 : \</span>
<a name="l00961"></a>00961 <span class="preprocessor">      (_n_ &gt; BM_MAX_V2B ? 3 : \</span>
<a name="l00962"></a>00962 <span class="preprocessor">       (_n_ &gt; BM_MAX_V1B ? 2 : 1))))))</span>
<a name="l00963"></a>00963 <span class="preprocessor"></span>
<a name="l00964"></a><a class="code" href="bmz_8c.html#709fa120bd8d2f8a404a1b54c8346917">00964</a> <span class="preprocessor">#define BM_ENCODE_DELTA(_op_, _ipos_, _pos_, _len_) do { \</span>
<a name="l00965"></a>00965 <span class="preprocessor">  UInt64 _ipos = _ipos_, _len = _len_; \</span>
<a name="l00966"></a>00966 <span class="preprocessor">  int pos_w = BM_INT_WIDTH(_ipos); \</span>
<a name="l00967"></a>00967 <span class="preprocessor">  int len_w = BM_VINT_WIDTH(_len); \</span>
<a name="l00968"></a>00968 <span class="preprocessor">  BM_NEED_OUT(pos_w + len_w + 1); \</span>
<a name="l00969"></a>00969 <span class="preprocessor">  *_op_++ = BM_ESC; \</span>
<a name="l00970"></a>00970 <span class="preprocessor">  BM_ENCODE_INT(_op_, _pos_, pos_w); \</span>
<a name="l00971"></a>00971 <span class="preprocessor">  BM_ENCODE_VINT(_op_, _len_, len_w); \</span>
<a name="l00972"></a>00972 <span class="preprocessor">} while (0)</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>
<a name="l00974"></a><a class="code" href="bmz_8c.html#49d5f8020e39d4e1392f47850fbe80fe">00974</a> <span class="preprocessor">#define BM_HANDLE_COLLISIONS(_randomize_, _init_hash_) do { \</span>
<a name="l00975"></a>00975 <span class="preprocessor">  size_t adapts = lut.adapts, collisions = ++lut.collisions; \</span>
<a name="l00976"></a>00976 <span class="preprocessor">  \</span>
<a name="l00977"></a>00977 <span class="preprocessor">  if (adapts &gt; BM_COLLISION_ABORT_THRESH) { \</span>
<a name="l00978"></a>00978 <span class="preprocessor">    </span><span class="comment">/* stumped &amp; give up, just pass the bytes */</span> \
<a name="l00979"></a>00979     BM_LOG(1, "too much collisions: %llu, giving up.\n", \
<a name="l00980"></a>00980            (Llu)BM_ABORT_COLLISIONS); \
<a name="l00981"></a>00981     goto output_overrun; \
<a name="l00982"></a>00982   } \
<a name="l00983"></a>00983   else if (collisions &gt; collision_thresh) { \
<a name="l00984"></a>00984     <span class="comment">/* unlikely when the hash is good, so reinitialize hash, in case \</span>
<a name="l00985"></a>00985 <span class="comment">     * data is wacked/adversarial for some reasons. \</span>
<a name="l00986"></a>00986 <span class="comment">     */</span> \
<a name="l00987"></a>00987     BM_LOG(2, "hash collision %llu: %llx: pos: %llu and %llu: [" BM_COLOR_DBG, \
<a name="l00988"></a>00988            (Llu)lut.collisions, (Llu)hash, (Llu)pos, (Llu)i); \
<a name="l00989"></a>00989     BM_LOG_(2, in + pos, fp_len); \
<a name="l00990"></a>00990     BM_LOG(2, "%s", BM_COLOR_END "] vs [" BM_COLOR_ALT); \
<a name="l00991"></a>00991     BM_LOG_(2, in + i, fp_len); \
<a name="l00992"></a>00992     BM_LOG(2, "%s", BM_COLOR_END "] trying to adapt.\n"); \
<a name="l00993"></a>00993     _randomize_; \
<a name="l00994"></a>00994     boundary = last_i = i = offset; \
<a name="l00995"></a>00995     _init_hash_; \
<a name="l00996"></a>00996     init_bmlut(&amp;lut, in_len / fp_len, work_mem); \
<a name="l00997"></a>00997     lut.adapts = adapts + 1; \
<a name="l00998"></a>00998     op = out + 1; \
<a name="l00999"></a>00999     last_ip = in; \
<a name="l01000"></a>01000     continue; \
<a name="l01001"></a>01001   } \
<a name="l01002"></a><a class="code" href="bmz_8c.html#1218fb9dbdd245d08037f7c62815f77e">01002</a> } while (0)
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="preprocessor">#define BM_ENCODE_STAT(_msg_) do { \</span>
<a name="l01005"></a>01005 <span class="preprocessor">  size_t c = lut.collisions; \</span>
<a name="l01006"></a>01006 <span class="preprocessor">  BM_LOG(1, "%s: in: %llu, out: %llu, lut.collisions: %llu (eff. bits: %.3f) " \</span>
<a name="l01007"></a>01007 <span class="preprocessor">         "thresh: %llu), lut.probes: %llu (%.3f/lu)\n", _msg_, (Llu)in_len, \</span>
<a name="l01008"></a>01008 <span class="preprocessor">         (Llu)*out_len_p, (Llu)c, \</span>
<a name="l01009"></a>01009 <span class="preprocessor">         c ? log((double)nfps * scan_len / c) / log(2) : sizeof(size_t) * 8., \</span>
<a name="l01010"></a>01010 <span class="preprocessor">         (Llu)collision_thresh, (Llu)lut.probes, \</span>
<a name="l01011"></a>01011 <span class="preprocessor">         (double)lut.probes / scan_len); \</span>
<a name="l01012"></a>01012 <span class="preprocessor">} while (0)</span>
<a name="l01013"></a><a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">01013</a> <span class="preprocessor"></span>
<a name="l01014"></a>01014 <span class="comment">/* The main algorithm */</span>
<a name="l01015"></a>01015 <span class="preprocessor">#define BM_ENCODE_BODY(_init_hash_, _update_hash_, _randomize_) \</span>
<a name="l01016"></a>01016 <span class="preprocessor">  size_t i = offset, last_i = i, end_i = in_len - fp_len; \</span>
<a name="l01017"></a>01017 <span class="preprocessor">  size_t boundary = i, scan_len = end_i - offset; \</span>
<a name="l01018"></a>01018 <span class="preprocessor">  size_t nfps, hash, pos, collision_thresh; \</span>
<a name="l01019"></a>01019 <span class="preprocessor">  Byte *in = (Byte *) src, *out = (Byte *) dst; \</span>
<a name="l01020"></a>01020 <span class="preprocessor">  Byte *ip = in, *last_ip = ip, *in_end = in + in_len; \</span>
<a name="l01021"></a>01021 <span class="preprocessor">  Byte *op = out, *out_end; \</span>
<a name="l01022"></a>01022 <span class="preprocessor">  BmLut lut = { 0, 0, 0, 0, NULL }; \</span>
<a name="l01023"></a>01023 <span class="preprocessor">  BmLutEntry *entry = NULL; \</span>
<a name="l01024"></a>01024 <span class="preprocessor">  \</span>
<a name="l01025"></a>01025 <span class="preprocessor">  BM_CHECK(fp_len &gt; 0); \</span>
<a name="l01026"></a>01026 <span class="preprocessor">  nfps = in_len / fp_len; \</span>
<a name="l01027"></a>01027 <span class="preprocessor">  collision_thresh = s_collision_thresh ? s_collision_thresh \</span>
<a name="l01028"></a>01028 <span class="preprocessor">                                        : scan_len / 1e9 * nfps + 8; \</span>
<a name="l01029"></a>01029 <span class="preprocessor">  if (in_len &lt;= offset + fp_len) BM_ENCODE_PASS; \</span>
<a name="l01030"></a>01030 <span class="preprocessor">  \</span>
<a name="l01031"></a>01031 <span class="preprocessor">  init_bmlut(&amp;lut, nfps, work_mem); \</span>
<a name="l01032"></a>01032 <span class="preprocessor">  _init_hash_; \</span>
<a name="l01033"></a>01033 <span class="preprocessor">  \</span>
<a name="l01034"></a>01034 <span class="preprocessor">  *op++ = 1; </span><span class="comment">/* default */</span> \
<a name="l01035"></a>01035   out_end = op + (*out_len_p &lt; in_len ? *out_len_p : in_len);  \
<a name="l01036"></a>01036   \
<a name="l01037"></a>01037   for (; i &lt;= end_i; ++i) { \
<a name="l01038"></a>01038     if (i &gt; last_i) { \
<a name="l01039"></a>01039       BM_LOOKUP(lut, hash, entry); \
<a name="l01040"></a>01040       pos = entry-&gt;pos; \
<a name="l01041"></a>01041       \
<a name="l01042"></a>01042       if (pos != BM_NPOS) { \
<a name="l01043"></a>01043         Byte *ip0 = in + pos, *cp = in + i, *cp0 = cp; \
<a name="l01044"></a>01044         Byte *ip1 = ip0 + fp_len, *cp1 = cp0 + fp_len; \
<a name="l01045"></a>01045         \
<a name="l01046"></a>01046         if (memcmp(ip0, cp0, fp_len) == 0) { \
<a name="l01047"></a>01047           <span class="comment">/* we have a match */</span> \
<a name="l01048"></a>01048           size_t mlen = 0; \
<a name="l01049"></a>01049           <span class="comment">/* greedy backward up to fp_len - 1 */</span> \
<a name="l01050"></a>01050           for (ip = ip0; ip &gt; in &amp;&amp; cp &gt; last_ip &amp;&amp; \
<a name="l01051"></a>01051                mlen &lt; fp_len - 1 &amp;&amp; *--ip == *--cp; ++mlen); \
<a name="l01052"></a>01052           cp = cp0 - mlen; \
<a name="l01053"></a>01053           BM_ENCODE_OUTPUT(op, last_ip, cp); \
<a name="l01054"></a>01054           pos = ip0 - mlen - in; \
<a name="l01055"></a>01055           mlen += fp_len; \
<a name="l01056"></a>01056           <span class="comment">/* greedy forward as much as possible */</span> \
<a name="l01057"></a>01057           for (ip = ip1, cp = cp1; cp &lt; in_end &amp;&amp; *ip++ == *cp++; ++mlen); \
<a name="l01058"></a>01058           BM_ENCODE_DELTA(op, last_ip - in, pos, mlen); \
<a name="l01059"></a>01059           last_ip = cp0 - (ip0 - (in + pos)) + mlen; \
<a name="l01060"></a>01060           if (last_ip == in_end) break; \
<a name="l01061"></a>01061           last_i = last_ip - in; \
<a name="l01062"></a>01062         } \
<a name="l01063"></a>01063         else BM_HANDLE_COLLISIONS(_randomize_, _init_hash_); \
<a name="l01064"></a>01064       } \
<a name="l01065"></a>01065     } \
<a name="l01066"></a>01066     if ((i - offset) == boundary) { \
<a name="l01067"></a>01067       if (i &lt;= last_i) BM_LOOKUP(lut, hash, entry); \
<a name="l01068"></a>01068       <span class="comment">/* insert hash */</span> \
<a name="l01069"></a>01069       entry-&gt;hash = hash; \
<a name="l01070"></a>01070       entry-&gt;pos = i; \
<a name="l01071"></a>01071       boundary += fp_len; \
<a name="l01072"></a>01072     } \
<a name="l01073"></a>01073     if (i &lt; end_i) hash = _update_hash_; <span class="comment">/* for next iter */</span> \
<a name="l01074"></a>01074   } \
<a name="l01075"></a>01075   <span class="comment">/* copy the remaining bytes */</span> \
<a name="l01076"></a>01076   BM_ENCODE_FINAL_OUTPUT(op, last_ip, in_end); \
<a name="l01077"></a>01077   *out_len_p = op - out; \
<a name="l01078"></a>01078   BM_ENCODE_STAT("success"); \
<a name="l01079"></a>01079   \
<a name="l01080"></a>01080   return BMZ_E_OK; \
<a name="l01081"></a>01081   \
<a name="l01082"></a>01082 output_overrun: \
<a name="l01083"></a>01083   if (*out_len_p &gt; in_len) BM_ENCODE_PASS; \
<a name="l01084"></a>01084   BM_ENCODE_STAT("tip: make output buffer at least input length + 1"); \
<a name="l01085"></a>01085   return BMZ_E_OUTPUT_OVERRUN
<a name="l01086"></a>01086 
<a name="l01087"></a><a class="code" href="bmz_8c.html#3cd5f4759b0179973c761f3f70b57aad">01087</a> <span class="comment">/* External APIs for bm encoding */</span>
<a name="l01088"></a>01088 <span class="keywordtype">int</span>
<a name="l01089"></a>01089 <a class="code" href="bmz-internal_8h.html#a45c7686fc2784cb8a6453f31c4b4809">bmz_bm_pack_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01090"></a>01090                 <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">void</span> *work_mem,
<a name="l01091"></a>01091                 <span class="keywordtype">size_t</span> b, <span class="keywordtype">size_t</span> m) {
<a name="l01092"></a>01092   <span class="keywordtype">size_t</span> pow_n;
<a name="l01093"></a>01093   <a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">BM_ENCODE_BODY</a>(hash = <a class="code" href="bmz_8c.html#a8d4cdc49a30c978b1f95f9d46506c0f">r_hash_mod</a>(in + i, fp_len, b, m);
<a name="l01094"></a>01094                  pow_n = <a class="code" href="bmz_8c.html#021b2e4afafd99528b355a841d9caa46">pow_mod</a>(b, fp_len, m),
<a name="l01095"></a>01095                  <a class="code" href="bmz_8c.html#51c0ac9c282c2ca5ea066a093bd9927f">update_hash_mod</a>(hash, in[i + fp_len], in[i], pow_n, b, m),
<a name="l01096"></a>01096                  b = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(0));
<a name="l01097"></a>01097 }
<a name="l01098"></a><a class="code" href="bmz_8c.html#0526aa0d6170af45b05d842cd25d520e">01098</a> 
<a name="l01099"></a>01099 <span class="keywordtype">int</span>
<a name="l01100"></a>01100 <a class="code" href="bmz-internal_8h.html#3289ef93ffadd66b6658f97855b8bb12">bmz_bm_pack_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>,
<a name="l01101"></a>01101                     <span class="keywordtype">size_t</span> *out_len_p, <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len,
<a name="l01102"></a>01102                     <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2,
<a name="l01103"></a>01103                     <span class="keywordtype">size_t</span> m1, <span class="keywordtype">size_t</span> m2) {
<a name="l01104"></a>01104   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l01105"></a>01105   <a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">BM_ENCODE_BODY</a>(hash = <a class="code" href="bmz_8c.html#0d8985bd4c2f526f448536d0558a977a">r_hash_mod16x2</a>(in + i, fp_len, b1, b2, m1, m2);
<a name="l01106"></a>01106                  pow_n_b1 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b1, fp_len, m1);
<a name="l01107"></a>01107                  pow_n_b2 = <a class="code" href="bmz_8c.html#69164e2d93aa1de7e475da0570c1f260">pow_mod32</a>(b2, fp_len, m2),
<a name="l01108"></a>01108                  <a class="code" href="bmz_8c.html#ece1e6f452452c26dcc33617a384072a">update_hash_mod16x2</a>(hash, in[i + fp_len], in[i],
<a name="l01109"></a>01109                                      pow_n_b1, pow_n_b2, b1, b2, m1, m2),
<a name="l01110"></a>01110                  b1 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(0);
<a name="l01111"></a>01111                  b2 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(b1));
<a name="l01112"></a>01112 }
<a name="l01113"></a><a class="code" href="bmz_8c.html#5c7d501f326a7888b79aa385ad42230c">01113</a> 
<a name="l01114"></a>01114 <span class="keywordtype">int</span>
<a name="l01115"></a>01115 <a class="code" href="bmz-internal_8h.html#84c863b6b17abac17fed590ca3c4d442">bmz_bm_pack_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>,
<a name="l01116"></a>01116                      <span class="keywordtype">size_t</span> *out_len_p, <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len,
<a name="l01117"></a>01117                      <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l01118"></a>01118   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l01119"></a>01119   <a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">BM_ENCODE_BODY</a>(hash = <a class="code" href="bmz_8c.html#45245d5d4e493f39b0ee0ccd0c76bd89">r_hash_mask16x2</a>(in + i, fp_len, b1, b2);
<a name="l01120"></a>01120                  pow_n_b1 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b1, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>);
<a name="l01121"></a>01121                  pow_n_b2 = <a class="code" href="bmz_8c.html#c0a0fb4da8079958553bb53b388a8e56">pow_mask32</a>(b2, fp_len, <a class="code" href="bmz_8c.html#28b5858d4b13eb990d167731030d9b2c">BM_MASK16</a>),
<a name="l01122"></a>01122                  <a class="code" href="bmz_8c.html#bc601002cf02fa53451041bf163dc0e3">update_hash_mask16x2</a>(hash, in[i + fp_len], in[i],
<a name="l01123"></a>01123                                       pow_n_b1, pow_n_b2, b1, b2),
<a name="l01124"></a>01124                  b1 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(0);
<a name="l01125"></a>01125                  b2 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(b1));
<a name="l01126"></a>01126 }
<a name="l01127"></a><a class="code" href="bmz_8c.html#be9f8b258dd0744a8f2f01fb60df69ec">01127</a> 
<a name="l01128"></a>01128 <span class="keywordtype">int</span>
<a name="l01129"></a>01129 <a class="code" href="bmz-internal_8h.html#c4e27a682bb63aabd805edf34a6b330f">bmz_bm_pack_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01130"></a>01130                    <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b) {
<a name="l01131"></a>01131   <span class="keywordtype">size_t</span> pow_n;
<a name="l01132"></a>01132   <a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">BM_ENCODE_BODY</a>(hash = <a class="code" href="bmz_8c.html#b698842df9102dcd9fa240b10f03ed99">r_hash_mask</a>(in + i, fp_len, b, <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>);
<a name="l01133"></a>01133                  pow_n = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b, fp_len, <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>),
<a name="l01134"></a>01134                  <a class="code" href="bmz_8c.html#641e680114d4266a0e464315b88dbc2f">update_hash_mask</a>(hash, in[i + fp_len], in[i],
<a name="l01135"></a>01135                                   pow_n, b, <a class="code" href="bmz_8c.html#b462c18c82c94245fe73c8daf48a27ee">BM_MASKSZ</a>),
<a name="l01136"></a>01136                  b = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(0));
<a name="l01137"></a>01137 }
<a name="l01138"></a><a class="code" href="bmz_8c.html#4c0170360142e225c237d17c9e00cfaa">01138</a> 
<a name="l01139"></a>01139 <span class="keywordtype">int</span>
<a name="l01140"></a>01140 <a class="code" href="bmz-internal_8h.html#0b96bf37f10a93dd67b8f4ff0118f241">bmz_bm_pack_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>,
<a name="l01141"></a>01141                      <span class="keywordtype">size_t</span> *out_len_p, <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len,
<a name="l01142"></a>01142                      <span class="keywordtype">void</span> *work_mem, <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l01143"></a>01143   <span class="keywordtype">size_t</span> pow_n_b1, pow_n_b2;
<a name="l01144"></a>01144   <a class="code" href="bmz_8c.html#3641ef6dcdd9be5677f56ae9718c1e01">BM_ENCODE_BODY</a>(hash = <a class="code" href="bmz_8c.html#6eb632306f5c71eca0092c2e2559e474">r_hash_mask32x2</a>(in + i, fp_len, b1, b2);
<a name="l01145"></a>01145                  pow_n_b1 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b1, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>);
<a name="l01146"></a>01146                  pow_n_b2 = <a class="code" href="bmz_8c.html#55f93b35d5aa7f38ed48df29c44b153f">pow_mask</a>(b2, fp_len, <a class="code" href="bmz_8c.html#892fcaeaecd830fb18c06bfd1e33d5ec">BM_MASK32</a>),
<a name="l01147"></a>01147                  <a class="code" href="bmz_8c.html#b18eb6dc329d5093d96247a2cf0482e4">update_hash_mask32x2</a>(hash, in[i + fp_len], in[i],
<a name="l01148"></a>01148                                       pow_n_b1, pow_n_b2, b1, b2),
<a name="l01149"></a>01149                  b1 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(0);
<a name="l01150"></a>01150                  b2 = <a class="code" href="bmz_8c.html#1394f25ec9f76bd88c8ee2def6345fd6">random_prime</a>(b1));
<a name="l01151"></a>01151 }
<a name="l01152"></a><a class="code" href="bmz_8c.html#89616f181d863922cdfe7590660f4edb">01152</a> 
<a name="l01153"></a>01153 <span class="comment">/* Max lz overhead for incompressible block */</span>
<a name="l01154"></a>01154 <span class="preprocessor">#define BM_LZ_MAX(_len_) ((_len_) / 16 + 64 + 3)</span>
<a name="l01155"></a><a class="code" href="bmz_8h.html#7aad4bda12547a956976c802a2b220aa">01155</a> <span class="preprocessor"></span>
<a name="l01156"></a>01156 <span class="keywordtype">size_t</span>
<a name="l01157"></a>01157 <a class="code" href="bmz_8c.html#565eb981fe7e7a2fc1fefc47ef491b8e" title="Compute bmz compression output buffer length.">bmz_pack_buflen</a>(<span class="keywordtype">size_t</span> in_len) {
<a name="l01158"></a>01158   <span class="keywordflow">return</span> in_len + <a class="code" href="bmz_8c.html#89616f181d863922cdfe7590660f4edb">BM_LZ_MAX</a>(in_len) + 1;
<a name="l01159"></a>01159 }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161 
<a name="l01162"></a>01162 
<a name="l01163"></a><a class="code" href="bmz_8c.html#cc4c9f8cf69a211ddb2991af3379492c">01163</a> <span class="comment">/* Workmem (lut) for bm pack */</span>
<a name="l01164"></a>01164 <span class="keywordtype">size_t</span>
<a name="l01165"></a>01165 <a class="code" href="bmz-internal_8h.html#048b4d97f938d7eca4fab65f819c90fc">bmz_bm_pack_worklen</a>(<span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l01166"></a>01166   <span class="keywordflow">return</span> <a class="code" href="bmz_8c.html#a6dc90230ff6c47606d2f8db961c5f64">bm_lut_size</a>(in_len / fp_len) * <span class="keyword">sizeof</span>(<a class="code" href="struct_bm_lut_entry.html">BmLutEntry</a>);
<a name="l01167"></a>01167 }
<a name="l01168"></a>01168 
<a name="l01169"></a><a class="code" href="bmz_8c.html#5c6bfd6fb66c3140d43e4fbc232d6edb">01169</a> <span class="comment">/* Size for compressor auxiliary memory */</span>
<a name="l01170"></a>01170 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l01171"></a>01171 <a class="code" href="bmz_8c.html#5c6bfd6fb66c3140d43e4fbc232d6edb">bmz_pack_auxlen</a>(<span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l01172"></a>01172   <span class="keywordtype">size_t</span> lz_worklen = <a class="code" href="bmz-internal_8h.html#087d347b0445da10b0954b70528345ce">bmz_lz_pack_worklen</a>(in_len) + 16;
<a name="l01173"></a>01173   <span class="keywordtype">size_t</span> bm_worklen = <a class="code" href="bmz-internal_8h.html#048b4d97f938d7eca4fab65f819c90fc">bmz_bm_pack_worklen</a>(in_len, fp_len) + 16;
<a name="l01174"></a>01174   <span class="keywordflow">return</span> bm_worklen &gt; lz_worklen ? bm_worklen : lz_worklen;
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a><a class="code" href="bmz_8h.html#b437c89620b15260be14000dcbb4cec4">01177</a> <span class="comment">/* Including temporary space for bm output as well */</span>
<a name="l01178"></a>01178 <span class="keywordtype">size_t</span>
<a name="l01179"></a>01179 <a class="code" href="bmz_8c.html#c0b1526bfbf81c4511a27afee751d010" title="Return size of work memory for bmz compression.">bmz_pack_worklen</a>(<span class="keywordtype">size_t</span> in_len, <span class="keywordtype">size_t</span> fp_len) {
<a name="l01180"></a>01180   <a class="code" href="bmz_8c.html#b66b3e096507cd190f39cac9e7eea9a0">BM_CHECK</a>(fp_len &gt; 0);
<a name="l01181"></a>01181   <span class="keywordflow">return</span> in_len + <a class="code" href="bmz_8c.html#5c6bfd6fb66c3140d43e4fbc232d6edb">bmz_pack_auxlen</a>(in_len, fp_len); 
<a name="l01182"></a>01182 }
<a name="l01183"></a><a class="code" href="bmz_8h.html#d659f08ee6839f76aba8269b1f17ef16">01183</a> 
<a name="l01184"></a>01184 <span class="keywordtype">size_t</span>
<a name="l01185"></a>01185 <a class="code" href="bmz_8c.html#8a29912372c85a850b530ba8143034dc" title="Return size of work memory for bmz decompression.">bmz_unpack_worklen</a>(<span class="keywordtype">size_t</span> out_len) {
<a name="l01186"></a>01186   <span class="keywordflow">return</span> out_len + 1;
<a name="l01187"></a><a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">01187</a> }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189 <span class="preprocessor">#define BMZ_PACK_BODY(_bm_pack_) \</span>
<a name="l01190"></a>01190 <span class="preprocessor">  size_t tlen = in_len + 1; \</span>
<a name="l01191"></a>01191 <span class="preprocessor">  Byte *dst = (Byte *)work_mem; \</span>
<a name="l01192"></a>01192 <span class="preprocessor">  Byte *aux_mem = dst + tlen; \</span>
<a name="l01193"></a>01193 <span class="preprocessor">  Byte *work_mem_aligned = BM_ALIGN(aux_mem, 8); \</span>
<a name="l01194"></a>01194 <span class="preprocessor">  int ret; \</span>
<a name="l01195"></a>01195 <span class="preprocessor">  \</span>
<a name="l01196"></a>01196 <span class="preprocessor">  </span><span class="comment">/* overlap flag assume the following memory layout    \</span>
<a name="l01197"></a>01197 <span class="comment">   * |=============== input/output =================|   \</span>
<a name="l01198"></a>01198 <span class="comment">   * |&lt;------------- bmz_pack_buflen --------------&gt;|   \</span>
<a name="l01199"></a>01199 <span class="comment">   * |&lt;---------------- in_len ----------------&gt;|       \</span>
<a name="l01200"></a><a class="code" href="bmz_8c.html#abb21a119edc59c2521fd38127ee91d9">01200</a> <span class="comment">   * |&lt;-- *out_len_p --&gt;|                               \</span>
<a name="l01201"></a>01201 <span class="comment">   */</span>                                                   \
<a name="l01202"></a>01202   ret = _bm_pack_; \
<a name="l01203"></a>01203   if (ret != BMZ_E_OK) return ret; \
<a name="l01204"></a>01204   return bmz_lz_pack(dst, tlen, out, out_len_p, work_mem_aligned)
<a name="l01205"></a>01205 
<a name="l01206"></a>01206 <span class="keywordtype">int</span>
<a name="l01207"></a>01207 <a class="code" href="bmz-internal_8h.html#23545104dae6710d6a50a110330c1f10">bmz_pack_mod</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01208"></a><a class="code" href="bmz_8c.html#2d6a60ecd1be9608259baf979c529c7f">01208</a>              <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem,
<a name="l01209"></a>01209              <span class="keywordtype">size_t</span> b, <span class="keywordtype">size_t</span> m) {
<a name="l01210"></a>01210   <a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">BMZ_PACK_BODY</a>(<a class="code" href="bmz-internal_8h.html#a45c7686fc2784cb8a6453f31c4b4809">bmz_bm_pack_mod</a>(in, in_len, <a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, &amp;tlen,
<a name="l01211"></a>01211                 offset, fp_len, work_mem_aligned, b, m));
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="keywordtype">int</span>
<a name="l01215"></a>01215 <a class="code" href="bmz-internal_8h.html#27af4384bb5db406f7055754d9bb4712">bmz_pack_mod16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01216"></a><a class="code" href="bmz_8c.html#d1bbd62e0fb35f34439ee85e1d23657a">01216</a>                  <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem,
<a name="l01217"></a>01217                  <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2, <span class="keywordtype">size_t</span> m1, <span class="keywordtype">size_t</span> m2) {
<a name="l01218"></a>01218   <a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">BMZ_PACK_BODY</a>(<a class="code" href="bmz-internal_8h.html#3289ef93ffadd66b6658f97855b8bb12">bmz_bm_pack_mod16x2</a>(in, in_len, <a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, &amp;tlen,
<a name="l01219"></a>01219                 offset, fp_len, work_mem_aligned, b1, b2, m1, m2));
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 <span class="keywordtype">int</span>
<a name="l01223"></a>01223 <a class="code" href="bmz-internal_8h.html#fca59d18273c83c682010654b43b918c">bmz_pack_mask16x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01224"></a><a class="code" href="bmz_8c.html#10271928f949d5177149f7876f6ee75d">01224</a>                   <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem,
<a name="l01225"></a>01225                   <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l01226"></a>01226   <a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">BMZ_PACK_BODY</a>(<a class="code" href="bmz-internal_8h.html#84c863b6b17abac17fed590ca3c4d442">bmz_bm_pack_mask16x2</a>(in, in_len, <a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, &amp;tlen,
<a name="l01227"></a>01227                 offset, fp_len, work_mem_aligned, b1, b2));
<a name="l01228"></a>01228 }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230 <span class="keywordtype">int</span>
<a name="l01231"></a>01231 <a class="code" href="bmz-internal_8h.html#2421d9129238ae90893142312c8402b1">bmz_pack_mask</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01232"></a><a class="code" href="bmz_8c.html#c969b1df672f5b2f376b611bff2b957b">01232</a>               <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem,
<a name="l01233"></a>01233               <span class="keywordtype">size_t</span> b) {
<a name="l01234"></a>01234   <a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">BMZ_PACK_BODY</a>(<a class="code" href="bmz-internal_8h.html#c4e27a682bb63aabd805edf34a6b330f">bmz_bm_pack_mask</a>(in, in_len, <a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, &amp;tlen,
<a name="l01235"></a>01235                 offset, fp_len, work_mem_aligned, b));
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="keywordtype">int</span>
<a name="l01239"></a>01239 <a class="code" href="bmz-internal_8h.html#a8efabcfde96388752273cc252a64a1e">bmz_pack_mask32x2</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01240"></a><a class="code" href="bmz_8h.html#694a10d27d37013c1535dc3a3d0563b2">01240</a>                   <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem,
<a name="l01241"></a>01241                   <span class="keywordtype">size_t</span> b1, <span class="keywordtype">size_t</span> b2) {
<a name="l01242"></a>01242   <a class="code" href="bmz_8c.html#afcfda8cc00a79b758e1125a1019d7ca">BMZ_PACK_BODY</a>(<a class="code" href="bmz-internal_8h.html#0b96bf37f10a93dd67b8f4ff0118f241">bmz_bm_pack_mask32x2</a>(in, in_len, <a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a>, &amp;tlen,
<a name="l01243"></a>01243                 offset, fp_len, work_mem_aligned, b1, b2));
<a name="l01244"></a>01244 }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="keywordtype">int</span>
<a name="l01247"></a>01247 <a class="code" href="bmz_8c.html#56feb9141bd6c6ece9151c4f40b8c638" title="Perform bmz compression.">bmz_pack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01248"></a>01248          <span class="keywordtype">size_t</span> <a class="code" href="code__search__and__replace_8cc.html#d5f0842c40c7e46344fd8df70187fa0f">offset</a>, <span class="keywordtype">size_t</span> fp_len, <span class="keywordtype">unsigned</span> flags, <span class="keywordtype">void</span> *work_mem) {
<a name="l01249"></a>01249   <span class="keywordflow">switch</span> (flags &gt;&gt; 24) {
<a name="l01250"></a>01250   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#bdd4ffb59c09910bb6187afb9d81a680" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BMZ_HASH_MOD</a>:
<a name="l01251"></a>01251     <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#23545104dae6710d6a50a110330c1f10">bmz_pack_mod</a>(in, in_len, out, out_len_p, offset, fp_len, flags,
<a name="l01252"></a>01252                         work_mem, <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, <a class="code" href="bmz_8c.html#3a2abe993ac92e596721d71805ecb5dd">BM_M1</a>);
<a name="l01253"></a>01253   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#98eddc5603e74b3d34930cc2b8bd806e">BMZ_HASH_MOD16X2</a>:
<a name="l01254"></a>01254     <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#27af4384bb5db406f7055754d9bb4712">bmz_pack_mod16x2</a>(in, in_len, out, out_len_p, offset, fp_len, flags,
<a name="l01255"></a>01255                             work_mem, <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>, <a class="code" href="bmz_8c.html#3a2abe993ac92e596721d71805ecb5dd">BM_M1</a>, <a class="code" href="bmz_8c.html#297c411c96dab287ba0c6ac6d44fc37b">BM_M2</a>);
<a name="l01256"></a>01256   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#fa4019afd464eb9044696285482042fa">BMZ_HASH_MASK16X2</a>:
<a name="l01257"></a>01257     <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#fca59d18273c83c682010654b43b918c">bmz_pack_mask16x2</a>(in, in_len, out, out_len_p, offset, fp_len, flags,
<a name="l01258"></a>01258                              work_mem, <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>);
<a name="l01259"></a>01259   <span class="keywordflow">case</span> 0: <span class="comment">/* default */</span>
<a name="l01260"></a>01260   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#1bf2311a8eccf8da1d429bec69fda5fe">BMZ_HASH_MASK</a>:
<a name="l01261"></a>01261     <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#2421d9129238ae90893142312c8402b1">bmz_pack_mask</a>(in, in_len, out, out_len_p, offset, fp_len, flags,
<a name="l01262"></a>01262                          work_mem, <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>);
<a name="l01263"></a>01263   <span class="keywordflow">case</span> <a class="code" href="bmz-internal_8h.html#eff04f542211021ab9025be24d5eee0f">BMZ_HASH_MASK32X2</a>:
<a name="l01264"></a>01264     <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#a8efabcfde96388752273cc252a64a1e">bmz_pack_mask32x2</a>(in, in_len, out, out_len_p, offset, fp_len, flags,
<a name="l01265"></a>01265                              work_mem, <a class="code" href="bmz_8c.html#a7d4b10eadacd3cd00a3373a407a7bd6" title="Copyright (C) 2007 Luke Lu (Zvents, Inc.">BM_B1</a>, <a class="code" href="bmz_8c.html#f991fd3f78bbbf816d88faeba9e14b00">BM_B2</a>);
<a name="l01266"></a><a class="code" href="bmz_8h.html#e4ca9b0dd493d6487016a5f24c6a011c">01266</a>   <span class="keywordflow">default</span>:
<a name="l01267"></a>01267     <a class="code" href="bmz_8c.html#98322961a1ae4dfc89a56c9d27a3339b">BM_DIE</a>(<span class="stringliteral">"unknown hash algorithm: %u"</span>, (flags &gt;&gt; 24));
<a name="l01268"></a>01268   }
<a name="l01269"></a>01269   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#e94a3e9a39986d4de5b6fd61e62c12ad">BMZ_E_ERROR</a>;
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 <span class="keywordtype">int</span>
<a name="l01273"></a>01273 <a class="code" href="bmz_8c.html#a251ec18664698ab168a138221b37c6a" title="Perform bmz decompression.">bmz_unpack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01274"></a>01274            <span class="keywordtype">void</span> *work_mem) {
<a name="l01275"></a>01275   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *<a class="code" href="lzoconf_8h.html#19cbb22b1e5f063785152ae6b1755c18">dst</a> = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)work_mem;
<a name="l01276"></a>01276   <span class="keywordtype">size_t</span> tlen = *out_len_p + 1;
<a name="l01277"></a>01277   <span class="keywordtype">int</span> ret;
<a name="l01278"></a><a class="code" href="bmz_8c.html#9c454d479fadd42c63e04936c5d3a949">01278</a> 
<a name="l01279"></a>01279   ret = <a class="code" href="bmz-internal_8h.html#632dff4b3fe1fddb5a8b8a04fbfca36c">bmz_lz_unpack</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, dst, &amp;tlen);
<a name="l01280"></a>01280   <span class="keywordflow">if</span> (ret != <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>) <span class="keywordflow">return</span> ret;
<a name="l01281"></a>01281   <span class="keywordflow">return</span> <a class="code" href="bmz-internal_8h.html#2597fab94d23d868c24c1d3878f01756">bmz_bm_unpack</a>(dst, tlen, out, out_len_p);
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="preprocessor">#define BM_DECODE_POS(_cpos_, _n_) do { \</span>
<a name="l01286"></a>01286 <span class="preprocessor">  UInt64 _ipos = _cpos_; \</span>
<a name="l01287"></a>01287 <span class="preprocessor">  int w = BM_INT_WIDTH(_ipos); \</span>
<a name="l01288"></a>01288 <span class="preprocessor">  BM_NEED_IN(w); \</span>
<a name="l01289"></a>01289 <span class="preprocessor">  \</span>
<a name="l01290"></a>01290 <span class="preprocessor">  switch (w) { \</span>
<a name="l01291"></a>01291 <span class="preprocessor">  case 1: \</span>
<a name="l01292"></a>01292 <span class="preprocessor">    _n_ = *ip++; \</span>
<a name="l01293"></a>01293 <span class="preprocessor">    break; \</span>
<a name="l01294"></a>01294 <span class="preprocessor">  case 2: \</span>
<a name="l01295"></a>01295 <span class="preprocessor">    _n_ = (*ip++ &lt;&lt; 8); \</span>
<a name="l01296"></a>01296 <span class="preprocessor">    _n_ |= *ip++; \</span>
<a name="l01297"></a>01297 <span class="preprocessor">    break; \</span>
<a name="l01298"></a>01298 <span class="preprocessor">  case 3: \</span>
<a name="l01299"></a>01299 <span class="preprocessor">    _n_ = (*ip++ &lt;&lt; 16); \</span>
<a name="l01300"></a>01300 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 8); \</span>
<a name="l01301"></a>01301 <span class="preprocessor">    _n_ |= *ip++; \</span>
<a name="l01302"></a>01302 <span class="preprocessor">    break; \</span>
<a name="l01303"></a>01303 <span class="preprocessor">  case 4: \</span>
<a name="l01304"></a>01304 <span class="preprocessor">    _n_ = (*ip++ &lt;&lt; 24); \</span>
<a name="l01305"></a>01305 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 16); \</span>
<a name="l01306"></a>01306 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 8); \</span>
<a name="l01307"></a>01307 <span class="preprocessor">    _n_ |= *ip++; \</span>
<a name="l01308"></a>01308 <span class="preprocessor">    break; \</span>
<a name="l01309"></a>01309 <span class="preprocessor">  case 5: \</span>
<a name="l01310"></a>01310 <span class="preprocessor">    _n_ = ((UInt64)*ip++ &lt;&lt; 32); \</span>
<a name="l01311"></a>01311 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 24); \</span>
<a name="l01312"></a>01312 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 16); \</span>
<a name="l01313"></a>01313 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 8); \</span>
<a name="l01314"></a>01314 <span class="preprocessor">    _n_ |= *ip++; \</span>
<a name="l01315"></a>01315 <span class="preprocessor">    break; \</span>
<a name="l01316"></a>01316 <span class="preprocessor">  case 6: \</span>
<a name="l01317"></a>01317 <span class="preprocessor">    _n_ = ((UInt64)*ip++ &lt;&lt; 40); \</span>
<a name="l01318"></a>01318 <span class="preprocessor">    _n_ |= ((UInt64)*ip++ &lt;&lt; 32); \</span>
<a name="l01319"></a>01319 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 24); \</span>
<a name="l01320"></a>01320 <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 16); \</span>
<a name="l01321"></a><a class="code" href="bmz_8c.html#0066dadcc18d96dc4dc4a9283cdc1cbf">01321</a> <span class="preprocessor">    _n_ |= (*ip++ &lt;&lt; 8); \</span>
<a name="l01322"></a>01322 <span class="preprocessor">    _n_ |= *ip++; \</span>
<a name="l01323"></a>01323 <span class="preprocessor">  default: \</span>
<a name="l01324"></a><a class="code" href="bmz_8c.html#ae49f746fd263f9dffd2405ebb71ce75">01324</a> <span class="preprocessor">    BM_DIE("%s", "256TB ought to be enough for anyone!"); \</span>
<a name="l01325"></a>01325 <span class="preprocessor">  } \</span>
<a name="l01326"></a>01326 <span class="preprocessor">} while (0)</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span>
<a name="l01328"></a>01328 <span class="preprocessor">#define BM_DECODE_LEN(_n_) BM_DECODE_VINT(_n_)</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span>
<a name="l01330"></a>01330 <span class="keywordtype">int</span>
<a name="l01331"></a>01331 <a class="code" href="bmz-internal_8h.html#2597fab94d23d868c24c1d3878f01756">bmz_bm_unpack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *dst, <span class="keywordtype">size_t</span> *out_len_p) {
<a name="l01332"></a>01332   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *in = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)src, *out = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)dst;
<a name="l01333"></a>01333   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *ip = in, *last_ip = ip + 1, *op = out, *cp;
<a name="l01334"></a>01334   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *in_end = ip + in_len, *out_end = op + *out_len_p;
<a name="l01335"></a>01335   <span class="keywordtype">int</span> remains;
<a name="l01336"></a>01336 
<a name="l01337"></a>01337   <span class="keywordflow">if</span> (*ip++ == 0) {
<a name="l01338"></a>01338     memcpy(out, ip, --in_len);
<a name="l01339"></a>01339     *out_len_p = in_len;
<a name="l01340"></a>01340     <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>;
<a name="l01341"></a>01341   }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343   <span class="keywordflow">while</span> (ip &lt; in_end) {
<a name="l01344"></a>01344     <span class="keywordflow">if</span> (*ip == <a class="code" href="bmz_8c.html#9c199bd0f9500d69e1bff9654e1bb5e6">BM_ESC</a>) {
<a name="l01345"></a>01345       <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a> = ip - last_ip, pos = 0;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (len) {
<a name="l01348"></a>01348         <a class="code" href="bmz_8c.html#ae4764ce9dab784ab6fae469830de3e7">BM_NEED_OUT</a>(len);
<a name="l01349"></a>01349         memcpy(op, last_ip, len);
<a name="l01350"></a>01350         op += len;
<a name="l01351"></a>01351         last_ip = ip;
<a name="l01352"></a>01352       }
<a name="l01353"></a>01353       <a class="code" href="bmz_8c.html#94b4d1ed238e8468b72a77dd4208d1a4">BM_NEED_IN</a>(1);
<a name="l01354"></a>01354 
<a name="l01355"></a>01355       <span class="keywordflow">if</span> (ip[1] == <a class="code" href="bmz_8c.html#9c199bd0f9500d69e1bff9654e1bb5e6">BM_ESC</a>) {
<a name="l01356"></a>01356         ++last_ip;
<a name="l01357"></a>01357         ip += 2;
<a name="l01358"></a>01358       }
<a name="l01359"></a>01359       <span class="keywordflow">else</span> {
<a name="l01360"></a>01360         ++ip;
<a name="l01361"></a>01361         <a class="code" href="bmz_8c.html#9c454d479fadd42c63e04936c5d3a949">BM_DECODE_POS</a>(op - out, pos);
<a name="l01362"></a>01362         <a class="code" href="bmz_8c.html#0066dadcc18d96dc4dc4a9283cdc1cbf">BM_DECODE_LEN</a>(len);
<a name="l01363"></a>01363         <a class="code" href="bmz_8c.html#ae4764ce9dab784ab6fae469830de3e7">BM_NEED_OUT</a>(len);
<a name="l01364"></a>01364         last_ip = ip;
<a name="l01365"></a>01365         cp = out + pos;
<a name="l01366"></a>01366         
<a name="l01367"></a>01367         <span class="keywordflow">while</span> (len--) *op++ = *cp++;
<a name="l01368"></a>01368       }
<a name="l01369"></a>01369     }
<a name="l01370"></a>01370     <span class="keywordflow">else</span> ++ip;
<a name="l01371"></a>01371   }
<a name="l01372"></a>01372   remains = in_end - last_ip;
<a name="l01373"></a>01373   <a class="code" href="bmz_8c.html#ae4764ce9dab784ab6fae469830de3e7">BM_NEED_OUT</a>(remains);
<a name="l01374"></a>01374   memcpy(op, last_ip, remains);
<a name="l01375"></a>01375   *out_len_p = op - out + remains;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 input_overrun:
<a name="l01380"></a>01380   *out_len_p = op - out;
<a name="l01381"></a>01381   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#74b796dbf1a657a2eefafd445b1da415">BMZ_E_INPUT_OVERRUN</a>;
<a name="l01382"></a><a class="code" href="bmz_8c.html#076ebabc200fa0ac68576cd6123b8cc5">01382</a> 
<a name="l01383"></a>01383 output_overrun:
<a name="l01384"></a>01384   *out_len_p = op - out;
<a name="l01385"></a>01385   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#fff5a360241b7d7b1595318ba6d87a43">BMZ_E_OUTPUT_OVERRUN</a>;
<a name="l01386"></a>01386 }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388 <span class="keywordtype">int</span>
<a name="l01389"></a>01389 <a class="code" href="bmz-internal_8h.html#fa1f001946fb0576f3f3dd9c9fe29199">bmz_bm_dump</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> in_len) {
<a name="l01390"></a>01390   <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *in = (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)src, *ip = in, *in_end = ip + in_len;
<a name="l01391"></a>01391   <a class="code" href="bmz_8c.html#a288382a207683aa38aca516f6edd66d">UInt64</a> pos = 0, <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>, cpos = 0, tot_pte_sz = 0, tot_ptr_sz = 0, nptrs = 0;
<a name="l01392"></a>01392   <span class="keywordtype">int</span> is_on = *ip++;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   printf(<a class="code" href="bmz_8c.html#20a8d9069f5f5520d36488258b59f262">BM_COLOR_DBG</a> <span class="stringliteral">"%d"</span> <a class="code" href="bmz_8c.html#326de7dc61165ac27a86660869d4a8ed">BM_COLOR_END</a>, is_on);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396   <span class="keywordflow">if</span> (!is_on) {
<a name="l01397"></a>01397     fwrite(ip, 1, in_end - ip, stdout);
<a name="l01398"></a>01398     <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>;
<a name="l01399"></a>01399   }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401   <span class="keywordflow">while</span> (ip &lt; in_end) {
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (*ip == <a class="code" href="bmz_8c.html#9c199bd0f9500d69e1bff9654e1bb5e6">BM_ESC</a>) {
<a name="l01403"></a>01403       <a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *ip0 = ip;
<a name="l01404"></a>01404       <a class="code" href="bmz_8c.html#94b4d1ed238e8468b72a77dd4208d1a4">BM_NEED_IN</a>(1);
<a name="l01405"></a>01405 
<a name="l01406"></a>01406       <span class="keywordflow">if</span> (ip[1] != <a class="code" href="bmz_8c.html#9c199bd0f9500d69e1bff9654e1bb5e6">BM_ESC</a>) {
<a name="l01407"></a>01407         ++ip;
<a name="l01408"></a>01408         <a class="code" href="bmz_8c.html#9c454d479fadd42c63e04936c5d3a949">BM_DECODE_POS</a>(cpos, pos);
<a name="l01409"></a>01409         <a class="code" href="bmz_8c.html#0066dadcc18d96dc4dc4a9283cdc1cbf">BM_DECODE_LEN</a>(<a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>);
<a name="l01410"></a>01410         printf(<a class="code" href="bmz_8c.html#20a8d9069f5f5520d36488258b59f262">BM_COLOR_DBG</a> <span class="stringliteral">"&lt;%llu,%llu&gt;"</span> BM_COLOR_END,
<a name="l01411"></a>01411                (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)pos, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)<a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>);
<a name="l01412"></a>01412         cpos += <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>;
<a name="l01413"></a>01413         tot_pte_sz += <a class="code" href="_range_server_8cc.html#7360b55975153b822efc5217b7734e6a">len</a>;
<a name="l01414"></a>01414         tot_ptr_sz += ip - ip0;
<a name="l01415"></a>01415         ++nptrs;
<a name="l01416"></a>01416       }
<a name="l01417"></a>01417       <span class="keywordflow">else</span> {
<a name="l01418"></a>01418         putchar(*ip++);
<a name="l01419"></a>01419         putchar(*ip++);
<a name="l01420"></a>01420         cpos += 2;
<a name="l01421"></a>01421       }
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423     <span class="keywordflow">else</span> {
<a name="l01424"></a>01424       putchar(*ip++);
<a name="l01425"></a>01425       ++cpos;
<a name="l01426"></a>01426     }
<a name="l01427"></a>01427   }
<a name="l01428"></a>01428   <a class="code" href="bmz_8c.html#bb4926e4303ea0d7e586d5cbcf00e2dc">BM_LOG</a>(1, <span class="stringliteral">"%llu pointers, avg pointee size: %.3f, avg pointer size: %.3f\n"</span>, 
<a name="l01429"></a>01429          (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)nptrs, (<span class="keywordtype">double</span>)tot_pte_sz / nptrs,
<a name="l01430"></a>01430          (<span class="keywordtype">double</span>)tot_ptr_sz / nptrs);
<a name="l01431"></a><a class="code" href="bmz_8h.html#505b3b5f2bf8b68360e72bff5d19570c">01431</a>   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a>;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 input_overrun:
<a name="l01434"></a>01434   <span class="keywordflow">return</span> <a class="code" href="bmz_8h.html#74b796dbf1a657a2eefafd445b1da415">BMZ_E_INPUT_OVERRUN</a>;
<a name="l01435"></a>01435 }
<a name="l01436"></a>01436 
<a name="l01437"></a><a class="code" href="bmz_8c.html#9014728f5c8333ab31b4cb505ea69c8f">01437</a> <span class="keywordtype">int</span>
<a name="l01438"></a>01438 <a class="code" href="bmz_8c.html#62f518d7d1e2a5f5e638807edfb64a85" title="Perform bmz initialization only needs to be called once, mostly for sanity checks...">bmz_init</a>() {
<a name="l01439"></a>01439   <span class="keywordtype">int</span> ret = <a class="code" href="lzoconf_8h.html#b37847919b4ac4f81505077f7438c6db">lzo_init</a>();
<a name="l01440"></a>01440   <span class="keywordflow">return</span> ret == <a class="code" href="lzoconf_8h.html#95ee0d3ad214da3df73208e04697ebcc">LZO_E_OK</a> ? <a class="code" href="bmz_8h.html#bcd9587ac68784e74887226dbdd439a3">BMZ_E_OK</a> : <a class="code" href="bmz_8h.html#e94a3e9a39986d4de5b6fd61e62c12ad">BMZ_E_ERROR</a>;
<a name="l01441"></a>01441 }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443 <span class="keywordtype">int</span>
<a name="l01444"></a>01444 <a class="code" href="bmz-internal_8h.html#f8cba2a905364e4d0706ee2af1075465">bmz_lz_pack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p,
<a name="l01445"></a>01445             <span class="keywordtype">void</span> *work_mem) {
<a name="l01446"></a><a class="code" href="bmz_8c.html#df115a08d08828c589fe62552a6b8d44">01446</a>   <a class="code" href="lzoconf_8h.html#3be3d806d795286654cf766c55057dd5">lzo_uint</a> olen = *out_len_p;
<a name="l01447"></a>01447   <span class="keywordtype">int</span> ret = <a class="code" href="minilzo_8h.html#1a1b44b6186cab6dad41c98edef0ece7">lzo1x_1_compress</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)out, &amp;olen, work_mem);
<a name="l01448"></a>01448   *out_len_p = olen;
<a name="l01449"></a>01449   <span class="keywordflow">return</span> ret;
<a name="l01450"></a>01450 }
<a name="l01451"></a><a class="code" href="bmz_8c.html#fb1007aa2dbcc461c8a4d4a20ecb66b8">01451</a> 
<a name="l01452"></a>01452 <span class="keywordtype">size_t</span>
<a name="l01453"></a>01453 <a class="code" href="bmz-internal_8h.html#087d347b0445da10b0954b70528345ce">bmz_lz_pack_worklen</a>(<span class="keywordtype">size_t</span> in_len) {
<a name="l01454"></a>01454   <span class="keywordflow">return</span> <a class="code" href="minilzo_8h.html#34c10f026ddce699545fedc7495683d9">LZO1X_MEM_COMPRESS</a>;
<a name="l01455"></a>01455 }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 <span class="keywordtype">int</span>
<a name="l01458"></a>01458 <a class="code" href="bmz-internal_8h.html#632dff4b3fe1fddb5a8b8a04fbfca36c">bmz_lz_unpack</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len, <span class="keywordtype">void</span> *out, <span class="keywordtype">size_t</span> *out_len_p) {
<a name="l01459"></a><a class="code" href="bmz_8h.html#4bd0017201c8233825a566e8b7152eff">01459</a>   <a class="code" href="lzoconf_8h.html#3be3d806d795286654cf766c55057dd5">lzo_uint</a> olen = *out_len_p;
<a name="l01460"></a>01460   <span class="keywordtype">int</span> ret = <a class="code" href="minilzo_8h.html#56d80346d5050546f13920548481426d">lzo1x_decompress</a>((<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len, (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)out, &amp;olen, NULL);
<a name="l01461"></a>01461   *out_len_p = olen;
<a name="l01462"></a>01462   <span class="keywordflow">return</span> ret;
<a name="l01463"></a>01463 }
<a name="l01464"></a><a class="code" href="bmz_8h.html#373d3498f368d4137596cee6ee64a105">01464</a> 
<a name="l01465"></a>01465 <span class="keywordtype">unsigned</span>
<a name="l01466"></a>01466 <a class="code" href="bmz_8c.html#054672aaf755771f6fa521b21b42a419" title="A fast checksum (adler32) function that might be useful.">bmz_checksum</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len) {
<a name="l01467"></a>01467   <span class="keywordflow">return</span> <a class="code" href="lzoconf_8h.html#f4ad0d00105c9e6e749126ea6e9879bb">lzo_adler32</a>(1, (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len);
<a name="l01468"></a>01468 }
<a name="l01469"></a>01469 
<a name="l01470"></a>01470 <span class="keywordtype">unsigned</span>
<a name="l01471"></a>01471 <a class="code" href="bmz_8c.html#1c77bbaed72a9d87217befae17152079">bmz_update_checksum</a>(<span class="keywordtype">unsigned</span> s, <span class="keyword">const</span> <span class="keywordtype">void</span> *in, <span class="keywordtype">size_t</span> in_len) {
<a name="l01472"></a>01472   <span class="keywordflow">return</span> <a class="code" href="lzoconf_8h.html#f4ad0d00105c9e6e749126ea6e9879bb">lzo_adler32</a>(s, (<a class="code" href="bmz_8c.html#7ae8f3766c8853286755f4ec0903c6f0">Byte</a> *)in, in_len);
<a name="l01473"></a>01473 }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475 <span class="comment">/* vim: et sw=2</span>
<a name="l01476"></a>01476 <span class="comment"> */</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri May 23 15:19:17 2008 for hypertable by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
